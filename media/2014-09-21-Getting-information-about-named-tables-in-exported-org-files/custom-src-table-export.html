<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>blog</title>
<!-- 2014-09-21 Sun 14:33 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">blog</h1>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Getting information about named tables in exported org-files</h2>
<div class="outline-text-2" id="text-1">
<p>
I have found that the names of tables typically get lost when you export an org-file to another format like html or pdf. Since we may use named tables as data sources, it can become unclear in the exported file what has happened, or which table data came from. In this post, we examine how to include the name of a table in exported html. Here are two named tables <code>tbl-1</code> and <code>tbl-2</code> that will form the beginning of our effort. 
</p>

<br>TBLNAME: <a name="tbl-1"></a>tbl-1<br><table id="tbl-1" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">3</td>
</tr>
</tbody>
</table>

<p>
Another table, so we have something to work with later.
</p>

<br>TBLNAME: <a name="tbl-2"></a>tbl-2<br><table id="tbl-2" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">a</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">5</td>
</tr>

<tr>
<td class="right">3</td>
</tr>
</tbody>
</table>


<p>
Org-buffers get parsed into nested lists, with properties usually in plists. It will be convenient to get a list of the keys for an element, so we can tell what information we have on each element. Some code for this can be found here: <a href="http://www.emacswiki.org/emacs/mon-plist-utils.el">http://www.emacswiki.org/emacs/mon-plist-utils.el</a>. Rather than use that recursive approach, here we just loop through the plist and accumulate the keys.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="elisp-keys">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">plist-get-keys</span> (plist)
  (interactive)
  (<span style="color: #8b0000;">let</span> ((keys))
    (<span style="color: #8b0000;">while</span> (car plist)
      (add-to-list 'keys (car plist) t)
      (setq plist (cddr plist)))
    keys))

; <span style="color: #ff0000; font-weight: bold;">example of use</span>
(plist-get-keys '(<span style="color: #cd0000;">:a</span> 1 <span style="color: #cd0000;">:b</span> 3 <span style="color: #cd0000;">:parent</span> '(another plist)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">:a</td>
<td class="left">:b</td>
<td class="left">:parent</td>
</tr>
</tbody>
</table>


<p>
Now, when we parse a buffer for elements, we get a nested lisp data structure, and the best I can tell is we need the cadr of that list to get to the relevant plist of properties. So, here, we map over the tables, and see what properties are available.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map
    (org-element-parse-buffer) 'table
  (<span style="color: #8b0000;">lambda</span> (element)  (plist-get-keys (cadr element))))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:name</td>
<td class="left">:parent</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:name</td>
<td class="left">:parent</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:results</td>
<td class="left">:parent</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:caption</td>
<td class="left">:parent</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:name</td>
<td class="left">:caption</td>
<td class="left">:parent</td>
</tr>

<tr>
<td class="left">:begin</td>
<td class="left">:end</td>
<td class="left">:type</td>
<td class="left">:tblfm</td>
<td class="left">:contents-begin</td>
<td class="left">:contents-end</td>
<td class="left">:value</td>
<td class="left">:post-blank</td>
<td class="left">:post-affiliated</td>
<td class="left">:results</td>
<td class="left">:parent</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Depending on when you run the codeblock above (i.e. I ran it at different stages of development of this document, so some tables after this point are shown), you see different results; some of the tables are RESULTS from code blocks with no names, and two tables have a caption.  
</p>

<p>
Let us now map over the tables and see if they have names. We add an unnamed table, and a named table, both with captions.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> an unnamed table of category counts.</caption>

<colgroup>
<col  class="left" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">category</th>
<th scope="col" class="right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">emacs</td>
<td class="right">4</td>
</tr>

<tr>
<td class="left">orgmode</td>
<td class="right">3</td>
</tr>
</tbody>
</table>

<br>TBLNAME: <a name="python-table"></a>python-table<br><table id="python-table" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> an named table of category counts on python.</caption>

<colgroup>
<col  class="left" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">category</th>
<th scope="col" class="right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Python</td>
<td class="right">4</td>
</tr>

<tr>
<td class="left">pep8</td>
<td class="right">3</td>
</tr>
</tbody>
</table>

<p>
Here we get the names of the tables. Only three tables have names, and several are unnamed.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map
    (org-element-parse-buffer) 'table
  (<span style="color: #8b0000;">lambda</span> (element)  (plist-get (cadr element) <span style="color: #cd0000;">:name</span>)))
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">tbl-1</td>
<td class="left">tbl-2</td>
<td class="left">python-table</td>
</tr>
</tbody>
</table>


<p>
If you think that is a little awkward, I agree. Here is probably a better way to get that information using features in org-mode..
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map
    (org-element-parse-buffer) 'table
  (<span style="color: #8b0000;">lambda</span> (element)  (org-element-property <span style="color: #cd0000;">:name</span> element)))
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">tbl-1</td>
<td class="left">tbl-2</td>
<td class="left">python-table</td>
</tr>
</tbody>
</table>


<p>
I had thought we could use a <a href="http://orgmode.org/manual/Advanced-configuration.html">filter</a> to add the name to each table. The issue with filtering is that we get the transcoded text directly, and no practical way to get back to the element it came from (at least none I could find). I have previously used filters (e.g. for <a href="http://kitchingroup.cheme.cmu.edu/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/">changing links on export</a>) for something like this, but it involved parsing the document once, then exporting, and iterating through the results to change the output. I want to do something different here, and fix the issue on the export. 
</p>

<p>
That requires us to derive a new backend for export, with our new function for formatting. This will give us access to the actual table element, and we can use the original transcoding function to get most of the table, and our own code to modify that before it is exported.
</p>

<p>
Basically, we just want to add an HTML anchor to the table with some text to indicate the table name. With the anchor we can then link to it elsewhere like this:
</p>

<a href="#tbl-2"> See tbl-2</a>

<p>
We just define a function that satisfies the transcoding function signature (element contents info), and if our element has a :name property, we will prepend it onto the usual table output for html. We will go ahead and code in some conditional code for different backends, although for now only handle the html backend.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">my-table-format</span> (table contents info)
  (<span style="color: #8b0000;">let</span> ((tblname (org-element-property <span style="color: #cd0000;">:name</span> table)))    
    (<span style="color: #8b0000;">cond</span>
     ((eq (elt (plist-get info <span style="color: #cd0000;">:back-end</span>) 2) 'html)  
      (concat
       (<span style="color: #8b0000;">when</span> tblname
         (format <span style="color: #228b22;">"&lt;br&gt;TBLNAME: &lt;a name=\"%s\"&gt;&lt;/a&gt;%s&lt;br&gt;"</span> tblname tblname))
       (org-html-table table contents info))))))

(org-export-define-derived-backend 'my-html 'html
  <span style="color: #cd0000;">:translate-alist</span> '((table . my-table-format)))


(browse-url (org-export-to-file 'my-html <span style="color: #228b22;">"custom-src-table-export.html"</span>))
</pre>
</div>

<pre class="example">
#&lt;process open custom-src-table-export.html&gt;
</pre>

<p>
)</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2014-09-21 Sun 14:33</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.50.1 (<a href="http://orgmode.org">Org</a> mode 8.2.7c)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
