

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Changing links to files so they work in a blog</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications/index.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            






<article>
  <div class="blog_post">
    <header>
      <div id="Changing-links-to-files-so-they-work-in-a-blog"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/" rel="bookmark" title="Permanent Link to Changing links to files so they work in a blog">Changing links to files so they work in a blog</a></h2>
      <p><small><span class="blog_post_date">Posted September 28, 2013 at 05:49 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated September 29, 2013 at 08:14 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Getting links to files in a post to point to the actual file</a>
<ul>
<li><a href="#sec-1-1">1.1. link one</a></li>
<li><a href="#sec-1-2">1.2. link two</a></li>
<li><a href="#sec-1-3">1.3. link three</a></li>
<li><a href="#sec-1-4">1.4. Checkout all the links</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Getting links to files in a post to point to the actual file</h2>
<div class="outline-text-2" id="text-1">
<p>
Occasionally I use a data file in post. In the local org-file buffer I can make a link to the file, and it opens just fine. However, when I publish the post, there is not a mechanism to copy the file to the blog directory, and rewrite the link in exported html so it opens the file. 
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> link one</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This is an explicit file link
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">news.org</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> link two</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Here we just use a path inside [[]]
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">news.org</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> link three</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Here we use a decorated link.
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">Org-file containing news</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Checkout all the links</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Let us now check out the links. We will use org-element-map to parse the elements and print the link number, the link type, and the :path. For fun, let us put an emacs-lisp link in: <pre>elisp:(princ "test")</pre>and a link to an image:
</p>


<div class="figure">
<p><img src="/media/Changing-links-to-files-so-they work-in-a-blog/tooltip-emacs.png">
</p>
</div>

<p>
And finally, I want a link to a file in another directory: <a href="/media/Changing-links-to-files-so-they work-in-a-blog/fabfile.py">fabfile.py</a>
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
      (counter 0))
  (org-element-map parsetree 'link
    (<span style="color: #8b0000;">lambda</span> (link) 
      (<span style="color: #8b0000;">let</span> ((type (nth 0 link))
            (plist (nth 1 link))
            (content (nth 2 link)))
        (princ (format <span style="color: #228b22;">"%s %s: %s %s\n"</span> counter (plist-get plist '<span style="color: #cd0000;">:type</span>) (plist-get plist <span style="color: #cd0000;">:path</span>) content))
        (setq counter (+ counter 1))))))
</pre>
</div>

<pre class="example">
0 file: news.org nil
1 file: ./news.org nil
2 file: ./news.org Org-file containing news
3 elisp: (princ "test") nil
4 file: ../img/tooltip-emacs.png nil
5 file: ../fabfile.py nil
6 http: //orgmode.org/worg/exporters/filter-markup.html nil
7 https: //github.com/jkitchin/jmax/blob/prelude/blogofile.el blogofile.el
</pre>

<p>
So we can see all the links this way, and we will have to differentiate what kind of links they are. What needs to happen when exporting is that the files we want to refer to in the post must be copied to the media folder of the blog, and a url to that file needs to be put in the exported html in the place of the link. We are going to try the following strategy:
</p>

<ol class="org-ol">
<li>Parse the org-file.
</li>
<li>For each file link we will copy the file to the blogofile media folder and make a list of URLS for each link
</li>
<li>Write a link filter that gets the nth value of our list of urls and replace the link text with a url to the file. If the link had any content, use that for the URL text.
</li>
</ol>


<p>
Ok. Now let us write a block of code that does all those things. I want to avoid overwriting files with the same name from other posts, so we will copy all these files to a directory based on the blog post title: "Changing-links-to-files-so-they work-in-a-blog". We construct URLS for each link type that we want and store them in a list in the variable <code>url-list</code>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq url-list (<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
                     (counter 0))
                 (org-element-map parsetree 'link
                   (<span style="color: #8b0000;">lambda</span> (link) 
                     (<span style="color: #8b0000;">let*</span> ((type (nth 0 link))
                            (plist (nth 1 link))
                            (content (nth 2 link))
                            (path (plist-get plist <span style="color: #cd0000;">:path</span>))
                            (type (plist-get plist '<span style="color: #cd0000;">:type</span>))
                            (fname (car (last (split-string path <span style="color: #228b22;">"/"</span>))))
                            )
                       <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">make directory if it does not exist</span>
                       (make-directory <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog"</span> t)
                       (<span style="color: #8b0000;">cond</span>
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">image</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>)
                              (string-match <span style="color: #228b22;">"png"</span> (file-name-extension fname))) 
                         (<span style="color: #8b0000;">progn</span> 
                           (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                           (format <span style="color: #228b22;">"&lt;img src=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;"</span> fname)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>)  content)
                         (<span style="color: #8b0000;">progn</span> (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                                (format <span style="color: #228b22;">"&lt;a href=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;%s&lt;/a&gt;"</span> fname content)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with no content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>))
                         (<span style="color: #8b0000;">progn</span> (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                                (format <span style="color: #228b22;">"&lt;a href=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;%s&lt;/a&gt;"</span> fname fname)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">URLS</span>
                        ((string-match <span style="color: #228b22;">"http"</span> type) (format <span style="color: #228b22;">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> 
                          (plist-get plist <span style="color: #cd0000;">:raw-link</span>) (plist-get plist <span style="color: #cd0000;">:raw-link</span>)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">all other links will be formatted as &lt;pre&gt; blocks on the raw link</span>
                        (t (format <span style="color: #228b22;">"&lt;pre&gt;%s&lt;/pre&gt;"</span> (plist-get plist <span style="color: #cd0000;">:raw-link</span>)))))))))
(princ url-list)
<span style="color: #ff0000; font-weight: bold;">;</span><span style="color: #ff0000; font-weight: bold;">(princ (org-element-parse-buffer))</span>
</pre>
</div>

<pre class="example">
(&lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;news.org&lt;/a&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;news.org&lt;/a&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;Org-file containing news&lt;/a&gt; &lt;pre&gt;elisp:(princ "test")&lt;/pre&gt; &lt;img src="/media/Changing-links-to-files-so-they work-in-a-blog/tooltip-emacs.png"&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/fabfile.py"&gt;fabfile.py&lt;/a&gt; &lt;a href="http://orgmode.org/worg/exporters/filter-markup.html"&gt;http://orgmode.org/worg/exporters/filter-markup.html&lt;/a&gt; &lt;a href="https://github.com/jkitchin/jmax/blob/prelude/blogofile.el"&gt;https://github.com/jkitchin/jmax/blob/prelude/blogofile.el&lt;/a&gt;)
</pre>

<p>
Now, we are ready to consider the filter. Again, building off of <a href="http://orgmode.org/worg/exporters/filter-markup.html">http://orgmode.org/worg/exporters/filter-markup.html</a>we are going to setup a counter, increment the counter in the filter, and get the nth url from the list we constructed above, and replace the text if the URL is not nil. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((counter 0))

  (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-link</span> (text back-end info)
    (<span style="color: #8b0000;">let</span> ((url (nth counter url-list)))
      (<span style="color: #8b0000;">if</span> (not (string= url <span style="color: #228b22;">"nil"</span>)) (setq output   (format <span style="color: #228b22;">"%s"</span> url))
        (setq output (format <span style="color: #228b22;">"%s"</span> text)))
      (setq counter (+ counter 1))
      output))

  (<span style="color: #8b0000;">let</span> ((org-export-filter-link-functions '(ox-mrkup-filter-link))
        (async nil)
        (subtreep nil)
        (visible-only nil)
        (body-only t)
        (ext-plist '()))
    (org-html-export-as-html async subtreep visible-only body-only ext-plist))

    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">now get the output into the org output</span>
    (switch-to-buffer <span style="color: #228b22;">"*Org HTML Export*"</span>)

    (setq HTML (buffer-string))
    (setq YAML <span style="color: #228b22;">"---</span>
<span style="color: #228b22;">title: Changing links to files so they work in a blog</span>
<span style="color: #228b22;">date: 2013/09/28 17:49:00</span>
<span style="color: #228b22;">updated: 2013/09/29 08:14:00</span>
<span style="color: #228b22;">categories: org-mode</span>
<span style="color: #228b22;">---</span>



<span style="color: #228b22;">"</span>)
  (<span style="color: #8b0000;">with-temp-buffer</span>
(insert YAML)
(insert HTML)
(write-region (point-min) (point-max) <span style="color: #228b22;">"../_posts/2013-09-28-Changing-links-to-files-so-they-work-in-a-blog.html"</span>)))
(princ <span style="color: #228b22;">"Done."</span>)
</pre>
</div>

<pre class="example">
Done.
</pre>

<p>
You can see from this that we were able to process the org-buffer to get all the links, identify which of those links were external files that were not images (png files), and copy those files to our blog directory. Finally, we used a filter to modify the link text to point towards the blog url for publishing to HTML. I don't have this fully automated in <a href="https://github.com/jkitchin/jmax/blob/prelude/blogofile.el">https://github.com/jkitchin/jmax/blob/prelude/blogofile.el</a>, but now all the pieces are done to enable that one day!
</p>
</div>
</div>
</div>


    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_url = "http://jkitchin.github.io/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog";
</script>
<script type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/embed.js"></script>
<noscript><a href="http://kitchinresearchgroup.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp/">A partial symbolic numeric solver in emacs-lisp</a></li>
      <li><a href="/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL/">A new and improved Emacs gnuplot DSL</a></li>
      <li><a href="/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/">An emacs-lisp dsl for gnuplot</a></li>
      <li><a href="/blog/2017/04/30/Emulating-Sparql-queries-in-emacs-lisp-with-pattern-matching/">Emulating Sparql queries in emacs-lisp with pattern matching</a></li>
      <li><a href="/blog/2017/04/16/A-callable-plist-data-structure-for-Emacs/">A callable plist data structure for Emacs</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2017
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



