

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Org-mode-and-ipython-enhancements-in-scimax"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax/" rel="bookmark" title="Permanent Link to Org-mode and ipython enhancements in scimax">Org-mode and ipython enhancements in scimax</a></h2>
      <p><small><span class="blog_post_date">Posted May 26, 2017 at 04:54 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/ipython/'>ipython</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org696d7c2">1. Some convenience functions</a></li>
<li><a href="#orgef414e8">2. ob-ipython-inspect works</a></li>
<li><a href="#orgd62ef75">3. Getting selective output from Ipython</a></li>
<li><a href="#org5cac271">4. Where was that error?</a></li>
<li><a href="#org3ebd0a8">5. Asynchronous Ipython</a></li>
</ul>
</div>
</div>
<p>
We have made some improvements to using Ipython in org-mode in the past including:
</p>

<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/29/ob-ipython-and-inline-figures-in-org-mode/">Inline figures</a></li>
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/21/Exporting-org-mode-to-Jupyter-notebooks/">Export to Jupyter notebooks</a></li>
</ol>

<p>
Today I will talk about a few new features and improvements I have introduced to scimax for using org-mode and Ipython together.
</p>

<p>
The video for this post might be more obvious than the post:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/dMira3QsUdg" frameborder="0" allowfullscreen></iframe>

<div id="outline-container-org696d7c2" class="outline-2">
<h2 id="org696d7c2"><span class="section-number-2">1</span> Some convenience functions</h2>
<div class="outline-text-2" id="text-1">
<p>
There are a few nice shortcuts in the Jupyter notebook. Now we have some convenient commands in scimax to mimic those. My favorites are adding cells above or below the current cell. You can insert a new src block above the current one with (M-x <code>org-babel-insert-block</code>). You can use a prefix arg to insert it below the current block.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">code</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">below</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">some code</span>
</pre>
</div>

<p>
I am particularly fond of splitting a large block into two smaller blocks. Use (M-x <code>org-babel-split-src-block</code>) to do that and leave the point in the upper block. Use a prefix arg to leave the point in the lower block.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">lots of code in large block</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Even more code</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The end of the long block</span>
</pre>
</div>

<p>
You can execute all the blocks up to the current point with (M-x <code>org-babel-execute-to-point</code>).
</p>
</div>
</div>

<div id="outline-container-orgef414e8" class="outline-2">
<h2 id="orgef414e8"><span class="section-number-2">2</span> ob-ipython-inspect works</h2>
<div class="outline-text-2" id="text-2">
<p>
In the original ob-ipython I found that ob-ipython-inspect did not work unless you were in special edit mode. That is too inconvenient. I modified a few functions to work directly from the org-buffer. I bind this to M-. in org-mode.
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Compute areas and colors</span>
<span style="color: #BA36A5;">N</span> = 150
<span style="color: #BA36A5;">r</span> = 2 * np.random.rand(N)
<span style="color: #BA36A5;">theta</span> = 2 * np.pi * np.random.rand(N)
<span style="color: #BA36A5;">area</span> = 200 * r**2
<span style="color: #BA36A5;">colors</span> = theta

<span style="color: #BA36A5;">ax</span> = plt.subplot(111, projection=<span style="color: #008000;">'polar'</span>)
<span style="color: #BA36A5;">c</span> = ax.scatter(theta, r, c=colors, s=area, cmap=<span style="color: #008000;">'hsv'</span>, alpha=0.75)
</pre>
</div>

<p>

</p>

<p>
&lt;matplotlib.figure.Figure at 0x114ded710&gt;
<img src="/media/ob-ipython-1758dfdd7a96829c50791c7cc9a39f3a.png"> 
</p>
</div>
</div>



<div id="outline-container-orgd62ef75" class="outline-2">
<h2 id="orgd62ef75"><span class="section-number-2">3</span> Getting selective output from Ipython</h2>
<div class="outline-text-2" id="text-3">
<p>
Out of the box Ipython returns a lot of results. This block, for example returns a plain text, image and latex result as output.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> sympy <span style="color: #0000FF;">import</span> *
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">commenting out init_printing() results in no output</span>
init_printing()

var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>

</p>

<p>
 2
x  + y
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
We can select which one we want with a new header argument :ob-ipython-results. For this block you can give it the value of text/plain, text/latex or image/png.
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
 2
x  + y
</p>

<p>
Or to get the image:
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
This shows up with <a href="https://emacs.stackexchange.com/questions/33005/python-org-mode-babel-output-column-headers-misaligned/33016#33016">pandas too</a>. This block creates a table of data and then shows the first 5 rows. Ipython returns both plain text and html here.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>

</p>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      10    1  64.311947     0        8  False   False   8.036793
1          1       6    0  82.951484     1       73   True   False   7.996024
2          2      27    1  53.064501     3       95  False   False   9.015144
3          3      37    0  64.799128     0       93  False   False  10.099032
4          4      46    0  99.111394     2       25  False   False  11.711427
</p>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientid</th>
      <th>hospid</th>
      <th>sex</th>
      <th>age</th>
      <th>race</th>
      <th>cptCode</th>
      <th>rdm30d</th>
      <th>mort30d</th>
      <th>los</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>10</td>
      <td>1</td>
      <td>64.311947</td>
      <td>0</td>
      <td>8</td>
      <td>False</td>
      <td>False</td>
      <td>8.036793</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>82.951484</td>
      <td>1</td>
      <td>73</td>
      <td>True</td>
      <td>False</td>
      <td>7.996024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>27</td>
      <td>1</td>
      <td>53.064501</td>
      <td>3</td>
      <td>95</td>
      <td>False</td>
      <td>False</td>
      <td>9.015144</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>37</td>
      <td>0</td>
      <td>64.799128</td>
      <td>0</td>
      <td>93</td>
      <td>False</td>
      <td>False</td>
      <td>10.099032</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>46</td>
      <td>0</td>
      <td>99.111394</td>
      <td>2</td>
      <td>25</td>
      <td>False</td>
      <td>False</td>
      <td>11.711427</td>
    </tr>
  </tbody>
</table>
</div>


<p>
We can use the header to select only the plain text output!
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      21    0  73.633836     1       38  False   False   7.144019
1          1      16    1  67.518804     3       23  False   False   3.340534
2          2      15    0  44.139033     0        8  False   False   9.258706
3          3      29    1  45.510276     2        5  False   False  10.590245
4          4       7    0  52.974924     2        4  False    True   5.811064
</p>
</div>
</div>

<div id="outline-container-org5cac271" class="outline-2">
<h2 id="org5cac271"><span class="section-number-2">4</span> Where was that error?</h2>
<div class="outline-text-2" id="text-4">
<p>
A somewhat annoying feature of running cells in org-mode is when there is an exception there has not been a good way to jump to the line that caused the error to edit it. The lines in the src block are not numbered, so in a large block it can be tedious to find the line. In scimax, when you get an exception it will number the lines in the src block, and when you press q in the exception traceback buffer it will jump to the line in the block where the error occurred.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">print</span>(1)
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">raise Exception('Here')</span>
<span style="color: #0000FF;">print</span>(2)
</pre>
</div>

<p>
1
2
</p>



<p>
If you don't like the numbers add this to your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> ob-ipython-number-on-exception nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ebd0a8" class="outline-2">
<h2 id="org3ebd0a8"><span class="section-number-2">5</span> Asynchronous Ipython</h2>
<div class="outline-text-2" id="text-5">
<p>
I have made a few improvements to the asynchronous workflow in Ipython. We now have a calculation queue, so you can use C-c C-c to execute several blocks in a row, and they will run asynchronously in the order you ran them. While they are running you can continue using Emacs, e.g. writing that paper, reading email, checking RSS feeds, tetris, &#x2026; This also lets you run all the blocks up to the current point (M-x <code>org-babel-execute-ipython-buffer-to-point-async</code>) or the whole buffer (of Ipython) blocks asynchronously (M-x <code>org-babel-execute-ipython-buffer-async</code>).
</p>

<p>
To turn this on by default put this in your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> org-babel-async-ipython t)
</pre>
</div>

<p>
This requires all src blocks to have a name, and running the block will give it a name if you have not named the block. By default we use human-readable names. While the block is running, there will be a link indicating it is running. You can click on the link to cancel it. Running subsequent blocks will queue them to be run when the first block is done.
</p>

<p>
Here is an example:
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="orgb3ddac3"><span style="color: #0000FF;">import</span> time
time.sleep(5)
<span style="color: #BA36A5;">a</span> = 5
<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'done'</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython" id="org5b7e30b"><span style="color: #0000FF;">print</span>(3 * a)
</pre>
</div>

<p>
15
</p>




<p>
Occasionally you will run into an issue. You can clear the queue with <code>org-babel-async-ipython-clear-queue</code>.</p>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-partial-symbolic-numeric-solver-in-emacs-lisp"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp/" rel="bookmark" title="Permanent Link to A partial symbolic numeric solver in emacs-lisp">A partial symbolic numeric solver in emacs-lisp</a></h2>
      <p><small><span class="blog_post_date">Posted May 21, 2017 at 11:33 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/math/'>math</a>, <a href='/blog/category/emacs-lisp/'>emacs-lisp</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org18a4554">1. The Newton solver in emacs-lisp</a></li>
</ul>
</div>
</div>
<p>
I have been exploring  ways to use emacs-lisp to express scientific ideas. In this post, we explore a partial symbolic numeric solver in Emacs-lisp. This involves some syntactic developments to more clearly identify something we want to solve for and to then generate the code required to solve it.
</p>

<p>
In section <a href="#org18a4554">The Newton solver</a> you can find a simple implementation of a Newton solver in emacs-lisp. This function allows you to numerically solve equations that can be written in the form \(f(x) = 0\) for \(x\) given an initial guess. You write a function for \(f(x)\) and pass the function to the solver. This is a standard approach used in Python with fsolve, for example. Here is an example of solving a trivial problem: \(x - 4 = 0\) just to check that it works. We use a lambda function for \(f(x) = x - 4 = 0\). The answer is \(x=4\).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(newton-f (<span style="color: #0000FF;">lambda</span> (x) (- x 4)) 2)
</pre>
</div>

<p>
That syntax is not too bad, but we have the whole lambda expression in there, and some repetition of what we want to solve for as an argument and in the function. It would be interesting if we could just have an expression that gets solved, e.g. <code>(newton-f (- x? 4) 2)</code> where <code>x?</code> indicates the thing to solve for.
</p>

<p>
We can do that! We can take an expression, flatten it and find the variable names that end with ?. We should check that there is only one, but for now we don't. Here is an example that does that. I use a nested expression here just to illustrate that the code finds the <code>x?</code> variable correctly.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">dash</span>)

(<span style="color: #0000FF;">let</span> ((body '((* (- x? 4) 1))))
  (<span style="color: #0000FF;">loop</span> for item in (-flatten body)
        if (<span style="color: #0000FF;">and</span> (symbolp item) (s-ends-with? <span style="color: #008000;">"?"</span> (symbol-name item)))
        collect item))
</pre>
</div>

<p>
So, given an expression we can identify the unknown that should be the argument to a lambda function. So, we create a macro that takes that expression and constructs a function to solve it, then calls newton-f on it. The macro is syntactically useful here because we do not have to quote the expression. Here is that macro.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">solve</span> (expression guess)
  `(newton-f
    (<span style="color: #0000FF;">lambda</span> ,(<span style="color: #0000FF;">loop</span> for item in (-flatten expression)
                   if (<span style="color: #0000FF;">and</span> (symbolp item) (s-ends-with? <span style="color: #008000;">"?"</span> (symbol-name item)))
                   collect item)
      ,expression)
    ,guess))
</pre>
</div>

<p>
I call this a partial symbolic solver because we do some introspection symbolically to identify what to solve for, and then construct the code required to solve it. Here is that trivial example (x? - 4 = 0). It just shows we can have some nesting and it still works. I am not so thrilled with the initial guess, but this is an iterative solver, so you either need an initial guess, or a solution range.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">solve</span> (* (- x? 4) 1) 3)
</pre>
</div>

<p>
Here is what that expands into:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(macroexpand '(solve (* (- x? 4) 1) 3))
</pre>
</div>

<p>
It expands into what we would have written in the first place. The benefit to us is less typing, and a simpler syntax. Both of those reduce the opportunity to make errors!
</p>

<p>
A more realistic problem might be: Reactant A flows into a continuously stirred tank reactor at a rate of  \(F_{A0} = 1\) mol/min with a volumetric flow of \(v_0 = 1\) L/min.. The reactor achieves 50% conversion (\(X\)) of A to products. The reaction rate law is known to be \(-r_A = k C_A\) with \(k = 0.1\) 1/min. Estimate the volume of the reactor. If you have taken my class in reaction engineering, you know the following facts:
</p>

<ul class="org-ul">
<li>The exit molar flow is defined by \(F_A = F_{A0} (1 - X)\)</li>
<li>The exit concentration is \(C_A = F_A / v_0\)</li>
<li>The mole balance is defined by \(0 = F_{A0} - F_A + r_A V\)</li>
</ul>

<p>
That is all we need; we can solve for \(V\) from the last equation. This is simple enough you might do the algebra to get: \(V = \frac{F_{A0} - F_A}{-r_A}\) which can be simply evaluated. We use our solver here and compare it to the evaluation.
</p>

<p>
Here is the solver:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let*</span> ((Fa0 1)
       (X 0.5)
       (Fa (* Fa0 (- 1 X)))
       (k 0.1)
       (v0 1)
       (Ca (/ Fa v0))
       (r (* k Ca))
       (ra (* r -1)))
  (<span style="color: #0000FF;">solve</span> (+ Fa0 (* Fa -1) (* ra V?)) 2))
</pre>
</div>

<p>
It is pretty hard to imagine doing something like this in Python! It would probably involve parsing a string.
</p>

<p>
Here is the evaluation from our algebra:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let*</span> ((Fa0 1)
       (X 0.5)
       (Fa (* Fa0 (- 1 X)))
       (k 0.1)
       (v0 1)
       (Ca (/ Fa v0))
       (r (* k Ca))
       (ra (* r -1)))
  (/ (- Fa0 Fa) (* -1 ra)))
</pre>
</div>

<p>
Within the tolerance specified in <code>newton-f</code>, these are the same.
</p>

<p>
This is just the tip of the iceberg though. You may have noticed that none of the variables in the let* had any descriptions. Sure, you could put some comments after them, but those are not really part of the code.
</p>

<p>
Also, we had to define the variables in advance of the expression. That is a limitation of how computers work, they cannot evaluate undefined variables. It <i>constrains</i> how we can express the idea. What if we could instead specify the equation first, then the data? That way we are clear what we are trying to do at a higher level, and fill in the details later. Suppose we wanted a syntax like the block below instead. Here we emphasize the equation we are solving first, and then define the variables and quantities used in the equation, and finally the guess that we use to find the solution.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">solve1</span>
 (eqn (+ Fa0 (* -1 Fa) (* ra V?)))
 (data ((k 0.1 <span style="color: #008000;">"rate constant 1/min"</span>)
        (Ca0 1.0 <span style="color: #008000;">"feed concentration"</span>)
        (v0 1 <span style="color: #008000;">"volumetric flow L/min"</span>)
        (Fa0 (* v0 Ca0) <span style="color: #008000;">"Inlet molar flow"</span>)
        (X 0.5 <span style="color: #008000;">"Desired conversion"</span>)
        (Fa (* Fa0 (- 1 X)) <span style="color: #008000;">"Exit molar flow"</span>)
        (Ca (/ Fa v0) <span style="color: #008000;">"exit concentration"</span>)
        (ra (* -1 k Ca) <span style="color: #008000;">"rate in the reactor"</span>)))
 (guess 8))
</pre>
</div>

<p>
That is achievable with the solve1 macro below! It too has some limitations, mostly the order of the data block still has to be correct, e.g. you cannot use a variable before it is defined. It would take some serious macro-fu to sort these so that everything is defined in the right order! Still, it allows you to express an <i>executable</i> idea in the order we defined. The strings in this syntax for documenting the variables are ignored, but they could be used in the macro to print useful information or something else you could imagine. You could also make them mandatory to encourage documentation.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">solve1</span> (<span style="color: #6434A3;">&amp;rest</span> body)
  (<span style="color: #0000FF;">let</span> ((expression (second (assoc 'eqn body)))
        (data (<span style="color: #0000FF;">loop</span> for d in (second (assoc 'data body))
                    collect (list (first d) (second d))))
        (guess (second (assoc 'guess body))))
    `(<span style="color: #0000FF;">let*</span> ,data
       (newton-f
        (<span style="color: #0000FF;">lambda</span> ,(<span style="color: #0000FF;">loop</span> for item in (-flatten expression)
                       if (<span style="color: #0000FF;">and</span> (symbolp item) (s-ends-with? <span style="color: #008000;">"?"</span> (symbol-name item)))
                       collect item)
          ,expression)
        ,guess))))
</pre>
</div>

<p>
To summarize, lisp macros allow us to rewrite the syntax of code before it is evaluated. This gives us the opportunity to inspect it, and generate new code, e.g. functions with arguments based on the contents of expressions, to save us typing. It also allows us to define ideas in a near arbitrary order that make sense to us, and then rearrange them so they make sense to the computer. See, for example,  <a href="http://kitchingroup.cheme.cmu.edu/blog/2017/03/22/A-better-defun-for-emacs-lisp/">this post</a> for an example of changing how functions are defined.
</p>

<p>
This seems to be heading in the domain specific language direction. I think it would be very helpful in engineering problem solving to build up tools like this. They could start out simple for new students to use. They never need to see the macro parts of this, just to learn how to use them for problem solving. These beginner tools would be limited in what they could do to minimize how much lisp is required to be learned so students can focus on the problem solving. Eventually they might outgrow them, and in the process transition to having the full lisp language at their disposal for problem solving.
</p>


<div id="outline-container-org18a4554" class="outline-2">
<h2 id="org18a4554"><a id="ID-53A5F60F-F929-43BB-AD9D-167D6EBEB8EB"></a><span class="section-number-2">1</span> The Newton solver in emacs-lisp</h2>
<div class="outline-text-2" id="text-1">
<p>
This is an emacs-lisp implementation of Newton's method. It is a simple implementation for a single variable. The tolerance and step-size are hard-coded for this post because we focus on the partial symbolic solver, not the best solver methods.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">See https://en.wikipedia.org/wiki/Newton%27s_method for the method</span>

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">newton-f</span> (func x0)
  <span style="color: #036A07;">"Solve the equation FUNC(x)=0 using Newton's method.</span>
<span style="color: #036A07;">X0 is an initial guess."</span>
  (<span style="color: #0000FF;">let*</span> ((tolerance 1e-6)
         (x x0)
         (dx 1e-6)
         fx fpx)
    (<span style="color: #0000FF;">while</span> (&gt; (abs (funcall func x)) tolerance)
      (<span style="color: #0000FF;">setq</span> fx (funcall func x)
            fpx (/ (- (funcall func (+ x dx)) (funcall func (- x dx))) (* 2 dx))
            x (- x (/ fx fpx))))
    x))
</pre>
</div>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-new-and-improved-Emacs-gnuplot-DSL"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL/" rel="bookmark" title="Permanent Link to A new and improved Emacs gnuplot DSL">A new and improved Emacs gnuplot DSL</a></h2>
      <p><small><span class="blog_post_date">Posted May 05, 2017 at 10:26 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/lisp/'>lisp</a>, <a href='/blog/category/plotting/'>plotting</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated February 04, 2018 at 05:07 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
A significant limitation of the	<a href="http://kitchingroup.cheme.cmu.edu/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/">previous</a> DSL I wrote is that all the plotting commands have to go in one macro. It would be nice to accumulate them in different forms, and when you want to run them all. A classic way to do that in Emacs lisp is to make a global variable, e.g. <code>*gnuplot-cmds*</code> and append commands to it. Then when you want to, run the commands.
</p>

<p>
A more modern approach is to use a closure to encapsulate the commands. Here is a <a href="http://letoverlambda.com">"let over lambda"</a> that defines a few functions that encapsulate an enclosed variable gnuplot-commands. We define one function to add commands to the list of commands, one to clear the commands, one to generate the gnuplot script as a string, and one to run the program. The enclosed variable <code>gnuplot-commands</code> is basically only accessible by these functions. It is encapsulated, similar to if we defined a class in Python then made an instance of it with an attribute that was accessible only be instance methods. On one hand, this "protects" the variable, and keeps it out of the global namespace. On the other hand, we lose the documentation that would have come with a defvar, and we have to define a function to access the contents of that variable.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((gnuplot-commands '(<span style="color: #008000;">"set terminal qt"</span>)))

  (<span style="color: #0000FF;">defun</span> <span style="color: #006699;">gnuplot-add-cmd</span> (s)
    <span style="color: #036A07;">"Append the command S to gnuplot-cmds."</span>
    (<span style="color: #0000FF;">setq</span> gnuplot-commands (append gnuplot-commands (list s))))

  (<span style="color: #0000FF;">defun</span> <span style="color: #006699;">gnuplot-clear</span> ()
    (<span style="color: #0000FF;">setq</span> gnuplot-commands '(<span style="color: #008000;">"set terminal qt"</span>)))

  (<span style="color: #0000FF;">defun</span> <span style="color: #006699;">gnuplot-script</span> ()
    (s-join <span style="color: #008000;">"\n"</span> gnuplot-commands)))
</pre>
</div>

<pre class="example">
gnuplot-script

</pre>

<p>
To run the commands, we define this function. It does not need to be in the closure because it only accesses the commands through functions we defined in the closure.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">gnuplot-show</span> ()
    (<span style="color: #0000FF;">let*</span> ((temporary-file-directory <span style="color: #008000;">"."</span>)
           (cmdfile (make-temp-file <span style="color: #008000;">"gnuplot-cmds-"</span> nil <span style="color: #008000;">".gpl"</span>))
           (shellcmd (format <span style="color: #008000;">"gnuplot --persist -c \"%s\""</span> cmdfile))
           (cmds (gnuplot-script)))
      (<span style="color: #0000FF;">with-temp-file</span> cmdfile
        (insert cmds))
      (shell-command shellcmd)
      (delete-file cmdfile)
      cmds))
</pre>
</div>

<pre class="example">
gnuplot-show

</pre>

<p>
Last time I noted I had a new idea for the DSL syntax that would give us more flexibility to inject variables and code into the DSL. The idea is to use keywords, symbols that start with :, to indicate they should be replaced by the value of the non-keyword symbol in the environment, and for any form that starts with : to evaluate that form. So, (: - 5 4) would get replaced by 1. Here is the new macro for that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">kargs</span> (<span style="color: #6434A3;">&amp;rest</span> args)
  <span style="color: #036A07;">"Convert symbols to strings, quote strings, and (expr) to what they evaluate to."</span>
  `(s-join <span style="color: #008000;">" "</span> (list ,@(cl-mapcan
                        (<span style="color: #0000FF;">lambda</span> (s)
                          (list
                           (<span style="color: #0000FF;">cond</span>
                            ((keywordp s)
                             (format <span style="color: #008000;">"%s"</span>
                                     (symbol-value (intern (substring (symbol-name s) 1)))))
                            ((symbolp s)
                             (symbol-name s))
                            ((stringp s)
                             (format <span style="color: #008000;">"\"%s\""</span> s))
                            ((<span style="color: #0000FF;">and</span> (listp s) (eq : (car s)))
                             `(<span style="color: #0000FF;">with-output-to-string</span>
                                (princ ,(cdr s))))
                            (t
                             (format <span style="color: #008000;">"%s"</span> s)))))
                        args))))
</pre>
</div>

<pre class="example">
kargs

</pre>

<p>
Now, our gnuplot macro is simpler, since all it does is add commands to the list. If the form is a string, we add it as is, if the form starts with (: stuff) we evaluate the cdr of the form, and otherwise, we pass the form contents to the kargs macro for processing.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">gnuplot</span> (<span style="color: #6434A3;">&amp;rest</span> forms)
  `(<span style="color: #0000FF;">loop</span> for s in (list ,@(mapcar (<span style="color: #0000FF;">lambda</span> (x)
                                    (<span style="color: #0000FF;">cond</span>
                                     ((stringp x)
                                      x)
                                     ((<span style="color: #0000FF;">and</span> (listp x) (eq : (car x)))
                                      `,(cdr x))
                                     (t
                                      `(kargs ,@x))))
                                  forms))
         do (gnuplot-add-cmd s)))
</pre>
</div>

<pre class="example">
gnuplot

</pre>

<p>
What did that gain us? First, we can break up a script so we can talk about it, maybe do some calculations, etc&#x2026; Let's look at the example at <a href="http://gnuplot.sourceforge.net/demo/linkedaxes.html">http://gnuplot.sourceforge.net/demo/linkedaxes.html</a>.
</p>

<p>
We can start with the basic settings.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(gnuplot-clear)

(gnuplot
 (set terminal png)
 (set output <span style="color: #008000;">"linkedaxes.png"</span>)
 (set encoding utf8)
 (set key outside Left)
 (set bmargin 5)
 (set tmargin 6)
 (set style data lines)
 (set tics in)
 (set ticslevel 0.5)
 (set xlabel  <span style="color: #008000;">"X-ray energy in eV"</span>)

 (set format y  \'%5.1fe\')
 (set title <span style="color: #008000;">" Anomalous scattering factors "</span>)
 (set xrange  [9000:14400])
 (set offset 0\,0\,1.0\,0)
 (set xtics nomirror)
 (set link x via 12398./x inverse 12398./x)

 (set x2label  <span style="color: #008000;">"X-ray wavelength in &#197;"</span>)
 (set x2tics 0.1  format <span style="color: #008000;">"%.1f &#197;"</span> nomirror))
</pre>
</div>

<p>
We need to download some data files. We can do that, and add another line to the gnuplot script. The escaping on the quotes and commas is especially tedious in this one ;) but, we don't need those pesky line-continuations here.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(shell-command <span style="color: #008000;">"wget http://www.bmsc.washington.edu/scatter/data/Br.dat"</span>)
(shell-command <span style="color: #008000;">"wget http://www.bmsc.washington.edu/scatter/data/Ta.dat"</span>)


(gnuplot
 (plot <span style="color: #008000;">"Br.dat"</span> volatile using 1:3 title \'Br f\"\'  lt 1 lw 3\, \'\' volatile using 1:2 title <span style="color: #008000;">"Br f'"</span>  lt 1 lw 1\,
       <span style="color: #008000;">"Ta.dat"</span> volatile using 1:3 title \'Ta f\"\' lt 2 lw 3\, \'\' volatile using 1:2 title \"Ta f\'\"  lt 2 lw 1))

(gnuplot-script)
</pre>
</div>

<pre class="example">
set terminal qt
set terminal png
set output "linkedaxes.png"
set encoding utf8
set key outside Left
set bmargin 5
set tmargin 6
set style data lines
set tics in
set ticslevel 0.5
set xlabel "X-ray energy in eV"
set format y '%5.1fe'
set title " Anomalous scattering factors "
set xrange [9000:14400]
set offset 0,0,1.0,0
set xtics nomirror
set link x via 12398./x inverse 12398./x
set x2label "X-ray wavelength in Å"
set x2tics 0.1 format "%.1f Å" nomirror
plot "Br.dat" volatile using 1:3 title 'Br f"' lt 1 lw 3, '' volatile using 1:2 title "Br f'" lt 1 lw 1, "Ta.dat" volatile using 1:3 title 'Ta f"' lt 2 lw 3, '' volatile using 1:2 title "Ta f'" lt 2 lw 1
</pre>

<p>
Finally, we can set the output to png, and run our program.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(gnuplot-show)
</pre>
</div>

<p>
Looks good.
</p>



<p>
<img src="/media/linkedaxes.png"> 
</p>

<p>
What about the fancy keyword formatting? Here is an example of that in action. :term gets replaced by the term variable, :png gets replaced by the filename, and :x is replaced by 4.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(gnuplot-clear)
(<span style="color: #0000FF;">let</span> ((x 4)
      (term <span style="color: #008000;">"png"</span>)
      (png <span style="color: #008000;">"\"polar.png\""</span>))
  (gnuplot
   (set terminal <span style="color: #006FE0;">:term</span>)
   (set output <span style="color: #006FE0;">:png</span>)
   (set polar)
   (set dummy t)
   (plot sin\( <span style="color: #006FE0;">:x</span> *t\) \,cos\( <span style="color: #006FE0;">:x</span> *t\))
   (set offset 0\,0\,0\,0)))

(gnuplot-show)
</pre>
</div>

<pre class="example">
set terminal qt
set terminal png
set output "polar.png"
set polar
set dummy t
plot sin( 4 *t) ,cos( 4 *t)
set offset 0,0,0,0

</pre>

<p>
<img src="/media/polar.png"> 
</p>

<p>
There are a few nuances I didn't expect. First, you have to escape the parentheses in this case because otherwise it looks like a form that will be ignored. Second, you have to quote the string to get quotes into the gnuplot script. Third, there has to be a space before and after the keywords for emacs to parse it correctly and do the substitution.
</p>

<p>
Let's look at one last example that uses the (: form). We reproduce a figure from <a href="http://gnuplot.sourceforge.net/demo/transparent_solids.html">http://gnuplot.sourceforge.net/demo/transparent_solids.html</a> here.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(gnuplot-clear)
(gnuplot
 (set terminal pngcairo  background <span style="color: #008000;">"#ffffff"</span> enhanced font <span style="color: #008000;">"arial,9"</span> fontscale 1.0 size 512\, 384 )
 (set output <span style="color: #008000;">"transparent-solids.png"</span>)
 <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">construct the title</span>
 (set title (: format <span style="color: #008000;">"\"%s\""</span> (concat <span style="color: #008000;">"Interlocking Tori - PM3D surface"</span> <span style="color: #008000;">"with depth sorting and transparency"</span>)))

 <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">use lisp code to create a gnuplot command</span>
 (: concat <span style="color: #008000;">"unset"</span> <span style="color: #008000;">" "</span> <span style="color: #008000;">"border"</span>)

 (unset key)
 (set object 1 rect from screen 0\, 0\, 0 to screen 1\, 1\, 0 behind)
 (set object 1 rect fc  rgb \"gray\"  fillstyle solid 1.0  border -1)
 (set view 64\, 345\, 1.24375\, 0.995902)
 (set isosamples 50\, 20)
 (unset xtics)
 (unset ytics)
 (unset ztics)
 (set dummy u\,v)
 (set parametric)
 (set urange [ -pi : pi ])
 (set vrange [ -pi : pi ])

 (set style fill  transparent solid 0.30 border)
 (set pm3d depthorder)
 (set palette rgbformulae 8\, 9\, 7)
 (set pm3d interpolate 1\,1 flush begin noftriangles border lt black linewidth 0.500 dashtype solid corners2color mean)
 (set colorbox vertical origin screen 0.9\, 0.2\, 0 size screen 0.05\, 0.6\, 0 front  noinvert bdefault)

 (splot (: concat <span style="color: #008000;">"cos(u)+.5*cos(u)*cos(v),sin(u)+.5*sin(u)*cos(v),.5*sin(v) with pm3d,"</span>
           <span style="color: #008000;">"1+cos(u)+.5*cos(u)*cos(v),.5*sin(v),sin(u)+.5*sin(u)*cos(v) with pm3d"</span>)))
(gnuplot-show)
</pre>
</div>

<pre class="example">
set terminal qt
set terminal pngcairo background "#ffffff" enhanced font "arial,9" fontscale 1.0 size 512, 384
set output "transparent-solids.png"
set title "Interlocking Tori - PM3D surfacewith depth sorting and transparency"
unset border
unset key
set object 1 rect from screen 0, 0, 0 to screen 1, 1, 0 behind
set object 1 rect fc rgb "gray" fillstyle solid 1.0 border -1
set view 64, 345, 1.24375, 0.995902
set isosamples 50, 20
unset xtics
unset ytics
unset ztics
set dummy u,v
set parametric
set urange [-pi : pi]
set vrange [-pi : pi]
set style fill transparent solid 0.3 border
set pm3d depthorder
set palette rgbformulae 8, 9, 7
set pm3d interpolate 1,1 flush begin noftriangles border lt black linewidth 0.5 dashtype solid corners2color mean
set colorbox vertical origin screen 0.9, 0.2, 0 size screen 0.05, 0.6, 0 front noinvert bdefault
splot cos(u)+.5*cos(u)*cos(v),sin(u)+.5*sin(u)*cos(v),.5*sin(v) with pm3d,1+cos(u)+.5*cos(u)*cos(v),.5*sin(v),sin(u)+.5*sin(u)*cos(v) with pm3d
</pre>


<p>
<img src="/media/transparent-solids.png"> 
</p>

<p>
Overall this seems like an improvement to the DSL. I didn't invent the idea of reusing keywords this way out of the blue. In On Lisp, Paul graham uses "special" variable names in Chapter 18, where he shows how to use gensyms for special purposes, and also variables with special names like ?x. Even Emacs is using a variation of this idea. Check out this <a href="http://endlessparentheses.com/new-on-elpa-and-in-emacs-25-1-let-alist.html">new let-alist</a> macro:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let-alist</span> '((x . 5))
  (+ 1 .x))
</pre>
</div>

<pre class="example">
6

</pre>

<p>
There is a special variable inside the body that is a dot-name. The macro expands to provide a value for that symbol. I wonder if I should have tried to use an approach like this instead. Maybe another day. After I read and study the four defuns and single defmacro that make this possible!
</p>

<p>
You can see here what happens:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(macroexpand '(let-alist '((x . 5))
  (+ 1 .x)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span>
    ((alist
      '((x . 5))))
  (<span style="color: #0000FF;">let</span> ((\.x (cdr (assq 'x alist))))
    (+ 1 \.x)))
</pre>
</div>

<p>
The macro builds up an internal alist for the dot-names.
</p>
<p>Copyright (C) 2018 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL.org">org-mode source</a></p>
<p>Org-mode version = 9.1.6</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="An-emacs-lisp-dsl-for-gnuplot"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/" rel="bookmark" title="Permanent Link to An emacs-lisp dsl for gnuplot">An emacs-lisp dsl for gnuplot</a></h2>
      <p><small><span class="blog_post_date">Posted May 04, 2017 at 07:33 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/lisp/'>lisp</a>, <a href='/blog/category/plotting/'>plotting</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge24f7e9">1. Embedding Python or gnuplot</a></li>
<li><a href="#orgfe7800b">2. An alternative approach using a DSL</a></li>
<li><a href="#orga773a9d">3. Summary</a></li>
</ul>
</div>
</div>
<p>
Plotting is a pretty general feature we need in scientific work. In this post we examine a way we could get at least minimal plotting into Emacs-lisp with as lispy a syntax as reasonable.
</p>

<div id="outline-container-orge24f7e9" class="outline-2">
<h2 id="orge24f7e9"><span class="section-number-2">1</span> Embedding Python or gnuplot</h2>
<div class="outline-text-2" id="text-1">
<p>
With org-mode we can fluidly integrate many languages in one document. That is not the goal here, where I want to integrate plotting into a program. You certainly could go this route to embed python programs in your lisp programs for plotting.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">python</span> (code)
  (<span style="color: #0000FF;">let*</span> ((temporary-file-directory <span style="color: #008000;">"."</span>)
        (tmpfile (make-temp-file <span style="color: #008000;">"py-"</span> nil <span style="color: #008000;">".py"</span>)))
    (<span style="color: #0000FF;">with-temp-file</span> tmpfile
      (insert code))
    (shell-command-to-string (format <span style="color: #008000;">"python %s"</span> tmpfile))))
</pre>
</div>

<p>
Here is that function in action.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(python <span style="color: #008000;">"import matplotlib.pyplot as plt</span>
<span style="color: #008000;">import numpy as np</span>
<span style="color: #008000;">x = np.linspace(0, 1)</span>
<span style="color: #008000;">y = np.exp(x)</span>
<span style="color: #008000;">plt.plot(x, y, label='data')</span>
<span style="color: #008000;">plt.title('A Title')</span>
<span style="color: #008000;">plt.xlim([0, 1])</span>
<span style="color: #008000;">plt.ylim([1, 2.75])</span>
<span style="color: #008000;">plt.xlabel('x')</span>
<span style="color: #008000;">plt.ylabel('y')</span>
<span style="color: #008000;">plt.legend()</span>
<span style="color: #008000;">plt.savefig('figpy.png')"</span>)
</pre>
</div>

<p>
And the corresponding figure:
<img src="/media/figpy.png"> 
</p>

<p>
This is irritating for a few reasons. One is it is annoying to write python programs in string form; you don't get much editor support for indentation or syntax highlighting, and you have to be careful with quotes. It is not that easy to switch that snippet to Python mode either. You are pretty limited in writing programs that expand and modify the code too. Basically you have to do that all by string manipulation.
</p>

<p>
Along these lines, you could imagine a gnuplot function. It ends up not being much better.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">gnuplot</span> (cmds)
  (<span style="color: #0000FF;">let*</span> ((temporary-file-directory <span style="color: #008000;">"."</span>)
         (cmdfile (make-temp-file <span style="color: #008000;">"gnuplot-cmds-"</span> nil <span style="color: #008000;">".gpl"</span>))
         (shellcmd (format <span style="color: #008000;">"gnuplot --persist -c \"%s\""</span> cmdfile)))
    (<span style="color: #0000FF;">with-temp-file</span> cmdfile
      (insert cmds))
    (shell-command shellcmd)
    (delete-file cmdfile)))
</pre>
</div>

<p>
You use this the same way.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">gnuplot</span> <span style="color: #008000;">"set title \"Simple Plots\" font \",20\"</span>
<span style="color: #008000;">set key left box</span>
<span style="color: #008000;">set samples 50</span>
<span style="color: #008000;">set style data points</span>
<span style="color: #008000;">set terminal png</span>
<span style="color: #008000;">set output \"gnuplot.png\"</span>

<span style="color: #008000;">plot [-10:10] sin(x),atan(x),cos(atan(x))"</span>)
</pre>
</div>

<p>
<img src="/media/gnuplot.png"> 
</p>

<p>
It has the same limitations as our string-based Python solution. The benefit of them is the native command structure for Python or gnuplot is used, so anything they can do you can too.
</p>
</div>
</div>

<div id="outline-container-orgfe7800b" class="outline-2">
<h2 id="orgfe7800b"><span class="section-number-2">2</span> An alternative approach using a DSL</h2>
<div class="outline-text-2" id="text-2">
<p>
As an alternative, we consider here a domain specific language (DSL) that maps onto gnuplot. Suppose we could do this instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">gnuplot</span>
 (set terminal png)
 (set output <span style="color: #008000;">"test.png"</span>)
 (set title <span style="color: #008000;">"Simple Plots"</span> font <span style="color: #008000;">",20"</span>)
 (set key left box)
 (set samples 50)
 (set style data points)

 (<span style="color: #0000FF;">plot</span> [-10:10] sin\(x\) \,atan\(x\) \,cos\(atan\(x\)\)))
</pre>
</div>

<p>
Here is the figure from that code. The most annoying part of this is in the plot function we have to escape all the parentheses and commas, but otherwise it looks pretty lispy. The output of that program is the gnuplot commands that were generated for making the plot.
<img src="/media/test.png"> 
</p>

<p>
This retains a lot of benefits of programming in lisp. <code>gnuplot</code> has to be a macro though because we do not want to evaluate the s-expressions inside as lisp. For starters they just look lispy, I don't actually use them as lisp at all. Instead we transform them to the gnuplot code.
</p>

<p>
In the following code, I will develop the gnuplot macro. It has some sticky and tricky points, and it is not obvious it will support all the features of gnuplot, but I learned a lot doing it that I will share here.
</p>

<p>
Starting with a simple form inside the macro, I wanted to convert (set output "test.png") to "set output \"test.png\"". For this DSL, I want to treat every symbol in the form as if it should be turned into a string, anything that is a string should be quoted, and anything that is in parentheses (i.e. it passes listp) should be evaluated and converted to a string. Then all those strings should be joined by spaces. Here is a macro that does that (adapted from a solution at <a href="https://emacs.stackexchange.com/questions/32558/eval-some-arguments-in-a-macro/32570?noredirect=1#comment50186_32570">https://emacs.stackexchange.com/questions/32558/eval-some-arguments-in-a-macro/32570?noredirect=1#comment50186_32570</a>).
</p>

<p>
There are a couple of corner cases that are handled here. If the arg is a string, we quote it.  If the arg is not a symbol or string, then it is evaluated and converted to a string. Importantly, this is done in the run environment though, so we can inject variables into the gnuplot code.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">gargs</span> (<span style="color: #6434A3;">&amp;rest</span> args)
  <span style="color: #036A07;">"Convert symbols to strings, quote strings, and (expr) to what they evaluate to."</span>
  `(s-join <span style="color: #008000;">" "</span> (list ,@(cl-mapcan
                        (<span style="color: #0000FF;">lambda</span> (s)
                          (list
                           (<span style="color: #0000FF;">cond</span>
                            ((symbolp s)
                             (symbol-name s))
                            ((stringp s)
                             (format <span style="color: #008000;">"\"%s\""</span> s))
                            (t
                             `(<span style="color: #0000FF;">with-output-to-string</span>
                                (princ ,s))))))
                        args))))
</pre>
</div>

<p>
Here are a few examples of how it works. The loop is just to get a vertical table in org-mode for the blog post.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">loop</span> for s in
      (list (<span style="color: #0000FF;">gargs</span> set key title <span style="color: #008000;">"before fit"</span> size \, (+ 5 5))
            (<span style="color: #0000FF;">gargs</span> set title <span style="color: #008000;">"red"</span>)
            (<span style="color: #0000FF;">gargs</span> set yrange [0:*])
            (<span style="color: #0000FF;">gargs</span> <span style="color: #008000;">"5"</span>)
            (<span style="color: #0000FF;">let</span> ((x 6)) (<span style="color: #0000FF;">gargs</span> (identity x)))
            (<span style="color: #0000FF;">gargs</span> 'x)
            (<span style="color: #0000FF;">gargs</span> '(x))
            (<span style="color: #0000FF;">gargs</span> set label 1 <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n"</span> at graph .95\, graph .92 right))
      collect
      (list s))
</pre>
</div>

<p>
A limitation of this is that we either have quote things like parentheses, commas, semi-colons and sometimes square brackets:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">gargs</span> plot for [n=2:10] sin\(x*n\)/n notitle lw \(13-n\)/2)
</pre>
</div>

<p>
Or we have to use the string form instead; we can always fall back to that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">gargs</span> <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n notitle lw (13-n)/2"</span>)
</pre>
</div>

<p>
The macro above will do the grunt work on each form in the gnuplot macro. Finally, for the gnuplot macro, I want to take all the forms, convert them to gnuplot commands, write them to a temporary file, and then run gnuplot on the file, and finally delete the temp file. I assume we start with a gui terminal so graphs pop up unless you change it in your macro body. Here is that macro. It returns the generated code so it easy to see if you got the right program.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">gnuplot</span> (<span style="color: #6434A3;">&amp;rest</span> forms)
  (<span style="color: #0000FF;">let*</span> ((temporary-file-directory <span style="color: #008000;">"."</span>)
         (cmdfile (make-temp-file <span style="color: #008000;">"gnuplot-cmds-"</span> nil <span style="color: #008000;">".gpl"</span>))
         (shellcmd (format <span style="color: #008000;">"gnuplot --persist -c \"%s\""</span> cmdfile))
         (cmd-string))
    `(<span style="color: #0000FF;">let</span> ((cmd-string (s-join <span style="color: #008000;">"\n"</span> (list ,@(mapcar (<span style="color: #0000FF;">lambda</span> (x)
                                                      (<span style="color: #0000FF;">if</span> (stringp x)
                                                          x
                                                        `(<span style="color: #0000FF;">gargs</span> ,@x)))
                                                    forms)))))
       (<span style="color: #0000FF;">with-temp-file</span> ,cmdfile
         (insert <span style="color: #008000;">"set terminal qt\n"</span>)
         (insert cmd-string)
         (<span style="color: #0000FF;">setq</span> cmd-string (buffer-string)))
       (shell-command ,shellcmd)
       (delete-file ,cmdfile)
       cmd-string)))
</pre>
</div>

<p>
Here is a figure adapted from <a href="http://gnuplot.sourceforge.net/demo/iterate.html">http://gnuplot.sourceforge.net/demo/iterate.html</a>. I use the string form for the last line to avoid escaping all the special characters.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">gnuplot</span>
 (set terminal png)
 (set output <span style="color: #008000;">"iteration.png"</span>)
 (set title <span style="color: #008000;">"Iteration within plot command"</span>)
 (set xrange [0:3])
 (set label 1 <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n"</span> at graph .95\, graph .92 right)
 <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n notitle lw (13-n)/2"</span>)
</pre>
</div>

<p>
Here is the resulting figure.
</p>

<p>
<img src="/media/iteration.png"> 
</p>

<p>
That is overall pretty sweet. There is a little dissonance between the strings, escaped comma, etc.., and it is not terribly ideal for integrating with regular lisp code inside the macro yet. That seems to be a feature of my choice to use (expr) as the syntax to evaluate a form. It means you have to do some gymnastics to get some s-expressions into the graphs. For example below I use a couple of variables to inject values. To get a string I have to use format to add the extra quotes, and to get the number I have to use the identity function. I also used escaped characters in the last line to see the difference.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((ts <span style="color: #008000;">"Iteration and substitution"</span>)
      (x0 0)
      (xf 3)
      (g1 0.95)
      (g2 0.92))
  (<span style="color: #0000FF;">gnuplot</span>
   (set terminal png)
   (set output <span style="color: #008000;">"iteration-2.png"</span>)
   (set title (format <span style="color: #008000;">"\"%s\""</span> ts))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Note the escaped square brackets</span>
   (set xrange \[ (identity x0) : (identity xf) \])
   (set label 1 <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n"</span> at graph (identity g1) \, graph (identity g2) right)
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">note here I escaped the parentheses!</span>
   (<span style="color: #0000FF;">plot</span> for [n=2:10] sin\(x*n\)/n notitle lw \(13-n\)/2)))
</pre>
</div>


<p>
<img src="/media/iteration-2.png"> 
</p>
</div>
</div>



<div id="outline-container-orga773a9d" class="outline-2">
<h2 id="orga773a9d"><span class="section-number-2">3</span> Summary</h2>
<div class="outline-text-2" id="text-3">
<p>
For the simple plots here, my DSL worked ok. There is a tradeoff in the syntax I chose that has some consequences. We cannot use the values of symbols in this DSL without resorting to hackery like (identity sym). We also cannot use the infix notation for sin(x) without quoting it as "sin(x)" or escaping the parentheses, e.g. <code>sin\(x\)</code>, likewise square brackets which lisp will read  as a vector. Commas have to be escaped, which is probably an emacs-lisp issue. To address that would require a reader macro which emacs-lisp does not have great support for. I am calling this experiment done for now. I have another syntax idea to try out another day.
</p>

<p>
Here is a preview of what it might look like. It is basically the same but I reuse keywords to indicate that :x0 should be replaced by whatever x0 evaluates to, and (: - 1 0.05) should be evaluated. The special character escaping is still there of course, since that is a limitation of the emacs lisp reader I think. I might try using x0? and (? - 1 0.05) instead. That might be less confusing. I like that the keywords are syntax highlighted for free though, and you can't use them for anything else.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((ts <span style="color: #008000;">"Iteration and substitution"</span>)
      (x0 0)
      (xf 3)
      (g2 0.92))
  (<span style="color: #0000FF;">gnuplot</span>
   (set terminal png)
   (set output <span style="color: #008000;">"iteration-2.png"</span>)
   (set title <span style="color: #006FE0;">:ts</span>)
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Note the escaped square brackets</span>
   (set xrange \[ <span style="color: #006FE0;">:x0</span> : <span style="color: #006FE0;">:xf</span> \])
   (set label 1 <span style="color: #008000;">"plot for [n=2:10] sin(x*n)/n"</span> at graph (<span style="color: #0000FF;">:</span> - 1 0.05) \, graph <span style="color: #006FE0;">:g2</span> right)
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">note here I escaped the parentheses!</span>
   (<span style="color: #0000FF;">plot</span> for [n=2:10] sin(x*n)/n notitle lw (13-n)/2)))
</pre>
</div>

<p>
This has the benefit of a little cleaner injection of variables and selective execution of parenthetical expressions, we will just ignore any that don't pass (= (car expr) :). That May not work for sin((: + 1 1) x) though, unless I escape the outer parentheses too.</p>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/04/An-emacs-lisp-dsl-for-gnuplot.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/10/11/A-differentiable-ODE-integrator-for-sensitivity-analysis/">A differentiable ODE integrator for sensitivity analysis</a></li>
      <li><a href="/blog/2018/10/10/Autograd-and-the-derivative-of-an-integral-function/">Autograd and the derivative of an integral function</a></li>
      <li><a href="/blog/2018/10/09/Compressibility-variation-from-an-implicit-equation-of-state/">Compressibility variation from an implicit equation of state</a></li>
      <li><a href="/blog/2018/10/08/Getting-derivatives-from-implicit-functions-with-autograd/">Getting derivatives from implicit functions with autograd</a></li>
      <li><a href="/blog/2018/10/07/Compressibility-factor-variation-from-the-van-der-Waals-equation-by-three-different-approaches/">Compressibility factor variation from the van der Waals equation by three different approaches</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



