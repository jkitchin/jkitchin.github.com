

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Literate-programming-with-python-doctests"></div>
      <h2 class="blog_post_title"><a href="/blog/2018/05/17/Literate-programming-with-python-doctests/" rel="bookmark" title="Permanent Link to Literate programming with python doctests">Literate programming with python doctests</a></h2>
      <p><small><span class="blog_post_date">Posted May 17, 2018 at 04:41 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/noweb/'>noweb</a>, <a href='/blog/category/python/'>python</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
      <p><small><span class="blog_post_date">Updated May 18, 2018 at 03:07 PM</span></small>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org91f890f">1. Add a way to run the tests</a></li>
<li><a href="#org4759a84">2. Tangle the file</a></li>
<li><a href="#org8727607">3. Run the tests</a></li>
<li><a href="#org5a82a2f">4. The noweb doctest block</a></li>
</ul>
</div>
</div>
<p>
On the org-mode mailing list we had a nice discussion about using noweb and org-mode in literate programming. The results of that discussion were blogged about <a href="http://kdr2.com/tech/emacs/1805-approach-org-ref-code-to-text.html">here</a>. I thought of a different application of this for making <a href="https://pymotw.com/3/doctest/">doctests</a> in Python functions. I have to confess I have never liked these because I have always thought they were a pain to write since you basically have to put code and results into a docstring. The ideas developed in the discussion above led me to think of a new way to write these that seems totally reasonable.
</p>

<p>
The idea is just to put noweb placeholders in the function docstring for the doctests. The placeholders will be expanded when you tangle the file, and they will get their contents from other src-blocks where you have written and run examples to test them.
</p>

<p>
This video might make the rest of this post easier to follow:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/u8CWbedVV9Y" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

<p>
I will illustrate the idea using org-mode and the ob-ipython I have in scimax. The defaults of my ob-ipython setup are not useful for this example because it puts the execution count and mime types of output in the output. These are not observed in a REPL, and so we turn this off by setting these variables.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> ob-ipython-suppress-execution-count t
      ob-ipython-show-mime-types nil)
</pre>
</div>

<p>
Now, we make an example function that takes a single argument and returns one divided by that argument. This block is runnable, and the function is then defined in the jupyter kernel. The docstring contains several noweb references to doctest blocks we define later. For now, they don't do anything. See <a href="#org5a82a2f">The noweb doctest block</a> section for the block that is used to expand these. This block also has a tangle header which indicates the file to tangle the results to. When I run this block, it is sent to a Jupyter kernel and saved in memory for use in subsequent blocks.
</p>

<p>
Here is the block with no noweb expansion. Note that this is easier to read in the original org source than it is to read in the published blog format.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">func</span>(a):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #036A07;">"""A function to divide one by a.</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #036A07;">   &lt;&lt;doctest("doctest-1")&gt;&gt;</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #036A07;">   &lt;&lt;doctest("doctest-2")&gt;&gt;</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #036A07;">   &lt;&lt;doctest("doctest-3")&gt;&gt;</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #036A07;">   Returns: 1 / a.</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #036A07;">   """</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> 1 / a

</pre>
</div>

<p>
Now, we can write a series of named blocks that define various tests we might want to use as doctests. You can run these blocks here, and verify they are correct. Later, when we tangle the document, these will be incorporated into the tangled file in the docstring we defined above.
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="org4eaeeaf">func(5) == 0.2
</pre>
</div>

<pre class="example">
True

</pre>



<p>
This next test will raise an Exception, and we just run it to make sure it does.
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="org560fcaf">func(0)
</pre>
</div>

<pre class="example">

ZeroDivisionErrorTraceback (most recent call last)
&lt;ipython-input-6-ba0cd5a88f0a&gt; in &lt;module&gt;()
----&gt; 1 func(0)

&lt;ipython-input-1-eafd354a3163&gt; in func(a)
     18     Returns: 1 / a.
     19     """
---&gt; 20     return 1 / a

ZeroDivisionError: division by zero

</pre>



<p>
This is just a doctest with indentation to show how it is used.
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="org968debf"><span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(1, 4):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">print</span>(func(i))
</pre>
</div>

<pre class="example">
1.0
0.5
0.3333333333333333


</pre>



<p>
That concludes the examples I want incorporated into the doctests. Each one of these blocks has a name, which is used as an argument to the noweb references in the function docstring.
</p>

<div id="outline-container-org91f890f" class="outline-2">
<h2 id="org91f890f"><span class="section-number-2">1</span> Add a way to run the tests</h2>
<div class="outline-text-2" id="text-1">
<p>
This is a common idiom to enable easy running of the doctests. This will get tangled out to the file.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">import</span> doctest
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   doctest.testmod()
</pre>
</div>
</div>
</div>


<div id="outline-container-org4759a84" class="outline-2">
<h2 id="org4759a84"><span class="section-number-2">2</span> Tangle the file</h2>
<div class="outline-text-2" id="text-2">
<p>
So far, the Python code we have written only exists in the org-file, and in memory. Tangling is the extraction of the code into a code file.
</p>

<p>
We run this command, which extracts the code blocks marked for tangling, and expands the noweb references in them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-babel-tangle)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">test.py</td>
</tr>
</tbody>
</table>

<p>
Here is what we get:
</p>

<pre class="example">
def func(a):
    """A function to divide one by a.

    &gt;&gt;&gt; func(5) == 0.2
    True

    &gt;&gt;&gt; func(0)
    Traceback (most recent call last):
    ZeroDivisionError: division by zero

    &gt;&gt;&gt; for i in range(1, 4):
    ...     print(func(i))
    1.0
    0.5
    0.3333333333333333


    Returns: 1 / a.
    """
    return 1 / a

if __name__ == "__main__":
    import doctest
    doctest.testmod()

</pre>

<p>
That looks like a reasonable python file. You can see the doctest blocks have been inserted into the docstring, as desired. The proof of course is that we can run these doctests, and use the python module. We show that next.
</p>
</div>
</div>


<div id="outline-container-org8727607" class="outline-2">
<h2 id="org8727607"><span class="section-number-2">3</span> Run the tests</h2>
<div class="outline-text-2" id="text-3">
<p>
Now, we can check if the tests pass in a fresh run (i.e. not using the version stored in the jupyter kernel.) The standard way to run the doctests is like this:
</p>

<div class="org-src-container">
<pre class="src src-sh">python test.py -v
</pre>
</div>




<p>
Well, that's it! It worked fine. Now we have a python file we can import and reuse, with some doctests that show how it works. For example, here it is in a small Python script.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span> test <span style="color: #0000FF;">import</span> func
<span style="color: #0000FF;">print</span>(func(3))
</pre>
</div>

<pre class="example">
0.3333333333333333

</pre>



<p>
There are surely some caveats to keep in mind here. This was just a simple proof of concept idea that isn't tested beyond this example. I don't know how many complexities would arise from more complex doctests. But, it seems like a good idea to continue pursuing if you like using doctests, and like using org-mode and interactive/literate programming techniques.
</p>

<p>
It is definitely an interesting way to use noweb to build up better code files in my opinion.
</p>
</div>
</div>

<div id="outline-container-org5a82a2f" class="outline-2">
<h2 id="org5a82a2f"><a id="ID-D4437A03-A9D0-4B6D-B254-5F03CFB25F95"></a><span class="section-number-2">4</span> The noweb doctest block</h2>
<div class="outline-text-2" id="text-4">
<p>
These blocks are used in the noweb expansions. Each block takes a variable which is the name of a block. This block grabs the body of the named src block and formats it as if it was in a REPL.
</p>

<p>
We also grab the results of the named block and format it for the doctest. We use a heuristic to detect Tracebacks and modify the output to be consistent with it. In that case we assume the relevant Traceback is on the last line.
</p>

<p>
Admittedly, this does some fragile feeling things, like trimming whitespace here and there to remove blank lines, and quoting quotes (which was not actually used in this example), and removing the ": " pieces of ob-ipython results. Probably other ways of running the src-blocks would not be that suitable for this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org52486c2">(org-babel-goto-named-src-block name)
(<span style="color: #0000FF;">let*</span> ((src (s-trim-right (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context))))
       (src-lines (split-string src <span style="color: #008000;">"\n"</span>))
       body result)
  (<span style="color: #0000FF;">setq</span> body
        (s-trim-right
         (s-concat <span style="color: #008000;">"&gt;&gt;&gt; "</span> (car src-lines) <span style="color: #008000;">"\n"</span>
                   (s-join <span style="color: #008000;">"\n"</span> (mapcar (<span style="color: #0000FF;">lambda</span> (s)
                                          (concat <span style="color: #008000;">"... "</span> s))
                                        (cdr src-lines))))))
  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now the results</span>
  (org-babel-goto-named-result name)
  (<span style="color: #0000FF;">let</span> ((result (org-element-context)))
    (<span style="color: #0000FF;">setq</span> result
          (<span style="color: #0000FF;">thread-last</span>
              (buffer-substring (org-element-property <span style="color: #006FE0;">:contents-begin</span> result)
                                (org-element-property <span style="color: #006FE0;">:contents-end</span> result))
            (s-trim)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">remove ": " from beginning of lines</span>
            (replace-regexp-in-string <span style="color: #008000;">"^: *"</span> <span style="color: #008000;">""</span>)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">quote quotes</span>
            (replace-regexp-in-string <span style="color: #008000;">"\\\""</span> <span style="color: #008000;">"\\\\\""</span>)))
    (<span style="color: #0000FF;">when</span> (string-match <span style="color: #008000;">"Traceback"</span> result)
      (<span style="color: #0000FF;">setq</span> result (format
                    <span style="color: #008000;">"Traceback (most recent call last):\n%s"</span>
                    (car (last (split-string result <span style="color: #008000;">"\n"</span>))))))
    (concat body <span style="color: #008000;">"\n"</span> result)))
</pre>
</div>
</div>
</div>
<p>Copyright (C) 2018 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2018/05/17/Literate-programming-with-python-doctests.org">org-mode source</a></p>
<p>Org-mode version = 9.1.13</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2018/05/17/Literate-programming-with-python-doctests">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="f-strings-in-emacs-lisp"></div>
      <h2 class="blog_post_title"><a href="/blog/2018/05/14/f-strings-in-emacs-lisp/" rel="bookmark" title="Permanent Link to f-strings in emacs-lisp">f-strings in emacs-lisp</a></h2>
      <p><small><span class="blog_post_date">Posted May 14, 2018 at 05:27 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/elisp/'>elisp</a></span> | tags: 
      <p><small><span class="blog_post_date">Updated May 25, 2018 at 07:44 AM</span></small>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I am a big fan of f-strings in Python 3. They let you put variable names and expressions in a string template that get expanded to create new strings. Here is a simple example of using those:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">username</span> = <span style="color: #008000;">'John Kitchin'</span>
<span style="color: #BA36A5;">somevar</span> = 5**0.5
<span style="color: #0000FF;">print</span>(f<span style="color: #008000;">'{username:30s}{somevar:1.2f}'</span>)
</pre>
</div>

<pre class="example">
John Kitchin                  2.24


</pre>

<p>
String formatting in emacs-lisp is by comparison not as fun and easy. Out of the box we have:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((username <span style="color: #008000;">"John Kitchin"</span>)
      (somevar (sqrt 5)))
  (format <span style="color: #008000;">"%-30s%1.2f"</span> username somevar))
</pre>
</div>

<pre class="example">
John Kitchin                  2.24

</pre>

<p>
That is still three lines of code, but it is ugly and hard to read like the old python code:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">print</span>(<span style="color: #008000;">'%-30s%1.2f'</span> % (username, somevar))
</pre>
</div>

<pre class="example">
John Kitchin                  2.24


</pre>


<p>
My experience has shown that this gets harder to figure out as the strings get larger, and f-strings are easier to read.
</p>

<p>
The wonderful <a href="https://github.com/magnars/s.el">'s</a> library provides some salvation for emacs-lisp, if you don't want the format fields. You can refer to variables in a lexical environment like this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((username <span style="color: #008000;">"John Kitchin"</span>)
      (somevar (sqrt 5)))
  (<span style="color: #0000FF;">s-lex-format</span> <span style="color: #008000;">"${username}${somevar}"</span>))
</pre>
</div>

<pre class="example">
John Kitchin2.23606797749979

</pre>

<p>
Today, I decided to do something about this, and wrote this little macro. It is a variation on s-lex-format that introduces a slightly new syntax. You can now add an optional format field separated from the variable name by a space.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">f-string</span> (fmt)
  <span style="color: #036A07;">"Like `</span><span style="color: #D0372D;">s-format</span><span style="color: #036A07;">' but with format fields in it.</span>
<span style="color: #036A07;">FMT is a string to be expanded against the current lexical</span>
<span style="color: #036A07;">environment. It is like what is used in `</span><span style="color: #D0372D;">s-lex-format</span><span style="color: #036A07;">', but has</span>
<span style="color: #036A07;">an expanded syntax to allow format-strings. For example:</span>
<span style="color: #036A07;">${user-full-name 20s} will be expanded to the current value of</span>
<span style="color: #036A07;">the variable `</span><span style="color: #D0372D;">user-full-name</span><span style="color: #036A07;">' in a field 20 characters wide.</span>
<span style="color: #036A07;">  (let ((f (sqrt 5)))  (f-string \"${f 1.2f}\"))</span>
<span style="color: #036A07;">  will render as: 2.24</span>
<span style="color: #036A07;">This function is inspired by the f-strings in Python 3.6, which I</span>
<span style="color: #036A07;">enjoy using a lot.</span>
<span style="color: #036A07;">"</span>
  (<span style="color: #0000FF;">let*</span> ((matches (s-match-strings-all<span style="color: #008000;">"${</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?3:</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?1:</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">} ]+</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;"> *</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?2:</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">}]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">}"</span> fmt))
         (agetter (<span style="color: #0000FF;">cl-loop</span> for (m0 m1 m2 m3) in matches
                        collect `(cons ,m3  (format (format <span style="color: #008000;">"%%%s"</span> (<span style="color: #0000FF;">if</span> (string= ,m2 <span style="color: #008000;">""</span>)
                                                                      (<span style="color: #0000FF;">if</span> s-lex-value-as-lisp <span style="color: #008000;">"S"</span> <span style="color: #008000;">"s"</span>)
                                                                   ,m2))
                                                  (symbol-value (intern ,m1)))))))

    `<span style="color: #D0372D;">(s-format ,fmt </span>'aget (list ,@agetter))))
</pre>
</div>

<pre class="example">
f-string

</pre>

<p>
Here it is in action.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((username <span style="color: #008000;">"John Kitchin"</span>)
      (somevar (sqrt 5)))
  (<span style="color: #0000FF;">f-string</span> <span style="color: #008000;">"${username -30s}${somevar 1.2f}"</span>))
</pre>
</div>

<pre class="example">
John Kitchin                  2.24

</pre>

<p>
It still lacks some of the capability of f-strings in python, e.g. in Python, arguments inside the template to be expanded get evaluated. The solution used above is too simple for that, since it just used a regexp and is limited to the value of variables in the lexical environment.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">print</span>(f<span style="color: #008000;">'{5**0.5:1.3f}'</span>)
</pre>
</div>

<pre class="example">
2.236


</pre>

<p>
Nevertheless, this simple solution matches what I do most of the time anyway, so I still consider it an improvement!
</p>
<p>Copyright (C) 2018 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2018/05/14/f-strings-in-emacs-lisp.org">org-mode source</a></p>
<p>Org-mode version = 9.1.13</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2018/05/14/f-strings-in-emacs-lisp">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions"></div>
      <h2 class="blog_post_title"><a href="/blog/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions/" rel="bookmark" title="Permanent Link to Making it easier to extend the export of org-mode links with generic functions">Making it easier to extend the export of org-mode links with generic functions</a></h2>
      <p><small><span class="blog_post_date">Posted May 09, 2018 at 07:49 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I am a big fan of org-mode links. Lately, I have had a need to modify how some links are exported, e.g. defining new exports for different backends, or fine-tuning a particular backend. This can be difficult, depending on how the link was set up. Here is a typical setup I am used to using, where the different options for the backends are handled in a conditional statement in a single function. I will just use a link that just serves to illustrate the issues here. These links are just sytactic sugar for markup, they don't do anything else. We start with an example that just converts text to italic text for different backends like html or latex.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-export</span> (path desc backend)
  (<span style="color: #0000FF;">cond</span>
   ((eq 'html backend)
    (format <span style="color: #008000;">"&lt;em&gt;%s&lt;/em&gt;"</span> path))
   ((eq 'latex backend)
    (format <span style="color: #008000;">"\\textit{%s}"</span> path))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fall-through case for everything else</span>
   (t
    path)))

(org-link-set-parameters <span style="color: #008000;">"italic"</span> <span style="color: #006FE0;">:export</span> 'italic-link-export)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:export</td>
<td class="org-left">italic-link-export</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'html t)
</pre>
</div>

<pre class="example">
&lt;p&gt;
&lt;em&gt;text&lt;/em&gt;&lt;/p&gt;

</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'latex t)
</pre>
</div>

<pre class="example">
\textit{text}

</pre>

<p>
This falls through though to the default case.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-md</span>)
(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'md t)
</pre>
</div>

<pre class="example">

# Table of Contents



text


</pre>

<p>
The point I want to make here is that this is not easy to extend as a user. You have to either modify the italic-link-export function, advise it, or monkey-patch it. None of these are especially nice.
</p>

<p>
I could define italic-link-export in a way that it retrieves the function to use from an alist or hash-table using the backend, but then you have to do two things to modify the behavior: define a backend specific function <i>and</i> register it in the lookup variable. It is also possible to just look up a function by a derived symbol, e.g. using fboundp, and then using funcall to execute it. This looks something like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a user definable function for exporting to latex</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-export-latex</span> (path desc backend)
  (format <span style="color: #008000;">"\\textit{%s}"</span> path))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">generic export function that looks up functions or defaults to</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-exporter</span> (path desc backend)
  <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">italic-link-export-BACKEND</span><span style="color: #036A07;">' if it exists, or return path."</span>
  (<span style="color: #0000FF;">let</span> ((func (intern-soft (format <span style="color: #008000;">"italic-link-export-%s"</span> backend))))
    (<span style="color: #0000FF;">if</span> (fboundp func)
        (funcall func path desc backend)
      path)))
</pre>
</div>

<p>
This has some indirection, but allows you to just define new functions to add new export backends, or replace single backend exports. It isn't bad, but there is room for improvement.
</p>

<p>
In this <a href="https://github.com/jkitchin/org-ref/issues/492#issuecomment-387806180">comment</a> in org-ref, I saw a new opportunity to address this issue using generic functions in elisp! The idea is to define a generic function that handles the general export case, and then define additional functions for each specific backend based on the signature of the export function. I will switch to bold markup for this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-defgeneric</span> <span style="color: #006699;">bold-link-export</span> (path desc backend)
 <span style="color: #036A07;">"Generic function to export a bold link."</span>
 path)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this one runs when the backend is equal to html</span>
(<span style="color: #0000FF;">cl-defmethod</span> <span style="color: #006699;">bold-link-export</span> ((path t) (desc t) (backend (eql html)))
 (format <span style="color: #008000;">"&lt;b&gt;%s&lt;/b&gt;"</span> path))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this one runs when the backend is equal to latex</span>
(<span style="color: #0000FF;">cl-defmethod</span> <span style="color: #006699;">bold-link-export</span> ((path t) (desc t) (backend (eql latex)))
 (format <span style="color: #008000;">"\\textit{%s}"</span> path))

(org-link-set-parameters <span style="color: #008000;">"bold"</span> <span style="color: #006FE0;">:export</span> 'bold-link-export)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:export</td>
<td class="org-left">bold-link-export</td>
</tr>
</tbody>
</table>

<p>
Here it is in action:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'html t)
</pre>
</div>

<pre class="example">
&lt;p&gt;
some &lt;b&gt;text&lt;/b&gt;&lt;/p&gt;

</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'latex t)
</pre>
</div>

<p>
This uses the generic function.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-md</span>)
(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'md t)
</pre>
</div>

<pre class="example">

# Table of Contents



some text


</pre>

<p>
The syntax for defining the generic function is pretty similar to a regular function. The specific methods are a little different since they have to provide the specific "signature" that triggers each method. Here we only differentiate on the type of the backend. It is nice these are all separate functions though. It makes it trivial to add new ones, and less intrusive to replace in my opinion.
</p>

<p>
Generic functions have many other potential applications to replace functions that use lots of conditions to control flow, with a fall-through option at the end. You can learn more about them here: <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html">https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html</a>. There is a lot more to them than I have illustrated here.
</p>
<p>Copyright (C) 2018 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions.org">org-mode source</a></p>
<p>Org-mode version = 9.1.13</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions">Discuss on Twitter</a>

  <hr class="interblog" />

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2021/12/18/New-publication-Origin-of-the-Stokes-Einstein-Deviation-in-Liquid-Al-Si/">New publication - Origin of the Stokes-Einstein Deviation in Liquid Al-Si</a></li>
      <li><a href="/blog/2021/12/03/New-publication-Accelerated-Optimization-of-Pure-Metal-and-Ligand-Compositions-for-Light-driven-Hydrogen-Production/">New publication - Accelerated Optimization of Pure Metal and Ligand Compositions for Light-driven Hydrogen Production</a></li>
      <li><a href="/blog/2021/12/02/New-publication-Ligand-Enhanced-Activity-of-in-Situ-Formed-Nanoparticles-for-Photocatalytic-Hydrogen-Evolution/">New publication - Ligand Enhanced Activity of in Situ Formed Nanoparticles for Photocatalytic Hydrogen Evolution</a></li>
      <li><a href="/blog/2021/11/30/New-publication-Uncertainty-quantification-in-machine-learning-and-nonlinear-least-squares-regression-models/">New publication - Uncertainty quantification in machine learning and nonlinear least squares regression models</a></li>
      <li><a href="/blog/2021/11/23/pycse-YouTube-Channel/">pycse YouTube Channel</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2021
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



