

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-git-status-Emacs-modeline"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/09/19/A-git-status-Emacs-modeline/" rel="bookmark" title="Permanent Link to A git status Emacs modeline">A git status Emacs modeline</a></h2>
      <p><small><span class="blog_post_date">Posted September 19, 2014 at 09:36 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/git/'>git</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2014/09/19/A-git-status-Emacs-modeline#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I am using git more and more in Emacs, and I would like a way to know the status of the git repo I am working in by looking at the modeline. I know about <a href="https://github.com/magit/magit">magit</a> , and other git modes, but none of them provide something as easy as useful as say <a href="https://github.com/magicmonty/bash-git-prompt">bash-git-prompt</a> in the bash shell, which is to say I do not want to run a command to see the status (I might as well be in the shell then). Part of this need comes from a project with hundreds of git repos in it, and I want convenient status when I open any one of them.
</p>

<p>
Here, I want to emulate the bash-git-prompt feature in the Emacs modeline where it will show you when you are in a git repo, and then some basic information like what branch you are on, the number of untracked, modified files, and the commit status with respect to a remote. First, we only want this when we are in a git repo. We can check for that like this. The command in this block returns a string that starts with fatal when not in a git repo.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(not (string-match <span style="color: #228b22;">"^fatal"</span> (shell-command-to-string <span style="color: #228b22;">"git rev-parse --git-dir"</span>)))
</pre>
</div>

<pre class="example">
t
</pre>

<p>
Let us wrap that in a nice function so we can use it later..
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">in-git-p</span> ()
  (not (string-match <span style="color: #228b22;">"^fatal"</span> (shell-command-to-string <span style="color: #228b22;">"git rev-parse --git-dir"</span>))))

(in-git-p)
</pre>
</div>

<pre class="example">
t
</pre>

<p>
Next, we would like to know how many untracked, modified and other (e.g. unmerged, deleted, etc&#x2026;) files we have. We can get this from  <code>git status --porcelain</code>. I am going to set these to be red if they are not zero, so they stand out, and be green otherwise. We will also store a list of each file type so we can make a tooltip on the counter to see what is there.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">git-parse-status</span> ()
  (interactive)
  (<span style="color: #8b0000;">let</span> ((U 0)   ; <span style="color: #ff0000; font-weight: bold;">untracked files</span>
        (M 0)   ; <span style="color: #ff0000; font-weight: bold;">modified files</span>
        (O 0)   ; <span style="color: #ff0000; font-weight: bold;">other files</span>
        (U-files <span style="color: #228b22;">""</span>)
        (M-files <span style="color: #228b22;">""</span>)
        (O-files <span style="color: #228b22;">""</span>))
    (<span style="color: #8b0000;">dolist</span> (line (split-string
                   (shell-command-to-string <span style="color: #228b22;">"git status --porcelain"</span>)
                   <span style="color: #228b22;">"\n"</span>))
      (<span style="color: #8b0000;">cond</span>

       ;; <span style="color: #ff0000; font-weight: bold;">ignore empty line at end</span>
       ((string= <span style="color: #228b22;">""</span> line) nil)

       ((string-match <span style="color: #228b22;">"^\\?\\?"</span> line)
        (setq U (+ 1 U))
        (setq U-files (concat U-files <span style="color: #228b22;">"\n"</span> line)))

       ((string-match <span style="color: #228b22;">"^ M"</span> line)
        (setq M (+ 1 M))
        (setq M-files (concat M-files <span style="color: #228b22;">"\n"</span> line))
        )

       (t
        (message <span style="color: #228b22;">"detected other in %s"</span> line)
        (setq O (+ 1 O))
        (setq O-files (concat O-files <span style="color: #228b22;">"\n"</span> line)))))
      
    ;; <span style="color: #ff0000; font-weight: bold;">construct propertized string</span>
    (concat
     <span style="color: #228b22;">"("</span>
     (propertize 
      (format <span style="color: #228b22;">"M:%d"</span> M)
      'face (list '<span style="color: #cd0000;">:foreground</span> (<span style="color: #8b0000;">if</span> (&gt; M 0)
                                   <span style="color: #228b22;">"red"</span>
                                 <span style="color: #228b22;">"forest green"</span>))
      'help-echo M-files)
     <span style="color: #228b22;">"|"</span>
     (propertize 
      (format <span style="color: #228b22;">"U:%d"</span> U)
      'face (list '<span style="color: #cd0000;">:foreground</span> (<span style="color: #8b0000;">if</span> (&gt; U 0)
                                   <span style="color: #228b22;">"red"</span>
                                 <span style="color: #228b22;">"forest green"</span>))
      'help-echo U-files)
     <span style="color: #228b22;">"|"</span>
     (propertize 
      (format <span style="color: #228b22;">"O:%d"</span> O)
      'face (list '<span style="color: #cd0000;">:foreground</span> (<span style="color: #8b0000;">if</span> (&gt; O 0)
                                   <span style="color: #228b22;">"red"</span>
                                 <span style="color: #228b22;">"forest green"</span>))
      'help-echo O-files)                   
      <span style="color: #228b22;">") "</span>)))

(git-parse-status)
</pre>
</div>

<pre class="example">
(M:1|U:2|O:0) 
</pre>

<p>
Finally, let us get the branch we are on, and the commits with respect to a remote. We can do that like this. We use some unicode characters to indicate what direction things go, e.g. an up arrow to indicate you need to push, and a down arrow to indicate you should pull.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">git-remote-status</span> ()
  (interactive)
  (<span style="color: #8b0000;">let*</span> (;; <span style="color: #ff0000; font-weight: bold;">get the branch we are on.</span>
         (branch (s-trim
                  (shell-command-to-string
                   <span style="color: #228b22;">"git rev-parse --abbrev-ref HEAD"</span>)))
         ;; <span style="color: #ff0000; font-weight: bold;">get the remote the branch points to.</span>
         (remote (s-trim
                  (shell-command-to-string
                   (format <span style="color: #228b22;">"git config branch.%s.remote"</span> branch))))
         (remote-branch (s-trim
                         (shell-command-to-string
                          <span style="color: #228b22;">"git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)"</span>)))
         (commits (split-string
                   (s-trim
                    (shell-command-to-string
                     (format
                      <span style="color: #228b22;">"git rev-list --count --left-right HEAD...%s"</span>
                      remote-branch)))))
         (local (nth 0 commits))
         (remotes (nth 1 commits)))
    (concat
     <span style="color: #228b22;">"["</span>
     (propertize
      (format <span style="color: #228b22;">"%s"</span> branch)
      'face (list <span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"magenta"</span>))
     <span style="color: #228b22;">"|"</span>
     (format <span style="color: #228b22;">"&#8593;%s|&#8595;%s"</span> local remotes)
     <span style="color: #228b22;">"]"</span>))) 

(git-remote-status)
</pre>
</div>

<pre class="example">
[source|↑0|↓0]
</pre>

<p>
Now, we can finally put this together in a little minor mode. We add an element to the mode-line-format variable that evaluates those functions. When we turn off the minor mode, we remove the element from the modeline.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">define-minor-mode</span> <span style="color: #8b2323;">git-mode</span>
  <span style="color: #228b22;">"minor mode to put git repo status in modeline"</span>
  nil nil nil
  (<span style="color: #8b0000;">let</span> ((git-modeline '(<span style="color: #cd0000;">:eval</span> (<span style="color: #8b0000;">if</span> (not (in-git-p))
                                  <span style="color: #228b22;">""</span>
                                (concat 
                                 (git-remote-status)
                                 (git-parse-status))))))
    (<span style="color: #8b0000;">if</span> git-mode
        ;; <span style="color: #ff0000; font-weight: bold;">put in modeline</span>
        (push git-modeline mode-line-format)
      ;; <span style="color: #ff0000; font-weight: bold;">remove from modeline</span>
      (setq mode-line-format
            (-remove (<span style="color: #8b0000;">lambda</span> (x)
                       (equal x git-modeline))                                  
                     mode-line-format)))))
</pre>
</div>

<p>
This leads to a modeline that looks like this (when my mouse is hovered over the M):
</p>


<div class="figure">
<p><img src="/media/2014-09-19-A-git-status-Emacs-modeline/git-modeline.png"> 
</p>
</div>

<p>
This seems to have some performance issue, since pretty much everytime I type a key, it updates the modeline, and runs git. That is too often. Let us redefine the mode here so we have a minimum time between updates, say 15 seconds. We will store the last time updated, and the last value of the mode-line. Then each time the modeline updates, if the time since the last update is greater than our interval, then we will run the git commands. Otherwise, we just use the old modeline value.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">git-modeline-last-update</span> (float-time) <span style="color: #228b22;">"Last time we updated"</span>)
(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">git-modeline-update-interval</span> 15 <span style="color: #228b22;">"Minimum time between update in seconds"</span>)
(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">git-modeline</span> <span style="color: #228b22;">""</span> <span style="color: #228b22;">"Last value of the modeline"</span>)

(<span style="color: #8b0000;">define-minor-mode</span> <span style="color: #8b2323;">git-mode</span>
  <span style="color: #228b22;">"minor mode to put git repo status in modeline"</span>
  nil nil nil
  (<span style="color: #8b0000;">let</span> ((git-modeline '(<span style="color: #cd0000;">:eval</span> (<span style="color: #8b0000;">if</span>
                                  (&gt; (- (float-time) git-modeline-last-update)
                                     git-modeline-update-interval)
                                  ;; <span style="color: #ff0000; font-weight: bold;">we are updating                              </span>
                                  (setq git-modeline
                                        (<span style="color: #8b0000;">if</span> (not (in-git-p))
                                            <span style="color: #228b22;">""</span>                                   
                                          (setq  git-modeline-last-update (float-time))
                                          (concat 
                                           (git-remote-status)
                                           (git-parse-status))))
                                
                              ;; <span style="color: #ff0000; font-weight: bold;">use last value of the modeline</span>
                              git-modeline))))
    (<span style="color: #8b0000;">if</span> git-mode
        ;; <span style="color: #ff0000; font-weight: bold;">put in modeline</span>
        (push git-modeline mode-line-format)
      ;; <span style="color: #ff0000; font-weight: bold;">remove from modeline</span>
      (setq mode-line-format
            (-remove (<span style="color: #8b0000;">lambda</span> (x)
                       (equal x git-modeline))                                  
                     mode-line-format)))))
</pre>
</div>

<p>
That does it I think. I don't have any performance issues here now. I have not tested this super thoroughly on many git repos, but it seems to be pretty consistent and correct so far. The remote status code is where there is the most probability for issues. I still do not know that part of git very well.  I wonder if there is a more elegant solution than this, perhaps an idle timer. I notice a little lag in updating the data when I switch to another git repo. That might be a little confusing one day.
</p>


<p>
Otherwise, this seems like a pretty nice solution so far. There are still some things that would be nice to see on here. For example, a pop-up menu on the modeline to switch branches, push or pull, and with actions for the files, e.g. add/commit, etc&#x2026; Those do not seem to hard to </p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/19/A-git-status-Emacs-modeline.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2014/09/19/A-git-status-Emacs-modeline#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Colorized-text-in-Emacs"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/09/14/Colorized-text-in-Emacs/" rel="bookmark" title="Permanent Link to Colorized text in Emacs">Colorized text in Emacs</a></h2>
      <p><small><span class="blog_post_date">Posted September 14, 2014 at 02:23 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2014/09/14/Colorized-text-in-Emacs#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated September 14, 2014 at 02:33 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
As I continue investigating Emacs + org-mode as a platform for creating applications, it has come up a few times that it would be useful to display colored text. For example, in a summary report of a git repo, you might want to see some information in red, e.g. if you have uncommitted changes, and some information in green, e.g. the repo is clean and consistent with a remote.
</p>

<p>
We can set colors on a string in Emacs like this:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(propertize <span style="color: #228b22;">"Red Text"</span> 'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"red"</span>))
</pre>
</div>

<p>
The only tricky part is that we need to insert the text into a font-locked buffer to see it. That is also a tad tricky to illustrate in a code block, so here is a way to try it:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(re-search-forward <span style="color: #228b22;">"-&gt; "</span>)
(insert
  (propertize <span style="color: #228b22;">"Red Text"</span> 'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"red"</span>)))
</pre>
</div>

<p>
-&gt; Red Text
</p>

<p>
The red text does not show in the HTML post, so this is a screenshot of what it looks like in my buffer:
</p>


<div class="figure">
<p><img src="/media/2014-09-14-Colorized-text-in-Emacs/red-text.png"> 
</p>
</div>

<p>
Now, here is how we might use this in a summary report. Say we have a git repo, and we want to know various facts about it. We can get information about tracked/ untracked and modified files like this:
</p>

<div class="org-src-container">

<pre class="src src-sh">git status --porcelain
</pre>
</div>
<pre class="example">
 M _blog/blog.html
 M _blog/blog.org
A  _blog/images/red-text.png
</pre>

<p>
This shows we have two tracked, but modified files, and on added but not committed file. We can use this code to show if we have any untracked files.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((n 0) s)
  (<span style="color: #8b0000;">dolist</span> (line (split-string
                 (shell-command-to-string <span style="color: #228b22;">"git status --porcelain"</span>)
                 <span style="color: #228b22;">"\n"</span>))
    (<span style="color: #8b0000;">when</span> (string-match <span style="color: #228b22;">"^\\?\\?"</span> line)
      (setq n (+ 1 n))))
  (<span style="color: #8b0000;">if</span> (&gt; n 0)
      (setq s (propertize (format <span style="color: #228b22;">"%s untracked files"</span> n)
                          'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"red"</span>)))
    (setq s (propertize <span style="color: #228b22;">"No untracked files"</span> 
                        'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"forest green"</span>))))
  (re-search-forward <span style="color: #228b22;">"-&gt;"</span>)
  (insert s))
</pre>
</div>

<p>
-&gt;No untracked files
</p>

<p>
In HTML (i.e. the blog post) you cannot really see the green text, so here is a screenshot illustrating it.
<img src="/media/2014-09-14-Colorized-text-in-Emacs/git-untracked-files.png"> 
</p>

<p>
Similarly, we can check for modified files. We add a wrinkle and add a tooltip like text that shows the output of the git command.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((n 0)
      (output (shell-command-to-string <span style="color: #228b22;">"git status --porcelain"</span>))
      s)
  (<span style="color: #8b0000;">dolist</span> (line (split-string
                 output
                 <span style="color: #228b22;">"\n"</span>))
    (<span style="color: #8b0000;">when</span> (string-match <span style="color: #228b22;">"^ M"</span> line)
      (setq n (+ 1 n))))
  (<span style="color: #8b0000;">if</span> (&gt; n 0)
      (setq s (propertize (format <span style="color: #228b22;">"%s modified files"</span> n)
                          'help-echo output
                          'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"red"</span>)))
    (setq s (propertize <span style="color: #228b22;">"No modified files"</span> 
                        'font-lock-face '(<span style="color: #cd0000;">:foreground</span> <span style="color: #228b22;">"forest green"</span>))))
  (re-search-forward <span style="color: #228b22;">"-&gt; "</span>)
  (insert s))
</pre>
</div>

<p>
-&gt; 2 modified files
</p>

<p>
That looks like this in emacs:
</p>


<div class="figure">
<p><img src="/media/2014-09-14-Colorized-text-in-Emacs/git-modified.png"> 
</p>
</div>


<p>
That is the main idea in this post. You can create strings with properties, and use code to determine what they e.g. what color the text is, etc&#x2026; There are lots of properties listed at <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Special-Properties.html">http://www.gnu.org/software/emacs/manual/html_node/elisp/Special-Properties.html</a> that might be helpful in an application. Here are some previous posts that examined similar ideas.
</p>

<ul class="org-ul">
<li>Read-only text <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/09/13/Make-some-org-sections-read-only/">http://kitchingroup.cheme.cmu.edu/blog/2014/09/13/Make-some-org-sections-read-only/</a> 
</li>

<li>Tool tips: <a href="http://kitchingroup.cheme.cmu.edu/blog/2013/04/12/Tool-tips-on-text-in-Emacs/">http://kitchingroup.cheme.cmu.edu/blog/2013/04/12/Tool-tips-on-text-in-Emacs/</a> 
</li>

<li>Invisible text (this is not exactly a property, but it is similar)
</li>
</ul>
<p>
<a href="http://kitchingroup.cheme.cmu.edu/blog/2014/02/06/Invisible-text-in-emacs/">http://kitchingroup.cheme.cmu.edu/blog/2014/02/06/Invisible-text-in-emacs/</a> </p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/14/Colorized-text-in-Emacs.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2014/09/14/Colorized-text-in-Emacs#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Make-some-org-sections-read-only"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/09/13/Make-some-org-sections-read-only/" rel="bookmark" title="Permanent Link to Make some org-sections read-only">Make some org-sections read-only</a></h2>
      <p><small><span class="blog_post_date">Posted September 13, 2014 at 01:50 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2014/09/13/Make-some-org-sections-read-only#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
There are times where I want an org-file to be <i>partly</i> read-only. For example, there might be instructions that should not be modified. In this post we consider how to implement that. For now, we only want an org-section to be read-only, and we will designate those sections by a tag read<sub>only</sub>. Then, the idea is that a hook function would be run when the org-file is loaded, and mark regions of text as read-only before the user can do anything.
</p>

<p>
In Emacs, you can mark a section of text, and set it to have a property of read-only. So, we can just map over the entries, and any heading that is tagged as read<sub>only</sub> can be made read-only!
</p>

<p>
Here we set the first few characters of this buffer to be read-only.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-text-properties 1 8 '(read-only t))
</pre>
</div>

<pre class="example">
t
</pre>

<p>
Emacs is semi-serious about what read-only means. You cannot even change properties of read-only text, unless you set inhibit-read-only as a variable.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((inhibit-read-only t))
 (remove-text-properties 1 8 '(read-only t)))
</pre>
</div>

<pre class="example">
t
</pre>

<p>
Now, we can map over the entries in this buffer, and set any heading tagged read<sub>only</sub> to actually be that way like this.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-map-entries (<span style="color: #8b0000;">lambda</span> ()
                   (<span style="color: #8b0000;">let*</span> ((element (org-element-at-point))
                          (begin (org-element-property <span style="color: #cd0000;">:begin</span> element))
                          (end (org-element-property <span style="color: #cd0000;">:end</span> element)))
                     (add-text-properties begin end '(read-only t))))
                 <span style="color: #228b22;">"read_only"</span>)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">t</td>
</tr>
</tbody>
</table>

<p>
To get this to work when org-mode is turned on, we just wrap it in a function, add the function to a hook, and a function to undo the read-only behavior. I found that if I use the end reported by org-element-at-point, it includes the first character of the next section, we take one away from the end to avoid that.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-mark-readonly</span> ()
  (interactive)
  (org-map-entries
   (<span style="color: #8b0000;">lambda</span> ()
     (<span style="color: #8b0000;">let*</span> ((element (org-element-at-point))
            (begin (org-element-property <span style="color: #cd0000;">:begin</span> element))
            (end (org-element-property <span style="color: #cd0000;">:end</span> element)))
       (add-text-properties begin (- end 1) '(read-only t))))
   <span style="color: #228b22;">"read_only"</span>)
 (message <span style="color: #228b22;">"Made readonly!"</span>))


(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-remove-readonly</span> ()
  (interactive)
  (org-map-entries
   (<span style="color: #8b0000;">lambda</span> ()
     (<span style="color: #8b0000;">let*</span> ((element (org-element-at-point))
            (begin (org-element-property <span style="color: #cd0000;">:begin</span> element))
            (end (org-element-property <span style="color: #cd0000;">:end</span> element))
            (inhibit-read-only t))
         (remove-text-properties begin (- end 1) '(read-only t))))
     <span style="color: #228b22;">"read_only"</span>))

(add-hook 'org-mode-hook 'org-mark-readonly)
</pre>
</div>

<p>
That seem to be all there is. After executing the code above, when I open this file, the next section is read-only! I can use the other function to remove that if I need to edit it. Score one for Emacs + org-mode!
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Read-only section&#xa0;&#xa0;&#xa0;<span class="tag"><span class="read_only">read_only</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
This text is so important, it should be read-only.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Editable section</h2>
<div class="outline-text-2" id="text-2">
<p>
You can do what you want here. Like add text.
</p>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/13/Make-some-org-sections-read-only.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2014/09/13/Make-some-org-sections-read-only#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Randomize-a-list-in-Emacs"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/09/06/Randomize-a-list-in-Emacs/" rel="bookmark" title="Permanent Link to Randomize a list in Emacs">Randomize a list in Emacs</a></h2>
      <p><small><span class="blog_post_date">Posted September 06, 2014 at 10:08 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs-lisp/'>emacs_lisp</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2014/09/06/Randomize-a-list-in-Emacs#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated September 06, 2014 at 03:11 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
I have an application where I have a list of userids, and I want to randomize the order of the list. Today, I explore some ways to do that. The first idea is to simply mimic the algorithm in Python's random.shuffle algorithm.
</p>

<div class="org-src-container">

<pre class="src src-python">    <span style="color: #8b0000;">def</span> <span style="color: #8b2323;">shuffle</span>(<span style="color: #8b0000;">self</span>, x, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">random</span>=<span style="color: #8b0000;">None</span>):
        <span style="color: #228b22;">"""x, random=random.random -&gt; shuffle list x in place; return None.</span>

<span style="color: #228b22;">        Optional arg random is a 0-argument function returning a random</span>
<span style="color: #228b22;">        float in [0.0, 1.0); by default, the standard random.random.</span>

<span style="color: #228b22;">        """</span>

        <span style="color: #8b0000;">if</span> random <span style="color: #8b0000;">is</span> <span style="color: #8b0000;">None</span>:
            <span style="color: #000000; background-color: #cccccc; font-weight: bold;">random</span> = <span style="color: #8b0000;">self</span>.random
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">_int</span> =<span style="color: #cd0000;"> int</span>
        <span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span><span style="color: #cd0000;"> reversed(xrange</span>(<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,<span style="color: #cd0000;"> len</span>(x))):
            <span style="color: #ff0000; font-weight: bold;"># pick an element in x[:i+1] with which to exchange x[i]</span>
            <span style="color: #000000; background-color: #cccccc; font-weight: bold;">j</span> = _int(random() * (i+<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>))
            x[i], <span style="color: #000000; background-color: #cccccc; font-weight: bold;">x</span>[j] = x[j], x[i]
</pre>
</div>

<p>
It looks like we loop through the elements, and swap them at random.
</p>

<p>
We have a similar feature for xrange in emacs-lisp:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(number-sequence 1 5)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
<td class="right">3</td>
<td class="right">4</td>
<td class="right">5</td>
</tr>
</tbody>
</table>

<p>
Note that number-sequence includes the last value, unlike xrange. And for reverse:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(reverse (number-sequence 1 5))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">5</td>
<td class="right">4</td>
<td class="right">3</td>
<td class="right">2</td>
<td class="right">1</td>
</tr>
</tbody>
</table>

<p>
Of course, we can select random numbers:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(random 5) ; <span style="color: #ff0000; font-weight: bold;">random between 0 and 5</span>
</pre>
</div>

<pre class="example">
4
</pre>

<p>
Last, we need to work out how to swap to elements. It looks like this will swap elements 2 and 3. We store element 3 temporarily, set 3 to 2, and then set 2 to the temporarily stored value of 3.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let*</span> ((L '(1 2 3 4))
       (tmp (nth 3 L)))
  (setf (nth 3 L) (nth 2 L))
  (setf (nth 2 L) tmp)
L)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
<td class="right">4</td>
<td class="right">3</td>
</tr>
</tbody>
</table>

<p>
So, now we can shuffle our list.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq userids '(user1 user2 user3 user4 user5 user6))

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">swap</span> (LIST el1 el2)
  <span style="color: #228b22;">"in LIST swap indices EL1 and EL2 in place"</span>
  (<span style="color: #8b0000;">let</span> ((tmp (nth el1 LIST)))
    (setf (nth el1 LIST) (nth el2 LIST))
    (setf (nth el2 LIST) tmp)))

;; <span style="color: #ff0000; font-weight: bold;">now run the loop</span>
(loop for i in (reverse (number-sequence 1 (1- (length userids))))
      do (<span style="color: #8b0000;">let</span> ((j (random (+ i 1))))
           (swap userids i j)))

userids
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">user4</td>
<td class="left">user6</td>
<td class="left">user3</td>
<td class="left">user2</td>
<td class="left">user1</td>
<td class="left">user5</td>
</tr>
</tbody>
</table>

<p>
The order has certainly changed. It is a little difficult to tell how randomized it actually is, but what is important for my application is that the order is different each time I use it. It looks like this will accomplish that objective. I think this basically implements the algorithm in the Python random.shuffle code. That code does something a little differently. It generates a random float between 0-1, multiplies it by i + 1, and converts the result to an integer. We directly get an integer in the range of 0 to i + 1. I think the result is practically the same.
</p>

<p>
Finally, let us wrap the whole thing up in a nice neat function for future use. We will use elt instead of nth so it works for arrays too.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">swap</span> (LIST el1 el2)
  <span style="color: #228b22;">"in LIST swap indices EL1 and EL2 in place"</span>
  (<span style="color: #8b0000;">let</span> ((tmp (elt LIST el1)))
    (setf (elt LIST el1) (elt LIST el2))
    (setf (elt LIST el2) tmp)))


(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">shuffle</span> (LIST)
  <span style="color: #228b22;">"Shuffle the elements in LIST.</span>
<span style="color: #228b22;">shuffling is done in place."</span>
  (loop for i in (reverse (number-sequence 1 (1- (length LIST))))
        do (<span style="color: #8b0000;">let</span> ((j (random (+ i 1))))
             (swap LIST i j)))
  LIST)
</pre>
</div>

<pre class="example">
shuffle
</pre>

<p>
Example usage for a list:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(shuffle '(user1 user2 user3 user4 user5 user6))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">user4</td>
<td class="left">user2</td>
<td class="left">user3</td>
<td class="left">user5</td>
<td class="left">user6</td>
<td class="left">user1</td>
</tr>
</tbody>
</table>

<p>
And for a vector:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(shuffle [user1 user2 user3 user4 user5 user6])
</pre>
</div>

<pre class="example">
[user3 user2 user6 user4 user5 user1]
</pre>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Addendum</h2>
<div class="outline-text-2" id="text-1">
<p>
Artur at <a href="http://endlessparentheses.com">http://endlessparentheses.com</a> suggested one can use psetf to swap values. Thanks for the tip, I was not aware of that cool function. It evaluates the values first, then sets them, so there is no need for a temporary storage of a value! Here is an example usage. We could rewrite our swap function like this if we wanted.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((LIST '(1 2 3 4 5)))
  (psetf (elt LIST 2) (elt LIST 1)
         (elt LIST 1) (elt LIST 2))
LIST)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">3</td>
<td class="right">2</td>
<td class="right">4</td>
<td class="right">5</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/06/Randomize-a-list-in-Emacs.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2014/09/06/Randomize-a-list-in-Emacs#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="../1">« Previous Page</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/01/27/New-publication-in-Topics-in-Catalysis/">New publication in Topics in Catalysis</a></li>
      <li><a href="/blog/2018/01/03/New-publication-in-Molecular-Simulation/">New publication in Molecular Simulation</a></li>
      <li><a href="/blog/2017/12/31/2017-in-a-nutshell-for-the-Kitchin-Research-group/">2017 in a nutshell for the Kitchin Research group</a></li>
      <li><a href="/blog/2017/11/29/Solving-an-eigenvalue-differential-equation-with-a-neural-network/">Solving an eigenvalue differential equation with a neural network</a></li>
      <li><a href="/blog/2017/11/28/Solving-ODEs-with-a-neural-network-and-autograd/">Solving ODEs with a neural network and autograd</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



