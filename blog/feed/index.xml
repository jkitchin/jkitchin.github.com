<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
     xmlns:content="http://purl.org/rss/1.0/modules/content/"
     xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:wfw="http://wellformedweb.org/CommentAPI/"
     >
  <channel>
    <title>The Kitchin Research Group</title>
    <link>http://jkitchin.github.io/blog</link>
    <description>Chemical Engineering at Carnegie Mellon University</description>
    <pubDate>Mon, 23 Feb 2015 00:07:05 GMT</pubDate>
    <generator>Blogofile</generator>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>
    <item>
      <title>org-mode links meet hydra</title>
      <link>http://jkitchin.github.io/blog/2015/02/22/org-mode-links-meet-hydra</link>
      <pubDate>Sun, 22 Feb 2015 19:06:41 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[hydra]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">TYEqdqY8zmTBakbJFQgkXPMjC88=</guid>
      <description>org-mode links meet hydra</description>
      <content:encoded><![CDATA[


<p>
I have played with a lot of options to give org-mode links extra functionality. Here are a few of the ideas I have looked at so far.
</p>

<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links/">Enabling right clicks on links</a> 
</li>
<li>A home made minibuffer menu in org-ref
</li>
<li>A helm buffer in org-ref
</li>
</ol>

<p>
Here, I want to explore a hydra menu for a link. The idea is pretty simple, we need functions that do something with the link at point, and a hydra interface to call them. This turned out to be a little tricky. I could not get the path from the link in the link lambda function, and we need a way to pass the path to the function. I use a global variable for that. I wish there was another way to do that, but this does actually work. We illustrate it here with a more functional doi link.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-crossref</span> ()
  <span style="color: #036A07;">"Search DOI in CrossRef."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://search.crossref.org/?q=%s"</span> *doi-hydra-path*)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-google-scholar</span> ()
  <span style="color: #036A07;">"Google scholar the doi."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://scholar.google.com/scholar?q=%s"</span> *doi-hydra-path*)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-pubmed</span> ()
  <span style="color: #036A07;">"Pubmed the doi."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://www.ncbi.nlm.nih.gov/pubmed/?term=%s"</span>
    (url-hexify-string *doi-hydra-path*))))

 (defhydra doi-hydra ()
   <span style="color: #008000;">"org-ref"</span>
   (<span style="color: #008000;">"c"</span> doi-crossref <span style="color: #008000;">"Crossref"</span>)
   (<span style="color: #008000;">"g"</span> doi-google-scholar <span style="color: #008000;">"Google Scholar"</span>)
   (<span style="color: #008000;">"p"</span> doi-pubmed <span style="color: #008000;">"Pubmed"</span>))

(org-add-link-type <span style="color: #008000;">"doi"</span>
  (<span style="color: #0000FF;">lambda</span> (path) (setq *doi-hydra-path* path) (doi-hydra/body)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(path)</td>
<td class="left">(setq <b>doi-hydra-path</b> path)</td>
<td class="left">(doi-hydra/body)</td>
</tr>
</tbody>
</table>

<p>
Now for a test, <a href="10.1021/jp047349j">10.1021/jp047349j</a>.
</p>

<p>
It works fine, when you click on a link, you get a minibuffer menu with context hints, and pressing any other key than is defined simply cancels the command.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/22/org-mode-links-meet-hydra.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>org-ref meets hydra</title>
      <link>http://jkitchin.github.io/blog/2015/02/20/org-ref-meets-hydra</link>
      <pubDate>Fri, 20 Feb 2015 21:17:20 EST</pubDate>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">qjfPB2nhToDr-tiuGWfHxETUYh8=</guid>
      <description>org-ref meets hydra</description>
      <content:encoded><![CDATA[


<p>
I am enjoying learning about <a href="https://github.com/abo-abo/hydra">abo-abo/hydra</a> , which is a nice package for making minibuffer menus to run commands. It is light-weight solution that does not mess up your window too much, and it is easier to use than any home-grown solution I have made in the past. Here is a simple little code that gives me three options when I press "zz" quickly (a key-chord). I can press "c" to put in a cite link using helm, "r" to insert a ref link using helm, and "l" to insert a new label. Any other key just cancels the menu. One thing to remember ("zz"), and hints for the rest!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">hydra</span>)
(setq hydra-is-helpful t)

(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">key-chord</span>)
(key-chord-mode 1)
(key-chord-define-global
 <span style="color: #008000;">"zz"</span>
 (defhydra org-ref-hydra ()
   <span style="color: #008000;">"org-ref"</span>
   (<span style="color: #008000;">"c"</span> org-ref-helm-insert-cite-link <span style="color: #008000;">"cite"</span>)
   (<span style="color: #008000;">"r"</span> org-ref-helm-insert-ref-link <span style="color: #008000;">"ref"</span>)
   (<span style="color: #008000;">"l"</span> org-ref-helm-insert-label-link <span style="color: #008000;">"label"</span>)
   (<span style="color: #008000;">"R"</span> org-ref <span style="color: #008000;">"org-ref"</span>)))
</pre>
</div>

<pre class="example">
org-ref-hydra/body
</pre>

<p>
Pretty nice. Check out the nice hydra interface to <a href="https://github.com/jkitchin/jmax/blob/master/words.el">words.el</a> . A simple press of "ww" gets you easy access to single key presses of all the nice words functions. What would you hydra for?</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/20/org-ref-meets-hydra.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Extending the org-mode link syntax with attributes</title>
      <link>http://jkitchin.github.io/blog/2015/02/05/Extending-the-org-mode-link-syntax-with-attributes</link>
      <pubDate>Thu, 05 Feb 2015 10:06:25 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">lkBnYhulyhLMZBLWqqgRvAxph3o=</guid>
      <description>Extending the org-mode link syntax with attributes</description>
      <content:encoded><![CDATA[


<p>
I make super heavy use of links in org-mode. I use them extensively in org-ref to create functional citations. One detail that has never been very satisfactory is the need for pre/post text in citations. I don't need that capability often, but it seems important to some. I have implemented a kind of clunky solution where I use the description part of a link with the pre/post text separated by a ::. Although that works, I dislike the way it looks, the need to parse it, and that the description covers the link.
</p>

<pre class="example">
[[cite:key][pre text::post text]]
</pre>

<p>
Some <a href="https://lists.gnu.org/archive/html/emacs-orgmode/2010-08/msg00404.html">time ago</a> there was a suggestion of how to extend the link syntax, which was to my knowledge never implemented. Here is the proposed syntax:
</p>
<pre class="example">
$[link http://google.com
         :last-followed [2009-02-25 Wed 02:00]
         :label "click here for evil search engine"
         :export-label "click here for nice search engine"]
</pre>

<p>
This is interesting because this syntax suggests the link has attributes which can be updated.
</p>

<p>
We will show here how to implement part of this idea with the existing link syntax. We will make a link that has attributes like that. The basic idea is to simply incorporate the attributes into the path, and use lisp to read them. We will wrap the link path in parentheses and read that as a lisp data structure. So, a link like <i>link:key :pre "some pre text" :post "some post text"</i> will be parsed as:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(read <span style="color: #008000;">"(key :pre \"some pre text\" :post \"some post text\")"</span>)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">key</td>
<td class="left">:pre</td>
<td class="left">some pre text</td>
<td class="left">:post</td>
<td class="left">some post text</td>
</tr>
</tbody>
</table>

<p>
The car of that list is the key, and the cdr contains the attributes. The quotes are necessary here to make sure all the text is correctly parsed as a single element for each attribute. So, here is an example link
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type
 <span style="color: #008000;">"slink"</span>
 <span style="color: #8D8D84;">;;  </span><span style="color: #8D8D84; font-style: italic;">follow function</span>
 (<span style="color: #0000FF;">lambda</span> (path)
   (<span style="color: #0000FF;">let*</span> ((data (read (format <span style="color: #008000;">"(%s)"</span> path)))
          (head (car data))
          (plist (cdr data))
          (link (org-element-context))
          (begin (org-element-property <span style="color: #006FE0;">:begin</span> link))
          (end (org-element-property <span style="color: #006FE0;">:end</span> link)))
     (setq plist (plist-put plist <span style="color: #006FE0;">:last-clicked</span> (current-time-string)))
     (<span style="color: #0000FF;">save-excursion</span>
     (setf (buffer-substring begin end) <span style="color: #008000;">""</span>)
     (goto-char begin)
     (insert (format <span style="color: #008000;">"[[slink:%s %s]]"</span> head
         (substring (format <span style="color: #008000;">"%S"</span> plist) 1 -1))))))
 <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">format function</span>
 (<span style="color: #0000FF;">lambda</span> (path description backend)
   (<span style="color: #0000FF;">let*</span> ((data (read (concat <span style="color: #008000;">"("</span> path <span style="color: #008000;">")"</span>)))
          (head (car data))
          (plist (cadr data)))
     (format <span style="color: #008000;">"\\%s[%s][%s]{%s}"</span>
             (plist-get plist <span style="color: #006FE0;">:type</span>)
             (plist-get plist <span style="color: #006FE0;">:pre</span>)
             (plist-get plist <span style="color: #006FE0;">:post</span>)
             head))))
</pre>
</div>

<p>
Now, each time I click on this link, the time stamp gets updated.
</p>

<p>
\nil[nil][nil]{kitchin-2010}
</p>

<pre class="example">
[[slink:kitchin-2010 :pre "See for example" :post "page 47" :type "cite" :last-clicked "Thu Feb  5 09:31:15 2015"]]
</pre>


<p>
And, the generic export of this link is:
</p>

<pre class="example">
\cite[See for example][page 47]{kitchin-2010}
</pre>

<p>
Is this a good idea? I am not using this for anything right now. Sometimes my version of org-mode has trouble recognizing that is a link. It is strange, as I am typing, sometimes it flashes in and out of being recognized as a link. Anyway, it is an interesting idea!</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/05/Extending-the-org-mode-link-syntax-with-attributes.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Helm at the Emacs</title>
      <link>http://jkitchin.github.io/blog/2015/02/04/Helm-at-the-Emacs</link>
      <pubDate>Wed, 04 Feb 2015 08:47:40 EST</pubDate>
      <category><![CDATA[helm]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">BQa4exu2NqS2LIJDkrMHfiML8kw=</guid>
      <description>Helm at the Emacs</description>
      <content:encoded><![CDATA[


<p>
I have written several (<a href="http://kitchingroup.cheme.cmu.edu/blog/2015/01/24/Anatomy-of-a-helm-source/">intro</a> , <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/02/01/Handling-multiple-selections-in-helm/">multiple args</a> , <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/02/03/helm-and-prefix-functions/">prefix args)</a> times about using Helm in Emacs so far. Today, I want to share a way I use helm to get me where I want to be in Emacs for my daily activities. This came out of a desire to have single command that would give me a lot of options to open exactly the buffer/file I wanted when I need it. I call the command hotspots, and it is bound to f9 for me, so when I press f9 I get a helm buffer to select what I want from.
</p>

<p>
So, what kinds of things do I want. First, I want to be able to open my mail, calendar, News feed or agenda from this command. Second, I have a list of hotspots I developed using the code at <a href="http://ergoemacs.org/emacs/emacs_hotkey_open_file_fast.html">http://ergoemacs.org/emacs/emacs_hotkey_open_file_fast.html</a> , which I want easy access to. Third, I want to be able to open any org-file in my agenda list. Fourth, any bookmark I have, or to set a bookmark. Fifth, I want recent files as candidates. There is certainly some redundancy in their, but that is ok, it gets me where I want to be.
</p>

<p>
Here is the code that does that for me. There are six helm sources that provide candidates and actions.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">hotspots</span> ()
  <span style="color: #036A07;">"helm interface to my hotspots, which includes my locations,</span>
<span style="color: #036A07;">org-files and bookmarks"</span>
  (interactive)
  (helm <span style="color: #006FE0;">:sources</span> `(((name . <span style="color: #008000;">"Mail and News"</span>)
                    (candidates . ((<span style="color: #008000;">"Mail"</span> . (<span style="color: #0000FF;">lambda</span> ()
                                               (<span style="color: #0000FF;">if</span> (get-buffer <span style="color: #008000;">"*mu4e-headers*"</span>)
                                                   (<span style="color: #0000FF;">progn</span>
                                                     (switch-to-buffer <span style="color: #008000;">"*mu4e-headers*"</span>)
                                                     (delete-other-windows))

                                                 (mu4e))))
                                   (<span style="color: #008000;">"Calendar"</span> . (<span style="color: #0000FF;">lambda</span> ()  (browse-url <span style="color: #008000;">"https://www.google.com/calendar/render"</span>)))
                                   (<span style="color: #008000;">"RSS"</span> . elfeed)
                                   (<span style="color: #008000;">"Agenda"</span> . (<span style="color: #0000FF;">lambda</span> () (org-agenda <span style="color: #008000;">""</span> <span style="color: #008000;">"w"</span>)))))
                    (action . ((<span style="color: #008000;">"Open"</span> . (<span style="color: #0000FF;">lambda</span> (x) (funcall x))))))
                   ((name . <span style="color: #008000;">"My Locations"</span>)
                    (candidates . ((<span style="color: #008000;">"master"</span> . <span style="color: #008000;">"~/Dropbox/org-mode/master.org"</span>)
                                   (<span style="color: #008000;">".emacs.d"</span> . <span style="color: #008000;">"~/Dropbox/kitchingroup/jmax"</span> )
                                   (<span style="color: #008000;">"blog"</span> . <span style="color: #008000;">"~/blogofile-jkitchin.github.com/_blog/blog.org"</span>)
                                   (<span style="color: #008000;">"ese"</span> . <span style="color: #008000;">"~/Dropbox/books/ese-book/ese.org"</span> )
                                   (<span style="color: #008000;">"passwords"</span> . <span style="color: #008000;">"~/Dropbox/org-mode/passwords.org.gpg"</span>)
                                   (<span style="color: #008000;">"Pycse"</span> . <span style="color: #008000;">"~/Dropbox/books/pycse/pycse.org"</span>)
                                   (<span style="color: #008000;">"references"</span> . <span style="color: #008000;">"~/Dropbox/bibliography/references.bib"</span>)
                                   (<span style="color: #008000;">"notes"</span> . <span style="color: #008000;">"~/Dropbox/bibliography/notes.org"</span>)
                                   (<span style="color: #008000;">"journal"</span> . <span style="color: #008000;">"~/Dropbox/org-mode/journal.org"</span>)
                                   (<span style="color: #008000;">"tasks"</span> . <span style="color: #008000;">"~/Dropbox/org-mode/tasks.org"</span>)))
                    (action . ((<span style="color: #008000;">"Open"</span> . (<span style="color: #0000FF;">lambda</span> (x) (find-file x))))))

                   ((name . <span style="color: #008000;">"My org files"</span>)
                    (candidates . ,(f-entries <span style="color: #008000;">"~/Dropbox/org-mode"</span>))
                    (action . ((<span style="color: #008000;">"Open"</span> . (<span style="color: #0000FF;">lambda</span> (x) (find-file x))))))
                   helm-source-recentf
                   helm-source-bookmarks
                   helm-source-bookmark-set)))
</pre>
</div>

<p>
Interesting to me is that there are not a lot of actions in here. I mostly use this command for navigation to various places. For example, I press f9, type meet, and I can quickly get to the meetings file in my agenda list, or I can type the first few letters of a student's name and open the org-file associated with them. Or I press f9 and go down an entry to open my calendar, etc&#x2026; I find this enormously helpful because it opens these files no matter where I am in Emacs, and it relieves my mind from remembering where they are, or the keystrokes/commands to get to them.</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/04/Helm-at-the-Emacs.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>helm and prefix functions</title>
      <link>http://jkitchin.github.io/blog/2015/02/03/helm-and-prefix-functions</link>
      <pubDate>Tue, 03 Feb 2015 11:12:53 EST</pubDate>
      <category><![CDATA[helm]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">8N-R8vMLReQ31rBXzaetXNyodro=</guid>
      <description>helm and prefix functions</description>
      <content:encoded><![CDATA[


<p>
Helm modifies how you use <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Prefix-Command-Arguments.html">prefix arguments</a> in Emacs. A prefix argument is when you type C-u before a command to modify its behavior. There are a few variations of prefix arguments. Basically, pressing C-u once sets a prefix variable to '(4), pressing twice sets it to '(16). Alternatively, C-u 7 sets the prefix to 7. In regular emacs commands, you type the prefix keys before the command. In helm, you type the after you enter the helm selection buffer, and before you press enter or select your action. In helm, you access the prefix arg in the variable helm-current-prefix-arg. Let us look at how you might use it.
</p>

<p>
We make an action function that does something conditionally depending on the prefix arg. Yes, you could write several functions to accomplish that too, but maybe there is just a little difference that you can use the prefix arg to handle. What you cannot remember 4 prefix options? You do write good doc strings on your functions right ;) If not, you probably ought to write four functions with meaningful names, and meaningful helm descriptions!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">action</span> (candidate)
  <span style="color: #036A07;">"Our action function.</span>
<span style="color: #036A07;">with no prefix message no prefix arg</span>
<span style="color: #036A07;">with one prefix arg message C-u</span>
<span style="color: #036A07;">with two prefix args message C-u C-u</span>
<span style="color: #036A07;">with a numeric prefix arg, message the number."</span>
  (interactive <span style="color: #008000;">"p"</span>)
  (<span style="color: #0000FF;">cond</span>
   ((eq nil helm-current-prefix-arg)
    (message-box <span style="color: #008000;">"no prefix arg"</span>))
   ((equal helm-current-prefix-arg '(4))
    (message-box <span style="color: #008000;">"C-u"</span>))
   ((equal helm-current-prefix-arg '(16))
    (message-box <span style="color: #008000;">"C-u C-u"</span>))
   (t
    (message-box (format <span style="color: #008000;">"C-u %s"</span> helm-current-prefix-arg)))))

(setq some-helm-source
      '((name . <span style="color: #008000;">"HELM at the Emacs"</span>)
        (candidates . (1 2 3 4))
        (action . action)))

(helm <span style="color: #006FE0;">:sources</span> '(some-helm-source))
</pre>
</div>

<pre class="example">
C-u (64)
</pre>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/03/helm-and-prefix-functions.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>helm actions when there is no match</title>
      <link>http://jkitchin.github.io/blog/2015/02/02/helm-actions-when-there-is-no-match</link>
      <pubDate>Mon, 02 Feb 2015 16:31:07 EST</pubDate>
      <category><![CDATA[uncategorized]]></category>
      <guid isPermaLink="false">6xQtR-zTp9q98z6VO9YTfH1mqCY=</guid>
      <description>helm actions when there is no match</description>
      <content:encoded><![CDATA[



<p>
Sometimes you run out of matches in a helm selection buffer, and all that is left is the pattern you have typed in. It turns out you can perform some action on that pattern! Why would you do that? Suppose you are searching your bibliography, and you do not find what you are looking for. Then, you may want to send the pattern to Google, or some other search engine to see what comes up.
</p>

<p>
The key to handling this situation is to use <i>two</i> sources in your helm session. One that works on the candidates and deals with actions on them, and one that has no candidates, and works on the pattern. The variable helm-pattern contains what you typed in. We call the second source the Fallback option. The second source has no candidates, and we use (dummy) in place of the candidates.
</p>

<p>
It easy to add two sources. Here we define the sources as variables, and use the variables in the :sources list to the helm command.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">some-action</span> (arg)
  (message-box <span style="color: #008000;">"%s\n%s"</span>
    (helm-get-selection)
    (helm-marked-candidates)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">default-action</span> (candidate)
  (browse-url
   (format
    <span style="color: #008000;">"http://www.google.com/search?q=%s"</span> (url-hexify-string helm-pattern))))

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">source1</span> '((name . <span style="color: #008000;">"HELM"</span>)
                  (candidates . (1 2 3 4))
                  (action . ((<span style="color: #008000;">"open"</span> . some-action)))))

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">fallback-source</span> '((name . <span style="color: #008000;">"fallback"</span>)
                          (dummy)
                          (action . ((<span style="color: #008000;">"Google"</span> . default-action)))))

(helm <span style="color: #006FE0;">:sources</span> '(source1 fallback-source))
</pre>
</div>

<pre class="example">
#&lt;process open http://www.google.com/search?q=addtion%20pul&gt;
</pre>

<p>
When you run this, if you run out of search candidates, all that will be left is the fallback option, and when you press enter, it will launch a browser pointing to the google search for your pattern.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/02/helm-actions-when-there-is-no-match.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Handling multiple selections in helm</title>
      <link>http://jkitchin.github.io/blog/2015/02/01/Handling-multiple-selections-in-helm</link>
      <pubDate>Sun, 01 Feb 2015 08:51:26 EST</pubDate>
      <category><![CDATA[helm]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">N5qxsrIWtmCMMl_qTvm4aKnq_-Y=</guid>
      <description>Handling multiple selections in helm</description>
      <content:encoded><![CDATA[


<p>
The basic usage pattern of helm is you run a command which opens a buffer of choices. You enter some text in the minibuffer which eliminates choices that do not match what you type in. You can select multiple choices by using C-spc, or M-a to mark them all. When you press enter, the current selection is sent to the default action defined. The action is a function that does something, usually on the selected item(s). Here, we explore writing the action function to do what we want. The reason this is somewhat tricky is that when you mark an item in helm, the "cursor" moves to the next item, which means when you press enter it may be possible that the current highlighted item is not part of the items you have marked. If your action will perform a delete action, for example, you may have wanted to delete the marked items, and <i>not</i> the current selection! So, what we need is a way to get what we want.
</p>

<p>
An action function in helm should normally take one argument, which is going to be the currently selected item from helm. However, we can use two different functions to access either the selected item (helm-get-selection) or the marked items (helm-marked-candidates). So, we can write our function to do "do what we mean". Note, even if you do not mark any candidates,  (helm-marked-candidates) will return a list that has the current selection in it. So we can write our action function to act on this list so it works on what is marked or what is selected if nothing is marked. That is probably "what we mean".
</p>

<p>
Here is one way to work on a selection or marked list of selections. We define an action function that takes an arg, but inside we operate on each element of the marked candidates.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">some-action</span> (candidate)
  (loop for cand in (helm-marked-candidates)
        do
        (message-box <span style="color: #008000;">"working on %s"</span> cand)))

(helm <span style="color: #006FE0;">:sources</span> '(((name . <span style="color: #008000;">"HELM"</span>)
                  (candidates . (1 2 3 4))
                  (action . ((<span style="color: #008000;">"open"</span> . some-action))))))
</pre>
</div>


<p>
Here is an alternative approach. Here we define the action function to work on one candidate. That might be helpful for testing, for example. Then, we use mapc to apply the function to each marked candidate.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">some-action</span> (candidate)
  (message-box <span style="color: #008000;">"single working on %s"</span> candidate))

(helm <span style="color: #006FE0;">:sources</span> '(((name . <span style="color: #008000;">"HELM"</span>)
                  (candidates . (1 2 3 4))
                  (action . ((<span style="color: #008000;">"open"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                         (mapc
                                          'some-action
                                          (helm-marked-candidates)))))))))
</pre>
</div>

<p>
A little more verbose method might be like this. Here we just pull out the lambda function to another function, to make the helm source definition a little shorter. I cannot tell if this is easier to follow, it is just another option.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">some-action</span> (candidate)
  (message-box <span style="color: #008000;">"single2 working on %s"</span> candidate))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">some-actions</span> (candidate)
  (mapc 'some-action (helm-marked-candidates)))

(helm <span style="color: #006FE0;">:sources</span> '(((name . <span style="color: #008000;">"HELM"</span>)
                  (candidates . (1 2 3 4))
                  (action . some-actions))))
</pre>
</div>


<p>
So there you have it. You can select multiple things in helm, and then operate on them with your action function!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/01/Handling-multiple-selections-in-helm.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Turn an ISBN to a bibtex entry</title>
      <link>http://jkitchin.github.io/blog/2015/01/31/Turn-an-ISBN-to-a-bibtex-entry</link>
      <pubDate>Sat, 31 Jan 2015 15:48:39 EST</pubDate>
      <category><![CDATA[bibtex]]></category>
      <guid isPermaLink="false">r4J6MnDJgujiwuNPEsngAyRriio=</guid>
      <description>Turn an ISBN to a bibtex entry</description>
      <content:encoded><![CDATA[


<p>
Occasionally, I need a bibtex entry for a book. Books are often identified by an ISBN number. Similar to using Crossref to get metadata about a DOI, we can use a web service to get metadata about an ISBN. From that, we might be able to construct a bibtex entry.
</p>

<p>
Here is an example of what we can get for ISBN 9780309095211. It does not seem to matter if there are dashes in the ISBN or not.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">with-current-buffer</span>
        (url-retrieve-synchronously
<span style="color: #008000;">"http://xisbn.worldcat.org/webservices/xid/isbn/9780309095211?method=getMetadata&amp;format=json&amp;fl=*"</span>)
      (buffer-substring url-http-end-of-headers (point-max)))
</pre>
</div>

<pre class="example">
{
 "stat":"ok",
 "list":[{
	"url":["http://www.worldcat.org/oclc/224969280?referer=xid"],
	"publisher":"National Academies Press",
	"form":["BC"],
	"lccn":["2006016786"],
	"lang":"eng",
	"city":"Washington, D.C.",
	"author":"Committee on the Guide to Recruiting and Advancing Women Scientists and Engineers in Academia, Committee on Women in Science and Engineering, Policy and Global Affairs, National Research Council of the National Academies.",
	"ed":"[Online-Ausg.]",
	"year":"2006",
	"isbn":["9780309095211"],
	"title":"To recruit and advance women students and faculty in science and engineering",
	"oclcnum":["224969280",
	 "70060944",
	 "756709329",
	 "804792476",
	 "817950524",
	 "833420290",
	 "836338922",
	 "704551455"]}]}
</pre>

<p>
We get a nice json data string back. We can parst that to get an actual data structure.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">with-current-buffer</span>
        (url-retrieve-synchronously
<span style="color: #008000;">"http://xisbn.worldcat.org/webservices/xid/isbn/9780309095211?method=getMetadata&amp;format=json&amp;fl=*"</span>)
      (json-read-from-string
        (buffer-substring url-http-end-of-headers (point-max))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">((list .
       [((oclcnum .
                  [<span style="color: #008000;">"224969280"</span> <span style="color: #008000;">"70060944"</span> <span style="color: #008000;">"756709329"</span> <span style="color: #008000;">"804792476"</span> <span style="color: #008000;">"817950524"</span> <span style="color: #008000;">"833420290"</span> <span style="color: #008000;">"836338922"</span> <span style="color: #008000;">"704551455"</span>])
         (title . <span style="color: #008000;">"To recruit and advance women students and faculty in science and engineering"</span>)
         (isbn .
               [<span style="color: #008000;">"9780309095211"</span>])
         (year . <span style="color: #008000;">"2006"</span>)
         (ed . <span style="color: #008000;">"[Online-Ausg.]"</span>)
         (author . <span style="color: #008000;">"Committee on the Guide to Recruiting and Advancing Women Scientists and Engineers in Academia, Committee on Women in Science and Engineering, Policy and Global Affairs, National Research Council of the National Academies."</span>)
         (city . <span style="color: #008000;">"Washington, D.C."</span>)
         (lang . <span style="color: #008000;">"eng"</span>)
         (lccn .
               [<span style="color: #008000;">"2006016786"</span>])
         (form .
               [<span style="color: #008000;">"BC"</span>])
         (publisher . <span style="color: #008000;">"National Academies Press"</span>)
         (url .
              [<span style="color: #008000;">"http://www.worldcat.org/oclc/224969280?referer=xid"</span>]))])
 (stat . <span style="color: #008000;">"ok"</span>))
</pre>
</div>

<p>
Ok, so we should check that stat is ok, then build the bibtex entry. Accessing the metadata below seems pretty hacky; but it works, and I don't understand the deep nesting of results, and there seems to be a vector in there.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let*</span> ((results  (<span style="color: #0000FF;">with-current-buffer</span>
                    (url-retrieve-synchronously
                     <span style="color: #008000;">"http://xisbn.worldcat.org/webservices/xid/isbn/9780309095211?method=getMetadata&amp;format=json&amp;fl=*"</span>)
                  (json-read-from-string
                   (buffer-substring url-http-end-of-headers (point-max)))))
       (status (cdr (nth 1 results)))
       (metadata (aref (cdar results) 0)))

  (<span style="color: #0000FF;">unless</span> (string= <span style="color: #008000;">"ok"</span> status)
    (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Status is %s"</span> status))

  (concat <span style="color: #008000;">"@book{,\n"</span>
          (mapconcat (<span style="color: #0000FF;">lambda</span> (x)
                       (format <span style="color: #008000;">"  %s={%s},"</span> (car x) (cdr x)))
                     metadata <span style="color: #008000;">"\n"</span>)
          <span style="color: #008000;">"}\n"</span>))
</pre>
</div>

<pre class="example">
@book{,
  oclcnum={[224969280 70060944 756709329 804792476 817950524 833420290 836338922 704551455]},
  title={To recruit and advance women students and faculty in science and engineering},
  isbn={[9780309095211]},
  year={2006},
  ed={[Online-Ausg.]},
  author={Committee on the Guide to Recruiting and Advancing Women Scientists and Engineers in Academia, Committee on Women in Science and Engineering, Policy and Global Affairs, National Research Council of the National Academies.},
  city={Washington, D.C.},
  lang={eng},
  lccn={[2006016786]},
  form={[BC]},
  publisher={National Academies Press},
  url={[http://www.worldcat.org/oclc/224969280?referer=xid]},}
</pre>

<p>
That looks good to me. Let us finally wrap it into a function that will take an ISBN and bibtex file interactively, create a bibtex entry, and insert it if there is not an entry with a key like that already. If we have selected region, lI should note this code uses some functionality from my org-ref package (and when I am done here, I am adding it to the doi-utils package inside org-ref). This is a fancy function, built from the experience I have from writing doi-utils.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">isbn-to-bibtex</span> (isbn bibfile)
  <span style="color: #036A07;">"Get bibtex entry for ISBN and insert it into BIBFILE unless an</span>
<span style="color: #036A07;">entry with the generated key already exists in the file."</span>
  (interactive
   (list
    (read-input
     <span style="color: #008000;">"ISBN: "</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now set initial input</span>
     (<span style="color: #0000FF;">cond</span>
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">If region is active and it starts with a number, we use it</span>
      ((and  (region-active-p)
             (s-match <span style="color: #008000;">"^[0-9]"</span> (buffer-substring (region-beginning) (region-end))))
       (buffer-substring (region-beginning) (region-end)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">if first entry in kill ring starts with a number assume it is an isbn</span>
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and use it as the guess</span>
      ((<span style="color: #0000FF;">if</span> (s-match <span style="color: #008000;">"^[0-9]"</span> (car kill-ring))
           (car kill-ring)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">type or paste it in</span>
      (t
       nil)))
    (ido-completing-read
     <span style="color: #008000;">"Bibfile: "</span>
     (append (f-entries <span style="color: #008000;">"."</span> (<span style="color: #0000FF;">lambda</span> (f) (f-ext? f <span style="color: #008000;">"bib"</span>)))
             org-ref-default-bibliography))))

  (<span style="color: #0000FF;">let*</span> ((results (<span style="color: #0000FF;">with-current-buffer</span>
                      (url-retrieve-synchronously
                       (format
                        <span style="color: #008000;">"http://xisbn.worldcat.org/webservices/xid/isbn/%s?method=getMetadata&amp;format=json&amp;fl=*"</span>
                        isbn))
                    (json-read-from-string
                     (buffer-substring url-http-end-of-headers (point-max)))))
         (status (cdr (nth 1 results)))
         (metadata (aref (cdar results) 0))
         (new-entry)
         (new-key))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">check if we got something</span>
    (<span style="color: #0000FF;">unless</span> (string= <span style="color: #008000;">"ok"</span> status)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Status is %s"</span> status))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">construct an alphabetically sorted bibtex entry. I assume ISBN numbers go</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">with book entries.</span>
    (setq new-entry
          (concat <span style="color: #008000;">"\n@book{,\n"</span>
                  (mapconcat
                   'identity
                   (loop for field in (-sort 'string-lessp (mapcar 'car metadata))
                         collect
                         (format <span style="color: #008000;">"  %s={%s},"</span> field (cdr (assoc field metadata))))
                   <span style="color: #008000;">"\n"</span>)
                  <span style="color: #008000;">"\n}\n"</span>))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">build entry in temp buffer to get the key so we can check for duplicates</span>
    (setq new-entry (<span style="color: #0000FF;">with-temp-buffer</span>
                      (insert new-entry)
                      (org-ref-clean-bibtex-entry)
                      (setq new-key (bibtex-key-in-head))
                      (buffer-string)))
    (find-file bibfile)
    (goto-char (point-min))
    (<span style="color: #0000FF;">when</span> (search-forward new-key nil t)
      (beep)
      (setq new-key (read-input
                     (format  <span style="color: #008000;">"%s already exists. Enter new key (C-g to cancel): "</span> new-key)
                     new-key)))
    (goto-char (point-max))
    (insert new-entry)
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">set key. It is simplest to just replace it, even if it is the same.</span>
    (bibtex-beginning-of-entry)
    (re-search-forward bibtex-entry-maybe-empty-head)
    (<span style="color: #0000FF;">if</span> (match-beginning bibtex-key-in-head)
        (delete-region (match-beginning bibtex-key-in-head)
                       (match-end bibtex-key-in-head)))
    (insert new-key)
    (bibtex-fill-entry)
    (save-buffer)))
</pre>
</div>

<pre class="example">
isbn-to-bibtex
</pre>

<p>
That is it, for the one ISBN I have tested it on, I get a nicely sorted bibtex entry in the file I select! Hopefully that means no more tedious bibtex entry entering for books! If you use org-ref, just update to the latest version and you should be able to use this function.
</p>

<p>
Now, back to that proposal I am writing that needs a lot of citations to books that are not in my bibtex file yet, but will be soon ;)
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/01/31/Turn-an-ISBN-to-a-bibtex-entry.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>More adventures in helm - more than one action</title>
      <link>http://jkitchin.github.io/blog/2015/01/30/More-adventures-in-helm-more-than-one-action</link>
      <pubDate>Fri, 30 Jan 2015 08:00:16 EST</pubDate>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">_HTg08cujf5IREAJYfTp1bU5n2M=</guid>
      <description>More adventures in helm - more than one action</description>
      <content:encoded><![CDATA[


<p>
We continue our <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/01/24/Anatomy-of-a-helm-source/">exploration of helm</a> and now consider how to have more than one action for a selection. When you press enter, helm runs the default action defined, but you can define more than one action, and choose which one to run. How do you know if there are multiple actions? Press C-z in helm and you will get a new helm buffer showing the actions. The first action is the default, and you can select the the actions with function keys, e.g. f1 is the first action, f2 is the second action, or you can select the action and press enter.
</p>

<p>
The main difference in setting up multiple actions is that instead of a single function for action in the source definition, we provide a list of cons cells for the action element of the helm source. Each action cons cell should have a descriptive string as the car that identifies the action. This will be shown in the helm buffer. The cdr should be the function to run on the candidate. The function will be called with the selection, so the function must take one argument.
</p>

<p>
Here is an example where we have two actions. The default action will just show us the email address of the selected candidates in a message box. It will show as a list. The second action opens an email window and inserts the selected candidates in the To: field as a comma separated list. I use helm-selected-candidates in these functions instead of the just the current selected candidate so we can have multiple selections. I define the first function as a lambda function, and the second one as a defun to illustrate how to use both approaches. You can have as many actions as you want, so you could consider functions that open notes about the person, or open your contacts to look up a phone number, or functions with template emails you send often, etc&#x2026;
</p>

<p>
Now, you have these options to run those actions.
</p>

<ol class="org-ol">
<li>Make a selection and press enter. That runs the first (and default) action to show you a message box.
</li>
<li>Make a selection and press C-z to see what actions are available. Select the action you want, and press enter.
</li>
<li>Make a selection and press F1 to run the default action, or F2 to run the second action.
</li>
</ol>

<p>
Here is our code.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq data '((<span style="color: #008000;">"John"</span> . <span style="color: #008000;">"john@email.com"</span>)
             (<span style="color: #008000;">"Jim"</span> . <span style="color: #008000;">"jim@email.com"</span>)
             (<span style="color: #008000;">"Jane"</span> . <span style="color: #008000;">"jane@email.com"</span>)
             (<span style="color: #008000;">"Jill"</span> . <span style="color: #008000;">"jill@email.com"</span>)))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">open-email</span> (candidates)
  <span style="color: #036A07;">"Compose an email to the candidates. Fill in the addresses and</span>
<span style="color: #036A07;">move point to the subject."</span>
  (compose-mail)
  (message-goto-to)
  (insert
   (mapconcat
    'identity
    (helm-marked-candidates)
    <span style="color: #008000;">","</span>))
  (message-goto-subject))

(setq some-helm-source
      `((name . <span style="color: #008000;">"HELM at the Emacs"</span>)
        (candidates . ,data)
        (action . ((<span style="color: #008000;">"show email address"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                             (message-box
                                              <span style="color: #008000;">"selected: %s"</span>
                                              (helm-marked-candidates))))
                   (<span style="color: #008000;">"send email"</span> . open-email)))))

(helm <span style="color: #006FE0;">:sources</span> '(some-helm-source))
</pre>
</div>

<pre class="example">
t
</pre>

<p>
Now, you can define multiple actions for your selection in helm!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/01/30/More-adventures-in-helm---more-than-one-action.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Export org-mode to docx with citations via pandoc</title>
      <link>http://jkitchin.github.io/blog/2015/01/29/Export-org-mode-to-docx-with-citations-via-pandoc</link>
      <pubDate>Thu, 29 Jan 2015 07:34:14 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[docx]]></category>
      <guid isPermaLink="false">SQ3JHeoJiZ9SqSQj6aLJepZ7lho=</guid>
      <description>Export org-mode to docx with citations via pandoc</description>
      <content:encoded><![CDATA[


<p>
Pandoc continues to develop, and since <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/07/17/Pandoc-does-org-mode-now/">the last time</a> I wrote about it there is improved support for citations. We will use that to convert org documents to Word documents that actually have citations and a bibliography in them. This post explores using helm-bibtex to insert pandoc compatible citations, and then using pandoc to convert the org file to a word document (docx). We can define the format of citations that helm-bibtex inserts in a function, and tell helm-bibtex to use it when in org mode.
</p>

<p>
Here is that code. This is just to give me a convenient tool to insert citations with searching in my bibtex file. I think you could just as easily use reftex for this, or an ido-completing function on bibtex keys. See <a href="http://johnmacfarlane.net/pandoc/README.html">Pandoc - Pandoc Users Guide</a> for directions on citation format. The key is to format the cite links to the pandoc format.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">helm-bibtex-format-pandoc-citation</span> (keys)
  (concat <span style="color: #008000;">"["</span> (mapconcat (<span style="color: #0000FF;">lambda</span> (key) (concat <span style="color: #008000;">"@"</span> key)) keys <span style="color: #008000;">"; "</span>) <span style="color: #008000;">"]"</span>))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">inform helm-bibtex how to format the citation in org-mode</span>
(setf (cdr (assoc 'org-mode helm-bibtex-format-citation-functions))
  'helm-bibtex-format-pandoc-citation)
</pre>
</div>
<pre class="example">
helm-bibtex-format-pandoc-citation
</pre>

<p>
Now, we can cite the org-mode book [@dominik-2010-org-mode], and some interesting papers on using org-mode [@schulte-2011-activ-docum; @schulte-2012-multi-languag]. You could pretty easily add pre and post text manually to these, after selecting and inserting them.
</p>

<p>
We need a bibliography file for pandoc to work. I will use a bibtex file, since I already have it and am using helm-bibtex to select keys. I found pandoc could not read my massive bibtex file, perhaps it does not support all the types yet, so I made a special small bibtex file for this. So, now all we need to do is convert this file to a docx. I use a function like this to do that. It uses an org-ref function to get the bibliography defined in this file, derives some file names, and then runs pandoc.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ox-export-to-docx-and-open</span> ()
 <span style="color: #036A07;">"Export the current org file as a docx via markdown."</span>
 (interactive)
 (<span style="color: #0000FF;">let*</span> ((bibfile (expand-file-name (car (org-ref-find-bibliography))))
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is probably a full path</span>
        (current-file (buffer-file-name))
        (basename (file-name-sans-extension current-file))
        (docx-file (concat basename <span style="color: #008000;">".docx"</span>)))
   (save-buffer)
   (<span style="color: #0000FF;">when</span> (file-exists-p docx-file) (delete-file docx-file))
   (shell-command (format
                   <span style="color: #008000;">"pandoc -s -S --bibliography=%s %s -o %s"</span>
                   bibfile current-file docx-file))
   (org-open-file docx-file '(16))))
</pre>
</div>

<p>
And now we run it to get our docx.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(ox-export-to-docx-and-open)
</pre>
</div>

<p>
Here is the result: <a href="/media/2015-01-29-Export-org-mode-to-docx-with-citations-via-pandoc/org-to-docx-pandoc.docx">org-to-docx-pandoc.docx</a> 
</p>

<p>
It is not too bad. Not all the equations showed up below, and the figure did not appear for some reason. But, the citations went through fine.  A downside of this is the citation links are not clickable (but see <a href="#sec-7">Making pandoc links</a> for a way to do this), so they lack all the awesome features that org-ref gives them. Maybe pandoc can convert these to LaTeX links, but we already have such a good framework for that I do not see why you would want to do it. A better option is to figure out how to export the org file to an org file, and transform the org citation links to pandoc citations, then use pandoc on the temporarily transformed buffer. That way, you keep the cite links and their functionality, and ability to export to many formats, <i>and</i> get export to docx via pandoc.
</p>

<p>
There are other options in pandoc to fine tune the reference format (you need a csl file). That can be included in the org-file via file tags pretty easily. These citations are not links in the word document, and it does not look like they can be converted to footnotes, endnotes or interact with Endnote or Zotero at this time, but it is a step forward in getting a passable word document with references out of org-mode!
</p>

<p>
Since we are testing, let us try it some other typical features in an org-file.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Numbered list</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Item 1
</li>
<li>Item 2
</li>
<li>Item 3
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Bulleted list</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>item 1
</li>
<li>item 2
</li>
<li>item 3
<ul class="org-ul">
<li>subitem
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> definitions</h2>
<div class="outline-text-2" id="text-3">
<dl class="org-dl">
<dt> org-mode </dt><dd>tool for awesomeness
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Math</h2>
<div class="outline-text-2" id="text-4">
<p>
One equation:
<img src="ltxpng/org-to-docx-pandoc_71dd900d7f17a20875918a89a10eb146fccdd464.png" alt="\(e^{i\pi} - 1 = 0\)" />
</p>

<p>
A second equation:
</p>


<div class="figure">
<p><img src="ltxpng/org-to-docx-pandoc_fb56117cdd3c3ac81c363d24325cfc6b5a530420.png" alt="\begin{equation}
e^{i\pi} - 1 = 0
\end{equation}" /></p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> An image</h2>
<div class="outline-text-2" id="text-5">

<div id="icon" class="figure">
<p><img src="/media/2015-01-29-Export-org-mode-to-docx-with-citations-via-pandoc/emacs.png"> 
</p>
<p><span class="figure-number">Figure 1:</span> A little icon.</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> A table</h2>
<div class="outline-text-2" id="text-6">
<table id="my-table" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> A little table.</caption>

<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">4</td>
</tr>
</tbody>
</table>


<p>
a plain table
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">4</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><a id="ID-2958EFDC-CC33-4E2A-8A92-D2BE06EBB3F2" name="ID-2958EFDC-CC33-4E2A-8A92-D2BE06EBB3F2"></a><span class="section-number-2">7</span> Making pandoc links</h2>
<div class="outline-text-2" id="text-7">
<p>
Here I show a way to get clickable text on pandoc links. I found a nice library called <a href="https://github.com/rolandwalker/button-lock">button-lock</a> that uses a regular expression to attach text properties to matching text.
</p>

<p>
Below I repeat the citations so it is easy to see the effect after running the code block. Indeed, you get clickable text, even org-ref like capability. I think you could even add the idle-timer messages, and the org-ref menu.
</p>

<p>
Now, we can cite the org-mode book [@dominik-2010-org-mode], and some interesting papers on using org-mode [@schulte-2011-activ-docum; @schulte-2012-multi-languag]. You could pretty easily add pre and post text manually to these, after selecting and inserting them.
</p>

<p>
You would need to make this code run in when you open an org-file to get it to work every time.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">button-lock</span>)
(global-button-lock-mode)

(button-lock-set-button
 <span style="color: #008000;">"@</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[-a-zA-Z0-9_:]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
 (<span style="color: #0000FF;">lambda</span> ()
   (interactive)
   (re-search-backward <span style="color: #008000;">"@"</span>)
   (re-search-forward  <span style="color: #008000;">"@</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[-a-zA-Z0-9_:]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>)
   (<span style="color: #0000FF;">let*</span> ((key (match-string-no-properties 1))
          (bibfile (cdr (org-ref-get-bibtex-key-and-file key))))
     (<span style="color: #0000FF;">if</span> bibfile
        (<span style="color: #0000FF;">save-excursion</span>
          (<span style="color: #0000FF;">with-temp-buffer</span>
            (insert-file-contents bibfile)
            (bibtex-search-entry key)
            (message (org-ref-bib-citation))))
       (message <span style="color: #008000;">"No entry found"</span>))))
 <span style="color: #006FE0;">:face</span> (list 'org-link))
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> References</h2>
<div class="outline-text-2" id="text-8">
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/01/29/Export-org-mode-to-docx-with-citations-via-pandoc.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
  </channel>
</rss>
