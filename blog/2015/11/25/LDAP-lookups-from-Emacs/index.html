

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LDAP lookups from Emacs</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            






<article>
  <div class="blog_post">
    <header>
      <div id="LDAP-lookups-from-Emacs"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/25/LDAP-lookups-from-Emacs/" rel="bookmark" title="Permanent Link to LDAP lookups from Emacs">LDAP lookups from Emacs</a></h2>
      <p><small><span class="blog_post_date">Posted November 25, 2015 at 09:31 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/helm/'>helm</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/25/LDAP-lookups-from-Emacs#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
Now that I have email and Cisco Jabber totally integrated into Emacs it would be nice to tap into the CMU LDAP (Lightweight Directory Access Protocol) service  to find emails and phone numbers. We to use the ldapsearch command-line utility to query our LDAP service like this to find an email address.
</p>

<p>
You might like the video explanation here: <a href="https://www.youtube.com/watch?v=N7AaKHRd9uw">https://www.youtube.com/watch?v=N7AaKHRd9uw</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(shell-command-to-string <span style="color: #008000;">"ldapsearch -x -LLL -h ldap.andrew.cmu.edu -b ou=Person,dc=cmu,dc=edu cn=\"John Kitchin\""</span>)
</pre>
</div>

<pre class="example">
dn: guid=1976CCAA-B465-11D8-8000-080020CC75D3,ou=person,dc=cmu,dc=edu
objectClass: cmuPerson
eduPersonPrimaryAffiliation: Faculty
guid: 1976CCAA-B465-11D8-8000-080020CC75D3
cmuPrivate: homePostalAddress
cmuPrivate: homePhone
cn: John Kitchin
givenName: John
sn: Kitchin
cmuPrimaryCampus: Pittsburgh
cmuCampus: Pittsburgh
cmuAndrewId: jkitchin
cmueduId: jkitchin
cmuAndrewCommonNamespaceId: jkitchin
mail: jkitchin@cmu.edu
eduPersonSchoolCollegeName: CIT - Consolidated
cmuPersonPrincipalName: jkitchin@ANDREW.CMU.EDU
postalAddress: DH A207F
cmuDepartment: Chemical Engineering
cmuDepartment: MSE: Materials Science &amp; Engineering
cmuPersonAffiliation: Tenure-Track Faculty
eduPersonAffiliation: Faculty
cmuAccount: uid=jkitchin,ou=account,dc=andrew,dc=cmu,dc=edu
cmuAccount: uid=jkitchin,ou=account,dc=cmu,dc=edu
cmuActiveDN: uid=jkitchin,ou=account,dc=andrew,dc=cmu,dc=edu
cmuActiveDN: uid=jkitchin,ou=account,dc=cmu,dc=edu
title: Professor
telephoneNumber: +1 412 268 7803
</pre>

<p>
We actually get LDIF data from ldapsearch with a lot of details. Next we wrap the output in a function that converts each result from ldapsearch into a p-list that we will use later in a helm function to help us select a match.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ldap-query</span> (query-string)
  <span style="color: #036A07;">"Send QUERY-STRING to our ldap server and parse results into a</span>
<span style="color: #036A07;">list of p-lists for each entry returned."</span>
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sLDAP query: "</span>)
  (<span style="color: #0000FF;">let</span> ((output (butlast (split-string
                          (shell-command-to-string
                           (format (concat  <span style="color: #008000;">"ldapsearch -x -LLL "</span>
                                            <span style="color: #008000;">"-h ldap.andrew.cmu.edu "</span>
                                            <span style="color: #008000;">"-b ou=Person,dc=cmu,dc=edu %s"</span>)
                                   query-string))
                          <span style="color: #008000;">"\n"</span>)))
        (lines '())
        (result '())
        (results '(())))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">cleanup trailing lines and ignore initial lines</span>
    (<span style="color: #0000FF;">loop</span> for line in output
          do
          (<span style="color: #0000FF;">cond</span>
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">join lines that run over</span>
           ((s-starts-with? <span style="color: #008000;">" "</span> line)
            (<span style="color: #0000FF;">setf</span> (car (last lines))
                  (concat (car (last lines)) line)))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">ignore this</span>
           ((string-match <span style="color: #008000;">"Size limit exceeded"</span> line)
            nil)
           (t
            (add-to-list 'lines line t))))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now we need to parse the lines. A new entry starts with a dn: line.</span>
    (<span style="color: #0000FF;">dolist</span> (line lines)
      (<span style="color: #0000FF;">cond</span>
       ((s-starts-with? <span style="color: #008000;">"dn:"</span> line)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add new entry</span>
        (add-to-list 'results `(<span style="color: #006FE0;">:dn</span> ,line)))
       ((string-match <span style="color: #008000;">":"</span> line)
        (<span style="color: #0000FF;">let*</span> ((s (split-string line <span style="color: #008000;">":"</span>))
               (prop (intern (concat <span style="color: #008000;">":"</span> (s-trim (car s)))))
               (val (s-trim (cadr s))))
          (<span style="color: #0000FF;">setf</span> (car results) (plist-put (car results) prop val))))))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">last result seems to be nil so we drop it</span>
    (-filter (<span style="color: #0000FF;">lambda</span> (x) (not (null x))) results)))
</pre>
</div>

<pre class="example">
ldap-query
</pre>

<p>
Here is an example of that function:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(ldap-query <span style="color: #008000;">"cn=\"John Kitchin\""</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">((<span style="color: #006FE0;">:dn</span> <span style="color: #008000;">"dn: guid=1976CCAA-B465-11D8-8000-080020CC75D3,ou=person,dc=cmu,dc=edu"</span> <span style="color: #006FE0;">:objectClass</span> <span style="color: #008000;">"cmuPerson"</span> <span style="color: #006FE0;">:eduPersonPrimaryAffiliation</span> <span style="color: #008000;">"Faculty"</span> <span style="color: #006FE0;">:guid</span> <span style="color: #008000;">"1976CCAA-B465-11D8-8000-080020CC75D3"</span> <span style="color: #006FE0;">:cmuPrivate</span> <span style="color: #008000;">"homePhone"</span> <span style="color: #006FE0;">:cn</span> <span style="color: #008000;">"John Kitchin"</span> <span style="color: #006FE0;">:givenName</span> <span style="color: #008000;">"John"</span> <span style="color: #006FE0;">:sn</span> <span style="color: #008000;">"Kitchin"</span> <span style="color: #006FE0;">:cmuPrimaryCampus</span> <span style="color: #008000;">"Pittsburgh"</span> <span style="color: #006FE0;">:cmuCampus</span> <span style="color: #008000;">"Pittsburgh"</span> <span style="color: #006FE0;">:cmuAndrewId</span> <span style="color: #008000;">"jkitchin"</span> <span style="color: #006FE0;">:cmueduId</span> <span style="color: #008000;">"jkitchin"</span> <span style="color: #006FE0;">:cmuAndrewCommonNamespaceId</span> <span style="color: #008000;">"jkitchin"</span> <span style="color: #006FE0;">:mail</span> <span style="color: #008000;">"jkitchin@cmu.edu"</span> <span style="color: #006FE0;">:eduPersonSchoolCollegeName</span> <span style="color: #008000;">"CIT - Consolidated"</span> <span style="color: #006FE0;">:cmuPersonPrincipalName</span> <span style="color: #008000;">"jkitchin@ANDREW.CMU.EDU"</span> <span style="color: #006FE0;">:postalAddress</span> <span style="color: #008000;">"DH A207F"</span> <span style="color: #006FE0;">:cmuDepartment</span> <span style="color: #008000;">"MSE"</span> <span style="color: #006FE0;">:cmuPersonAffiliation</span> <span style="color: #008000;">"Tenure-Track Faculty"</span> <span style="color: #006FE0;">:eduPersonAffiliation</span> <span style="color: #008000;">"Faculty"</span> <span style="color: #006FE0;">:cmuAccount</span> <span style="color: #008000;">"uid=jkitchin,ou=account,dc=cmu,dc=edu"</span> <span style="color: #006FE0;">:cmuActiveDN</span> <span style="color: #008000;">"uid=jkitchin,ou=account,dc=cmu,dc=edu"</span> <span style="color: #006FE0;">:title</span> <span style="color: #008000;">"Professor"</span> <span style="color: #006FE0;">:telephoneNumber</span> <span style="color: #008000;">"+1 412 268 7803"</span>))
</pre>
</div>


<p>
Now, we wrap a helm function around that to give us a nice menu to select entries from, and a few actions like sending an email, calling, copying the name and email, and seeing the information in a reasonable way. We also add a fallback method in case we don't find what we want and need to do a new search.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">helm-ldap</span> (query-string)
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sLDAP query: "</span>)
  (helm
   <span style="color: #006FE0;">:sources</span>
   `(((name . <span style="color: #008000;">"HELM ldap"</span>)
      (candidates . ,(mapcar
                      (<span style="color: #0000FF;">lambda</span> (x)
                        (cons
                         (format
                          <span style="color: #008000;">"%20s|%30s|%30s|%20s|%s"</span>
                          (s-truncate
                           20
                           (<span style="color: #0000FF;">or</span> (plist-get x <span style="color: #006FE0;">:title</span>) <span style="color: #008000;">" "</span>))
                          (plist-get x <span style="color: #006FE0;">:cn</span>)
                          (plist-get x <span style="color: #006FE0;">:mail</span>)
                          (plist-get x <span style="color: #006FE0;">:cmuDisplayAddress</span>)
                          (<span style="color: #0000FF;">or</span> (plist-get x <span style="color: #006FE0;">:telephoneNumber</span>) <span style="color: #008000;">" "</span>))
                         x))
                      (ldap-query
                       (<span style="color: #0000FF;">if</span> (string-match <span style="color: #008000;">"="</span> query-string)
                           query-string
                         (concat <span style="color: #008000;">"cn=*"</span> query-string <span style="color: #008000;">"*"</span>)))))
      (action . ((<span style="color: #008000;">"Email"</span> . (<span style="color: #0000FF;">lambda</span> (x)
                              (compose-mail)
                              (message-goto-to)
                              (insert (plist-get x <span style="color: #006FE0;">:mail</span>))
                              (message-goto-subject)))
                 (<span style="color: #008000;">"Call"</span> . (<span style="color: #0000FF;">lambda</span> (x)
                             (cisco-call
                              (plist-get x <span style="color: #006FE0;">:telephoneNumber</span>))))
                 (<span style="color: #008000;">"Copy Name and email address"</span> . (<span style="color: #0000FF;">lambda</span> (x)
                                                    (kill-new
                                                     (format
                                                      <span style="color: #008000;">"%s &lt;%s&gt;"</span>
                                                      (plist-get x <span style="color: #006FE0;">:cn</span>)
                                                      (plist-get x <span style="color: #006FE0;">:mail</span>)))))
                 (<span style="color: #008000;">"Information"</span> . (<span style="color: #0000FF;">lambda</span> (x)
                                    (switch-to-buffer
                                     (get-buffer-create <span style="color: #008000;">"*helm ldap*"</span>))
                                    (erase-buffer)
                                    (<span style="color: #0000FF;">dolist</span> (key (<span style="color: #0000FF;">cl-loop</span>
                                                  for key in x by #'cddr
                                                  collect key))
                                      (insert (format <span style="color: #008000;">"|%s | %s|\n"</span>
                                                      key (plist-get x key))))
                                    (org-mode)
                                    (goto-char 0)
                                    (org-ctrl-c-ctrl-c)
                                    (insert <span style="color: #008000;">"press q to quit.\n\n"</span>)
                                    (<span style="color: #0000FF;">setq</span> buffer-read-only t)
                                    (use-local-map (copy-keymap org-mode-map))
                                    (local-set-key <span style="color: #008000;">"q"</span>
                                                   #'(lambda ()
                                                       (<span style="color: #0000FF;">interactive</span>)
                                                       (quit-window t))))))))
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fallback action</span>
     ((name . <span style="color: #008000;">"New search"</span>)
      (dummy)
      (action . (<span style="color: #0000FF;">lambda</span> (x) (helm-ldap x)))))))
</pre>
</div>

<pre class="example">
helm-ldap
</pre>

<p>
That is pretty convenient!
</p>

<p>
John Kitchin &lt;jkitchin@cmu.edu&gt;</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/25/LDAP-lookups-from-Emacs.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_url = "http://jkitchin.github.io/blog/2015/11/25/LDAP-lookups-from-Emacs";
</script>
<script type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/embed.js"></script>
<noscript><a href="http://kitchinresearchgroup.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/01/27/New-publication-in-Topics-in-Catalysis/">New publication in Topics in Catalysis</a></li>
      <li><a href="/blog/2018/01/03/New-publication-in-Molecular-Simulation/">New publication in Molecular Simulation</a></li>
      <li><a href="/blog/2017/12/31/2017-in-a-nutshell-for-the-Kitchin-Research-group/">2017 in a nutshell for the Kitchin Research group</a></li>
      <li><a href="/blog/2017/11/29/Solving-an-eigenvalue-differential-equation-with-a-neural-network/">Solving an eigenvalue differential equation with a neural network</a></li>
      <li><a href="/blog/2017/11/28/Solving-ODEs-with-a-neural-network-and-autograd/">Solving ODEs with a neural network and autograd</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



