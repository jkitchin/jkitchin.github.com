<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
     xmlns:content="http://purl.org/rss/1.0/modules/content/"
     xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:wfw="http://wellformedweb.org/CommentAPI/"
     >
  <channel>
    <title>The Kitchin Research Group</title>
    <link>http://jkitchin.github.io/blog</link>
    <description>Chemical Engineering at Carnegie Mellon University</description>
    <pubDate>Sun, 17 May 2015 17:36:22 GMT</pubDate>
    <generator>Blogofile</generator>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>
    <item>
      <title>Another approach to embedding org-source in html</title>
      <link>http://jkitchin.github.io/blog/2015/05/09/Another-approach-to-embedding-org-source-in-html</link>
      <pubDate>Sat, 09 May 2015 19:19:10 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[data]]></category>
      <guid isPermaLink="false">VDOCn9OcCwUtC5Mwgxhzeiweu7Y=</guid>
      <description>Another approach to embedding org-source in html</description>
      <content:encoded><![CDATA[


<p>
In this <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/05/09/An-alternative-approach-to-including-org-source-in-blog-posts/">post</a> I examined a way to embed the org-source in a comment in the html of the post, and developed a reasonably convenient way to extract the source in emacs. One downside of the approach was the need to escape at least the dashes, and then unescape them on extraction. I came across another idea, which is to put the org-source in base64 encoded form in a <a href="http://en.wikipedia.org/wiki/Data_URI_scheme">data uri</a> .
</p>

<p>
First let us see what the encoding means:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(base64-encode-string <span style="color: #008000;">"&lt;!-- test--&gt;"</span>)
</pre>
</div>
<pre class="example">
PCEtLSB0ZXN0LS0+
</pre>

<p>
And decoding:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(base64-decode-string <span style="color: #008000;">"PCEtLSB0ZXN0LS0+"</span>)
</pre>
</div>

<pre class="example">
&lt;!-- test--&gt;
</pre>

<p>
The encoding looks random, but it is reversible. More importantly, it probably will not have any html like characters in it that need escaped. The idea of a data uri is that the data it serves is embedded in the URL href attribute. This is basically how to make a data uri. We give the url here a class so we can find it later.
</p>
<pre class="example">
&lt;a class="some-org-source" href="data:text/plain;charset=US-ASCII;base64,PCEtLSB0ZXN0LS0+"&gt;source&lt;/a&gt;
</pre>

<p>
Here is the actual html for the browser. If you click on it, your browser automatically decodes it for you!
</p>
<a class="some-org-source" href="data:text/plain;charset=US-ASCII;base64,PCEtLSB0ZXN0LS0+">source</a>

<p>
So, during the blog publish step, we just need to add this little step to the html generation, and it will be included as a data uri. Here is the function that generates the data uri for us, and example of using it. The encoded source is not at all attractive to look at it, but you almost never need to look at it, it is invisible in the browser. Interestingly, if you click on the link, you will see the org source right in your browser!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">source-data-uri</span> (source)
  <span style="color: #036A07;">"Encode the string in SOURCE to a data uri."</span>
  (format
   <span style="color: #008000;">"&lt;a class=\"org-source\" href=\"data:text/plain;charset=US-ASCII;base64,%s\"&gt;source&lt;/a&gt;"</span>
   (base64-encode-string source)))

(source-data-uri (buffer-string))
</pre>
</div>

<a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KiBBbm90aGVyIGFwcHJvYWNoIHRvIGVtYmVkZGluZyBvcmctc291cmNlIGluIGh0bWwKSW4gdGhp
cyBbW2h0dHA6Ly9raXRjaGluZ3JvdXAuY2hlbWUuY211LmVkdS9ibG9nLzIwMTUvMDUvMDkvQW4t
YWx0ZXJuYXRpdmUtYXBwcm9hY2gtdG8taW5jbHVkaW5nLW9yZy1zb3VyY2UtaW4tYmxvZy1wb3N0
cy9dW3Bvc3RdXSBJIGV4YW1pbmVkIGEgd2F5IHRvIGVtYmVkIHRoZSBvcmctc291cmNlIGluIGEg
Y29tbWVudCBpbiB0aGUgaHRtbCBvZiB0aGUgcG9zdCwgYW5kIGRldmVsb3BlZCBhIHJlYXNvbmFi
bHkgY29udmVuaWVudCB3YXkgdG8gZXh0cmFjdCB0aGUgc291cmNlIGluIGVtYWNzLiBPbmUgZG93
bnNpZGUgb2YgdGhlIGFwcHJvYWNoIHdhcyB0aGUgbmVlZCB0byBlc2NhcGUgYXQgbGVhc3QgdGhl
IGRhc2hlcywgYW5kIHRoZW4gdW5lc2NhcGUgdGhlbSBvbiBleHRyYWN0aW9uLiBJIGNhbWUgYWNy
b3NzIGFub3RoZXIgaWRlYSwgd2hpY2ggaXMgdG8gcHV0IHRoZSBvcmctc291cmNlIGluIGJhc2U2
NCBlbmNvZGVkIGZvcm0gaW4gYSBbW2h0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGF0YV9V
Uklfc2NoZW1lXVtkYXRhIHVyaV1dLgoKRmlyc3QgbGV0IHVzIHNlZSB3aGF0IHRoZSBlbmNvZGlu
ZyBtZWFuczoKCiMrQkVHSU5fU1JDIGVtYWNzLWxpc3AKKGJhc2U2NC1lbmNvZGUtc3RyaW5nICI8
IS0tIHRlc3QtLT4iKQojK0VORF9TUkMKIytSRVNVTFRTOgo6IFBDRXRMU0IwWlhOMExTMCsKCkFu
ZCBkZWNvZGluZzoKCiMrQkVHSU5fU1JDIGVtYWNzLWxpc3AKKGJhc2U2NC1kZWNvZGUtc3RyaW5n
ICJQQ0V0TFNCMFpYTjBMUzArIikKIytFTkRfU1JDCgojK1JFU1VMVFM6CjogPCEtLSB0ZXN0LS0+
CgpBbmQgdGhpcyBpcyBiYXNpY2FsbHkgaG93IHRvIG1ha2UgYSBkYXRhIHVyaS4gV2UgZ2l2ZSB0
aGUgdXJsIGhlcmUgYSBjbGFzcyBzbyB3ZSBjYW4gZmluZCBpdCBsYXRlci4KIytCRUdJTl9FWEFN
UExFCjxhIGNsYXNzPSJvcmctc291cmNlIiBocmVmPSJkYXRhOnRleHQvcGxhaW47Y2hhcnNldD1V
Uy1BU0NJSTtiYXNlNjQsUENFdExTQjBaWE4wTFMwKyI+c291cmNlPC9hPgojK0VORF9FWEFNUExF
CgpIZXJlIGlzIHRoZSBhY3R1YWwgaHRtbCBmb3IgdGhlIGJyb3dzZXI6IAojK0JFR0lOX0hUTUwK
PGEgY2xhc3M9Im9yZy1zb3VyY2UiIGhyZWY9ImRhdGE6dGV4dC9wbGFpbjtjaGFyc2V0PVVTLUFT
Q0lJO2Jhc2U2NCxQQ0V0TFNCMFpYTjBMUzArIj5zb3VyY2U8L2E+CiMrRU5EX0hUTUwKClNvLCBk
dXJpbmcgdGhlIGJsb2cgcHVibGlzaCBzdGVwLCB3ZSBqdXN0IG5lZWQgdG8gYWRkIHRoaXMgbGl0
dGxlIHN0ZXAgdG8gdGhlIGh0bWwgZ2VuZXJhdGlvbiwgYW5kIGl0IHdpbGwgYmUgaW5jbHVkZWQg
YXMgYSBkYXRhIHVyaS4gSGVyZSBpcyB0aGUgZnVuY3Rpb24gdGhhdCBnZW5lcmF0ZXMgdGhlIGRh
dGEgdXJpIGZvciB1cywgYW5kIGV4YW1wbGUgb2YgdXNpbmcgaXQ6CgojK0JFR0lOX1NSQyBlbWFj
cy1saXNwICA6cmVzdWx0cyBodG1sCihkZWZ1biBzb3VyY2UtZGF0YS11cmkgKHNvdXJjZSkKICAi
RW5jb2RlIHRoZSBzdHJpbmcgaW4gU09VUkNFIHRvIGEgZGF0YSB1cmkuIgogIChmb3JtYXQKICAg
IjxhIGNsYXNzPVwib3JnLXNvdXJjZVwiIGhyZWY9XCJkYXRhOnRleHQvcGxhaW47Y2hhcnNldD1V
Uy1BU0NJSTtiYXNlNjQsJXNcIiBkb3dubG9hZD1cInNvdXJjZS5vcmdcIj5zb3VyY2U8L2E+IiAK
ICAgKGJhc2U2NC1lbmNvZGUtc3RyaW5nIHNvdXJjZSkpKQoKKHNvdXJjZS1kYXRhLXVyaSAoYnVm
ZmVyLXN0cmluZykpCiMrRU5EX1NSQwoKCgoKCgoK" download="source.org">source</a>

<p>
Now, we integrate it into the blogofile function:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">bf-get-post-html</span> ()
  <span style="color: #036A07;">"Return a string containing the YAML header, the post html, my</span>
<span style="color: #036A07;">copyright line, and a link to the org-source code."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((org-source (buffer-string))
        (url-to-org (bf-get-url-to-org-source))
        (yaml (bf-get-YAML-heading))
        (body (bf-get-HTML)))

    (<span style="color: #0000FF;">with-temp-buffer</span>
      (insert yaml)
      (insert body)
      (insert
       (format <span style="color: #008000;">"&lt;p&gt;Copyright (C) %s by John Kitchin. See the &lt;a href=\"/copying.html\"&gt;License&lt;/a&gt; for information about copying.&lt;p&gt;"</span>
               (format-time-string <span style="color: #008000;">"%Y"</span>)))
      (insert (format <span style="color: #008000;">"&lt;p&gt;&lt;a href=\"%s\"&gt;org-mode source&lt;/a&gt;&lt;p&gt;"</span>
                      url-to-org))
      (insert (format <span style="color: #008000;">"&lt;p&gt;Org-mode version = %s&lt;/p&gt;"</span> (org-version)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is the only new code we need to add.</span>
      (insert (source-data-uri org-source))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return value</span>
      (buffer-string))))
</pre>
</div>

<p>
Now we need a new adaptation of the grab-org-source function. We still need a regexp search to get the source, and we still need to decode it.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">grab-org-source</span> (url)
  <span style="color: #036A07;">"Extract org-source from URL to a buffer named *grab-org-source*."</span>
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sURL: "</span>)
  (switch-to-buffer (get-buffer-create <span style="color: #008000;">"*grab-org-source*"</span>))
  (erase-buffer)
  (org-mode)
  (insert
   (<span style="color: #0000FF;">with-current-buffer</span>
       (url-retrieve-synchronously url)
     (<span style="color: #0000FF;">let</span> (start)
       (re-search-forward
        <span style="color: #008000;">"&lt;a class=\"org-source\" href=\"data:text/plain;charset=US-ASCII;base64,</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">\"]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">\\\"&gt;"</span> nil t)
       (base64-decode-string  (match-string 1))))))
</pre>
</div>

<p>
What else could we do with this? One idea would be to generate data uris for each code block that you could open in your browser. For example, here we generate a list of data uris for each code block in the buffer. We don't take care to label them or make it easy to see what they are, but if you click on one, you should see a plain text version of the block. If this is done a lot, it might even make sense to change the mime type to download the code in some native app.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map (org-element-parse-buffer) 'src-block
  (<span style="color: #0000FF;">lambda</span> (src-block)
    (source-data-uri (org-element-property <span style="color: #006FE0;">:value</span> src-block))))
</pre>
</div>

(<a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KGJhc2U2NC1lbmNvZGUtc3RyaW5nICI8IS0tIHRlc3QtLT4iKQo=">source</a> <a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KGJhc2U2NC1kZWNvZGUtc3RyaW5nICJQQ0V0TFNCMFpYTjBMUzArIikK">source</a> <a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KGRlZnVuIHNvdXJjZS1kYXRhLXVyaSAoc291cmNlKQogICJFbmNvZGUgdGhlIHN0cmluZyBpbiBT
T1VSQ0UgdG8gYSBkYXRhIHVyaS4iCiAgKGZvcm1hdAogICAiPGEgY2xhc3M9XCJvcmctc291cmNl
XCIgaHJlZj1cImRhdGE6dGV4dC9wbGFpbjtjaGFyc2V0PVVTLUFTQ0lJO2Jhc2U2NCwlc1wiPnNv
dXJjZTwvYT4iCiAgIChiYXNlNjQtZW5jb2RlLXN0cmluZyBzb3VyY2UpKSkKCihzb3VyY2UtZGF0
YS11cmkgKGJ1ZmZlci1zdHJpbmcpKQo=">source</a> <a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KGRlZnVuIGJmLWdldC1wb3N0LWh0bWwgKCkKICAiUmV0dXJuIGEgc3RyaW5nIGNvbnRhaW5pbmcg
dGhlIFlBTUwgaGVhZGVyLCB0aGUgcG9zdCBodG1sLCBteQpjb3B5cmlnaHQgbGluZSwgYW5kIGEg
bGluayB0byB0aGUgb3JnLXNvdXJjZSBjb2RlLiIKICAoaW50ZXJhY3RpdmUpCiAgKGxldCAoKG9y
Zy1zb3VyY2UgKGJ1ZmZlci1zdHJpbmcpKQoJKHVybC10by1vcmcgKGJmLWdldC11cmwtdG8tb3Jn
LXNvdXJjZSkpCgkoeWFtbCAoYmYtZ2V0LVlBTUwtaGVhZGluZykpCgkoYm9keSAoYmYtZ2V0LUhU
TUwpKSkKCiAgICAod2l0aC10ZW1wLWJ1ZmZlcgogICAgICAoaW5zZXJ0IHlhbWwpCiAgICAgIChp
bnNlcnQgYm9keSkKICAgICAgKGluc2VydAogICAgICAgKGZvcm1hdCAiPHA+Q29weXJpZ2h0IChD
KSAlcyBieSBKb2huIEtpdGNoaW4uIFNlZSB0aGUgPGEgaHJlZj1cIi9jb3B5aW5nLmh0bWxcIj5M
aWNlbnNlPC9hPiBmb3IgaW5mb3JtYXRpb24gYWJvdXQgY29weWluZy48cD4iCgkgICAgICAgKGZv
cm1hdC10aW1lLXN0cmluZyAiJVkiKSkpCiAgICAgIChpbnNlcnQgKGZvcm1hdCAiPHA+PGEgaHJl
Zj1cIiVzXCI+b3JnLW1vZGUgc291cmNlPC9hPjxwPiIKCQkgICAgICB1cmwtdG8tb3JnKSkKICAg
ICAgKGluc2VydCAoZm9ybWF0ICI8cD5PcmctbW9kZSB2ZXJzaW9uID0gJXM8L3A+IiAob3JnLXZl
cnNpb24pKSkKICAgICAgOzsgdGhpcyBpcyB0aGUgb25seSBuZXcgY29kZSB3ZSBuZWVkIHRvIGFk
ZC4KICAgICAgKGluc2VydCAoc291cmNlLWRhdGEtdXJpIG9yZy1zb3VyY2UpKQogICAgICA7OyBy
ZXR1cm4gdmFsdWUKICAgICAgKGJ1ZmZlci1zdHJpbmcpKSkpCg==">source</a> <a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KGRlZnVuIGdyYWItb3JnLXNvdXJjZSAodXJsKQogICJFeHRyYWN0IG9yZy1zb3VyY2UgZnJvbSBV
UkwgdG8gYSBidWZmZXIgbmFtZWQgKmdyYWItb3JnLXNvdXJjZSouIgogIChpbnRlcmFjdGl2ZSAi
c1VSTDogIikKICAoc3dpdGNoLXRvLWJ1ZmZlciAoZ2V0LWJ1ZmZlci1jcmVhdGUgIipncmFiLW9y
Zy1zb3VyY2UqIikpCiAgKGVyYXNlLWJ1ZmZlcikKICAob3JnLW1vZGUpCiAgKGluc2VydAogICAo
d2l0aC1jdXJyZW50LWJ1ZmZlcgogICAgICAgKHVybC1yZXRyaWV2ZS1zeW5jaHJvbm91c2x5IHVy
bCkKICAgICAobGV0IChzdGFydCkKICAgICAgIChyZS1zZWFyY2gtZm9yd2FyZAoJIjxhIGNsYXNz
PVwib3JnLXNvdXJjZVwiIGhyZWY9XCJkYXRhOnRleHQvcGxhaW47Y2hhcnNldD1VUy1BU0NJSTti
YXNlNjQsXFwoW15cIl0qXFwpXFxcIj4iIG5pbCB0KQogICAgICAgKGJhc2U2NC1kZWNvZGUtc3Ry
aW5nICAobWF0Y2gtc3RyaW5nIDEpKSkpKSkK">source</a> <a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KG9yZy1lbGVtZW50LW1hcCAob3JnLWVsZW1lbnQtcGFyc2UtYnVmZmVyKSAnc3JjLWJsb2NrCiAg
KGxhbWJkYSAoc3JjLWJsb2NrKQogICAgKHNvdXJjZS1kYXRhLXVyaSAob3JnLWVsZW1lbnQtcHJv
cGVydHkgOnZhbHVlIHNyYy1ibG9jaykpKSkK">source</a>)


<p>
I am not sure if this is better or worse than the other approach. I have not tested it very thoroughly, but it seems like it should work pretty generally. I imagine you could also embed other kinds of files in the html, if for some reason you did not want to put the files on your server. Overall this seems to lack some elegance in searching for data, e.g. like <a href="http://en.wikipedia.org/wiki/Embedded_RDF">RDF</a> or <a href="http://en.wikipedia.org/wiki/RDFa">RDFa</a> is supposed to enable, but it might be a step in that direction, using org-mode and Emacs as the editor.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/05/09/Another-approach-to-embedding-org-source-in-html.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p><a class="org-source" href="data:text/plain;charset=US-ASCII;base64,KiBET05FIEFub3RoZXIgYXBwcm9hY2ggdG8gZW1iZWRkaW5nIG9yZy1zb3VyY2UgaW4gaHRtbAog
IENMT1NFRDogWzIwMTUtMDUtMDkgU2F0IDE5OjE5XQogIDpQUk9QRVJUSUVTOgogIDpkYXRlOiAg
ICAgMjAxNS8wNS8wOSAxOToxOToxMAogIDp1cGRhdGVkOiAgMjAxNS8wNS8xMCAwOTozNDo1NQog
IDpjYXRlZ29yaWVzOiBvcmdtb2RlLCBkYXRhCiAgOkVORDoKSW4gdGhpcyBbW2h0dHA6Ly9raXRj
aGluZ3JvdXAuY2hlbWUuY211LmVkdS9ibG9nLzIwMTUvMDUvMDkvQW4tYWx0ZXJuYXRpdmUtYXBw
cm9hY2gtdG8taW5jbHVkaW5nLW9yZy1zb3VyY2UtaW4tYmxvZy1wb3N0cy9dW3Bvc3RdXSBJIGV4
YW1pbmVkIGEgd2F5IHRvIGVtYmVkIHRoZSBvcmctc291cmNlIGluIGEgY29tbWVudCBpbiB0aGUg
aHRtbCBvZiB0aGUgcG9zdCwgYW5kIGRldmVsb3BlZCBhIHJlYXNvbmFibHkgY29udmVuaWVudCB3
YXkgdG8gZXh0cmFjdCB0aGUgc291cmNlIGluIGVtYWNzLiBPbmUgZG93bnNpZGUgb2YgdGhlIGFw
cHJvYWNoIHdhcyB0aGUgbmVlZCB0byBlc2NhcGUgYXQgbGVhc3QgdGhlIGRhc2hlcywgYW5kIHRo
ZW4gdW5lc2NhcGUgdGhlbSBvbiBleHRyYWN0aW9uLiBJIGNhbWUgYWNyb3NzIGFub3RoZXIgaWRl
YSwgd2hpY2ggaXMgdG8gcHV0IHRoZSBvcmctc291cmNlIGluIGJhc2U2NCBlbmNvZGVkIGZvcm0g
aW4gYSBbW2h0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGF0YV9VUklfc2NoZW1lXVtkYXRh
IHVyaV1dLgoKRmlyc3QgbGV0IHVzIHNlZSB3aGF0IHRoZSBlbmNvZGluZyBtZWFuczoKCiMrQkVH
SU5fU1JDIGVtYWNzLWxpc3AKKGJhc2U2NC1lbmNvZGUtc3RyaW5nICI8IS0tIHRlc3QtLT4iKQoj
K0VORF9TUkMKIytSRVNVTFRTOgo6IFBDRXRMU0IwWlhOMExTMCsKCkFuZCBkZWNvZGluZzoKCiMr
QkVHSU5fU1JDIGVtYWNzLWxpc3AKKGJhc2U2NC1kZWNvZGUtc3RyaW5nICJQQ0V0TFNCMFpYTjBM
UzArIikKIytFTkRfU1JDCgojK1JFU1VMVFM6CjogPCEtLSB0ZXN0LS0+CgpUaGUgZW5jb2Rpbmcg
bG9va3MgcmFuZG9tLCBidXQgaXQgaXMgcmV2ZXJzaWJsZS4gTW9yZSBpbXBvcnRhbnRseSwgaXQg
cHJvYmFibHkgd2lsbCBub3QgaGF2ZSBhbnkgaHRtbCBsaWtlIGNoYXJhY3RlcnMgaW4gaXQgdGhh
dCBuZWVkIGVzY2FwZWQuIFRoZSBpZGVhIG9mIGEgZGF0YSB1cmkgaXMgdGhhdCB0aGUgZGF0YSBp
dCBzZXJ2ZXMgaXMgZW1iZWRkZWQgaW4gdGhlIFVSTCBocmVmIGF0dHJpYnV0ZS4gVGhpcyBpcyBi
YXNpY2FsbHkgaG93IHRvIG1ha2UgYSBkYXRhIHVyaS4gV2UgZ2l2ZSB0aGUgdXJsIGhlcmUgYSBj
bGFzcyBzbyB3ZSBjYW4gZmluZCBpdCBsYXRlci4KIytCRUdJTl9FWEFNUExFCjxhIGNsYXNzPSJz
b21lLW9yZy1zb3VyY2UiIGhyZWY9ImRhdGE6dGV4dC9wbGFpbjtjaGFyc2V0PVVTLUFTQ0lJO2Jh
c2U2NCxQQ0V0TFNCMFpYTjBMUzArIj5zb3VyY2U8L2E+CiMrRU5EX0VYQU1QTEUKCkhlcmUgaXMg
dGhlIGFjdHVhbCBodG1sIGZvciB0aGUgYnJvd3Nlci4gSWYgeW91IGNsaWNrIG9uIGl0LCB5b3Vy
IGJyb3dzZXIgYXV0b21hdGljYWxseSBkZWNvZGVzIGl0IGZvciB5b3UhCiMrQkVHSU5fSFRNTAo8
YSBjbGFzcz0ic29tZS1vcmctc291cmNlIiBocmVmPSJkYXRhOnRleHQvcGxhaW47Y2hhcnNldD1V
Uy1BU0NJSTtiYXNlNjQsUENFdExTQjBaWE4wTFMwKyI+c291cmNlPC9hPgojK0VORF9IVE1MCgpT
bywgZHVyaW5nIHRoZSBibG9nIHB1Ymxpc2ggc3RlcCwgd2UganVzdCBuZWVkIHRvIGFkZCB0aGlz
IGxpdHRsZSBzdGVwIHRvIHRoZSBodG1sIGdlbmVyYXRpb24sIGFuZCBpdCB3aWxsIGJlIGluY2x1
ZGVkIGFzIGEgZGF0YSB1cmkuIEhlcmUgaXMgdGhlIGZ1bmN0aW9uIHRoYXQgZ2VuZXJhdGVzIHRo
ZSBkYXRhIHVyaSBmb3IgdXMsIGFuZCBleGFtcGxlIG9mIHVzaW5nIGl0LiBUaGUgZW5jb2RlZCBz
b3VyY2UgaXMgbm90IGF0IGFsbCBhdHRyYWN0aXZlIHRvIGxvb2sgYXQgaXQsIGJ1dCB5b3UgYWxt
b3N0IG5ldmVyIG5lZWQgdG8gbG9vayBhdCBpdCwgaXQgaXMgaW52aXNpYmxlIGluIHRoZSBicm93
c2VyLiBJbnRlcmVzdGluZ2x5LCBpZiB5b3UgY2xpY2sgb24gdGhlIGxpbmssIHlvdSB3aWxsIHNl
ZSB0aGUgb3JnIHNvdXJjZSByaWdodCBpbiB5b3VyIGJyb3dzZXIhCgojK0JFR0lOX1NSQyBlbWFj
cy1saXNwICA6cmVzdWx0cyBodG1sCihkZWZ1biBzb3VyY2UtZGF0YS11cmkgKHNvdXJjZSkKICAi
RW5jb2RlIHRoZSBzdHJpbmcgaW4gU09VUkNFIHRvIGEgZGF0YSB1cmkuIgogIChmb3JtYXQKICAg
IjxhIGNsYXNzPVwib3JnLXNvdXJjZVwiIGhyZWY9XCJkYXRhOnRleHQvcGxhaW47Y2hhcnNldD1V
Uy1BU0NJSTtiYXNlNjQsJXNcIj5zb3VyY2U8L2E+IgogICAoYmFzZTY0LWVuY29kZS1zdHJpbmcg
c291cmNlKSkpCgooc291cmNlLWRhdGEtdXJpIChidWZmZXItc3RyaW5nKSkKIytFTkRfU1JDCgoj
K1JFU1VMVFM6CiMrQkVHSU5fSFRNTAo8YSBjbGFzcz0ib3JnLXNvdXJjZSIgaHJlZj0iZGF0YTp0
ZXh0L3BsYWluO2NoYXJzZXQ9VVMtQVNDSUk7YmFzZTY0LEtpQkJibTkwYUdWeUlHRndjSEp2WVdO
b0lIUnZJR1Z0WW1Wa1pHbHVaeUJ2Y21jdGMyOTFjbU5sSUdsdUlHaDBiV3dLU1c0Z2RHaHAKY3lC
YlcyaDBkSEE2THk5cmFYUmphR2x1WjNKdmRYQXVZMmhsYldVdVkyMTFMbVZrZFM5aWJHOW5Mekl3
TVRVdk1EVXZNRGt2UVc0dApZV3gwWlhKdVlYUnBkbVV0WVhCd2NtOWhZMmd0ZEc4dGFXNWpiSFZr
YVc1bkxXOXlaeTF6YjNWeVkyVXRhVzR0WW14dlp5MXdiM04wCmN5OWRXM0J2YzNSZFhTQkpJR1Y0
WVcxcGJtVmtJR0VnZDJGNUlIUnZJR1Z0WW1Wa0lIUm9aU0J2Y21jdGMyOTFjbU5sSUdsdUlHRWcK
WTI5dGJXVnVkQ0JwYmlCMGFHVWdhSFJ0YkNCdlppQjBhR1VnY0c5emRDd2dZVzVrSUdSbGRtVnNi
M0JsWkNCaElISmxZWE52Ym1GaQpiSGtnWTI5dWRtVnVhV1Z1ZENCM1lYa2dkRzhnWlhoMGNtRmpk
Q0IwYUdVZ2MyOTFjbU5sSUdsdUlHVnRZV056TGlCUGJtVWdaRzkzCmJuTnBaR1VnYjJZZ2RHaGxJ
R0Z3Y0hKdllXTm9JSGRoY3lCMGFHVWdibVZsWkNCMGJ5QmxjMk5oY0dVZ1lYUWdiR1ZoYzNRZ2RH
aGwKSUdSaGMyaGxjeXdnWVc1a0lIUm9aVzRnZFc1bGMyTmhjR1VnZEdobGJTQnZiaUJsZUhSeVlX
TjBhVzl1TGlCSklHTmhiV1VnWVdOeQpiM056SUdGdWIzUm9aWElnYVdSbFlTd2dkMmhwWTJnZ2FY
TWdkRzhnY0hWMElIUm9aU0J2Y21jdGMyOTFjbU5sSUdsdUlHSmhjMlUyCk5DQmxibU52WkdWa0lH
WnZjbTBnYVc0Z1lTQmJXMmgwZEhBNkx5OWxiaTUzYVd0cGNHVmthV0V1YjNKbkwzZHBhMmt2UkdG
MFlWOVYKVWtsZmMyTm9aVzFsWFZ0a1lYUmhJSFZ5YVYxZExnb0tSbWx5YzNRZ2JHVjBJSFZ6SUhO
bFpTQjNhR0YwSUhSb1pTQmxibU52WkdsdQpaeUJ0WldGdWN6b0tDaU1yUWtWSFNVNWZVMUpESUdW
dFlXTnpMV3hwYzNBS0tHSmhjMlUyTkMxbGJtTnZaR1V0YzNSeWFXNW5JQ0k4CklTMHRJSFJsYzNR
dExUNGlLUW9qSzBWT1JGOVRVa01LSXl0U1JWTlZURlJUT2dvNklGQkRSWFJNVTBJd1dsaE9NRXhU
TUNzS0NrRnUKWkNCa1pXTnZaR2x1WnpvS0NpTXJRa1ZIU1U1ZlUxSkRJR1Z0WVdOekxXeHBjM0FL
S0dKaGMyVTJOQzFrWldOdlpHVXRjM1J5YVc1bgpJQ0pRUTBWMFRGTkNNRnBZVGpCTVV6QXJJaWtL
SXl0RlRrUmZVMUpEQ2dvaksxSkZVMVZNVkZNNkNqb2dQQ0V0TFNCMFpYTjBMUzArCkNncEJibVFn
ZEdocGN5QnBjeUJpWVhOcFkyRnNiSGtnYUc5M0lIUnZJRzFoYTJVZ1lTQmtZWFJoSUhWeWFTNGdW
MlVnWjJsMlpTQjAKYUdVZ2RYSnNJR2hsY21VZ1lTQmpiR0Z6Y3lCemJ5QjNaU0JqWVc0Z1ptbHVa
Q0JwZENCc1lYUmxjaTRLSXl0Q1JVZEpUbDlGV0VGTgpVRXhGQ2p4aElHTnNZWE56UFNKdmNtY3Rj
MjkxY21ObElpQm9jbVZtUFNKa1lYUmhPblJsZUhRdmNHeGhhVzQ3WTJoaGNuTmxkRDFWClV5MUJV
ME5KU1R0aVlYTmxOalFzVUVORmRFeFRRakJhV0U0d1RGTXdLeUkrYzI5MWNtTmxQQzloUGdvaksw
Vk9SRjlGV0VGTlVFeEYKQ2dwSVpYSmxJR2x6SUhSb1pTQmhZM1IxWVd3Z2FIUnRiQ0JtYjNJZ2RH
aGxJR0p5YjNkelpYSTZJQW9qSzBKRlIwbE9YMGhVVFV3SwpQR0VnWTJ4aGMzTTlJbTl5WnkxemIz
VnlZMlVpSUdoeVpXWTlJbVJoZEdFNmRHVjRkQzl3YkdGcGJqdGphR0Z5YzJWMFBWVlRMVUZUClEw
bEpPMkpoYzJVMk5DeFFRMFYwVEZOQ01GcFlUakJNVXpBcklqNXpiM1Z5WTJVOEwyRStDaU1yUlU1
RVgwaFVUVXdLQ2xOdkxDQmsKZFhKcGJtY2dkR2hsSUdKc2IyY2djSFZpYkdsemFDQnpkR1Z3TENC
M1pTQnFkWE4wSUc1bFpXUWdkRzhnWVdSa0lIUm9hWE1nYkdsMApkR3hsSUhOMFpYQWdkRzhnZEdo
bElHaDBiV3dnWjJWdVpYSmhkR2x2Yml3Z1lXNWtJR2wwSUhkcGJHd2dZbVVnYVc1amJIVmtaV1Fn
CllYTWdZU0JrWVhSaElIVnlhUzRnU0dWeVpTQnBjeUIwYUdVZ1puVnVZM1JwYjI0Z2RHaGhkQ0Ju
Wlc1bGNtRjBaWE1nZEdobElHUmgKZEdFZ2RYSnBJR1p2Y2lCMWN5d2dZVzVrSUdWNFlXMXdiR1Vn
YjJZZ2RYTnBibWNnYVhRNkNnb2pLMEpGUjBsT1gxTlNReUJsYldGagpjeTFzYVhOd0lDQTZjbVZ6
ZFd4MGN5Qm9kRzFzQ2loa1pXWjFiaUJ6YjNWeVkyVXRaR0YwWVMxMWNta2dLSE52ZFhKalpTa0tJ
Q0FpClJXNWpiMlJsSUhSb1pTQnpkSEpwYm1jZ2FXNGdVMDlWVWtORklIUnZJR0VnWkdGMFlTQjFj
bWt1SWdvZ0lDaG1iM0p0WVhRS0lDQWcKSWp4aElHTnNZWE56UFZ3aWIzSm5MWE52ZFhKalpWd2lJ
R2h5WldZOVhDSmtZWFJoT25SbGVIUXZjR3hoYVc0N1kyaGhjbk5sZEQxVgpVeTFCVTBOSlNUdGlZ
WE5sTmpRc0pYTmNJaUJrYjNkdWJHOWhaRDFjSW5OdmRYSmpaUzV2Y21kY0lqNXpiM1Z5WTJVOEwy
RStJaUFLCklDQWdLR0poYzJVMk5DMWxibU52WkdVdGMzUnlhVzVuSUhOdmRYSmpaU2twS1FvS0tI
TnZkWEpqWlMxa1lYUmhMWFZ5YVNBb1luVm0KWm1WeUxYTjBjbWx1WnlrcENpTXJSVTVFWDFOU1F3
b0tDZ29LQ2dvSyIgZG93bmxvYWQ9InNvdXJjZS5vcmciPnNvdXJjZTwvYT4KIytFTkRfSFRNTAoK
Tm93LCB3ZSBpbnRlZ3JhdGUgaXQgaW50byB0aGUgYmxvZ29maWxlIGZ1bmN0aW9uOgoKIytCRUdJ
Tl9TUkMgZW1hY3MtbGlzcAooZGVmdW4gYmYtZ2V0LXBvc3QtaHRtbCAoKQogICJSZXR1cm4gYSBz
dHJpbmcgY29udGFpbmluZyB0aGUgWUFNTCBoZWFkZXIsIHRoZSBwb3N0IGh0bWwsIG15CmNvcHly
aWdodCBsaW5lLCBhbmQgYSBsaW5rIHRvIHRoZSBvcmctc291cmNlIGNvZGUuIgogIChpbnRlcmFj
dGl2ZSkKICAobGV0ICgob3JnLXNvdXJjZSAoYnVmZmVyLXN0cmluZykpCgkodXJsLXRvLW9yZyAo
YmYtZ2V0LXVybC10by1vcmctc291cmNlKSkKCSh5YW1sIChiZi1nZXQtWUFNTC1oZWFkaW5nKSkK
CShib2R5IChiZi1nZXQtSFRNTCkpKQoKICAgICh3aXRoLXRlbXAtYnVmZmVyCiAgICAgIChpbnNl
cnQgeWFtbCkKICAgICAgKGluc2VydCBib2R5KQogICAgICAoaW5zZXJ0CiAgICAgICAoZm9ybWF0
ICI8cD5Db3B5cmlnaHQgKEMpICVzIGJ5IEpvaG4gS2l0Y2hpbi4gU2VlIHRoZSA8YSBocmVmPVwi
L2NvcHlpbmcuaHRtbFwiPkxpY2Vuc2U8L2E+IGZvciBpbmZvcm1hdGlvbiBhYm91dCBjb3B5aW5n
LjxwPiIKCSAgICAgICAoZm9ybWF0LXRpbWUtc3RyaW5nICIlWSIpKSkKICAgICAgKGluc2VydCAo
Zm9ybWF0ICI8cD48YSBocmVmPVwiJXNcIj5vcmctbW9kZSBzb3VyY2U8L2E+PHA+IgoJCSAgICAg
IHVybC10by1vcmcpKQogICAgICAoaW5zZXJ0IChmb3JtYXQgIjxwPk9yZy1tb2RlIHZlcnNpb24g
PSAlczwvcD4iIChvcmctdmVyc2lvbikpKQogICAgICA7OyB0aGlzIGlzIHRoZSBvbmx5IG5ldyBj
b2RlIHdlIG5lZWQgdG8gYWRkLgogICAgICAoaW5zZXJ0IChzb3VyY2UtZGF0YS11cmkgb3JnLXNv
dXJjZSkpCiAgICAgIDs7IHJldHVybiB2YWx1ZQogICAgICAoYnVmZmVyLXN0cmluZykpKSkKIytF
TkRfU1JDCgpOb3cgd2UgbmVlZCBhIG5ldyBhZGFwdGF0aW9uIG9mIHRoZSBncmFiLW9yZy1zb3Vy
Y2UgZnVuY3Rpb24uIFdlIHN0aWxsIG5lZWQgYSByZWdleHAgc2VhcmNoIHRvIGdldCB0aGUgc291
cmNlLCBhbmQgd2Ugc3RpbGwgbmVlZCB0byBkZWNvZGUgaXQuCgojK0JFR0lOX1NSQyBlbWFjcy1s
aXNwCihkZWZ1biBncmFiLW9yZy1zb3VyY2UgKHVybCkKICAiRXh0cmFjdCBvcmctc291cmNlIGZy
b20gVVJMIHRvIGEgYnVmZmVyIG5hbWVkICpncmFiLW9yZy1zb3VyY2UqLiIKICAoaW50ZXJhY3Rp
dmUgInNVUkw6ICIpCiAgKHN3aXRjaC10by1idWZmZXIgKGdldC1idWZmZXItY3JlYXRlICIqZ3Jh
Yi1vcmctc291cmNlKiIpKQogIChlcmFzZS1idWZmZXIpCiAgKG9yZy1tb2RlKQogIChpbnNlcnQK
ICAgKHdpdGgtY3VycmVudC1idWZmZXIKICAgICAgICh1cmwtcmV0cmlldmUtc3luY2hyb25vdXNs
eSB1cmwpCiAgICAgKGxldCAoc3RhcnQpCiAgICAgICAocmUtc2VhcmNoLWZvcndhcmQKCSI8YSBj
bGFzcz1cIm9yZy1zb3VyY2VcIiBocmVmPVwiZGF0YTp0ZXh0L3BsYWluO2NoYXJzZXQ9VVMtQVND
SUk7YmFzZTY0LFxcKFteXCJdKlxcKVxcXCI+IiBuaWwgdCkKICAgICAgIChiYXNlNjQtZGVjb2Rl
LXN0cmluZyAgKG1hdGNoLXN0cmluZyAxKSkpKSkpCiMrRU5EX1NSQwoKV2hhdCBlbHNlIGNvdWxk
IHdlIGRvIHdpdGggdGhpcz8gT25lIGlkZWEgd291bGQgYmUgdG8gZ2VuZXJhdGUgZGF0YSB1cmlz
IGZvciBlYWNoIGNvZGUgYmxvY2sgdGhhdCB5b3UgY291bGQgb3BlbiBpbiB5b3VyIGJyb3dzZXIu
IEZvciBleGFtcGxlLCBoZXJlIHdlIGdlbmVyYXRlIGEgbGlzdCBvZiBkYXRhIHVyaXMgZm9yIGVh
Y2ggY29kZSBibG9jayBpbiB0aGUgYnVmZmVyLiBXZSBkb24ndCB0YWtlIGNhcmUgdG8gbGFiZWwg
dGhlbSBvciBtYWtlIGl0IGVhc3kgdG8gc2VlIHdoYXQgdGhleSBhcmUsIGJ1dCBpZiB5b3UgY2xp
Y2sgb24gb25lLCB5b3Ugc2hvdWxkIHNlZSBhIHBsYWluIHRleHQgdmVyc2lvbiBvZiB0aGUgYmxv
Y2suIElmIHRoaXMgaXMgZG9uZSBhIGxvdCwgaXQgbWlnaHQgZXZlbiBtYWtlIHNlbnNlIHRvIGNo
YW5nZSB0aGUgbWltZSB0eXBlIHRvIGRvd25sb2FkIHRoZSBjb2RlIGluIHNvbWUgbmF0aXZlIGFw
cC4KCiMrQkVHSU5fU1JDIGVtYWNzLWxpc3AgOnJlc3VsdHMgaHRtbAoob3JnLWVsZW1lbnQtbWFw
IChvcmctZWxlbWVudC1wYXJzZS1idWZmZXIpICdzcmMtYmxvY2sKICAobGFtYmRhIChzcmMtYmxv
Y2spCiAgICAoc291cmNlLWRhdGEtdXJpIChvcmctZWxlbWVudC1wcm9wZXJ0eSA6dmFsdWUgc3Jj
LWJsb2NrKSkpKQojK0VORF9TUkMKCiMrUkVTVUxUUzoKIytCRUdJTl9IVE1MCig8YSBjbGFzcz0i
b3JnLXNvdXJjZSIgaHJlZj0iZGF0YTp0ZXh0L3BsYWluO2NoYXJzZXQ9VVMtQVNDSUk7YmFzZTY0
LEtHSmhjMlUyTkMxbGJtTnZaR1V0YzNSeWFXNW5JQ0k4SVMwdElIUmxjM1F0TFQ0aUtRbz0iPnNv
dXJjZTwvYT4gPGEgY2xhc3M9Im9yZy1zb3VyY2UiIGhyZWY9ImRhdGE6dGV4dC9wbGFpbjtjaGFy
c2V0PVVTLUFTQ0lJO2Jhc2U2NCxLR0poYzJVMk5DMWtaV052WkdVdGMzUnlhVzVuSUNKUVEwVjBU
Rk5DTUZwWVRqQk1VekFySWlrSyI+c291cmNlPC9hPiA8YSBjbGFzcz0ib3JnLXNvdXJjZSIgaHJl
Zj0iZGF0YTp0ZXh0L3BsYWluO2NoYXJzZXQ9VVMtQVNDSUk7YmFzZTY0LEtHUmxablZ1SUhOdmRY
SmpaUzFrWVhSaExYVnlhU0FvYzI5MWNtTmxLUW9nSUNKRmJtTnZaR1VnZEdobElITjBjbWx1WnlC
cGJpQlQKVDFWU1EwVWdkRzhnWVNCa1lYUmhJSFZ5YVM0aUNpQWdLR1p2Y20xaGRBb2dJQ0FpUEdF
Z1kyeGhjM005WENKdmNtY3RjMjkxY21ObApYQ0lnYUhKbFpqMWNJbVJoZEdFNmRHVjRkQzl3YkdG
cGJqdGphR0Z5YzJWMFBWVlRMVUZUUTBsSk8ySmhjMlUyTkN3bGMxd2lQbk52CmRYSmpaVHd2WVQ0
aUNpQWdJQ2hpWVhObE5qUXRaVzVqYjJSbExYTjBjbWx1WnlCemIzVnlZMlVwS1NrS0NpaHpiM1Z5
WTJVdFpHRjAKWVMxMWNta2dLR0oxWm1abGNpMXpkSEpwYm1jcEtRbz0iPnNvdXJjZTwvYT4gPGEg
Y2xhc3M9Im9yZy1zb3VyY2UiIGhyZWY9ImRhdGE6dGV4dC9wbGFpbjtjaGFyc2V0PVVTLUFTQ0lJ
O2Jhc2U2NCxLR1JsWm5WdUlHSm1MV2RsZEMxd2IzTjBMV2gwYld3Z0tDa0tJQ0FpVW1WMGRYSnVJ
R0VnYzNSeWFXNW5JR052Ym5SaGFXNXBibWNnCmRHaGxJRmxCVFV3Z2FHVmhaR1Z5TENCMGFHVWdj
Rzl6ZENCb2RHMXNMQ0J0ZVFwamIzQjVjbWxuYUhRZ2JHbHVaU3dnWVc1a0lHRWcKYkdsdWF5QjBi
eUIwYUdVZ2IzSm5MWE52ZFhKalpTQmpiMlJsTGlJS0lDQW9hVzUwWlhKaFkzUnBkbVVwQ2lBZ0tH
eGxkQ0FvS0c5eQpaeTF6YjNWeVkyVWdLR0oxWm1abGNpMXpkSEpwYm1jcEtRb0pLSFZ5YkMxMGJ5
MXZjbWNnS0dKbUxXZGxkQzExY213dGRHOHRiM0puCkxYTnZkWEpqWlNrcENna29lV0Z0YkNBb1lt
WXRaMlYwTFZsQlRVd3RhR1ZoWkdsdVp5a3BDZ2tvWW05a2VTQW9ZbVl0WjJWMExVaFUKVFV3cEtT
a0tDaUFnSUNBb2QybDBhQzEwWlcxd0xXSjFabVpsY2dvZ0lDQWdJQ0FvYVc1elpYSjBJSGxoYld3
cENpQWdJQ0FnSUNocApibk5sY25RZ1ltOWtlU2tLSUNBZ0lDQWdLR2x1YzJWeWRBb2dJQ0FnSUNB
Z0tHWnZjbTFoZENBaVBIQStRMjl3ZVhKcFoyaDBJQ2hECktTQWxjeUJpZVNCS2IyaHVJRXRwZEdO
b2FXNHVJRk5sWlNCMGFHVWdQR0VnYUhKbFpqMWNJaTlqYjNCNWFXNW5MbWgwYld4Y0lqNU0KYVdO
bGJuTmxQQzloUGlCbWIzSWdhVzVtYjNKdFlYUnBiMjRnWVdKdmRYUWdZMjl3ZVdsdVp5NDhjRDRp
Q2drZ0lDQWdJQ0FnS0dadgpjbTFoZEMxMGFXMWxMWE4wY21sdVp5QWlKVmtpS1NrcENpQWdJQ0Fn
SUNocGJuTmxjblFnS0dadmNtMWhkQ0FpUEhBK1BHRWdhSEpsClpqMWNJaVZ6WENJK2IzSm5MVzF2
WkdVZ2MyOTFjbU5sUEM5aFBqeHdQaUlLQ1FrZ0lDQWdJQ0IxY213dGRHOHRiM0puS1NrS0lDQWcK
SUNBZ0tHbHVjMlZ5ZENBb1ptOXliV0YwSUNJOGNENVBjbWN0Ylc5a1pTQjJaWEp6YVc5dUlEMGdK
WE04TDNBK0lpQW9iM0puTFhabApjbk5wYjI0cEtTa0tJQ0FnSUNBZ096c2dkR2hwY3lCcGN5QjBh
R1VnYjI1c2VTQnVaWGNnWTI5a1pTQjNaU0J1WldWa0lIUnZJR0ZrClpDNEtJQ0FnSUNBZ0tHbHVj
MlZ5ZENBb2MyOTFjbU5sTFdSaGRHRXRkWEpwSUc5eVp5MXpiM1Z5WTJVcEtRb2dJQ0FnSUNBN095
QnkKWlhSMWNtNGdkbUZzZFdVS0lDQWdJQ0FnS0dKMVptWmxjaTF6ZEhKcGJtY3BLU2twQ2c9PSI+
c291cmNlPC9hPiA8YSBjbGFzcz0ib3JnLXNvdXJjZSIgaHJlZj0iZGF0YTp0ZXh0L3BsYWluO2No
YXJzZXQ9VVMtQVNDSUk7YmFzZTY0LEtHUmxablZ1SUdkeVlXSXRiM0puTFhOdmRYSmpaU0FvZFhK
c0tRb2dJQ0pGZUhSeVlXTjBJRzl5WnkxemIzVnlZMlVnWm5KdmJTQlYKVWt3Z2RHOGdZU0JpZFda
bVpYSWdibUZ0WldRZ0ttZHlZV0l0YjNKbkxYTnZkWEpqWlNvdUlnb2dJQ2hwYm5SbGNtRmpkR2wy
WlNBaQpjMVZTVERvZ0lpa0tJQ0FvYzNkcGRHTm9MWFJ2TFdKMVptWmxjaUFvWjJWMExXSjFabVps
Y2kxamNtVmhkR1VnSWlwbmNtRmlMVzl5Clp5MXpiM1Z5WTJVcUlpa3BDaUFnS0dWeVlYTmxMV0ox
Wm1abGNpa0tJQ0FvYjNKbkxXMXZaR1VwQ2lBZ0tHbHVjMlZ5ZEFvZ0lDQW8KZDJsMGFDMWpkWEp5
Wlc1MExXSjFabVpsY2dvZ0lDQWdJQ0FnS0hWeWJDMXlaWFJ5YVdWMlpTMXplVzVqYUhKdmJtOTFj
Mng1SUhWeQpiQ2tLSUNBZ0lDQW9iR1YwSUNoemRHRnlkQ2tLSUNBZ0lDQWdJQ2h5WlMxelpXRnlZ
Mmd0Wm05eWQyRnlaQW9KSWp4aElHTnNZWE56ClBWd2liM0puTFhOdmRYSmpaVndpSUdoeVpXWTlY
Q0prWVhSaE9uUmxlSFF2Y0d4aGFXNDdZMmhoY25ObGREMVZVeTFCVTBOSlNUdGkKWVhObE5qUXNY
RndvVzE1Y0lsMHFYRndwWEZ4Y0lqNGlJRzVwYkNCMEtRb2dJQ0FnSUNBZ0tHSmhjMlUyTkMxa1pX
TnZaR1V0YzNSeQphVzVuSUNBb2JXRjBZMmd0YzNSeWFXNW5JREVwS1NrcEtTa0siPnNvdXJjZTwv
YT4gPGEgY2xhc3M9Im9yZy1zb3VyY2UiIGhyZWY9ImRhdGE6dGV4dC9wbGFpbjtjaGFyc2V0PVVT
LUFTQ0lJO2Jhc2U2NCxLRzl5WnkxbGJHVnRaVzUwTFcxaGNDQW9iM0puTFdWc1pXMWxiblF0Y0dG
eWMyVXRZblZtWm1WeUtTQW5jM0pqTFdKc2IyTnJDaUFnCktHeGhiV0prWVNBb2MzSmpMV0pzYjJO
cktRb2dJQ0FnS0hOdmRYSmpaUzFrWVhSaExYVnlhU0FvYjNKbkxXVnNaVzFsYm5RdGNISnYKY0dW
eWRIa2dPblpoYkhWbElITnlZeTFpYkc5amF5a3BLU2tLIj5zb3VyY2U8L2E+KQojK0VORF9IVE1M
CgoKSSBhbSBub3Qgc3VyZSBpZiB0aGlzIGlzIGJldHRlciBvciB3b3JzZSB0aGFuIHRoZSBvdGhl
ciBhcHByb2FjaC4gSSBoYXZlIG5vdCB0ZXN0ZWQgaXQgdmVyeSB0aG9yb3VnaGx5LCBidXQgaXQg
c2VlbXMgbGlrZSBpdCBzaG91bGQgd29yayBwcmV0dHkgZ2VuZXJhbGx5LiBJIGltYWdpbmUgeW91
IGNvdWxkIGFsc28gZW1iZWQgb3RoZXIga2luZHMgb2YgZmlsZXMgaW4gdGhlIGh0bWwsIGlmIGZv
ciBzb21lIHJlYXNvbiB5b3UgZGlkIG5vdCB3YW50IHRvIHB1dCB0aGUgZmlsZXMgb24geW91ciBz
ZXJ2ZXIuIE92ZXJhbGwgdGhpcyBzZWVtcyB0byBsYWNrIHNvbWUgZWxlZ2FuY2UgaW4gc2VhcmNo
aW5nIGZvciBkYXRhLCBlLmcuIGxpa2UgW1todHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Vt
YmVkZGVkX1JERl1bUkRGXV0gb3IgW1todHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1JERmFd
W1JERmFdXSBpcyBzdXBwb3NlZCB0byBlbmFibGUsIGJ1dCBpdCBtaWdodCBiZSBhIHN0ZXAgaW4g
dGhhdCBkaXJlY3Rpb24sIHVzaW5nIG9yZy1tb2RlIGFuZCBFbWFjcyBhcyB0aGUgZWRpdG9yLgoK">source</a>]]></content:encoded>
    </item>
    <item>
      <title>An alternative approach to including org-source in blog posts</title>
      <link>http://jkitchin.github.io/blog/2015/05/09/An-alternative-approach-to-including-org-source-in-blog-posts</link>
      <pubDate>Sat, 09 May 2015 13:50:18 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">4oTKb2dOfLhDk8IZh5DMGmhQuZ8=</guid>
      <description>An alternative approach to including org-source in blog posts</description>
      <content:encoded><![CDATA[


<p>
When you publish a Matlab m-file to HTML, Matlab includes the m-file source as an html comment in the output. They also provide a nice function called grabcode that will take a url, and open the source code in the editor. Today, we try a similar approach for org-mode.
</p>

<p>
This post is not totally self-contained. I have my own emacs-lisp module that converts org-mode to blogofile posts, and so far I have not made it broadly available. This is also a super exploratory idea, so I am just going to show the changes I need to make to my setup to get to the evaluation of the idea.
</p>

<p>
The idea is pretty simple, we just insert the current buffer string into an HTML comment. I just modify the bf-get-post-html function lightly to do that. This is a somewhat pathological example since there are html comments in the post! So, we will encode all the dashes to get around that.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">browse-url</span>)
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">bf-get-post-html</span> ()
  <span style="color: #036A07;">"Return a string containing the YAML header, the post html, my</span>
<span style="color: #036A07;">copyright line, and a link to the org-source code."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((org-source (buffer-string))
        (url-to-org (bf-get-url-to-org-source))
        (yaml (bf-get-YAML-heading))
        (body (bf-get-HTML)))

    (<span style="color: #0000FF;">with-temp-buffer</span>
      (insert yaml)
      (insert body)
      (insert
       (format <span style="color: #008000;">"&lt;p&gt;Copyright (C) %s by John Kitchin. See the &lt;a href=\"/copying.html\"&gt;License&lt;/a&gt; for information about copying.&lt;p&gt;"</span>
               (format-time-string <span style="color: #008000;">"%Y"</span>)))
      (insert (format <span style="color: #008000;">"&lt;p&gt;&lt;a href=\"%s\"&gt;org-mode source&lt;/a&gt;&lt;p&gt;"</span>
                      url-to-org))
      (insert (format <span style="color: #008000;">"&lt;p&gt;Org-mode version = %s&lt;/p&gt;"</span> (org-version)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is the only new code we need to add.</span>
      (insert (format <span style="color: #008000;">"</span>
<span style="color: #008000;">&lt;!--</span>
<span style="color: #008000;">  ##### SOURCE BEGIN #####</span>
<span style="color: #008000;">%s</span>
<span style="color: #008000;">##### SOURCE END #####</span>
<span style="color: #008000;">--&gt;"</span> (browse-url-url-encode-chars org-source <span style="color: #008000;">"[-]"</span>)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return value</span>
      (buffer-string))))
</pre>
</div>

<p>
By itself, that has limited value to me. So, let's also create a grab-org-source function to get the embedded source and open it in a buffer. This might be a naive approach, we just use a regexp to find the source boundaries and open it in a new buffer. We have to unescape the dashes, which appear as %2D in the comments. Here is our function.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">grab-org-source</span> (url)
  <span style="color: #036A07;">"Extract org-source from URL to a buffer named *grab-org-source*."</span>
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sURL: "</span>)
  (switch-to-buffer (get-buffer-create <span style="color: #008000;">"*grab-org-source*"</span>))
  (erase-buffer)
  (org-mode)
  (insert
   (<span style="color: #0000FF;">with-current-buffer</span>
       (url-retrieve-synchronously url)
     (<span style="color: #0000FF;">let</span> (start)
       (re-search-forward
        <span style="color: #008000;">"</span>
<span style="color: #008000;">&lt;!--</span>
<span style="color: #008000;">  ##### SOURCE BEGIN #####</span>
<span style="color: #008000;">"</span> nil t)
       (<span style="color: #0000FF;">setq</span> start (point))
       (re-search-forward <span style="color: #008000;">"##### SOURCE END #####</span>
<span style="color: #008000;">--&gt;"</span> nil t)
       (buffer-substring start (match-beginning 0)))))
  (goto-char (point-min))
  (<span style="color: #0000FF;">while</span> (search-forward <span style="color: #008000;">"%2D"</span> nil t)
    (replace-match <span style="color: #008000;">"-"</span>))
  (goto-char (point-min)))
</pre>
</div>

<p>
This concludes my basic proof of concept. I think there is a general escaping challenge in this approach, because it isn't clear if you can put really arbitrary stuff in an html comment, e.g. you cannot put &#x2013;&gt;! I am going to try incorporating this into my posts and see what other issues come up in the future.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/05/09/An-alternative-approach-to-including-org-source-in-blog-posts.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>
<!--
  ##### SOURCE BEGIN #####
* DONE An alternative approach to including org%2Dsource in blog posts
  CLOSED: [2015%2D05%2D09 Sat 13:57]
  :PROPERTIES:
  :categories: orgmode
  :date:     2015/05/09 13:50:18
  :updated:  2015/05/09 14:58:24
  :END:
When you publish a Matlab m%2Dfile to HTML, Matlab includes the m%2Dfile source as an html comment in the output. They also provide a nice function called grabcode that will take a url, and open the source code in the editor. Today, we try a similar approach for org%2Dmode.

This post is not totally self%2Dcontained. I have my own emacs%2Dlisp module that converts org%2Dmode to blogofile posts, and so far I have not made it broadly available. This is also a super exploratory idea, so I am just going to show the changes I need to make to my setup to get to the evaluation of the idea.

The idea is pretty simple, we just insert the current buffer string into an HTML comment. I just modify the bf%2Dget%2Dpost%2Dhtml function lightly to do that. This is a somewhat pathological example since there are html comments in the post! So, we will encode all the dashes to get around that.

#+BEGIN_SRC emacs%2Dlisp
(require 'browse%2Durl)
(defun bf%2Dget%2Dpost%2Dhtml ()
  "Return a string containing the YAML header, the post html, my
copyright line, and a link to the org%2Dsource code."
  (interactive)
  (let ((org%2Dsource (buffer%2Dstring))
	(url%2Dto%2Dorg (bf%2Dget%2Durl%2Dto%2Dorg%2Dsource))
	(yaml (bf%2Dget%2DYAML%2Dheading))
	(body (bf%2Dget%2DHTML)))

    (with%2Dtemp%2Dbuffer
      (insert yaml)
      (insert body)
      (insert
       (format "<p>Copyright (C) %s by John Kitchin. See the <a href=\"/copying.html\">License</a> for information about copying.<p>"
	       (format%2Dtime%2Dstring "%Y")))
      (insert (format "<p><a href=\"%s\">org%2Dmode source</a><p>"
		      url%2Dto%2Dorg))
      (insert (format "<p>Org%2Dmode version = %s</p>" (org%2Dversion)))
      ;; this is the only new code we need to add.
      (insert (format "
<!%2D%2D
  ##### SOURCE BEGIN #####
%s
##### SOURCE END #####
%2D%2D>" (browse%2Durl%2Durl%2Dencode%2Dchars org%2Dsource "[%2D]")))
      ;; return value
      (buffer%2Dstring))))
#+END_SRC

By itself, that has limited value to me. So, let's also create a grab%2Dorg%2Dsource function to get the embedded source and open it in a buffer. This might be a naive approach, we just use a regexp to find the source boundaries and open it in a new buffer. We have to unescape the dashes, which appear as %2D in the comments. Here is our function.

#+BEGIN_SRC emacs%2Dlisp
(defun grab%2Dorg%2Dsource (url)
  "Extract org%2Dsource from URL to a buffer named *grab%2Dorg%2Dsource*."
  (interactive "sURL: ")
  (switch%2Dto%2Dbuffer (get%2Dbuffer%2Dcreate "*grab%2Dorg%2Dsource*"))
  (erase%2Dbuffer)
  (org%2Dmode)
  (insert
   (with%2Dcurrent%2Dbuffer
       (url%2Dretrieve%2Dsynchronously url)
     (let (start)
       (re%2Dsearch%2Dforward
	"
<!%2D%2D
  ##### SOURCE BEGIN #####
" nil t)
       (setq start (point))
       (re%2Dsearch%2Dforward "##### SOURCE END #####
%2D%2D>" nil t)
       (buffer%2Dsubstring start (match%2Dbeginning 0)))))
  (goto%2Dchar (point%2Dmin))
  (while (search%2Dforward "%2D" nil t)
    (replace%2Dmatch "%2D"))
  (goto%2Dchar (point%2Dmin)))
#+END_SRC

This concludes my basic proof of concept. I think there is a general escaping challenge in this approach, because it isn't clear if you can put really arbitrary stuff in an html comment, e.g. you cannot put %2D%2D>! I am going to try incorporating this into my posts and see what other issues come up in the future.

##### SOURCE END #####
-->]]></content:encoded>
    </item>
    <item>
      <title>Restarting org-babel sessions in org-mode more effectively</title>
      <link>http://jkitchin.github.io/blog/2015/03/19/Restarting-org-babel-sessions-in-org-mode-more-effectively</link>
      <pubDate>Thu, 19 Mar 2015 18:53:18 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">GgehQHNYhDWDmJEFQfs4KCK_sGA=</guid>
      <description>Restarting org-babel sessions in org-mode more effectively</description>
      <content:encoded><![CDATA[



<p>
In a previous <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/03/12/Making-org-mode-Python-sessions-look-better/">post</a> I eliminated one annoying problem with sessions, which was getting rid of extraneous Python interpreter characters in the output. Another thing that has bothered me is when you close Emacs, or even the session buffer, the session is, of course, lost. That means when you reopen the file, you have to run each block in order to continue your work. There does not seem to be a selective way to do this in org. So, in this post, we consider a simple approach to automate that. We want a function that will run all the blocks in a current session that are above the current point.
</p>


<p>
The idea is we will go to the beginning of the buffer, find all blocks that match the language of the block we are in, and in the session, and execute them. We can tell if a block is in a session by looking at the :parameters property of the block. Interestingly, if a block is not in a session, then session will be "none", if it is in an unnamed session, session will be nil, and otherwise, session will be the session name.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">scenario</th>
<th scope="col" class="left">:session value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">no session</td>
<td class="left">"none"</td>
</tr>

<tr>
<td class="left">unnamed session</td>
<td class="left">nil</td>
</tr>

<tr>
<td class="left">named session</td>
<td class="left">"name"</td>
</tr>
</tbody>
</table>

<p>
Here is a function for testing if a block is in a session.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">src-block-in-session-p</span> (<span style="color: #6434A3;">&amp;optional</span> name)
  <span style="color: #036A07;">"Return if src-block is in a session of NAME.</span>
<span style="color: #036A07;">NAME may be nil for unnamed sessions."</span>
  (<span style="color: #0000FF;">let*</span> ((info (org-babel-get-src-block-info))
         (lang (nth 0 info))
         (body (nth 1 info))
         (params (nth 2 info))
         (session (cdr (assoc <span style="color: #006FE0;">:session</span> params))))

    (<span style="color: #0000FF;">cond</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">unnamed session, both name and session are nil</span>
     ((and (null session)
           (null name))
      t)
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Matching name and session</span>
     ((and
       (stringp name)
       (stringp session)
       (string= name session))
      t)
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">no match</span>
     (t nil))))
</pre>
</div>

<p>
Now, we need to get some information about the current point and block. We will want to run blocks that start before the current point, but not after. We will use org-element-map to find code blocks, and when the language and session of a code block matches the current block, and the block starts at a point earlier than the current point, then we will go to that block, and run it. Here is that code.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-restart-session-to-point</span> (<span style="color: #6434A3;">&amp;optional</span> arg)
  <span style="color: #036A07;">"Restart session up to the src-block in the current point.</span>
<span style="color: #036A07;">Goes to beginning of buffer and executes each code block with</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">org-babel-execute-src-block</span><span style="color: #036A07;">' that has the same language and</span>
<span style="color: #036A07;">session as the current block. ARG has same meaning as in</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">org-babel-execute-src-block</span><span style="color: #036A07;">'."</span>
  (interactive <span style="color: #008000;">"P"</span>)
  (<span style="color: #0000FF;">unless</span> (org-in-src-block-p)
    (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"You must be in a src-block to run this command"</span>))
  (<span style="color: #0000FF;">let*</span> ((current-point (point-marker))
         (info (org-babel-get-src-block-info))
         (lang (nth 0 info))
         (params (nth 2 info))
         (session (cdr (assoc <span style="color: #006FE0;">:session</span> params))))
    (<span style="color: #0000FF;">save-excursion</span>
      (goto-char (point-min))
      (<span style="color: #0000FF;">while</span> (re-search-forward org-babel-src-block-regexp nil t)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">goto start of block</span>
        (goto-char (match-beginning 0))
        (<span style="color: #0000FF;">let*</span> ((this-info (org-babel-get-src-block-info))
               (this-lang (nth 0 this-info))
               (this-params (nth 2 this-info))
               (this-session (cdr (assoc <span style="color: #006FE0;">:session</span> this-params))))
            (<span style="color: #0000FF;">when</span>
                (and
                 (&lt; (point) (marker-position current-point))
                 (string= lang this-lang)
                 (src-block-in-session-p session))
              (org-babel-execute-src-block arg)))
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">move forward so we can find the next block</span>
        (forward-line)))))
</pre>
</div>


<p>
In the course of testing this, I found this function a little helpful to kill the current session so we start fresh.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-kill-session</span> ()
  <span style="color: #036A07;">"Kill session for current code block."</span>
  (interactive)
  (<span style="color: #0000FF;">unless</span> (org-in-src-block-p)
    (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"You must be in a src-block to run this command"</span>))
  (<span style="color: #0000FF;">save-window-excursion</span>
    (org-babel-switch-to-session)
    (kill-buffer)))
</pre>
</div>

<p>
And also this one to remove all results in the buffer. This not at all selective, it removes results for session and non-session blocks.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-remove-result-buffer</span> ()
  <span style="color: #036A07;">"Remove results from every code block in buffer."</span>
  (interactive)
  (<span style="color: #0000FF;">save-excursion</span>
    (goto-char (point-min))
    (<span style="color: #0000FF;">while</span> (re-search-forward org-babel-src-block-regexp nil t)
      (org-babel-remove-result))))
</pre>
</div>

<p>
Ok, now for some testing. The rest of this post is pretty boring, just some blocks of mixed session and non-session to see if they get run. Skip to the <a href="#sec-1">1</a>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">def</span> <span style="color: #006699;">f</span>(x):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">y</span> = 4 * x
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> y

<span style="color: #0000FF;">print</span>(f(d))
</pre>
</div>

<pre class="example">
16
</pre>

<p>
Let us put a non-session block in this buffer for testing.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #BA36A5;">a</span> = 5
<span style="color: #0000FF;">print</span>(a)
</pre>
</div>

<p>
Now, some more named session blocks.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> f(5)
</pre>
</div>

<pre class="example">
20
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'ok'</span>
</pre>
</div>

<pre class="example">
ok
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> 2
</pre>
</div>

<pre class="example">
2
</pre>

<p>
An unnamed session that should not get run in restarting the named test session.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> 886
</pre>
</div>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> f(6)
</pre>
</div>

<pre class="example">
24
</pre>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Summary</h2>
<div class="outline-text-2" id="text-1">
<p>
This works pretty well so far.  It would be nice to consider making C-c C-c do this automatically, if the session does not exist, and maybe to take a prefix arg that would restart the session. Maybe on another day ;)
</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/03/19/Restarting-org-babel-sessions-in-org-mode-more-effectively.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Update on org-ref - it is now all emacs-lisp</title>
      <link>http://jkitchin.github.io/blog/2015/03/16/Update-on-org-ref-it-is-now-all-emacs-lisp</link>
      <pubDate>Mon, 16 Mar 2015 08:51:50 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[orgref]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">lxDcgY-unx5zZatEH91XGswGRFQ=</guid>
      <description>Update on org-ref - it is now all emacs-lisp</description>
      <content:encoded><![CDATA[



<p>
The <a href="https://github.com/jkitchin/org-ref">org-ref</a> code is finally all in emacs-lisp! This should make it much easier to install, and is another step closer to getting org-ref into MELPA. Previously, I had written the most significant code in org-mode source blocks that were intended to be tangled out. I found this was not really portable, because what gets tangled depends on your org-mode setup. I had to specifically set example blocks to not tangle, or org-ref would not work for other people, and if I forgot to set a block to tangle, it also would not work for others. That should not happen again now, since there is no more tangling.
</p>


<p>
There are some relatively new features in org-ref:
</p>
<ol class="org-ol">
<li>New colored org-ref links to differentiate them from other
org-links. Citations are greenish, refs and labels are maroonish.
</li>
<li>Context messages about links. With your cursor on a cite, ref or label link
you will get a context message, e.g. a formatted citation, some context about
the label a ref refers to, or a count of the labels in the mini-buffer.
</li>
<li>There is now an org-ref menu in the Org menu.
</li>
<li>There is a new org-ref-help function that opens an org-file of org-ref
documentation.
</li>
<li>Pretty thorough integration of helm throughout org-ref, and some integration
of hydra.
</li>
<li>A few utility libraries: doi-utils, isbn, wos, pubmed, arxiv, jmax-bibtex, sci-id,
x2bib. Not all these are new, but if you didn't know about them, check them out.
</li>
<li>Cask integration. This mostly provides access to testing and dependencies
right now. org-ref is also now tested continuously at
<a href="https://travis-ci.org/jkitchin/org-ref">https://travis-ci.org/jkitchin/org-ref</a> .
</li>
</ol>

<p>
org-ref is basically feature complete I think (which is to say that once again, I do not have any big ideas for new features ;). There are some places where it could be refactored a little, e.g. there are some bibtex only functions in org-ref.el that really should go into jmax-bibtex.el (which also could be renamed). This is a very low priority though, because things are working fine as far as I can tell.
</p>

<p>
What does it need before going into MELPA? Probably some tests would be a good idea. On Travis, all that is really tested is that it loads with no errors. I would like to see some stability on my end, e.g. at least a week where no commits get made, and no errors are reported. And finally, I would like to make sure I have some time to handle issues that come up when a broader audience is trying it out.
</p>

<p>
My target date to get this in MELPA is June 1, 2015. Try out the new org-ref, and let me know how it goes!</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/03/16/Update-on-org-ref---it-is-now-all-emacs-lisp.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Making org-mode Python sessions look better</title>
      <link>http://jkitchin.github.io/blog/2015/03/12/Making-org-mode-Python-sessions-look-better</link>
      <pubDate>Thu, 12 Mar 2015 10:45:25 EDT</pubDate>
      <category><![CDATA[python]]></category>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">MN-Omj3zydWElmxF1nt9OF2w1B0=</guid>
      <description>Making org-mode Python sessions look better</description>
      <content:encoded><![CDATA[


<p>
Using sessions for python in org-mode has always bugged me a little bit. Mostly the appearance of &gt;&gt;&gt; and &#x2026; in the output. For example:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> 8
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; 8
</pre>

<p>
Today on the org-mode mailing list someone suggested a <a href="http://thread.gmane.org/gmane.emacs.orgmode/95980/focus=96011">patch</a> that might fix that up. Hopefully that patch makes it into org-mode, but if you run off of ELPA like I do it will be some time before it appears in your working version.
</p>

<p>
In the meantime, inspired by my <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/03/11/Updating-Multiple-RESULTS-blocks-in-org-mode/">recent post</a> on updating multiple results, here we add a new hook function that removes these annoying characters from a Python session results section. Here is my version of this code.
"^: &gt;&gt;&gt;$"
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-python-strip-session-chars</span> ()
  <span style="color: #036A07;">"Remove &gt;&gt;&gt; and ... from a Python session output."</span>
  (<span style="color: #0000FF;">when</span> (and (string=
              <span style="color: #008000;">"python"</span>
              (org-element-property <span style="color: #006FE0;">:language</span> (org-element-at-point)))
             (string-match
              <span style="color: #008000;">":session"</span>
              (org-element-property <span style="color: #006FE0;">:parameters</span> (org-element-at-point))))

    (<span style="color: #0000FF;">save-excursion</span>
      (<span style="color: #0000FF;">when</span> (org-babel-where-is-src-block-result)
        (goto-char (org-babel-where-is-src-block-result))
        (end-of-line 1)
        <span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">(while (looking-at "[\n\r\t\f ]") (forward-char 1))</span>
        (<span style="color: #0000FF;">while</span> (re-search-forward
                <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">\\.\\.\\. </span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">: $</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">: &gt;&gt;&gt;$</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
                (org-element-property <span style="color: #006FE0;">:end</span> (org-element-at-point))
                t)
          (replace-match <span style="color: #008000;">""</span>)
          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this enables us to get rid of blank lines and blank : &gt;&gt;&gt;</span>
          (beginning-of-line)
          (<span style="color: #0000FF;">when</span> (looking-at <span style="color: #008000;">"^$"</span>)
            (kill-line)))))))

(add-hook 'org-babel-after-execute-hook 'org-babel-python-strip-session-chars)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">org-babel-python-strip-session-chars</td>
<td class="left">(lambda nil (org-refresh-images))</td>
</tr>
</tbody>
</table>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
plt.plot([3, 4, 5])
plt.show()

<span style="color: #0000FF;">def</span> <span style="color: #006699;">f</span>(s):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">x</span> = 2 * s
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">blank lines look like indentation errors</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> x

<span style="color: #0000FF;">print</span> f(4)
</pre>
</div>

<pre class="example">
[&lt;matplotlib.lines.Line2D object at 0x10955c290&gt;]
8
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> f(9)
</pre>
</div>

<pre class="example">
18
</pre>

<p>
Here we can make an inline figure.
</p>
<div class="org-src-container">

<pre class="src src-python">plt.figure()
plt.plot([3, 4.5, 5])
plt.savefig(<span style="color: #008000;">'images/session-fig.png'</span>)
<span style="color: #008000;">'images/session-fig.png'</span>
</pre>
</div>

<p>
<img src="/media/2015-03-12-Making-org-mode-Python-sessions-look-better/session-fig.png"> 
Not bad. It seems to work! Maybe this will make sessions more usable for me.
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2015-03-12 Thu]</span></span> New corner case, do not cause an error when results are silenced.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> 6
</pre>
</div>


<p>
Testing getting rid of blank lines and empty : &gt;&gt;&gt; lines.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #BA36A5;">a</span> = 2
<span style="color: #BA36A5;">b</span> = 3
<span style="color: #BA36A5;">c</span> = 4
<span style="color: #0000FF;">print</span>
<span style="color: #0000FF;">print</span> <span style="color: #008000;">'a=      '</span>, a
<span style="color: #0000FF;">print</span> <span style="color: #008000;">'b =     '</span>, b
<span style="color: #0000FF;">print</span> <span style="color: #008000;">'a + b = '</span>, a+b
</pre>
</div>

<pre class="example">
a=       2
b =      3
a + b =  5
</pre>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/03/12/Making-org-mode-Python-sessions-look-better.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Updating Multiple RESULTS blocks in org-mode</title>
      <link>http://jkitchin.github.io/blog/2015/03/11/Updating-Multiple-RESULTS-blocks-in-org-mode</link>
      <pubDate>Wed, 11 Mar 2015 17:33:51 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">2vg4LFWYsRnJFSqzhHiiDl3OYtE=</guid>
      <description>Updating Multiple RESULTS blocks in org-mode</description>
      <content:encoded><![CDATA[



<p>
There was a recent question on the org-mode mailing list about getting multiple named block results to update when a named code block is run. I suppose you might want to do this if you need to see the results in more than one place. org-mode (at the moment) only updates the first named block that it finds from the beginning of the buffer. Challenge accepted ;)
</p>

<p>
Here is a function that will update all the named RESULTS blocks. The idea is to make a hook function that runs after you run a block. The hook function will get the block name, and if there is one, find all the named results in the buffer and update them.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">update-results</span> ()
  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get name of src block</span>
  (<span style="color: #0000FF;">let</span> ((name (org-element-property <span style="color: #006FE0;">:name</span> (org-element-at-point)))
        (results)
        (begin))
    (<span style="color: #0000FF;">when</span> name
      (setq results
            (<span style="color: #0000FF;">save-excursion</span>
              (goto-char (org-babel-find-named-result name))
              (forward-line)
              (buffer-substring
               (point) (org-element-property <span style="color: #006FE0;">:end</span> (org-element-at-point)))))
      (<span style="color: #0000FF;">save-excursion</span>
        (goto-char (point-min))
        (<span style="color: #0000FF;">while</span> (setq begin (org-babel-find-named-result name (point)))
          (goto-char begin)
          (forward-line)
          (setf (buffer-substring
                 (point)
                 (org-element-property <span style="color: #006FE0;">:end</span> (org-element-at-point)))
                results))))))

(add-hook 'org-babel-after-execute-hook 'update-results)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">update-results</td>
<td class="left">(lambda nil (org-refresh-images))</td>
</tr>
</tbody>
</table>

<p>
Now let us test it out. Here is an unnamed block that should be ignored.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> 4
</pre>
</div>

<pre class="example">
4
</pre>

<p>
Here we have a named results block from a code block we will see later.
</p>
<pre class="example">
[0.0825119635983067, 0.12793443834890417, 0.5235765147357154]
</pre>

<p>
Here is our named code block that just prints three random numbers.
</p>

<div class="org-src-container">

<pre class="src src-python" id="testcode"><span style="color: #0000FF;">import</span> random

<span style="color: #0000FF;">print</span> [random.random() <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(3)]
</pre>
</div>

<pre class="example">
[0.0825119635983067, 0.12793443834890417, 0.5235765147357154]
</pre>

<p>
Swell, everytime I run the block, the named results get updated everywhere! It isn't tested more than this post, so I would spend some time trying out your use cases before doing anything mission critical. Your mileage might vary. For example, if you have a named block outside a narrowed region it is not clear to me it would update. In other words, there might be other corners where this doesn't update like you thing.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/03/11/Updating-Multiple-RESULTS-blocks-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>org-mode links meet hydra</title>
      <link>http://jkitchin.github.io/blog/2015/02/22/org-mode-links-meet-hydra</link>
      <pubDate>Sun, 22 Feb 2015 19:06:41 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[hydra]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">TYEqdqY8zmTBakbJFQgkXPMjC88=</guid>
      <description>org-mode links meet hydra</description>
      <content:encoded><![CDATA[


<p>
I have played with a lot of options to give org-mode links extra functionality. Here are a few of the ideas I have looked at so far.
</p>

<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links/">Enabling right clicks on links</a> 
</li>
<li>A home made minibuffer menu in org-ref
</li>
<li>A helm buffer in org-ref
</li>
</ol>

<p>
Here, I want to explore a hydra menu for a link. The idea is pretty simple, we need functions that do something with the link at point, and a hydra interface to call them. This turned out to be a little tricky. I could not get the path from the link in the link lambda function, and we need a way to pass the path to the function. I use a global variable for that. I wish there was another way to do that, but this does actually work. We illustrate it here with a more functional doi link.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-crossref</span> ()
  <span style="color: #036A07;">"Search DOI in CrossRef."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://search.crossref.org/?q=%s"</span> *doi-hydra-path*)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-google-scholar</span> ()
  <span style="color: #036A07;">"Google scholar the doi."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://scholar.google.com/scholar?q=%s"</span> *doi-hydra-path*)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">doi-pubmed</span> ()
  <span style="color: #036A07;">"Pubmed the doi."</span>
  (interactive)
  (browse-url
   (format
    <span style="color: #008000;">"http://www.ncbi.nlm.nih.gov/pubmed/?term=%s"</span>
    (url-hexify-string *doi-hydra-path*))))

 (defhydra doi-hydra ()
   <span style="color: #008000;">"org-ref"</span>
   (<span style="color: #008000;">"c"</span> doi-crossref <span style="color: #008000;">"Crossref"</span>)
   (<span style="color: #008000;">"g"</span> doi-google-scholar <span style="color: #008000;">"Google Scholar"</span>)
   (<span style="color: #008000;">"p"</span> doi-pubmed <span style="color: #008000;">"Pubmed"</span>))

(org-add-link-type <span style="color: #008000;">"doi"</span>
  (<span style="color: #0000FF;">lambda</span> (path) (setq *doi-hydra-path* path) (doi-hydra/body)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(path)</td>
<td class="left">(setq <b>doi-hydra-path</b> path)</td>
<td class="left">(doi-hydra/body)</td>
</tr>
</tbody>
</table>

<p>
Now for a test, <a href="10.1021/jp047349j">10.1021/jp047349j</a>.
</p>

<p>
It works fine, when you click on a link, you get a minibuffer menu with context hints, and pressing any other key than is defined simply cancels the command.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/22/org-mode-links-meet-hydra.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Extending the org-mode link syntax with attributes</title>
      <link>http://jkitchin.github.io/blog/2015/02/05/Extending-the-org-mode-link-syntax-with-attributes</link>
      <pubDate>Thu, 05 Feb 2015 10:06:25 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">lkBnYhulyhLMZBLWqqgRvAxph3o=</guid>
      <description>Extending the org-mode link syntax with attributes</description>
      <content:encoded><![CDATA[


<p>
I make super heavy use of links in org-mode. I use them extensively in org-ref to create functional citations. One detail that has never been very satisfactory is the need for pre/post text in citations. I don't need that capability often, but it seems important to some. I have implemented a kind of clunky solution where I use the description part of a link with the pre/post text separated by a ::. Although that works, I dislike the way it looks, the need to parse it, and that the description covers the link.
</p>

<pre class="example">
[[cite:key][pre text::post text]]
</pre>

<p>
Some <a href="https://lists.gnu.org/archive/html/emacs-orgmode/2010-08/msg00404.html">time ago</a> there was a suggestion of how to extend the link syntax, which was to my knowledge never implemented. Here is the proposed syntax:
</p>
<pre class="example">
$[link http://google.com
         :last-followed [2009-02-25 Wed 02:00]
         :label "click here for evil search engine"
         :export-label "click here for nice search engine"]
</pre>

<p>
This is interesting because this syntax suggests the link has attributes which can be updated.
</p>

<p>
We will show here how to implement part of this idea with the existing link syntax. We will make a link that has attributes like that. The basic idea is to simply incorporate the attributes into the path, and use lisp to read them. We will wrap the link path in parentheses and read that as a lisp data structure. So, a link like <i>link:key :pre "some pre text" :post "some post text"</i> will be parsed as:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(read <span style="color: #008000;">"(key :pre \"some pre text\" :post \"some post text\")"</span>)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">key</td>
<td class="left">:pre</td>
<td class="left">some pre text</td>
<td class="left">:post</td>
<td class="left">some post text</td>
</tr>
</tbody>
</table>

<p>
The car of that list is the key, and the cdr contains the attributes. The quotes are necessary here to make sure all the text is correctly parsed as a single element for each attribute. So, here is an example link
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type
 <span style="color: #008000;">"slink"</span>
 <span style="color: #8D8D84;">;;  </span><span style="color: #8D8D84; font-style: italic;">follow function</span>
 (<span style="color: #0000FF;">lambda</span> (path)
   (<span style="color: #0000FF;">let*</span> ((data (read (format <span style="color: #008000;">"(%s)"</span> path)))
          (head (car data))
          (plist (cdr data))
          (link (org-element-context))
          (begin (org-element-property <span style="color: #006FE0;">:begin</span> link))
          (end (org-element-property <span style="color: #006FE0;">:end</span> link)))
     (<span style="color: #0000FF;">setq</span> plist (plist-put plist <span style="color: #006FE0;">:last-clicked</span> (current-time-string)))
     (<span style="color: #0000FF;">save-excursion</span>
     (<span style="color: #0000FF;">setf</span> (buffer-substring begin end) <span style="color: #008000;">""</span>)
     (goto-char begin)
     (insert (format <span style="color: #008000;">"[[slink:%s %s]]"</span> head
         (substring (format <span style="color: #008000;">"%S"</span> plist) 1 -1))))))
 <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">format function</span>
 (<span style="color: #0000FF;">lambda</span> (path description backend)
   (<span style="color: #0000FF;">let*</span> ((data (read (concat <span style="color: #008000;">"("</span> path <span style="color: #008000;">")"</span>)))
          (head (car data))
          (plist (cdr data)))
     (format <span style="color: #008000;">"\\%s[%s][%s]{%s}"</span>
             (plist-get plist <span style="color: #006FE0;">:type</span>)
             (plist-get plist <span style="color: #006FE0;">:pre</span>)
             (plist-get plist <span style="color: #006FE0;">:post</span>)
             head))))
</pre>
</div>

<p>
Now, each time I click on this link, the time stamp gets updated.
</p>

<p>
\cite[See for example][page 47]{kitchin-2010}
</p>

<pre class="example">
[[slink:kitchin-2010 :pre "See for example" :post "page 47" :type "cite" :last-clicked "Thu Feb  5 09:31:15 2015"]]
</pre>


<p>
And, the generic export of this link is:
</p>

<pre class="example">
\cite[See for example][page 47]{kitchin-2010}
</pre>

<p>
Is this a good idea? I am not using this for anything right now. Sometimes my version of org-mode has trouble recognizing that is a link. It is strange, as I am typing, sometimes it flashes in and out of being recognized as a link. Anyway, it is an interesting idea!</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/02/05/Extending-the-org-mode-link-syntax-with-attributes.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Export org-mode to docx with citations via pandoc</title>
      <link>http://jkitchin.github.io/blog/2015/01/29/Export-org-mode-to-docx-with-citations-via-pandoc</link>
      <pubDate>Thu, 29 Jan 2015 07:34:14 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[docx]]></category>
      <guid isPermaLink="false">SQ3JHeoJiZ9SqSQj6aLJepZ7lho=</guid>
      <description>Export org-mode to docx with citations via pandoc</description>
      <content:encoded><![CDATA[


<p>
Pandoc continues to develop, and since <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/07/17/Pandoc-does-org-mode-now/">the last time</a> I wrote about it there is improved support for citations. We will use that to convert org documents to Word documents that actually have citations and a bibliography in them. This post explores using helm-bibtex to insert pandoc compatible citations, and then using pandoc to convert the org file to a word document (docx). We can define the format of citations that helm-bibtex inserts in a function, and tell helm-bibtex to use it when in org mode.
</p>

<p>
Here is that code. This is just to give me a convenient tool to insert citations with searching in my bibtex file. I think you could just as easily use reftex for this, or an ido-completing function on bibtex keys. See <a href="http://johnmacfarlane.net/pandoc/README.html">Pandoc - Pandoc Users Guide</a> for directions on citation format. The key is to format the cite links to the pandoc format.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">helm-bibtex-format-pandoc-citation</span> (keys)
  (concat <span style="color: #008000;">"["</span> (mapconcat (<span style="color: #0000FF;">lambda</span> (key) (concat <span style="color: #008000;">"@"</span> key)) keys <span style="color: #008000;">"; "</span>) <span style="color: #008000;">"]"</span>))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">inform helm-bibtex how to format the citation in org-mode</span>
(setf (cdr (assoc 'org-mode helm-bibtex-format-citation-functions))
  'helm-bibtex-format-pandoc-citation)
</pre>
</div>
<pre class="example">
helm-bibtex-format-pandoc-citation
</pre>

<p>
Now, we can cite the org-mode book [@dominik-2010-org-mode], and some interesting papers on using org-mode [@schulte-2011-activ-docum; @schulte-2012-multi-languag]. You could pretty easily add pre and post text manually to these, after selecting and inserting them.
</p>

<p>
We need a bibliography file for pandoc to work. I will use a bibtex file, since I already have it and am using helm-bibtex to select keys. I found pandoc could not read my massive bibtex file, perhaps it does not support all the types yet, so I made a special small bibtex file for this. So, now all we need to do is convert this file to a docx. I use a function like this to do that. It uses an org-ref function to get the bibliography defined in this file, derives some file names, and then runs pandoc.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ox-export-to-docx-and-open</span> ()
 <span style="color: #036A07;">"Export the current org file as a docx via markdown."</span>
 (interactive)
 (<span style="color: #0000FF;">let*</span> ((bibfile (expand-file-name (car (org-ref-find-bibliography))))
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is probably a full path</span>
        (current-file (buffer-file-name))
        (basename (file-name-sans-extension current-file))
        (docx-file (concat basename <span style="color: #008000;">".docx"</span>)))
   (save-buffer)
   (<span style="color: #0000FF;">when</span> (file-exists-p docx-file) (delete-file docx-file))
   (shell-command (format
                   <span style="color: #008000;">"pandoc -s -S --bibliography=%s %s -o %s"</span>
                   bibfile current-file docx-file))
   (org-open-file docx-file '(16))))
</pre>
</div>

<p>
And now we run it to get our docx.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(ox-export-to-docx-and-open)
</pre>
</div>

<p>
Here is the result: <a href="/media/2015-01-29-Export-org-mode-to-docx-with-citations-via-pandoc/org-to-docx-pandoc.docx">org-to-docx-pandoc.docx</a> 
</p>

<p>
It is not too bad. Not all the equations showed up below, and the figure did not appear for some reason. But, the citations went through fine.  A downside of this is the citation links are not clickable (but see <a href="#sec-7">Making pandoc links</a> for a way to do this), so they lack all the awesome features that org-ref gives them. Maybe pandoc can convert these to LaTeX links, but we already have such a good framework for that I do not see why you would want to do it. A better option is to figure out how to export the org file to an org file, and transform the org citation links to pandoc citations, then use pandoc on the temporarily transformed buffer. That way, you keep the cite links and their functionality, and ability to export to many formats, <i>and</i> get export to docx via pandoc.
</p>

<p>
There are other options in pandoc to fine tune the reference format (you need a csl file). That can be included in the org-file via file tags pretty easily. These citations are not links in the word document, and it does not look like they can be converted to footnotes, endnotes or interact with Endnote or Zotero at this time, but it is a step forward in getting a passable word document with references out of org-mode!
</p>

<p>
Since we are testing, let us try it some other typical features in an org-file.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Numbered list</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Item 1
</li>
<li>Item 2
</li>
<li>Item 3
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Bulleted list</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>item 1
</li>
<li>item 2
</li>
<li>item 3
<ul class="org-ul">
<li>subitem
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> definitions</h2>
<div class="outline-text-2" id="text-3">
<dl class="org-dl">
<dt> org-mode </dt><dd>tool for awesomeness
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Math</h2>
<div class="outline-text-2" id="text-4">
<p>
One equation:
<img src="ltxpng/org-to-docx-pandoc_71dd900d7f17a20875918a89a10eb146fccdd464.png" alt="\(e^{i\pi} - 1 = 0\)" />
</p>

<p>
A second equation:
</p>


<div class="figure">
<p><img src="ltxpng/org-to-docx-pandoc_fb56117cdd3c3ac81c363d24325cfc6b5a530420.png" alt="\begin{equation}
e^{i\pi} - 1 = 0
\end{equation}" /></p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> An image</h2>
<div class="outline-text-2" id="text-5">

<div id="icon" class="figure">
<p><img src="/media/2015-01-29-Export-org-mode-to-docx-with-citations-via-pandoc/emacs.png"> 
</p>
<p><span class="figure-number">Figure 1:</span> A little icon.</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> A table</h2>
<div class="outline-text-2" id="text-6">
<table id="my-table" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> A little table.</caption>

<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">4</td>
</tr>
</tbody>
</table>


<p>
a plain table
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">4</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><a id="ID-2958EFDC-CC33-4E2A-8A92-D2BE06EBB3F2" name="ID-2958EFDC-CC33-4E2A-8A92-D2BE06EBB3F2"></a><span class="section-number-2">7</span> Making pandoc links</h2>
<div class="outline-text-2" id="text-7">
<p>
Here I show a way to get clickable text on pandoc links. I found a nice library called <a href="https://github.com/rolandwalker/button-lock">button-lock</a> that uses a regular expression to attach text properties to matching text.
</p>

<p>
Below I repeat the citations so it is easy to see the effect after running the code block. Indeed, you get clickable text, even org-ref like capability. I think you could even add the idle-timer messages, and the org-ref menu.
</p>

<p>
Now, we can cite the org-mode book [@dominik-2010-org-mode], and some interesting papers on using org-mode [@schulte-2011-activ-docum; @schulte-2012-multi-languag]. You could pretty easily add pre and post text manually to these, after selecting and inserting them.
</p>

<p>
You would need to make this code run in when you open an org-file to get it to work every time.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">button-lock</span>)
(global-button-lock-mode)

(button-lock-set-button
 <span style="color: #008000;">"@</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[-a-zA-Z0-9_:]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
 (<span style="color: #0000FF;">lambda</span> ()
   (interactive)
   (re-search-backward <span style="color: #008000;">"@"</span>)
   (re-search-forward  <span style="color: #008000;">"@</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[-a-zA-Z0-9_:]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>)
   (<span style="color: #0000FF;">let*</span> ((key (match-string-no-properties 1))
          (bibfile (cdr (org-ref-get-bibtex-key-and-file key))))
     (<span style="color: #0000FF;">if</span> bibfile
        (<span style="color: #0000FF;">save-excursion</span>
          (<span style="color: #0000FF;">with-temp-buffer</span>
            (insert-file-contents bibfile)
            (bibtex-search-entry key)
            (message (org-ref-bib-citation))))
       (message <span style="color: #008000;">"No entry found"</span>))))
 <span style="color: #006FE0;">:face</span> (list 'org-link))
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> References</h2>
<div class="outline-text-2" id="text-8">
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/01/29/Export-org-mode-to-docx-with-citations-via-pandoc.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Redirecting stderr in org-mode shell blocks</title>
      <link>http://jkitchin.github.io/blog/2015/01/04/Redirecting-stderr-in-org-mode-shell-blocks</link>
      <pubDate>Sun, 04 Jan 2015 08:59:04 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">FnSd1HUqeesF9gkoSEIMopOBpTk=</guid>
      <description>Redirecting stderr in org-mode shell blocks</description>
      <content:encoded><![CDATA[


<p>
Org-mode shell source blocks do not capture stderr. For example, in this block, with the default setup:
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stdout"</span> &gt;&amp;1
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stderr"</span> &gt;&amp;2
</pre>
</div>

<pre class="example">
testing stdout
</pre>

<p>
You can see the second line is not in the output.
</p>

<p>
If you run this command, you get an <b>Org-Babel Error Output</b> buffer saying it is an illegal option.
</p>

<div class="org-src-container">

<pre class="src src-sh">date -g
</pre>
</div>

<p>
It would be nice to just capture that error, and show it.
</p>

<p>
We solved this problem in <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/12/21/Capturing-stderr-from-Python-in-org-mode-take-2/">Python</a> by redirecting stderr at runtime. It is not that simple in shell blocks, but we can do a similar thing. The code block is executed (I think) by saving the block to a temporary file, and then running org-babel-sh-command on the file. That magic happens inside the command shell-command-on-region. We just need to make that command redirect stderr. Here is a new shell command that does this. This next block can be tangled out to an executable command. This script takes one argument, which I believe is a filename (the temporary file containing the source block region).
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
{
bash $<span style="color: #BA36A5;">1</span>
} 2&gt;&amp;1
</pre>
</div>

<p>
Now, we set org-babel-sh-command to our new shell command.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq org-babel-sh-command <span style="color: #008000;">"./sh_stderr.sh"</span>)
</pre>
</div>

<pre class="example">
./sh_stderr.sh
</pre>

<p>
Now, it appears we get what we want:
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stdout"</span> &gt;&amp;1
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stderr"</span> &gt;&amp;2
</pre>
</div>
<pre class="example">
testing stdout
testing stderr
</pre>

<p>
And, with the bad option to date, we get:
</p>

<div class="org-src-container">

<pre class="src src-sh">date -g
<span style="color: #006FE0;">echo</span>
</pre>
</div>
<pre class="example">
date: illegal option -- g
usage: date [-jnu] [-d dst] [-r seconds] [-t west] [-v[+|-]val[ymwdHMS]] ...
            [-f fmt date | [[[mm]dd]HH]MM[[cc]yy][.ss]] [+format]
</pre>

<p>
Not bad! I have not tested this very thoroughly, i.e. beyond these little examples, but it seems like it could work.
</p>

<p>
Achim Gratz suggested this simpler approach that does not involve any external scripts. The : at the end is important!
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #0000FF;">exec</span> 2&gt;&amp;1
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stdout"</span> &gt;&amp;1
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"testing stderr"</span> &gt;&amp;2
date -g
:
</pre>
</div>
<pre class="example">
testing stdout
testing stderr
date: illegal option -- g
usage: date [-jnu] [-d dst] [-r seconds] [-t west] [-v[+|-]val[ymwdHMS]] ...
            [-f fmt date | [[[mm]dd]HH]MM[[cc]yy][.ss]] [+format]
</pre>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/01/04/Redirecting-stderr-in-org-mode-shell-blocks.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
  </channel>
</rss>
