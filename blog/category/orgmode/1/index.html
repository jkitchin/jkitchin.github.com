

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group: orgmode</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Adding-keymaps-to-src-blocks-via-org-font-lock-hook"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook/" rel="bookmark" title="Permanent Link to Adding keymaps to src blocks via org-font-lock-hook">Adding keymaps to src blocks via org-font-lock-hook</a></h2>
      <p><small><span class="blog_post_date">Posted June 10, 2017 at 03:27 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated June 12, 2017 at 11:28 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org49daca5">1. Update</a></li>
<li><a href="#org004cb53">2. Update #2</a></li>
</ul>
</div>
</div>
<p>
I had an idea to use custom keymaps in src-blocks. For example, you could then use lispy directly in your org-files without entering org-special-edit, or the elpy key-bindings in python blocks. There are other solutions I have seen, e.g. polymode, that claim to do this. You might guess that if they worked, I would not be writing this! There was some nice discussion about this idea on the org-mode mailing list, and Nicolas Goaziou pointed out this might be accomplished with the org-font-lock-hook.
</p>

<p>
You can check out the video here:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/a2jHqB1qWiY" frameborder="0" allowfullscreen></iframe>

<p>
It was relatively easy to figure out how to do this. Keymaps can be added to regions during font-lock, so I just had to hook into the org-mode font lock system with a function to find the src blocks and add the keymap as a text-property. That took three steps:
</p>

<ol class="org-ol">
<li>Define the keymaps to use. I use an a-list of (language . map) for this.</li>
<li>Define the font-lock function. This will add the keymap properties to src-blocks.</li>
<li>Define a minor mode to toggle this feature on and off.</li>
</ol>

<p>
Here is the definition of the keymaps. Generally I just copy the mode-map I want and then add some things to them. For example sometimes it is still a good idea to jump into the org-special-edit mode. For example, if you try to use a command in a Python block to send the buffer to the repl while in org-mode you are sure to get an error! You might also want to add the C-c C-e export command if you use that a lot. An alternative approach, of course, is to copy the org-map and add additional bindings to it. The choice is up to you.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">lispy</span>)
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">elpy</span>)

(<span style="color: #0000FF;">setq</span> scimax-src-block-keymaps
      `((<span style="color: #008000;">"ipython"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap
                                  `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                  org-mode-map)))
                        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">In org-mode I define RET so we f</span>
                        (define-key map (kbd <span style="color: #008000;">"&lt;return&gt;"</span>) 'newline)
                        (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                        map))
        (<span style="color: #008000;">"python"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap
                                 `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                 org-mode-map)))
                       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">In org-mode I define RET so we f</span>
                       (define-key map (kbd <span style="color: #008000;">"&lt;return&gt;"</span>) 'newline)
                       (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                       map))
        (<span style="color: #008000;">"emacs-lisp"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap `(,lispy-mode-map
                                                            ,emacs-lisp-mode-map
                                                            ,outline-minor-mode-map)
                                                          org-mode-map)))
                           (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                           map))))
</pre>
</div>

<p>
Next we define the function that will apply the keymap to each src block. The keymaps are only applied when they are defined in the variable above. This function is derived from org-fontify-meta-lines-and-blocks-1.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-add-keymap-to-src-blocks</span> (limit)
  <span style="color: #036A07;">"Add keymaps to src-blocks defined in `</span><span style="color: #D0372D;">scimax-src-block-keymaps</span><span style="color: #036A07;">'."</span>
  (<span style="color: #0000FF;">let</span> ((case-fold-search t)
        lang)
    (<span style="color: #0000FF;">while</span> (re-search-forward org-babel-src-block-regexp limit t)
      (<span style="color: #0000FF;">let</span> ((lang (match-string 2))
            (beg (match-beginning 0))
            (end (match-end 0)))
        (<span style="color: #0000FF;">if</span> (assoc (org-no-properties lang) scimax-src-block-keymaps)
            (<span style="color: #0000FF;">progn</span>
              (add-text-properties
               beg end `(local-map ,(cdr (assoc
                                          (org-no-properties lang)
                                          scimax-src-block-keymaps))))
              (add-text-properties
               beg end `(cursor-sensor-functions
                         ((<span style="color: #0000FF;">lambda</span> (win prev-pos sym)
                            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">This simulates a mouse click and makes a menu change</span>
                            (org-mouse-down-mouse nil)))))))))))
</pre>
</div>

<p>
Here we create an advice to trick any functions that need to know the major mode. We only apply the spoof if we are in org-mode and in a src block though. Otherwise we call the original function. So far lispy&#x2013;eval is the only function I have needed it for. This might be a general strategy though to do other things like narrow to the src-block, or even go into special edit mode temporarily if there are commands that require it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-spoof-mode</span> (orig-func <span style="color: #6434A3;">&amp;rest</span> args)
  <span style="color: #036A07;">"Advice function to spoof commands in org-mode src blocks.</span>
<span style="color: #036A07;">It is for commands that depend on the major mode. One example is</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">lispy--eval</span><span style="color: #036A07;">'."</span>
  (<span style="color: #0000FF;">if</span> (org-in-src-block-p)
      (<span style="color: #0000FF;">let</span> ((major-mode (intern (format <span style="color: #008000;">"%s-mode"</span> (first (org-babel-get-src-block-info))))))
        (apply orig-func args))
    (apply orig-func args)))
</pre>
</div>

<p>
We define a minor mode so we can toggle this on and off. Here we add the function to the org-font-lock-hook and advise the lispy&#x2013;eval function. I had to add the font-lock-function to the end of the org-font-lock hook for some reason, and also add local-map as an extra-managed property so it would be removed when we toggle it off.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">define-minor-mode</span> <span style="color: #006699;">scimax-src-keymap-mode</span>
  <span style="color: #036A07;">"Minor mode to add mode keymaps to src-blocks."</span>
  <span style="color: #006FE0;">:init-value</span> nil
  (<span style="color: #0000FF;">if</span> scimax-src-keymap-mode
      (<span style="color: #0000FF;">progn</span>
        (add-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks t)
        (add-to-list 'font-lock-extra-managed-props 'local-map)
        (add-to-list 'font-lock-extra-managed-props 'cursor-sensor-functions)
        (advice-add 'lispy--eval <span style="color: #006FE0;">:around</span> 'scimax-spoof-mode)
        (cursor-sensor-mode +1))
    (remove-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks)
    (advice-remove 'lispy--eval 'scimax-spoof-mode)
    (cursor-sensor-mode -1))
  (font-lock-fontify-buffer))

(add-hook 'org-mode-hook (<span style="color: #0000FF;">lambda</span> ()
                           (scimax-src-keymap-mode +1)))
</pre>
</div>

<p>
That is it! I am pretty sure this is a good idea. It helps a lot when you are writing a lot of short code blocks and near equal amounts of text (like in this blog post). It also helps write the code since many things like indentation, parentheses, etc. are automatically handled. That is what I used to go into special-edit mode all the time for!
</p>

<p>
I have not used this long enough to know if it causes any other surprises. If you try it and find any, leave a comment!
</p>

<div id="outline-container-org49daca5" class="outline-2">
<h2 id="org49daca5"><span class="section-number-2">1</span> Update</h2>
<div class="outline-text-2" id="text-1">
<p>
It turns out you can have the best of all the worlds by combining keymaps. The make-composed-keymap creates a new keymap that combines a keymaps and falls through to a parent keymap. So here we use that to combine several keymaps, falling through to org-mode. The only subtlety I have come across is that I remapped &lt;return&gt; in orgmode to scimax/org-return, and not all modes define it, so I redefine it in some places to just be newline. Also to keep C-c C-c for executing the block, I add that back too.
</p>

<p>
I use a few maps here, and some of them seem to just add menus that are only active when your cursor is in the block. Pretty handy!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> scimax-src-block-keymaps
      `((<span style="color: #008000;">"ipython"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap
                                  `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                  org-mode-map)))
                        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">In org-mode I define RET so we f</span>
                        (define-key map (kbd <span style="color: #008000;">"&lt;return&gt;"</span>) 'newline)
                        (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                        map))
        (<span style="color: #008000;">"python"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap
                                 `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                 org-mode-map)))
                       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">In org-mode I define RET so we f</span>
                       (define-key map (kbd <span style="color: #008000;">"&lt;return&gt;"</span>) 'newline)
                       (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                       map))
        (<span style="color: #008000;">"emacs-lisp"</span> . ,(<span style="color: #0000FF;">let</span> ((map (make-composed-keymap `(,lispy-mode-map
                                                            ,emacs-lisp-mode-map
                                                            ,outline-minor-mode-map)
                                                          org-mode-map)))
                           (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                           map))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org004cb53" class="outline-2">
<h2 id="org004cb53"><span class="section-number-2">2</span> Update #2</h2>
<div class="outline-text-2" id="text-2">
<p>
The previous version had some issues where it would only add a keymap to the first block. The code in this post now addresses that and uses cursor-sensor-functions to make sure we change key map on entering and leaving blocks. That might mean you need an emacs of at least version 25 to use this. I guess it will work with an earlier version, but the cursor-sensor-functions might get ignored. You might have to comment out the cursor-sensor-mode line
</p>

<p>
Thanks to those brave people alpha-testing this and helping refine the idea!
</p>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook.org">org-mode source</a></p>
<p>Org-mode version = 9.0.7</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Org-mode-and-ipython-enhancements-in-scimax"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax/" rel="bookmark" title="Permanent Link to Org-mode and ipython enhancements in scimax">Org-mode and ipython enhancements in scimax</a></h2>
      <p><small><span class="blog_post_date">Posted May 26, 2017 at 04:54 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/ipython/'>ipython</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org696d7c2">1. Some convenience functions</a></li>
<li><a href="#orgef414e8">2. ob-ipython-inspect works</a></li>
<li><a href="#orgd62ef75">3. Getting selective output from Ipython</a></li>
<li><a href="#org5cac271">4. Where was that error?</a></li>
<li><a href="#org3ebd0a8">5. Asynchronous Ipython</a></li>
</ul>
</div>
</div>
<p>
We have made some improvements to using Ipython in org-mode in the past including:
</p>

<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/29/ob-ipython-and-inline-figures-in-org-mode/">Inline figures</a></li>
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/21/Exporting-org-mode-to-Jupyter-notebooks/">Export to Jupyter notebooks</a></li>
</ol>

<p>
Today I will talk about a few new features and improvements I have introduced to scimax for using org-mode and Ipython together.
</p>

<p>
The video for this post might be more obvious than the post:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/dMira3QsUdg" frameborder="0" allowfullscreen></iframe>

<div id="outline-container-org696d7c2" class="outline-2">
<h2 id="org696d7c2"><span class="section-number-2">1</span> Some convenience functions</h2>
<div class="outline-text-2" id="text-1">
<p>
There are a few nice shortcuts in the Jupyter notebook. Now we have some convenient commands in scimax to mimic those. My favorites are adding cells above or below the current cell. You can insert a new src block above the current one with (M-x <code>org-babel-insert-block</code>). You can use a prefix arg to insert it below the current block.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">code</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">below</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">some code</span>
</pre>
</div>

<p>
I am particularly fond of splitting a large block into two smaller blocks. Use (M-x <code>org-babel-split-src-block</code>) to do that and leave the point in the upper block. Use a prefix arg to leave the point in the lower block.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">lots of code in large block</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Even more code</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The end of the long block</span>
</pre>
</div>

<p>
You can execute all the blocks up to the current point with (M-x <code>org-babel-execute-to-point</code>).
</p>
</div>
</div>

<div id="outline-container-orgef414e8" class="outline-2">
<h2 id="orgef414e8"><span class="section-number-2">2</span> ob-ipython-inspect works</h2>
<div class="outline-text-2" id="text-2">
<p>
In the original ob-ipython I found that ob-ipython-inspect did not work unless you were in special edit mode. That is too inconvenient. I modified a few functions to work directly from the org-buffer. I bind this to M-. in org-mode.
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Compute areas and colors</span>
<span style="color: #BA36A5;">N</span> = 150
<span style="color: #BA36A5;">r</span> = 2 * np.random.rand(N)
<span style="color: #BA36A5;">theta</span> = 2 * np.pi * np.random.rand(N)
<span style="color: #BA36A5;">area</span> = 200 * r**2
<span style="color: #BA36A5;">colors</span> = theta

<span style="color: #BA36A5;">ax</span> = plt.subplot(111, projection=<span style="color: #008000;">'polar'</span>)
<span style="color: #BA36A5;">c</span> = ax.scatter(theta, r, c=colors, s=area, cmap=<span style="color: #008000;">'hsv'</span>, alpha=0.75)
</pre>
</div>

<p>

</p>

<p>
&lt;matplotlib.figure.Figure at 0x114ded710&gt;
<img src="/media/ob-ipython-1758dfdd7a96829c50791c7cc9a39f3a.png"> 
</p>
</div>
</div>



<div id="outline-container-orgd62ef75" class="outline-2">
<h2 id="orgd62ef75"><span class="section-number-2">3</span> Getting selective output from Ipython</h2>
<div class="outline-text-2" id="text-3">
<p>
Out of the box Ipython returns a lot of results. This block, for example returns a plain text, image and latex result as output.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> sympy <span style="color: #0000FF;">import</span> *
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">commenting out init_printing() results in no output</span>
init_printing()

var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>

</p>

<p>
 2
x  + y
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
We can select which one we want with a new header argument :ob-ipython-results. For this block you can give it the value of text/plain, text/latex or image/png.
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
 2
x  + y
</p>

<p>
Or to get the image:
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
This shows up with <a href="https://emacs.stackexchange.com/questions/33005/python-org-mode-babel-output-column-headers-misaligned/33016#33016">pandas too</a>. This block creates a table of data and then shows the first 5 rows. Ipython returns both plain text and html here.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>

</p>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      10    1  64.311947     0        8  False   False   8.036793
1          1       6    0  82.951484     1       73   True   False   7.996024
2          2      27    1  53.064501     3       95  False   False   9.015144
3          3      37    0  64.799128     0       93  False   False  10.099032
4          4      46    0  99.111394     2       25  False   False  11.711427
</p>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientid</th>
      <th>hospid</th>
      <th>sex</th>
      <th>age</th>
      <th>race</th>
      <th>cptCode</th>
      <th>rdm30d</th>
      <th>mort30d</th>
      <th>los</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>10</td>
      <td>1</td>
      <td>64.311947</td>
      <td>0</td>
      <td>8</td>
      <td>False</td>
      <td>False</td>
      <td>8.036793</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>82.951484</td>
      <td>1</td>
      <td>73</td>
      <td>True</td>
      <td>False</td>
      <td>7.996024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>27</td>
      <td>1</td>
      <td>53.064501</td>
      <td>3</td>
      <td>95</td>
      <td>False</td>
      <td>False</td>
      <td>9.015144</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>37</td>
      <td>0</td>
      <td>64.799128</td>
      <td>0</td>
      <td>93</td>
      <td>False</td>
      <td>False</td>
      <td>10.099032</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>46</td>
      <td>0</td>
      <td>99.111394</td>
      <td>2</td>
      <td>25</td>
      <td>False</td>
      <td>False</td>
      <td>11.711427</td>
    </tr>
  </tbody>
</table>
</div>


<p>
We can use the header to select only the plain text output!
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      21    0  73.633836     1       38  False   False   7.144019
1          1      16    1  67.518804     3       23  False   False   3.340534
2          2      15    0  44.139033     0        8  False   False   9.258706
3          3      29    1  45.510276     2        5  False   False  10.590245
4          4       7    0  52.974924     2        4  False    True   5.811064
</p>
</div>
</div>

<div id="outline-container-org5cac271" class="outline-2">
<h2 id="org5cac271"><span class="section-number-2">4</span> Where was that error?</h2>
<div class="outline-text-2" id="text-4">
<p>
A somewhat annoying feature of running cells in org-mode is when there is an exception there has not been a good way to jump to the line that caused the error to edit it. The lines in the src block are not numbered, so in a large block it can be tedious to find the line. In scimax, when you get an exception it will number the lines in the src block, and when you press q in the exception traceback buffer it will jump to the line in the block where the error occurred.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">print</span>(1)
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">raise Exception('Here')</span>
<span style="color: #0000FF;">print</span>(2)
</pre>
</div>

<p>
1
2
</p>



<p>
If you don't like the numbers add this to your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> ob-ipython-number-on-exception nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ebd0a8" class="outline-2">
<h2 id="org3ebd0a8"><span class="section-number-2">5</span> Asynchronous Ipython</h2>
<div class="outline-text-2" id="text-5">
<p>
I have made a few improvements to the asynchronous workflow in Ipython. We now have a calculation queue, so you can use C-c C-c to execute several blocks in a row, and they will run asynchronously in the order you ran them. While they are running you can continue using Emacs, e.g. writing that paper, reading email, checking RSS feeds, tetris, &#x2026; This also lets you run all the blocks up to the current point (M-x <code>org-babel-execute-ipython-buffer-to-point-async</code>) or the whole buffer (of Ipython) blocks asynchronously (M-x <code>org-babel-execute-ipython-buffer-async</code>).
</p>

<p>
To turn this on by default put this in your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> org-babel-async-ipython t)
</pre>
</div>

<p>
This requires all src blocks to have a name, and running the block will give it a name if you have not named the block. By default we use human-readable names. While the block is running, there will be a link indicating it is running. You can click on the link to cancel it. Running subsequent blocks will queue them to be run when the first block is done.
</p>

<p>
Here is an example:
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="orgb3ddac3"><span style="color: #0000FF;">import</span> time
time.sleep(5)
<span style="color: #BA36A5;">a</span> = 5
<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'done'</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython" id="org5b7e30b"><span style="color: #0000FF;">print</span>(3 * a)
</pre>
</div>

<p>
15
</p>




<p>
Occasionally you will run into an issue. You can clear the queue with <code>org-babel-async-ipython-clear-queue</code>.</p>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-new-org-mode-exporter-to-Word-for-scimax"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/04/15/A-new-org-mode-exporter-to-Word-for-scimax/" rel="bookmark" title="Permanent Link to A new org-mode exporter to Word for scimax">A new org-mode exporter to Word for scimax</a></h2>
      <p><small><span class="blog_post_date">Posted April 15, 2017 at 04:19 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/export/'>export</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/04/15/A-new-org-mode-exporter-to-Word-for-scimax#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated April 15, 2017 at 04:21 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I am continuing to chip away to getting a reasonable export behavior for org-mode to MS Word. I have previously made some progress with Pandoc <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/01/29/Export-org-mode-to-docx-with-citations-via-pandoc/">here</a> and <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/06/11/ox-pandoc-org-mode-+-org-ref-to-docx-with-bibliographies/">here</a>, but those solutions never stuck with me. So here is another go. Here I leverage Pandoc again, but use a path through LaTeX to get citations without modifying the org-ref cite link syntax. The code for this can be found here: <a href="https://github.com/jkitchin/scimax/blob/master/ox-word.el">https://github.com/jkitchin/scimax/blob/master/ox-word.el</a>. The gist is you use org-ref like you always do, and you specify the bibliography style for Pandoc like this:
</p>

<p>
<img src="/media/date-15-04-2017-time-16-06-53.png"> 
</p>

<p>
You can download other csl files at <a href="https://www.zotero.org/styles">https://www.zotero.org/styles</a>. Then you can simply export the org-doc to a Word document with the key-binding C-c C-e w p.
</p>

<p>
Here is an example document to illustrate the exporter. I have written about data sharing in catalysis <a class='org-ref-reference' href="#kitchin-2015-examp">kitchin-2015-examp</a> and surface science <a class='org-ref-reference' href="#kitchin-2015-data-surfac-scien">kitchin-2015-data-surfac-scien</a>.
</p>

<p>
Here is an example source block.
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

plt.plot([1, 2, 3, 4, 5, 6])
</pre>
</div>

<p>
<img src="/media/ob-ipython-b8591826ba9e316738705d03264316a5.png"> 
</p>

<p>
See Ref. <a href="#fig:line">fig:line</a> for example. These do not work. That might require additional pre-processing to replace them with numbers.
</p>

<p>
Here is the Word document that is generated: <a href="/media/2017-04-15.docx">2017-04-15.docx</a> 
</p>

<p>
As a penultimate result it might be ok. The references are reasonably formatted, but not compatible with Endnote, or other bibliography manager software. There are still some issues with Figure numbering and cross-references, but it is not too bad. The main benefit of this seems to be that one source generates HTML and the Word document.
</p>

<p>

<h1 class='org-ref-bib-h1'>Bibliography</h1>
<ul class='org-ref-bib'><li><a id="kitchin-2015-examp">[kitchin-2015-examp] Kitchin, Examples of Effective Data Sharing in Scientific Publishing, <i>ACS Catalysis</i>, <b>5(6)</b>, 3894-3899 (2015). <a href=" http://dx.doi.org/10.1021/acscatal.5b00538 ">link</a>. <a href="http://dx.doi.org/10.1021/acscatal.5b00538">doi</a>.</a></li>
<li><a id="kitchin-2015-data-surfac-scien">[kitchin-2015-data-surfac-scien] "John Kitchin", Data Sharing in Surface Science, <i>"Surface Science "</i>, <b>647</b>, 103-107 (2016). <a href="http://www.sciencedirect.com/science/article/pii/S0039602815001326">link</a>. <a href="http://dx.doi.org/10.1016/j.susc.2015.05.007">doi</a>.</a></li>
</ul>
</p>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/04/15/A-new-org-mode-exporter-to-Word-for-scimax.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/04/15/A-new-org-mode-exporter-to-Word-for-scimax#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Autoformatting-ordinal-numbers-and-fractions-in-orgmode"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/04/11/Autoformatting-ordinal-numbers-and-fractions-in-orgmode/" rel="bookmark" title="Permanent Link to Autoformatting ordinal numbers and fractions in orgmode">Autoformatting ordinal numbers and fractions in orgmode</a></h2>
      <p><small><span class="blog_post_date">Posted April 11, 2017 at 03:05 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/04/11/Autoformatting-ordinal-numbers-and-fractions-in-orgmode#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
MS Word has a <i>few</i> things I like. One of them is the ability to autoformat things to make an ordinal number string like 1st to the superscripted version 1<sup>st</sup> while you type or a 1/2 to ½.  I thought it would be pretty easy to implement that for org-mode. It turns out it was not so easy!
</p>

<p>
There does not appear to be a way to specify a regexp pattern as an abbreviation, or an abbrev that starts with a number. What we need for ordinal numbers is to recognize a sequence of numbers followed by "st", "nd", "rd" or "th" followed by a space or punctuation, and then superscript the letters. In case you didn't want the replacement to occur, you should be able to undo it and get back the original string. This addition was a little hard won, so I am sharing the lessons here.
</p>

<p>
The logic I used is to put a function in the post-self-insert-hook. The function only works in org-mode, when not in a codeblock and when looking back at a regexp that matches a pattern to be replaced. Getting it to undo was trickier than expected. Eventually I worked out that you put an undo boundary in place before the change, and then it seems like you can undo the changes. I created a minor mode so it is easy to toggle this on and off.
</p>

<p>
Here is the implementation:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defcustom</span> <span style="color: #BA36A5;">scimax-autoformat-ordinals</span> t
  <span style="color: #036A07;">"Determines if scimax autoformats ordinal numbers."</span>
  <span style="color: #006FE0;">:group</span> 'scimax)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-org-autoformat-ordinals</span> ()
  <span style="color: #036A07;">"Expand ordinal words to superscripted versions in org-mode.</span>
<span style="color: #036A07;">1st to 1^{st}.</span>
<span style="color: #036A07;">2nd to 2^{nd}</span>
<span style="color: #036A07;">3rd to 3^{rd}</span>
<span style="color: #036A07;">4th to 4^{th}"</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> scimax-autoformat-ordinals
             (eq major-mode 'org-mode)
             (not (org-in-src-block-p))
             (looking-back <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?3:</span><span style="color: #008000;">\\&lt;</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?1:</span><span style="color: #008000;">[0-9]+</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?2:</span><span style="color: #008000;">st</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">nd</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">rd</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">th</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">\\&gt;</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?:</span><span style="color: #008000;">[[:punct:]]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">[[:space:]]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
                           (line-beginning-position)))
    (undo-boundary)
    (<span style="color: #0000FF;">save-excursion</span>
      (replace-match <span style="color: #008000;">"\\1^{\\2}"</span> nil nil nil 3))))


(<span style="color: #0000FF;">defcustom</span> <span style="color: #BA36A5;">scimax-autoformat-fractions</span> t
  <span style="color: #036A07;">"Determines if scimax autoformats fractions."</span>
  <span style="color: #006FE0;">:group</span> 'scimax)


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-org-autoformat-fractions</span> ()
  <span style="color: #036A07;">"Expand fractions to take up space."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> scimax-autoformat-fractions
             (eq major-mode 'org-mode)
             (not (org-in-src-block-p))
             (looking-back <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?3:</span><span style="color: #008000;">\\&lt;</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">1/4</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">1/2</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">3/4</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">\\&gt;</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?:</span><span style="color: #008000;">[[:punct:]]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">[[:space:]]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
                           (line-beginning-position)))
    (undo-boundary)
    (<span style="color: #0000FF;">save-excursion</span>
      (replace-match (cdr (assoc (match-string 3) '((<span style="color: #008000;">"1/4"</span> . <span style="color: #008000;">"&#188;"</span>)
                                                    (<span style="color: #008000;">"1/2"</span> . <span style="color: #008000;">"&#189;"</span>)
                                                    (<span style="color: #008000;">"3/4"</span> . <span style="color: #008000;">"&#190;"</span>))))
                     nil nil nil 3))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-org-autoformat</span> ()
  <span style="color: #036A07;">"Autoformat functions."</span>
  (scimax-org-autoformat-ordinals)
  (scimax-org-autoformat-fractions))

(<span style="color: #0000FF;">define-minor-mode</span> <span style="color: #006699;">scimax-autoformat-mode</span>
  <span style="color: #036A07;">"Toggle `</span><span style="color: #D0372D;">scimax-autoformat-mode</span><span style="color: #036A07;">'.  Converts 1st to 1^{st} as you type."</span>
  <span style="color: #006FE0;">:init-value</span> nil
  <span style="color: #006FE0;">:lighter</span> (<span style="color: #008000;">" om"</span>)
  (<span style="color: #0000FF;">if</span> scimax-ordinal-mode
      (add-hook 'post-self-insert-hook #'scimax-org-autoformat nil 'local)
    (remove-hook 'post-self-insert-hook #'scimax-org-autoformat 'local)))
</pre>
</div>

<p>
This is now a feature in scimax. This marks the 500<sup>th</sup> blog post! That is ½ way to 1000. At the current rate of posting, it will be at least 5 years until I hit that!
</p>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/04/11/Autoformatting-ordinal-numbers-and-fractions-in-orgmode.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/04/11/Autoformatting-ordinal-numbers-and-fractions-in-orgmode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-better-return-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/04/09/A-better-return-in-org-mode/" rel="bookmark" title="Permanent Link to A better return in org-mode">A better return in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted April 09, 2017 at 10:56 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2017/04/09/A-better-return-in-org-mode#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated April 20, 2017 at 09:19 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org774898d">1. a subheading</a></li>
<li><a href="#org4f302f8">2. another Subheading</a></li>
</ul>
</div>
</div>
<p>
Over on <a href="http://emacs.stackexchange.com/questions/24574/org-mode-default-to-alt-enter-for-bullets">Stackoverflow</a> someone wanted a better return in org-mode. They wanted return to add items in a list (instead of M-Ret). Someone posted a partial solution, and here I improve on it to add new items to lists, new headings after a heading, and new rows to tables. In each case, a double return on an empty item, headline or table row will delete that line, and terminate the list, headlines or table. You can still use M-Ret, and this function falls through to org-return like it did before. You can use a prefix arg to get a regular return if you want one (e.g. you want to press enter on a headline to push it down).
</p>

<p>
Here is the function. Give it a try. It is a small but helpful addition I think. I have not used it for long, so if you come across issues leave a comment!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">org-inlinetask</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax/org-return</span> (<span style="color: #6434A3;">&amp;optional</span> ignore)
  <span style="color: #036A07;">"Add new list item, heading or table row with RET.</span>
<span style="color: #036A07;">A double return on an empty element deletes it.</span>
<span style="color: #036A07;">Use a prefix arg to get regular RET. "</span>
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"P"</span>)
  (<span style="color: #0000FF;">if</span> ignore
      (org-return)
    (<span style="color: #0000FF;">cond</span>

     ((eq 'line-break (car (org-element-context)))
      (org-return-indent))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Open links like usual, unless point is at the end of a line.</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and if at beginning of line, just press enter.</span>
     ((<span style="color: #0000FF;">or</span> (<span style="color: #0000FF;">and</span> (eq 'link (car (org-element-context))) (not (eolp)))
          (bolp))
      (org-return))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">It doesn't make sense to add headings in inline tasks. Thanks Anders</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Johansson!</span>
     ((org-inlinetask-in-task-p)
      (org-return))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">checkboxes too</span>
     ((org-at-item-checkbox-p)
      (org-insert-todo-heading nil))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">lists end with two blank lines, so we need to make sure we are also not</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">at the beginning of a line to avoid a loop where a new entry gets</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">created with only one blank line.</span>
     ((org-in-item-p)
      (<span style="color: #0000FF;">if</span> (<span style="color: #0000FF;">save-excursion</span> (beginning-of-line) (org-element-property <span style="color: #006FE0;">:contents-begin</span> (org-element-context)))
          (org-insert-heading)
        (beginning-of-line)
        (delete-region (line-beginning-position) (line-end-position))
        (org-return)))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">org-heading</span>
     ((org-at-heading-p)
      (<span style="color: #0000FF;">if</span> (not (string= <span style="color: #008000;">""</span> (org-element-property <span style="color: #006FE0;">:title</span> (org-element-context))))
          (<span style="color: #0000FF;">progn</span> (org-end-of-meta-data)
                 (org-insert-heading-respect-content)
                 (outline-show-entry))
        (beginning-of-line)
        (<span style="color: #0000FF;">setf</span> (buffer-substring
               (line-beginning-position) (line-end-position)) <span style="color: #008000;">""</span>)))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">tables</span>
     ((org-at-table-p)
      (<span style="color: #0000FF;">if</span> (-any?
           (<span style="color: #0000FF;">lambda</span> (x) (not (string= <span style="color: #008000;">""</span> x)))
           (nth
            (- (org-table-current-dline) 1)
            (org-table-to-lisp)))
          (org-return)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">empty row</span>
        (beginning-of-line)
        (<span style="color: #0000FF;">setf</span> (buffer-substring
               (line-beginning-position) (line-end-position)) <span style="color: #008000;">""</span>)
        (org-return)))

     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fall-through case</span>
     (t
      (org-return)))))


(define-key org-mode-map (kbd <span style="color: #008000;">"RET"</span>)
  'scimax/org-return)
</pre>
</div>

<p>
Here are a few tests:
</p>


<ol class="org-ol">
<li>numbered item</li>
<li>second item
<ol class="org-ol">
<li>nested number</li>
<li>second number</li>
</ol></li>
</ol>


<ul class="org-ul">
<li>unordered 1</li>
<li>unordered 2
<ul class="org-ul">
<li>nested</li>
<li>nested 2
<ul class="org-ul">
<li>nested with link: <a href="http://emacs.stackexchange.com">http://emacs.stackexchange.com</a></li>
</ul></li>
</ul></li>
</ul>


<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> check 1</li>
<li class="off"><code>[&#xa0;]</code> check 2</li>
<li class="off"><code>[&#xa0;]</code> check 3</li>
</ul>


<div class="inlinetask">
<b>an inline task</b><br />
<p>
With some content
</p>
</div>


<div id="outline-container-org774898d" class="outline-2">
<h2 id="org774898d"><span class="section-number-2">1</span> a subheading</h2>
</div>

<div id="outline-container-org4f302f8" class="outline-2">
<h2 id="org4f302f8"><span class="section-number-2">2</span> another Subheading</h2>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/04/09/A-better-return-in-org-mode.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2017/04/09/A-better-return-in-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/orgmode/2">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/01/27/New-publication-in-Topics-in-Catalysis/">New publication in Topics in Catalysis</a></li>
      <li><a href="/blog/2018/01/03/New-publication-in-Molecular-Simulation/">New publication in Molecular Simulation</a></li>
      <li><a href="/blog/2017/12/31/2017-in-a-nutshell-for-the-Kitchin-Research-group/">2017 in a nutshell for the Kitchin Research group</a></li>
      <li><a href="/blog/2017/11/29/Solving-an-eigenvalue-differential-equation-with-a-neural-network/">Solving an eigenvalue differential equation with a neural network</a></li>
      <li><a href="/blog/2017/11/28/Solving-ODEs-with-a-neural-network-and-autograd/">Solving ODEs with a neural network and autograd</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



