

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group: orgmode</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="YAT-yet-another-template-strategy"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/01/YAT-yet-another-template-strategy/" rel="bookmark" title="Permanent Link to YAT - yet another template strategy">YAT - yet another template strategy</a></h2>
      <p><small><span class="blog_post_date">Posted November 01, 2015 at 02:12 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
I have another need for a template that is dynamically evaluated. I previously wrote about this <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/01/26/Another-alternative-to-string-templates/">here</a> , and today I am going to do a variation of the theme. We will still use a syntax of $(expression), but a new approach to evaluating the expression. I saw this interesting function to evaluate and replace an s-expression in a buffer <a href="http://emacsredux.com/blog/2013/06/21/eval-and-replace/">Eval and Replace - Emacs Redux</a> . I am going use that to replace a template expression in a string, with a little variation to avoid replacing non-sexp variations, e.g. $(. Here we go.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-and-replace</span> ()
  <span style="color: #036A07;">"Replace the preceding sexp with its value."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (backward-kill-sexp)
  (<span style="color: #0000FF;">condition-case</span> nil
      (princ (eval (read (current-kill 0)))
             (current-buffer))
    (<span style="color: #ff0000; font-weight: bold;">error</span> (message <span style="color: #008000;">"Invalid expression"</span>)
           (insert (concat <span style="color: #008000;">"$"</span> (current-kill 0))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">j-format</span> (s)
  <span style="color: #036A07;">"Replace all instances of $(expression) in S with the evaluated</span>
<span style="color: #036A07;">expression."</span>
  (<span style="color: #0000FF;">with-temp-buffer</span>
    (insert s)
    (goto-char (point-min))
    (<span style="color: #0000FF;">while</span> (re-search-forward <span style="color: #008000;">"$("</span> nil t)
      (backward-char)
      (<span style="color: #0000FF;">when</span> (sexp-at-point)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get rid of the $</span>
        (delete-char -1)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go to the end of the sexp and then eval-and-replace it.</span>
        (end-of-sexp)
        (eval-and-replace)))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return the formatted text.</span>
    (buffer-string)))


(<span style="color: #0000FF;">let</span> ((some-var <span style="color: #008000;">"You got me"</span>))
  (j-format <span style="color: #008000;">"Test of 4 + 5 = $(+ 4 5). $(  $(foobar). $(progn (setq x 5) \"\")</span>
<span style="color: #008000;">and then we have 2x=$(prin1 (* 2 x)).</span>

<span style="color: #008000;">some-var = $(print some-var)"</span>))
</pre>
</div>

<pre class="example">
Test of 4 + 5 = 9. $(  $(foobar).
and then we have 2x=10.

some-var = You got me
</pre>

<p>
That seems pretty ok. I obviously have not tested it extensively, but it looks pretty promising.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/01/YAT---yet-another-template-strategy.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Saving-the-current-restriction-and-restoring-it-while-following-links"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links/" rel="bookmark" title="Permanent Link to Saving the current restriction and restoring it while following links">Saving the current restriction and restoring it while following links</a></h2>
      <p><small><span class="blog_post_date">Posted October 24, 2015 at 01:41 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 25, 2015 at 07:09 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
On the org-mode mailing list there has been some discussion about following id links. The issue is that if your buffer is narrowed, clicking on the link does not change the restriction to actually take you to the entry. This is debatably desirable. If I click on a link, I want it to go where it points. But, I might also like to go back to my narrowed view. So here consider how to save the state of narrowing, and restore it. We modify the function that opens an id link to save the restriction, and widen the buffer if necessary.
</p>

<p>
Saving the restriction seems easy, we just save a marker to point, and the point-min and point-max. We save the marker for a convenient way to get the buffer, and perhaps the actual point. We advise the C-c &amp; function to restore the restriction after we leave it. This should fix the restriction in whatever buffer we undid it in.
</p>

<p>
Here is the code that seems to work for me. Thanks to Rasmus for the idea on saving the restriction data.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">*saved-restriction*</span> nil
 <span style="color: #036A07;">"A global var containing the current restriction.</span>
<span style="color: #036A07;">Returns (current-buffer point-min point-max"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">save-current-restriction</span> ()
  <span style="color: #036A07;">"Save the current restriction at point."</span>
  (<span style="color: #0000FF;">setq</span> *saved-restriction*
        (<span style="color: #0000FF;">if</span> (buffer-narrowed-p)
            (list (current-buffer) (point-min) (point-max))
          nil)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">restore-saved-restriction</span> ()
  <span style="color: #036A07;">"Restore the last saved restriction."</span>
  (<span style="color: #0000FF;">when</span> *saved-restriction*
    (set-buffer (car *saved-restriction*))
    (narrow-to-region (nth 1 *saved-restriction*)
                      (nth 2 *saved-restriction*)))
  (<span style="color: #0000FF;">setq</span> *saved-restriction* nil))

<span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">' actually modify this function to save the restriction, and widen if needed.</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-id-open</span> (id)
  <span style="color: #036A07;">"Go to the entry with id ID."</span>
  (org-mark-ring-push)
  (<span style="color: #0000FF;">let</span> ((m (org-id-find id 'marker))
        cmd)
    (<span style="color: #0000FF;">unless</span> m
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Cannot find entry with ID \"%s\""</span> id))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Use a buffer-switching command in analogy to finding files</span>
    (<span style="color: #0000FF;">setq</span> cmd
          (<span style="color: #0000FF;">or</span>
           (cdr
            (assq
             (cdr (assq 'file org-link-frame-setup))
             '((find-file . switch-to-buffer)
               (find-file-other-window . switch-to-buffer-other-window)
               (find-file-other-frame . switch-to-buffer-other-frame))))
           'switch-to-buffer-other-window))
    (<span style="color: #0000FF;">if</span> (not (equal (current-buffer) (marker-buffer m)))
        (funcall cmd (marker-buffer m)))
    (save-current-restriction)
    (<span style="color: #0000FF;">when</span> (&gt; m (point-max))
      (widen))
    (goto-char m)
    (move-marker m nil)
    (org-show-context)))


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">And we advise the function going back to restore the restriction.</span>
(<span style="color: #0000FF;">defadvice</span> <span style="color: #006699;">org-mark-ring-goto</span> (after restore-my-restriction () activate)
  <span style="color: #036A07;">"Restore narrowing."</span>
  (restore-saved-restriction))
</pre>
</div>

<pre class="example">
org-mark-ring-goto
</pre>

<p>
This seems to preserve restrictions in the current buffer and in other buffers, as long as I use C-c &amp; to invoke org-mark-ring goto. I am not sure how easy it would be to make this work for all links. Each link has its own function for following so I am not sure we can easily get them all to do this unless there is some high level function to advise like org-mouse-down-mouse or something similar. It also has the limitation that the restoration only occurs using org-mark-ring-goto, unless you specifically run the  (restore-saved-restriction) function yourself. That could be made an interactive function for that purpose. Otherwise, this seems like a reasonable approach.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Line-numbers-in-org-mode-code-blocks"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks/" rel="bookmark" title="Permanent Link to Line numbers in org-mode code blocks">Line numbers in org-mode code blocks</a></h2>
      <p><small><span class="blog_post_date">Posted October 13, 2015 at 08:58 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
Some of my students have wanted to show line numbers in code blocks. This is especially useful for when you run a Python block, and you get an error message with a line number in it. Right now, to figure out which line that is, you have to into the code block, type C-c ' to get into edit mode, and turn line numbers on. We look into how to achieve that here.
</p>

<p>
You may want to see the video here: <a href="https://www.youtube.com/watch?v=kinWijGzXms">https://www.youtube.com/watch?v=kinWijGzXms</a> .
</p>

<p>
First, we need to get the region that is the code block. We can find some info in the org-element, but, the :begin and :end include lines we don't want, like the header lines, and the results. But, we can get the beginning, and maybe from there search forward to the block. Run this code block to see where the point goes.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="boring-example"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a boring comment</span>

(<span style="color: #0000FF;">progn</span>
  (+ 40 2))

(goto-char (org-element-property <span style="color: #006FE0;">:begin</span> (org-element-context)))
(re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context))))
(goto-char (match-beginning 0))
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">number of lines in block. The last carriage return doesn't count.</span>
(1- (length (s-split <span style="color: #008000;">"\n"</span> (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))))
</pre>
</div>

<pre class="example">
9
</pre>

<p>
So, we can get the number of lines, and move the point to the first line. For numbers, we will use overlays. Here is a simple way to put a number at the beginning of a line.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> (ov)
  (beginning-of-line)
  (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
  (overlay-put ov 'before-string <span style="color: #008000;">"1"</span>))
</pre>
</div>

<pre class="example">
1
</pre>

<p>
The next thing to do is make a function that puts a number at the beginning of a line. We might as well store these overlays in a variable, so they are easy to remove later. This is just for exploration of how to do it. Later we combine all these pieces together.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line</span> (N)
 <span style="color: #036A07;">"Put an overlay at the beginning of a line."</span>
  (beginning-of-line)
  (<span style="color: #0000FF;">let</span> (ov)
    (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
    (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string N)))
    (add-to-list 'number-line-overlays ov)))

(number-line 4)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">#&lt;overlay from 1782 to 1782 in blog.org&gt;</td>
</tr>
</tbody>
</table>


<p>
That looks promising. Let's make a function to clear those overlays. It is so easy it may not even be worth writing.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-clear</span> ()
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-clear)
</pre>
</div>

<p>
Finally, we are ready to hack up the code block numbering code. The numbers will not automatically update, so we will write a function that numbers the block, but only temporarily. Any key press will get rid of the numbers so we can get back to work.  I am going to go ahead and make this a stand-alone function and block.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-src-block</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">save-excursion</span>
    (<span style="color: #0000FF;">let*</span> ((src-block (org-element-context))
           (nlines (- (length
                       (s-split
                        <span style="color: #008000;">"\n"</span>
                        (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
                      1)))
      (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> src-block))
      (re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
      (goto-char (match-beginning 0))

      (<span style="color: #0000FF;">loop</span> for i from 1 to nlines
            do
            (beginning-of-line)
            (<span style="color: #0000FF;">let</span> (ov)
              (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
              (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string i)))
              (add-to-list 'number-line-overlays ov))
            (next-line))))

  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now read a char to clear them</span>
  (read-key <span style="color: #008000;">"Press a key to clear numbers."</span>)
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-src-block)
</pre>
</div>

<p>
I am not sure how to get the numbers to automatically update smoothly like they do in linum-mode. That code uses a lot of hooks to make updates work, and embeds them in a minor mode to get rid of them. It also puts them in the fringe I think, but it is not clear how that is done.
</p>

<p>
We could modify what happens after the numbers are put on, e.g. pressing numbers might jump to a line, or some other kind of functionality. I don't have a critical need for this right now, so I didn't explore it more. Let me know if you have any good ideas for it!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/13/Line-numbers-in-org-mode-code-blocks.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Automatic-latex-image-toggling-when-cursor-is-on-a-fragment"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment/" rel="bookmark" title="Permanent Link to Automatic latex image toggling when cursor is on a fragment">Automatic latex image toggling when cursor is on a fragment</a></h2>
      <p><small><span class="blog_post_date">Posted October 09, 2015 at 11:54 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
There was a recent suggestion on the org-mode mailing list to make it possible to toggle individual equations in org-mode when the cursor is on them, and have them toggle back when the mouse is off. Presumably, this would let you edit the equation and see the result very easily.
</p>

<p>
The strategy to enable this is to use add a function to the post-command function hook. The function will store the last fragment/environment you were on, and compare it to where you are now.  If they are different the function will put the overlay back on the previous point, and do something appropriate at the current point, e.g. nothing if you are not on a fragment, or remove the overlay of the fragment you are on. The function will get run after every command, so we make sure we are in org-mode first!
</p>

<p>
Here are some example equations.
</p>

<p>
Here is a sentence with an equation \(f^{2x}=3\) and another form \(e^x = 20\) in it.
</p>

<p>
Here is a standalone equation environment.
</p>

\begin{equation}
a + b \sqrt{5o}
\end{equation}

<p>
And now, \[15 + 7 = 12\],
</p>

<p>
It is easiest to see this in a video here: <a href="https://www.youtube.com/watch?v=E0s3PDBqsEc">https://www.youtube.com/watch?v=E0s3PDBqsEc</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">org-latex-fragment-last</span> nil
  <span style="color: #036A07;">"Holds last fragment/environment you were on."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-latex-fragment-toggle</span> ()
  <span style="color: #036A07;">"Toggle a latex fragment image "</span>
  (<span style="color: #0000FF;">and</span> (eq 'org-mode major-mode)
       (<span style="color: #0000FF;">let*</span> ((el (org-element-context))
              (el-type (car el)))
         (<span style="color: #0000FF;">cond</span>
          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now on a new fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment we were on</span>
            org-latex-fragment-last
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and are on a fragment now</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but not on the last one this is a little tricky. as you edit the</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment, it is not equal to the last one. We use the begin</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">property which is less likely to change for the comparison.</span>
            (not (= (org-element-property <span style="color: #006FE0;">:begin</span> el)
                    (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go back to last one and put image back</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now remove current image</span>
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and save new fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now are not on a fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">not on a fragment now</span>
            (not (<span style="color: #0000FF;">or</span>
                  (eq 'latex-fragment el-type)
                  (eq 'latex-environment el-type)))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but we were on one</span>
            org-latex-fragment-last)
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">put image back on</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">unset last fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last nil))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were not on a fragment, and now are</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">we were not one one</span>
            (not org-latex-fragment-last)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but now we are</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type)))
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">remove image</span>
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))))))


(add-hook 'post-command-hook 'org-latex-fragment-toggle)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">org-latex-fragment-toggle</td>
<td class="left">matlab-start-block-highlight-timer</td>
<td class="left">eldoc-schedule-timer</td>
</tr>
</tbody>
</table>


<p>
I think there could be another way to do this with text properties, e.g. point-left and point-entered, but that would require those properties to be set on the fragments. I might try that approach another day.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-checkbox-list-in-org-mode-with-one-value"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value/" rel="bookmark" title="Permanent Link to A checkbox list in org-mode with one value">A checkbox list in org-mode with one value</a></h2>
      <p><small><span class="blog_post_date">Posted October 05, 2015 at 07:15 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated December 09, 2016 at 03:10 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
A while ago I had a need for a checklist in org-mode where only one value would be checked at a time. Like a radio button in a browser form. That isn't as far as I know a feature yet, but it was not hard to achieve thanks to the org-element api.  My simple idea is to make a function that will be added to the org-checkbox-statistics-hook. The function will uncheck all the boxes, and recheck the one you just clicked with a hybrid of manipulating the cursor and inserting characters with org-element code. We will use an attribute on the checklist to indicate it is a "radio" list. This seems like a feature that might already exist, but I couldn't find it.
</p>

<p>
Here is the code we run. First, we make sure we are on a plain list that has an attr_org property of ":radio", that way this won't apply to all lists, just the radio lists. Then, we loop through each element in the structure, and if it is checked, we replace [X] with [ ]. Then, we reinsert the X and delete a space, which puts [X] where we originally clicked, or used C-c C-c. Finally, we add it to the hook, so it only gets run when a checkbox is changed via clicking with org-mouse, or C-c C-c. Of course, this doesn't work if you type X in the box.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">dash</span>)
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">check-hook-fn</span> ()
  (<span style="color: #0000FF;">when</span> (-contains? (org-element-property
                     <span style="color: #006FE0;">:attr_org</span>
                     (org-element-property <span style="color: #006FE0;">:parent</span> (org-element-context)))
                    <span style="color: #008000;">":radio"</span>)
    (<span style="color: #0000FF;">save-excursion</span>
      (<span style="color: #0000FF;">loop</span> for el in (org-element-property <span style="color: #006FE0;">:structure</span> (org-element-context))
            do
            (goto-char (car el))
            (<span style="color: #0000FF;">when</span> (re-search-forward <span style="color: #008000;">"\\[</span><span style="color: #D0372D;">X\\</span><span style="color: #008000;">]"</span> (line-end-position) t)
              (replace-match <span style="color: #008000;">"[ ]"</span>))))
    (forward-char)
    (insert <span style="color: #008000;">"X"</span>)
    (delete-char 1)))

(add-hook 'org-checkbox-statistics-hook 'check-hook-fn)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">check-hook-fn</td>
</tr>
</tbody>
</table>

<p>
Here is a regular checklist. You can check as many as you want.
</p>
<ul class="org-ul">
<li class="on"><code>[X]</code> one</li>
<li class="on"><code>[X]</code> two</li>
<li class="off"><code>[&#xa0;]</code> three</li>
</ul>

<p>
Now, here is a radio checklist. Only one item at a time can be checked. Nice!
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> a</li>
<li class="off"><code>[&#xa0;]</code> b</li>
<li class="on"><code>[X]</code> c</li>
</ul>

<p>
It is worth noting here that if we put a name on the list, it becomes an addressable data source. First we need this convenient function to get the data associated with a named list.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-get-plain-list</span> (name)
  <span style="color: #036A07;">"Get the org-element representation of a plain-list with NAME."</span>
  (<span style="color: #0000FF;">catch</span> '<span style="color: #D0372D;">found</span>
    (org-element-map
        (org-element-parse-buffer)
        'plain-list
      (<span style="color: #0000FF;">lambda</span> (plain-list)
        (<span style="color: #0000FF;">when</span>
            (string= name (org-element-property <span style="color: #006FE0;">:name</span> plain-list))
          (<span style="color: #0000FF;">throw</span> '<span style="color: #D0372D;">found</span> plain-list))))))
</pre>
</div>

<pre class="example">
org-get-plain-list
</pre>

<p>
Now, let's use that to get the value of the checked item in the "test" list. We define the item as everything after the [X] and get it from a regular expression match.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">get-radio-list-value</span> (list-name)
  <span style="color: #036A07;">"Return the value of the checked item in a radio list."</span>
  (<span style="color: #0000FF;">save-excursion</span>
    (<span style="color: #0000FF;">loop</span> for el in (org-element-property
                     <span style="color: #006FE0;">:structure</span>
                     (org-get-plain-list list-name))
          if (string= (nth 4 el) <span style="color: #008000;">"[X]"</span>)
          return (<span style="color: #0000FF;">progn</span>
                   (<span style="color: #0000FF;">let</span> ((item (buffer-substring (car el) (car (last el)))))
                     (string-match <span style="color: #008000;">"\\[</span><span style="color: #D0372D;">X\\</span><span style="color: #008000;">]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">.*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">$"</span> item)
                     (match-string 1 item))))))

(get-radio-list-value <span style="color: #008000;">"test"</span>)
</pre>
</div>

<pre class="example">
c
</pre>

<p>
Perfect. This has lots of potential applications. Data collection and quizzes come to mind, with associated ability to autograde and aggregate the data!
</p>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2015/10/05/A-checkbox-list-in-org-mode-with-one-value.org">org-mode source</a></p>
<p>Org-mode version = 9.0</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/orgmode/7">« Previous Page</a>
  --  
 <a href="/blog/category/orgmode/9">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/01/27/New-publication-in-Topics-in-Catalysis/">New publication in Topics in Catalysis</a></li>
      <li><a href="/blog/2018/01/03/New-publication-in-Molecular-Simulation/">New publication in Molecular Simulation</a></li>
      <li><a href="/blog/2017/12/31/2017-in-a-nutshell-for-the-Kitchin-Research-group/">2017 in a nutshell for the Kitchin Research group</a></li>
      <li><a href="/blog/2017/11/29/Solving-an-eigenvalue-differential-equation-with-a-neural-network/">Solving an eigenvalue differential equation with a neural network</a></li>
      <li><a href="/blog/2017/11/28/Solving-ODEs-with-a-neural-network-and-autograd/">Solving ODEs with a neural network and autograd</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



