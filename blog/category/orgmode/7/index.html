

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group: orgmode</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications/index.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Improving-org-ref-cite-links-with-tooltips"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/23/Improving-org-ref-cite-links-with-tooltips/" rel="bookmark" title="Permanent Link to Improving org-ref cite links with tooltips">Improving org-ref cite links with tooltips</a></h2>
      <p><small><span class="blog_post_date">Posted November 23, 2015 at 07:03 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgref/'>orgref</a>, <a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/23/Improving-org-ref-cite-links-with-tooltips#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
Org-ref uses timers to give you messages about the cite link at point. I am not so crazy about the timer, there is always a (short) delay, and I have had trouble debugging timers in the past, and you have to put the point on the link. Since I wrote that code, I have learned some new things about Emacs, including dynamic tooltips. This will allow me to use the mouse to see what a cite link refers to. While reading documents, I am more likely to use a mouse than when typing a document, and getting a tooltip by hovering sounds like a good idea.
</p>

<p>
Here, we explore using dynamic tooltips on cite links. The idea is pretty simple, we tie into font-lock to add a function to the :help-echo property of a cite link. The function will go to point, and compute the citation string at point, which will be displayed as a tooltip when the mouse hovers over the citation.
</p>

<p>
Font-lock allows you to specify a function that sets match-data and that can have other side-effects, e.g. setting text properties. Org-ref has a regexp that defines cite links, which we use here, and a function that gets the citation string at point. We just go to the mouse position, and get that string, wrapped in a save-excursion macro so that point does not actually move. Then, we add the function to font-lock keywords, and we are done!
</p>

<p>
Here are some papers we wrote on using org-mode
<a class='org-ref-reference' href="#kitchin-2015-examp">kitchin-2015-examp</a>,<a class='org-ref-reference' href="#kitchin-2015-data-surfac-scien">kitchin-2015-data-surfac-scien</a> and some other references
in my bibliography <a class='org-ref-reference' href="#zou-2014-cobal-embed">zou-2014-cobal-embed</a>,<a class='org-ref-reference' href="#zlotea-2014-nanoal">zlotea-2014-nanoal</a> and one final
example <a class='org-ref-reference' href="#zhu-2015">zhu-2015</a>.
</p>


<p>
Here is the short code required to do this. You can see the tooltips in action here: <a href="https://www.youtube.com/watch?v=ifSmlId2rk0">https://www.youtube.com/watch?v=ifSmlId2rk0</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-ref-match-next-cite-link</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  (<span style="color: #0000FF;">when</span> (re-search-forward org-ref-cite-re limit t)
    (add-text-properties
     (match-beginning 0) (match-end 0)
     (list
      'help-echo (<span style="color: #0000FF;">lambda</span> (window object position)
                   (<span style="color: #0000FF;">save-excursion</span>
                     (goto-char position)
                     (<span style="color: #0000FF;">let</span> ((s (org-ref-get-citation-string-at-point)))
                       (<span style="color: #0000FF;">with-temp-buffer</span>
                         (insert s)
                         (fill-paragraph)
                         (buffer-string)))))))))

<span style="color: #8D8D84;">; </span><span style="color: #8D8D84; font-style: italic;">do this for this buffer</span>
(font-lock-add-keywords
    nil
    '((org-ref-match-next-cite-link (0  'org-ref-cite-face t)))
    t)
(font-lock-fontify-buffer)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">do this for every org file</span>
(add-hook
 'org-mode-hook
 (<span style="color: #0000FF;">lambda</span> ()
   (font-lock-add-keywords
    nil
    '((org-ref-match-next-cite-link (0  'org-ref-cite-face t)))
    t)))
</pre>
</div>


<p>
<h1 class='org-ref-bib-h1'>Bibliography</h1>
<ul class='org-ref-bib'><li><a id="kitchin-2015-data-surfac-scien">[kitchin-2015-data-surfac-scien] "John Kitchin", Data Sharing in Surface Science, <i>"Surface Science "</i>, <b>(0)</b>,  -  (2015). <a href="http://www.sciencedirect.com/science/article/pii/S0039602815001326">link</a>. <a href="http://dx.doi.org/10.1016/j.susc.2015.05.007">doi</a>.</a></li>
<li><a id="kitchin-2015-examp">[kitchin-2015-examp] Kitchin, Examples of Effective Data Sharing in Scientific Publishing, <i>ACS Catalysis</i>, <b>5(6)</b>, 3894-3899 (2015). <a href=" http://dx.doi.org/10.1021/acscatal.5b00538 ">link</a>. <a href="http://dx.doi.org/10.1021/acscatal.5b00538">doi</a>.</a></li>
<li><a id="zhu-2015">[zhu-2015] Yinlong Zhu, Wei Zhou, Zhi-Gang Chen, Yubo Chen, , Chao Su, Moses Tad\'e & Zongping Shao, \ceSrNb_0.1Co_0.7Fe_0.2 O_3-$\delta$ Perovskite As a  Next-Generation Electrocatalyst for Oxygen Evolution in  Alkaline Solution, <i>Angew. Chem. Int. Ed.</i>, <b>54(13)</b>, 3897-3901 (2015). <a href="http://dx.doi.org/10.1002/anie.201408998">link</a>. <a href="http://dx.doi.org/10.1002/anie.201408998">doi</a>.</a></li>
<li><a id="zlotea-2014-nanoal">[zlotea-2014-nanoal] Zlotea, Morfin, Nguyen, Nguyen, , Nelayah, Ricolleau, Latroche & Piccolo, Nanoalloying Bulk-Immiscible Iridium and Palladium Inhibits  Hydride Formation and Promotes Catalytic Performances, <i>Nanoscale</i>, <b>6(17)</b>, 9955 (2014). <a href="http://dx.doi.org/10.1039/C4NR02836H">link</a>. <a href="http://dx.doi.org/10.1039/c4nr02836h">doi</a>.</a></li>
<li><a id="zou-2014-cobal-embed">[zou-2014-cobal-embed] Zou, Huang, Goswami, , Silva, Sathe, Mikmekov\'a, ska & Asefa, Cobalt-Embedded Nitrogen-Rich Carbon Nanotubes Efficiently  Catalyze Hydrogen Evolution Reaction At All pH Values, <i>Angewandte Chemie</i>, <b></b>, 4461-4465 (2014). <a href="http://dx.doi.org/10.1002/ange.201311111">link</a>. <a href="http://dx.doi.org/10.1002/ange.201311111">doi</a>.</a></li>
</ul>
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/23/Improving-org-ref-cite-links-with-tooltips.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/23/Improving-org-ref-cite-links-with-tooltips#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/22/Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode/" rel="bookmark" title="Permanent Link to Adding emacs command key-bindings and help functionality to org-mode">Adding emacs command key-bindings and help functionality to org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted November 22, 2015 at 10:08 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/22/Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
The documentation of functions in emacs allows you to put some light markup into function doc strings that will render as the key sequence required to run the command when you look up the help on the function. I would like to have something like that in org-mode. You can look up the key-binding to a command like this:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(substitute-command-keys <span style="color: #008000;">"\\[</span><span style="color: #D0372D;">org-agenda</span><span style="color: #008000;">]"</span>)
</pre>
</div>

<pre class="example">
C-c a
</pre>

<p>
We are going to explore a way to recognize the syntax shown above, change its appearance to alert us that we are looking at an emacs command, add a tooltip, and make it clickable to open the documentation, and s (super) clickable to find the function code. Font lock is the tool we will use for this. Basically, we need a regular expression to match the syntax, and a function to find the next instance, and put some properties on the matched text.
</p>

<p>
I made a video (<a href="https://www.youtube.com/watch?v=VLUMW0sR4Vk">https://www.youtube.com/watch?v=VLUMW0sR4Vk</a> ) showing what this post is all about. It isn't easy to see in the post ☺.
</p>

<p>
Here we use the `rx' library to build up a regular expression for this. It is a bit easier to document than a raw regexp. Since we are matching \ in the pattern, there are some obligatory escaping \ characters in there too. All we need is to integrate this into font-lock. We define a function that will move the point to the end of the next match, and put properties on the match. We will go ahead and make the text clickable so we can access documentation and code easily. The tooltip will show the key-binding to run the command.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">rx</span>)

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-keybinding-re</span>
  (<span style="color: #0000FF;">rx</span>
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">opening \\[</span>
   (eval <span style="color: #008000;">"\\["</span>)
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">one or more characters that are not ]</span>
   (group (one-or-more (not (any <span style="color: #008000;">"]"</span>))))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">The closing ]</span>
   <span style="color: #008000;">"]"</span>)
<span style="color: #036A07;">"Regexp for an elisp command keybinding syntax. \\[</span><span style="color: #D0372D;">some-command</span><span style="color: #036A07;">]</span>
<span style="color: #036A07;">Regexp group 1 matches `</span><span style="color: #D0372D;">some-command</span><span style="color: #036A07;">'."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">match-next-keybinding</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  <span style="color: #036A07;">"Move point to the end of the next expression matching</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">elisp-symbol-keybinding-re</span><span style="color: #036A07;">', and put properties on the match</span>
<span style="color: #036A07;">that shows the key sequence. Non-bound commands are not</span>
<span style="color: #036A07;">fontified."</span>
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (re-search-forward
              elisp-symbol-keybinding-re
              limit t)
             (fboundp (intern (match-string 1))))
    (<span style="color: #0000FF;">let*</span> ((beg (match-beginning 0))
           (end (match-end 0))
           (s (match-string 0))
           (command (match-string 1))
           (describe-func `(<span style="color: #0000FF;">lambda</span> ()
                    <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">describe-function</span><span style="color: #036A07;">' on the command."</span>
                    (<span style="color: #0000FF;">interactive</span>)
                    (describe-function (intern ,command))))
           (find-func `(<span style="color: #0000FF;">lambda</span> ()
                     <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">find-function</span><span style="color: #036A07;">' on the command."</span>
                     (<span style="color: #0000FF;">interactive</span>)
                     (find-function (intern ,command))))
           (map (make-sparse-keymap)))

      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is what gets run when you click on it.</span>
      (define-key map [mouse-1] describe-func)
      (define-key map [s-mouse-1] find-func)
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Here we define the text properties</span>
      (add-text-properties
       beg end
       `(local-map ,map
         mouse-face highlight
         help-echo ,(format
                     <span style="color: #008000;">"%s\n\nClick for documentation.\ns-mouse-1 to find function."</span>
                     (substitute-command-keys s))
         keybinding t)))))
</pre>
</div>

<p>
Let's go ahead and make syntax for `some-command' too. This one seems simple enough we just write a regexp for it.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">match-next-emacs-command</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  <span style="color: #036A07;">"Move point to the end of the next expression matching</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">this-syntax</span><span style="color: #036A07;">', and put a tooltip on the match</span>
<span style="color: #036A07;">that shows the key sequence. Works on commands and variables."</span>
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (re-search-forward
              <span style="color: #008000;">"`</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">']+</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">'"</span>
              limit t)
             (<span style="color: #0000FF;">or</span> (boundp (intern (match-string 1)))
                 (fboundp (intern (match-string 1)))))
    (<span style="color: #0000FF;">let*</span> ((beg (match-beginning 0))
           (end (match-end 0))
           (s (match-string 0))
           (command (match-string 1))
           (describe-func
            `(<span style="color: #0000FF;">lambda</span> ()
               <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">describe-function/variable</span><span style="color: #036A07;">' on the command."</span>
               (<span style="color: #0000FF;">interactive</span>)
               (<span style="color: #0000FF;">cond</span> ((fboundp (intern ,command))
                      (describe-function (intern ,command)))
                     ((boundp (intern ,command))
                      (describe-variable (intern ,command))))))
           (find-func `(<span style="color: #0000FF;">lambda</span> ()
                     <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">find-function</span><span style="color: #036A07;">' on the command."</span>
                     (<span style="color: #0000FF;">interactive</span>)
                     (find-function (intern ,command))))
           (map (make-sparse-keymap)))

      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is what gets run when you click on it.</span>
      (define-key map [mouse-1] describe-func)
      (define-key map [s-mouse-1] find-func)
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Here we define the text properties</span>
      (add-text-properties
       beg end
       `(local-map ,map
         mouse-face highlight
         help-echo ,(format
                     <span style="color: #008000;">"%s\n\nClick for documentation.%s"</span>
                     (<span style="color: #0000FF;">if</span> (fboundp (intern command))
                         (substitute-command-keys (format <span style="color: #008000;">"\\[</span><span style="color: #D0372D;">%s</span><span style="color: #008000;">]"</span> command))
                       <span style="color: #008000;">"Variable"</span>)
                     (<span style="color: #0000FF;">if</span> (fboundp (intern command))
                         <span style="color: #008000;">"\ns-mouse-1 to find function."</span>
                       <span style="color: #008000;">""</span>))
         keybinding t)))))
</pre>
</div>

<p>
Now we need a way to turn them on and off. We do that here with a minor mode.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">define-minor-mode</span> <span style="color: #006699;">emacs-keybinding-command-tooltip-mode</span>
  <span style="color: #036A07;">"Fontify on emacs keybinding syntax. Adds a tooltip for</span>
<span style="color: #036A07;">keybinding, and make the command clickable to get to the</span>
<span style="color: #036A07;">documentation."</span>
  <span style="color: #006FE0;">:lighter</span> <span style="color: #008000;">" KB"</span>
  (<span style="color: #0000FF;">if</span> emacs-keybinding-command-tooltip-mode
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">turn them on</span>
      (font-lock-add-keywords
       nil
       '((match-next-keybinding 1 font-lock-constant-face)
         (match-next-emacs-command 1 font-lock-constant-face)))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">turn them off</span>
    (font-lock-remove-keywords
     nil
     '((match-next-keybinding 1 font-lock-constant-face)
       (match-next-emacs-command 1 font-lock-constant-face))))
  (font-lock-fontify-buffer))
</pre>
</div>

<p>
Here we turn it on:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(emacs-keybinding-command-tooltip-mode -1)
</pre>
</div>

<p>
Here are some sample uses. You can use  \\[org-toggle-latex-overlays] to toggle latex overlays.
</p>

<p>
You can use \\[org-ref-helm-insert-cite-link]  to insert citations.
</p>

<p>
That more or less does it! I don't know if this is the canonical way to do this, but it works nicely here. You can also use overlays, but I found them a little confusing because they are not editable, and you have to toggle the minor mode to see them. Here we have unobtrusive tooltips. One downside is these won't export in any fashion in org-mode since it is not part of the syntax. It might be a good idea to adjust `font-lock-extra-managed-props' for this
</p>

<p>
It works for this syntax too: `helm', which is also commonly used in doc strings. This should be pretty handy in org-mode documents about Emacs!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/22/Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/22/Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Insert-org-entities-into-org-mode-with-helm"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/21/Insert-org-entities-into-org-mode-with-helm/" rel="bookmark" title="Permanent Link to Insert org-entities into org-mode with helm">Insert org-entities into org-mode with helm</a></h2>
      <p><small><span class="blog_post_date">Posted November 21, 2015 at 11:37 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/helm/'>helm</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/21/Insert-org-entities-into-org-mode-with-helm#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
org-mode has a lot of pre-defined entities (see <a href="http://kitchingroup.cheme.cmu.edu/blog/2013/10/03/Exporting-accented-characters-to-latex-from-org-mode/">http://kitchingroup.cheme.cmu.edu/blog/2013/10/03/Exporting-accented-characters-to-latex-from-org-mode/</a> ), otherwise known to me as non-ascii characters. I rarely remember what these are, and occasionally want to insert the LaTeX or HTML code, so here we build a helm command to show them to me, and allow me to select one for insertion. We generate the helm sources from org-entities below. It works pretty well!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">helm-insert-org-entity</span> ()
  <span style="color: #036A07;">"Helm interface to insert an entity from `</span><span style="color: #D0372D;">org-entities</span><span style="color: #036A07;">'.</span>
<span style="color: #036A07;">F1 inserts utf-8 character</span>
<span style="color: #036A07;">F2 inserts entity code</span>
<span style="color: #036A07;">F3 inserts LaTeX code (does not wrap in math-mode)</span>
<span style="color: #036A07;">F4 inserts HTML code"</span>
  (<span style="color: #0000FF;">interactive</span>)
  (helm <span style="color: #006FE0;">:sources</span> (reverse
                  (<span style="color: #0000FF;">let</span> ((sources '())
                        toplevel
                        secondlevel)
                    (<span style="color: #0000FF;">dolist</span> (element (append
                                      '(<span style="color: #008000;">"* User"</span> <span style="color: #008000;">"** User entities"</span>)
                                      org-entities-user org-entities))
                      (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (stringp element)
                                 (s-starts-with? <span style="color: #008000;">"* "</span> element))
                        (<span style="color: #0000FF;">setq</span> toplevel element))
                      (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (stringp element)
                                 (s-starts-with? <span style="color: #008000;">"** "</span> element))
                        (<span style="color: #0000FF;">setq</span> secondlevel element)
                        (add-to-list
                         'sources
                         `((name . ,(concat
                                     toplevel
                                     (replace-regexp-in-string
                                      <span style="color: #008000;">"\\*\\*"</span> <span style="color: #008000;">" - "</span> secondlevel)))
                           (candidates . nil)
                           (action . ((<span style="color: #008000;">"insert utf-8 char"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                                               (insert (nth 6 candidate))))
                                      (<span style="color: #008000;">"insert org entity"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                                           (insert (concat <span style="color: #008000;">"\\"</span> (car candidate)))))
                                      (<span style="color: #008000;">"insert latex"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                                          (insert (nth 1 candidate))))
                                      (<span style="color: #008000;">"insert html"</span> . (<span style="color: #0000FF;">lambda</span> (candidate)
                                                         (insert (nth 3 candidate)))))))))
                      (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> element (listp element))
                        (<span style="color: #0000FF;">setf</span> (cdr (assoc 'candidates (car sources)))
                              (append
                               (cdr (assoc 'candidates (car sources)))
                               (list (cons
                                      (format <span style="color: #008000;">"%10s %s"</span> (nth 6 element) element)
                                      element))))))
                    sources))))
</pre>
</div>

<pre class="example">
helm-insert-org-entity
</pre>

<p>
Now I can write things like the particle was 60 Å in diameter at a temperature of 600°C, leading to an expansion coefficient of α=0.2 ± 0.01. It isn't quite as fast as knowing the keyboard shortcuts for those symbols, but a lot faster than looking them up then copy and pasting them. So far it seems like these export to HTML and LaTeX just fine, and they are more convenient and better looking than using the org-entities codes. This will make its way into jmax soon.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/21/Insert-org-entities-into-org-mode-with-helm.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/21/Insert-org-entities-into-org-mode-with-helm#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Asynchronously-running-python-blocks-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode/" rel="bookmark" title="Permanent Link to Asynchronously running python blocks in org-mode">Asynchronously running python blocks in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted November 20, 2015 at 11:46 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/python/'>python</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated November 20, 2015 at 07:30 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
If you run long Python blocks from org-mode, you might want to keep working while it runs. Currently Emacs gets blocked and you have to wait patiently.  In this post we consider some ways to avoid this that run our code asynchronously, but still put results where they belong in the org-buffer.
</p>

<p>
This is a long post. You may want to see the video: <a href="https://www.youtube.com/watch?v=VDyoN8yipSE">https://www.youtube.com/watch?v=VDyoN8yipSE</a> , or skip to the <a href="#sec-3">end</a> where the best and final version is shown.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The async module</h2>
<div class="outline-text-2" id="text-1">
<p>
Here we consider an approach that uses <a href="https://github.com/jwiegley/emacs-async">https://github.com/jwiegley/emacs-async</a> module. The idea is to tangle the Python block at point to a temp file, then asynchronously run it. We capture the output and put it back in the buffer. We use a uuid to find the place to put the results in org-mode format. Here is the code that implements this idea.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">async</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  <span style="color: #036A07;">"Run a python block at point asynchrously."</span>
  (<span style="color: #0000FF;">interactive</span>)

  (<span style="color: #0000FF;">let</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>)))

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)
    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">async-start</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">what to start</span>
     `(<span style="color: #0000FF;">lambda</span> ()
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now we run the command then cleanup</span>
        (<span style="color: #0000FF;">prog1</span>
            (shell-command-to-string (format <span style="color: #008000;">"python %s"</span> ,tempfile))
          (delete-file ,tempfile)))

     `(<span style="color: #0000FF;">lambda</span> (result)
        <span style="color: #036A07;">"Code that runs when the async function finishes."</span>
        (<span style="color: #0000FF;">save-window-excursion</span>
          (<span style="color: #0000FF;">save-excursion</span>
            (<span style="color: #0000FF;">save-restriction</span>
              (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                (goto-char (point-min))
                (re-search-forward ,uuid)
                (beginning-of-line)
                (kill-line)
                (insert (mapconcat
                         (<span style="color: #0000FF;">lambda</span> (x)
                           (format <span style="color: #008000;">": %s"</span> x))
                         (butlast (s-split <span style="color: #008000;">"\n"</span> result))
                         <span style="color: #008000;">"\n"</span>))))))))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<p>
Here is a block to test it on. We can run the block, and keep on working while the code runs. The results seem to get inserted correctly at the right point even if I am in another window or frame! We don't get easy access to continuous output of the command. This wouldn't work if we close Emacs, but who does that?
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(5)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:17:53 2015
</pre>

<p>
There are some limitations to this approach. One of them is it assumes the src block is a stand-alone block that will run on its own. That is usually how I run mine, but I could see having other modules that should be tangled out of a file too. I think the script is being run in the current working directory, so it probably will find any local imports it needs.
</p>

<p>
You don't get any intermediate feedback on this process. It seems to be possible to do that with a different approach that puts some output in a new buffer, e.g. with start-process. But, you still need some clever code like the async model to know when to insert the results back into this buffer. We consider Emacs processes and sentinels next.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Emacs process approach with tangling</h2>
<div class="outline-text-2" id="text-2">
<p>
We can start a process in Emacs, and attach a sentinel function to it that runs after the process completes. Here is an example of that. We still tangle the src-block here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
        (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
        process)

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">when</span> (string= <span style="color: #008000;">"finished\n"</span> event)
          (delete-file ,tempfile)
          (<span style="color: #0000FF;">save-window-excursion</span>
            (<span style="color: #0000FF;">save-excursion</span>
              (<span style="color: #0000FF;">save-restriction</span>
                (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                  (goto-char (point-min))
                  (re-search-forward ,uuid)
                  (beginning-of-line)
                  (kill-line)
                  (insert (mapconcat
                           (<span style="color: #0000FF;">lambda</span> (x)
                             (format <span style="color: #008000;">": %s"</span> x))
                           (split-string
                            (<span style="color: #0000FF;">with-current-buffer</span> ,pbuffer (buffer-string))
                            <span style="color: #008000;">"\n"</span>)
                           <span style="color: #008000;">"\n"</span>)))))))
        (kill-buffer ,pbuffer)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(10)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:20:01 2015
</pre>

<p>
That works well from what I can see. There are some limitations. I doubt this will work if you use variables in the src block header. Next we consider an approach that does not do the tangling, and that will show us code output as it goes.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><a id="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE" name="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE"></a><span class="section-number-2">3</span> Emacs process approach with no tangling</h2>
<div class="outline-text-2" id="text-3">
<p>
As an alternative to tangling to a file, here we just copy the code to a file and then run it. This allows us to use :var in the header to pass data in at run time. At the moment, this code only supports printed output from code blocks, not the value for :results.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute:python</span> ()
  <span style="color: #036A07;">"Execute the python src-block at point asynchronously.</span>
<span style="color: #036A07;">:var headers are supported.</span>
<span style="color: #036A07;">:results output is all that is supported for output.</span>

<span style="color: #036A07;">A new window will pop up showing you the output as it appears,</span>
<span style="color: #036A07;">and the output in that window will be put in the RESULTS section</span>
<span style="color: #036A07;">of the code block."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
         (uuid (org-id-uuid))
         (code (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))
         (temporary-file-directory <span style="color: #008000;">"."</span>)
         (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
         (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
         (varcmds (org-babel-variable-assignments:python
                   (nth 2 (org-babel-get-src-block-info))))
         process)

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get rid of old results, and put a place-holder for the new results to</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">come.</span>
    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">open the results buffer to see the results in.</span>
    (switch-to-buffer-other-window pbuffer)

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Create temp file containing the code.</span>
    (<span style="color: #0000FF;">with-temp-file</span> tempfile
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">if there are :var headers insert them.</span>
      (<span style="color: #0000FF;">dolist</span> (cmd varcmds)
        (insert cmd)
        (insert <span style="color: #008000;">"\n"</span>))
      (insert code))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">run the code</span>
    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">when the process is done, run this code to put the results in the</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">org-mode buffer.</span>
    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">save-window-excursion</span>
          (<span style="color: #0000FF;">save-excursion</span>
            (<span style="color: #0000FF;">save-restriction</span>
              (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                (goto-char (point-min))
                (re-search-forward ,uuid)
                (beginning-of-line)
                (kill-line)
                (insert
                 (mapconcat
                  (<span style="color: #0000FF;">lambda</span> (x)
                    (format <span style="color: #008000;">": %s"</span> x))
                  (butlast (split-string
                            (<span style="color: #0000FF;">with-current-buffer</span>
                                ,pbuffer
                              (buffer-string))
                            <span style="color: #008000;">"\n"</span>))
                  <span style="color: #008000;">"\n"</span>))))))
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">delete the results buffer then delete the tempfile.</span>
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">finally, delete the process.</span>
        (<span style="color: #0000FF;">when</span> (get-buffer ,pbuffer)
          (kill-buffer ,pbuffer)
          (delete-window))
        (delete-file ,tempfile)
        (delete-process process)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute:python
</pre>

<p>
Let us try it out again.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(1)

<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(5):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">print</span> i

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   time.sleep(0.5)


<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()

<span style="color: #0000FF;">print</span> data

<span style="color: #0000FF;">raise</span> <span style="color: #6434A3;">IOError</span>(<span style="color: #008000;">'No file!'</span>)
</pre>
</div>

<pre class="example">
hello world
0
1
2
3
4
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 19:30:16 2015
[1, 3]
Traceback (most recent call last):
  File "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/py-84344aa1", line 18, in &lt;module&gt;
    raise IOError('No file!')
IOError: No file!
</pre>

<p>
It works fine for this simple example. We get to see the output as the code executes, which is a pleasant change from the usual way of running python blocks. There is some support for some header arguments, notably the :var header. I don't use :results value in Python, so for now only output is supported. We even support Exceptions in the output finally!
</p>

<p>
Maybe some org-moder's out there can try this and run it through some more rigorous paces?
</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/20/Asynchronously-running-python-blocks-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Functional-and-display-math-in-technical-documents"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/11/19/Functional-and-display-math-in-technical-documents/" rel="bookmark" title="Permanent Link to Functional and display math in technical documents">Functional and display math in technical documents</a></h2>
      <p><small><span class="blog_post_date">Posted November 19, 2015 at 06:07 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated November 19, 2015 at 02:43 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I have been thinking about a way to have functional and readable mathematics in technical documents. It has always bothered me that I have to write a LaTeX version of an equation, and then a separate implementation of the equation in code somewhere. At least twice in my life these separate representations have not agreed!
</p>

<p>
One solution might be if my functional code could be converted to LaTeX easily. I explore one simple approach to this here. It is somewhat inspired by this work here <a href="http://oremacs.com/2015/01/23/eltex/">http://oremacs.com/2015/01/23/eltex/</a> on writing LaTeX in emacs-lisp, and from my work with org-mode in mixing narrative text, LaTeX and code.
</p>

<p>
The idea is to use emacs-lisp for the code, so it is functional, but provide an alternative output for the <i>same code</i> for a document conversion. In other words, we accept there is more than one version we need: a functional version for working, and a consumption version for presentation. We will generate the consumption version from the functional version.
</p>

<p>
I know emacs-lisp is not ideal for mathematics the way we are accustomed to seeing it, but it enables the idea I want to explore here so we will try it.
</p>

<p>
Here is the simplest example I could come up with for functional math. We can run it ourselves, and verify it is correct.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(+ 1 2 3)
</pre>
</div>

<pre class="example">
6
</pre>

<p>
Now, I can change the meaning of this code temporarily, so that it not only evaluates the form, but also represents the equation and result in LaTeX code. If this was incorporated into a preprocessor of the document, we could have a functional version representing our equations, in code form, and a presentation version generated from this version. The code that follows isn't how I would do this is in some production setting; it is only to show that you can <i>temporarily</i> change the meaning of "+". In a production setting, there would just be (+ 1 2 3) in the text, and a preprocessor would find all the sexps in the text, and replace them with the export format using code like this. At least, that is what I am imagining. It might be feasible to do this already with inline org-babel calls and an org-mode export filter, but I didn't try it here. So, here is the proof of concept code.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((+ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$%s = %s$"</span>
                (mapconcat #'number-to-string args <span style="color: #008000;">" + "</span>)
                (eval `(+ ,@args))))))
  (+ 1 2 3))
</pre>
</div>

<p>
\(1 + 2 + 3 = 6\)
</p>



<p>
Here is an example that generates a fraction from a division.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((/ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$\\frac{%s}{%s} = %s$"</span>
                (car args)
                (mapconcat 'number-to-string (cdr args) <span style="color: #008000;">" \\cdot "</span>)
                (eval `(/ ,@args))))))
  (/ 1.0 2.0 3.0))
</pre>
</div>

<p>
\(\frac{1.0}{2.0 \cdot 3.0} = 0.16666666666666666\)
</p>

<p>
As a proof of concept, this idea looks feasible, but this implementation has some limitations. Getting this to a complete workable approach would require a lot of work, basically creating transformation functions for many, many kinds of mathematical functions, and a lot of other kinds of logic. For example, (+ 1 2 (+ 3 4)) would not render correctly with the codes above. It isn't even clear what it should render to. I think you want 1 + 2 + (3 + 4) as the rendered output.
</p>

<p>
Anyway, it is an interesting idea, one that blurs the lines between code and mathematics. We are so used to the equation representation of mathematics, rather than the code representation that being able to go back and forth seems like a good idea, especially when one is derived from the other.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/19/Functional-and-display-math-in-technical-documents.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/orgmode/6">« Previous Page</a>
  --  
 <a href="/blog/category/orgmode/8">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook/">Adding keymaps to src blocks via org-font-lock-hook</a></li>
      <li><a href="/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax/">Org-mode and ipython enhancements in scimax</a></li>
      <li><a href="/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp/">A partial symbolic numeric solver in emacs-lisp</a></li>
      <li><a href="/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL/">A new and improved Emacs gnuplot DSL</a></li>
      <li><a href="/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/">An emacs-lisp dsl for gnuplot</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2017
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



