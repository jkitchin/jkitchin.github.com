

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="http://www.researcherid.com/rid/A-2363-2010" target="_new">Publications</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/group.html"
             class="">Group</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Finding-the-maximum-power-of-a-photovoltaic-device"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/04/15/Finding-the-maximum-power-of-a-photovoltaic-device/" rel="bookmark" title="Permanent Link to Finding the maximum power of a photovoltaic device.">Finding the maximum power of a photovoltaic device.</a></h2>
      <p><small><span class="blog_post_date">Posted April 15, 2014 at 08:38 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/python/'>python</a>, <a href='/blog/category/optimization/'>optimization</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2014/04/15/Finding-the-maximum-power-of-a-photovoltaic-device#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
A photovoltaic device is characterized by a current-voltage relationship. Let us say, for argument's sake, that the relationship is known and defined by
</p>

<p>
\(i = 0.5 - 0.5 * V^2\)
</p>

<p>
The voltage is highest when the current is equal to zero, but of course then you get no power. The current is highest when the voltage is zero, i.e. short-circuited, but there is again no power. We seek the highest power condition, which is to find the maximum of \(i V\). This is a constrained optimization. We solve it by creating an objective function that returns the negative of (\i V\), and then find the minimum.
</p>

<p>
First, let us examine the i-V relationship.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt
<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #8b008b;">V</span> = np.linspace(0, 1)

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">i</span>(V):
    <span style="color: #8b0000;">return</span> 0.5 - 0.5 * V**2
plt.plot(V, i(V))
plt.savefig(<span style="color: #228b22;">'images/iV.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2014-04-15-Finding-the-maximum-power-of-a-photovoltaic-device./iV.png"> 
</p>
</div>


<p>
Now, let us be sure there is a maximum in power.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt
<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #8b008b;">V</span> = np.linspace(0, 1)

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">i</span>(V):
    <span style="color: #8b0000;">return</span> 0.5 - 0.5 * V**2
plt.plot(V, i(V) * V)
plt.savefig(<span style="color: #228b22;">'images/P1.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2014-04-15-Finding-the-maximum-power-of-a-photovoltaic-device./P1.png"> 
</p>
</div>

<p>
You can see in fact there is a maximum, near V=0.6. We could solve this problem analytically by taking the appropriate derivative and solving it for zero. That still might require solving a nonlinear problem though. We will directly setup and solve the constrained optimization. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin_slsqp
<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">objective</span>(X):
    <span style="color: #8b008b;">i</span>, <span style="color: #8b008b;">V</span> = X
    <span style="color: #8b0000;">return</span> - i * V

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">eqc</span>(X):
    <span style="color: #228b22;">'equality constraint'</span>
    <span style="color: #8b008b;">i</span>, <span style="color: #8b008b;">V</span> = X
    <span style="color: #8b0000;">return</span> (0.5 - 0.5 * V**2) - i

<span style="color: #8b008b;">X0</span> = [0.2, 0.6]
<span style="color: #8b008b;">X</span> = fmin_slsqp(objective, X0, eqcons=[eqc])

<span style="color: #8b008b;">imax</span>, <span style="color: #8b008b;">Vmax</span> = X


<span style="color: #8b008b;">V</span> = np.linspace(0, 1)

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">i</span>(V):
    <span style="color: #8b0000;">return</span> 0.5 - 0.5 * V**2
plt.plot(V, i(V), Vmax, imax, <span style="color: #228b22;">'ro'</span>)
plt.savefig(<span style="color: #228b22;">'images/P2.png'</span>)
</pre>
</div>

<pre class="example">
Optimization terminated successfully.    (Exit mode 0)
            Current function value: -0.192450127337
            Iterations: 5
            Function evaluations: 20
            Gradient evaluations: 5
</pre>


<div class="figure">
<p><img src="/media/2014-04-15-Finding-the-maximum-power-of-a-photovoltaic-device./P2.png"> 
</p>
</div>

<p>
You can see the maximum power is approximately 0.2 (unspecified units), at the conditions indicated by the red dot in the figure above.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/04/15/Finding-the-maximum-power-of-a-photovoltaic-device..org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2014/04/15/Finding-the-maximum-power-of-a-photovoltaic-device#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Constrained-fits-to-data"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/06/11/Constrained-fits-to-data/" rel="bookmark" title="Permanent Link to Constrained fits to data">Constrained fits to data</a></h2>
      <p><small><span class="blog_post_date">Posted June 11, 2013 at 07:39 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/data-analysis/'>data analysis</a>, <a href='/blog/category/optimization/'>optimization</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/06/11/Constrained-fits-to-data#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated June 12, 2013 at 08:31 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
Our objective here is to fit a quadratic function in the least squares sense to some data, but we want to constrain the fit so that the function has specific values at the end-points. The application is to fit a function to the lattice constant of an alloy at different compositions. We constrain the fit because we know the lattice constant of the pure metals, which are at the end-points of the fit and we want these to be correct. 
</p>

<p>
We define the alloy composition in terms of the mole fraction of one species, e.g. \(A_xB_{1-x}\). For \(x=0\), the alloy is pure B, whereas for \(x=1\) the alloy is pure A. According to Vegard's law the lattice constant is a linear composition weighted average of the pure component lattice constants, but sometimes small deviations are observed. Here we will fit a quadratic function that is constrained to give the pure metal component lattice constants at the end points. 
</p>

<p>
The quadratic function is \(y = a x^2 + b x + c\). One constraint is at \(x=0\) where \(y = c\), or \(c\) is the lattice constant of pure B. The second constraint is at \(x=1\), where \(a + b + c\) is equal to the lattice constant of pure A. Thus, there is only one degree of freedom. \(c = LC_B\), and \(b = LC_A - c - a\), so \(a\) is our only variable.
</p>

<p>
We will solve this problem by minimizing the summed squared error between the fit and the data. We use the <code>fmin</code> function in <code>scipy.optimize</code>. First we create a fit function that encodes the constraints. Then we create an objective function that will be minimized. We have to make a guess about the value of \(a\) that minimizes the summed squared error. A line fits the data moderately well, so we guess a small value, i.e. near zero, for \(a\). Here is the solution.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">Data to fit to</span>
<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">x=0 is pure B</span>
<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">x=1 is pure A</span>
X = np.array([0.0, 0.1,  0.25, 0.5,  0.6,  0.8,  1.0])
Y = np.array([3.9, 3.89, 3.87, 3.78, 3.75, 3.69, 3.6])

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">func</span>(a, XX):
    LC_A = 3.6
    LC_B = 3.9

    c = LC_B
    b = LC_A - c - a

    yfit = a * XX**2 + b * XX + c
    <span style="color: #8b0000;">return</span> yfit

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">objective</span>(a):
    <span style="color: #228b22;">'function to minimize'</span>
    SSE = np.sum((Y - func(a, X))**2)
    <span style="color: #8b0000;">return</span> SSE


<span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin

a_fit = fmin(objective, 0)
plt.plot(X, Y, <span style="color: #228b22;">'bo '</span>)

x = np.linspace(0, 1)
plt.plot(x, func(a_fit, x))
plt.savefig(<span style="color: #228b22;">'images/constrained-quadratic-fit.png'</span>)
</pre>
</div>

<pre class="example">
Optimization terminated successfully.
         Current function value: 0.000445
         Iterations: 19
         Function evaluations: 38
</pre>

<p>
Here is the result:
<p><img src="/img/./images/constrained-quadratic-fit.png"><p>
</p>

<p>
You can see that the end points go through the end-points as prescribed. 
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/06/11/Constrained-fits-to-data.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/06/11/Constrained-fits-to-data#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Gibbs-energy-minimization-and-the-NIST-webbook"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/03/01/Gibbs-energy-minimization-and-the-NIST-webbook/" rel="bookmark" title="Permanent Link to Gibbs energy minimization and the NIST webbook">Gibbs energy minimization and the NIST webbook</a></h2>
      <p><small><span class="blog_post_date">Posted March 01, 2013 at 01:11 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/optimization/'>optimization</a></span> | tags: <a href='/blog/tag/thermodynamics/'>thermodynamics</a>
        | <a href="http://jkitchin.github.io/blog/2013/03/01/Gibbs-energy-minimization-and-the-NIST-webbook#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated March 06, 2013 at 04:31 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
<a href="http://matlab.cheme.cmu.edu/2011/12/25/gibbs-energy-minimization-and-the-nist-webbook/" >Matlab post</a>
In Post 1536 we used the NIST webbook to compute a temperature dependent Gibbs energy of reaction, and then used a reaction extent variable to compute the equilibrium concentrations of each species for the water gas shift reaction.
</p>

<p>
Today, we look at the direct minimization of the Gibbs free energy of the species, with no assumptions about stoichiometry of reactions. We only apply the constraint of conservation of atoms. We use the NIST Webbook to provide the data for the Gibbs energy of each species.
</p>

<p>
As a reminder we consider equilibrium between the species \(CO\), \(H_2O\), \(CO_2\) and \(H_2\), at 1000K, and 10 atm total pressure with an initial equimolar molar flow rate of \(CO\) and \(H_2O\).
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

T = 1000  <span style="color: #ff0000; font-weight: bold;"># K</span>
R = 8.314e-3 <span style="color: #ff0000; font-weight: bold;"># kJ/mol/K</span>

P = 10.0 <span style="color: #ff0000; font-weight: bold;"># atm, this is the total pressure in the reactor</span>
Po = 1.0 <span style="color: #ff0000; font-weight: bold;"># atm, this is the standard state pressure</span>
</pre>
</div>

<p>
We are going to store all the data and calculations in vectors, so we need to assign each position in the vector to a species. Here are the definitions we use in this work.
</p>

<pre class="example">
1  CO
2  H2O
3  CO2
4  H2
</pre>

<div class="org-src-container">

<pre class="src src-python">species = [<span style="color: #228b22;">'CO'</span>, <span style="color: #228b22;">'H2O'</span>, <span style="color: #228b22;">'CO2'</span>, <span style="color: #228b22;">'H2'</span>]

<span style="color: #ff0000; font-weight: bold;"># Heats of formation at 298.15 K</span>

Hf298 = [
    -110.53,  <span style="color: #ff0000; font-weight: bold;"># CO</span>
    -241.826, <span style="color: #ff0000; font-weight: bold;"># H2O</span>
    -393.51,  <span style="color: #ff0000; font-weight: bold;"># CO2</span>
       0.0]   <span style="color: #ff0000; font-weight: bold;"># H2</span>

<span style="color: #ff0000; font-weight: bold;"># Shomate parameters for each species</span>
<span style="color: #ff0000; font-weight: bold;">#           A          B           C          D          E            F          G       H</span>
WB = [[25.56759,  6.096130,     4.054656,  -2.671301,  0.131021, -118.0089, 227.3665,   -110.5271],  <span style="color: #ff0000; font-weight: bold;"># CO</span>
      [30.09200,  6.832514,     6.793435,  -2.534480,  0.082139, -250.8810, 223.3967,   -241.8264],  <span style="color: #ff0000; font-weight: bold;"># H2O</span>
      [24.99735,  55.18696,   -33.69137,    7.948387, -0.136638, -403.6075, 228.2431,   -393.5224],  <span style="color: #ff0000; font-weight: bold;"># CO2</span>
      [33.066178, -11.363417,  11.432816,  -2.772874, -0.158558, -9.980797, 172.707974,    0.0]]     <span style="color: #ff0000; font-weight: bold;"># H2</span>

WB = np.array(WB)

<span style="color: #ff0000; font-weight: bold;"># Shomate equations</span>
t = T/1000
T_H = np.array([t,  t**2 / 2.0, t**3 / 3.0, t**4 / 4.0, -1.0 / t, 1.0, 0.0, -1.0])
T_S = np.array([np.log(t), t,  t**2 / 2.0,  t**3 / 3.0, -1.0 / (2.0 * t**2), 0.0, 1.0, 0.0])

H = np.dot(WB, T_H)        <span style="color: #ff0000; font-weight: bold;"># (H - H_298.15) kJ/mol</span>
S = np.dot(WB, T_S/1000.0) <span style="color: #ff0000; font-weight: bold;"># absolute entropy kJ/mol/K</span>

Gjo = Hf298 + H - T*S      <span style="color: #ff0000; font-weight: bold;"># Gibbs energy of each component at 1000 K</span>
</pre>
</div>

<p>
Now, construct the Gibbs free energy function, accounting for the change in activity due to concentration changes (ideal mixing).
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">def</span> <span style="color: #8b2323;">func</span>(nj):
    nj = np.array(nj)
    Enj = np.sum(nj);
    Gj =  Gjo / (R * T) + np.log(nj / Enj * P / Po)
    <span style="color: #8b0000;">return</span> np.dot(nj, Gj)
</pre>
</div>

<p>
We impose the constraint that all atoms are conserved from the initial conditions to the equilibrium distribution of species. These constraints are in the form of \(A_{eq} n = b_{eq}\), where \(n\) is the vector of mole numbers for each species.
</p>

<div class="org-src-container">

<pre class="src src-python">Aeq = np.array([[ 1,    0,    1,    0],  <span style="color: #ff0000; font-weight: bold;"># C balance</span>
                [ 1,    1,    2,    0],  <span style="color: #ff0000; font-weight: bold;"># O balance</span>
                [ 0,    2,    0,    2]]) <span style="color: #ff0000; font-weight: bold;"># H balance</span>

<span style="color: #ff0000; font-weight: bold;"># equimolar feed of 1 mol H2O and 1 mol CO</span>
beq = np.array([1,  <span style="color: #ff0000; font-weight: bold;"># mol C fed</span>
                2,  <span style="color: #ff0000; font-weight: bold;"># mol O fed</span>
                2]) <span style="color: #ff0000; font-weight: bold;"># mol H fed</span>

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">ec1</span>(nj):
    <span style="color: #228b22;">'conservation of atoms constraint'</span>
    <span style="color: #8b0000;">return</span> np.dot(Aeq, nj) - beq
</pre>
</div>

<p>
Now we are ready to solve the problem. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin_slsqp

n0 = [0.5, 0.5, 0.5, 0.5]  <span style="color: #ff0000; font-weight: bold;"># initial guesses</span>
N = fmin_slsqp(func, n0, f_eqcons=ec1)
<span style="color: #8b0000;">print</span> N
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; Optimization terminated successfully.    (Exit mode 0)
            Current function value: -91.204832308
            Iterations: 2
            Function evaluations: 13
            Gradient evaluations: 2
[ 0.45502309  0.45502309  0.54497691  0.54497691]
</pre>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Compute mole fractions and partial pressures</h2>
<div class="outline-text-2" id="text-1">
<p>
The pressures here are in good agreement with the pressures found by other methods. The minor disagreement (in the third or fourth decimal place) is likely due to convergence tolerances in the different algorithms used.
</p>

<div class="org-src-container">

<pre class="src src-python">yj = N / np.sum(N)
Pj = yj * P

<span style="color: #8b0000;">for</span> s, y, p <span style="color: #8b0000;">in</span> <span style="color: #8b0000;">zip</span>(species, yj, Pj):
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'{0:10s}: {1:1.2f} {2:1.2f}'</span>.format(s, y, p)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; ... ... CO        : 0.23 2.28
H2O       : 0.23 2.28
CO2       : 0.27 2.72
H2        : 0.27 2.72
</pre>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Computing equilibrium constants</h2>
<div class="outline-text-2" id="text-2">
<p>
We can compute the equilibrium constant for the reaction \(CO + H_2O \rightleftharpoons CO_2 + H_2\). Compared to the value of K = 1.44 we found at the end of Post 1536 , the agreement is excellent. Note, that to define an equilibrium constant it is necessary to specify a reaction, even though it is not necessary to even consider a reaction to obtain the equilibrium distribution of species!
</p>

<div class="org-src-container">

<pre class="src src-python">nuj = np.array([-1, -1, 1, 1])  <span style="color: #ff0000; font-weight: bold;"># stoichiometric coefficients of the reaction</span>
K = np.prod(yj**nuj)
<span style="color: #8b0000;">print</span> K
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; 1.43446295961
</pre>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/03/01/Gibbs-energy-minimization-and-the-NIST-webbook.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/03/01/Gibbs-energy-minimization-and-the-NIST-webbook#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers/" rel="bookmark" title="Permanent Link to Finding equilibrium composition by direct minimization of Gibbs free energy on mole numbers">Finding equilibrium composition by direct minimization of Gibbs free energy on mole numbers</a></h2>
      <p><small><span class="blog_post_date">Posted March 01, 2013 at 12:27 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/optimization/'>optimization</a></span> | tags: <a href='/blog/tag/thermodynamics/'>thermodynamics</a>
        | <a href="http://jkitchin.github.io/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated March 06, 2013 at 06:24 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
<a href="http://matlab.cheme.cmu.edu/2011/12/25/finding-equilibrium-composition-by-direct-minimization-of-gibbs-free-energy-on-mole-numbers/" >Matlab post</a>
Adapted from problem 4.5 in Cutlip and Shacham
Ethane and steam are fed to a steam cracker at a total pressure of 1 atm and at 1000K at a ratio of 4 mol H2O to 1 mol ethane. Estimate the equilibrium distribution of products (CH4, C2H4, C2H2, CO2, CO, O2, H2, H2O, and C2H6).
</p>

<p>
Solution method: We will construct a Gibbs energy function for the mixture, and obtain the equilibrium composition by minimization of the function subject to elemental mass balance constraints.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

R = 0.00198588 <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">kcal/mol/K</span>
T = 1000 <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">K</span>

species = [<span style="color: #228b22;">'CH4'</span>, <span style="color: #228b22;">'C2H4'</span>, <span style="color: #228b22;">'C2H2'</span>, <span style="color: #228b22;">'CO2'</span>, <span style="color: #228b22;">'CO'</span>, <span style="color: #228b22;">'O2'</span>, <span style="color: #228b22;">'H2'</span>, <span style="color: #228b22;">'H2O'</span>, <span style="color: #228b22;">'C2H6'</span>]

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">$G_^\circ for each species. These are the heats of formation for each</span>
<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">species.</span>
Gjo = np.array([4.61, 28.249, 40.604, -94.61, -47.942, 0, 0, -46.03, 26.13]) <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">kcal/mol</span>
</pre>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The Gibbs energy of a mixture</h2>
<div class="outline-text-2" id="text-1">
<p>
We start with \(G=\sum\limits_j n_j \mu_j\). Recalling that we define \(\mu_j = G_j^\circ + RT \ln a_j\), and in the ideal gas limit, \(a_j = y_j P/P^\circ\), and that \(y_j = \frac{n_j}{\sum n_j}\). Since in this problem, P = 1 atm, this leads to the function \(\frac{G}{RT} = \sum\limits_{j=1}^n n_j\left(\frac{G_j^\circ}{RT} + \ln \frac{n_j}{\sum n_j}\right)\).
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">func</span>(nj):
    nj = np.array(nj)
    Enj = np.sum(nj);
    G = np.sum(nj * (Gjo / R / T + np.log(nj / Enj)))
    <span style="color: #8b0000;">return</span> G
</pre>
</div>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Linear equality constraints for atomic mass conservation</h2>
<div class="outline-text-2" id="text-2">
<p>
The total number of each type of atom must be the same as what entered the reactor. These form equality constraints on the equilibrium composition. We express these constraints as: \(A_{eq} n = b\) where \(n\) is a vector of the moles of each species present in the mixture. CH4 C2H4 C2H2 CO2 CO O2 H2 H2O C2H6
</p>

<div class="org-src-container">

<pre class="src src-python">Aeq = np.array([[0,   0,    0,   2,   1,  2,  0,  1,   0],      <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">oxygen balance</span>
                [4,   4,    2,   0,   0,  0,  2,  2,   6],      <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">hydrogen balance</span>
                [1,   2,    2,   1,   1,  0,  0,  0,   2]])     <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">carbon balance</span>

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">the incoming feed was 4 mol H2O and 1 mol ethane</span>
beq = np.array([4,  <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">moles of oxygen atoms coming in</span>
                14, <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">moles of hydrogen atoms coming in</span>
                2]) <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">moles of carbon atoms coming in</span>

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">ec1</span>(n):
    <span style="color: #228b22;">'equality constraint'</span>
    <span style="color: #8b0000;">return</span> np.dot(Aeq, n) - beq
</pre>
</div>

<p>
Now we solve the problem.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">initial guess suggested in the example</span>
n0 = [1e-3, 1e-3, 1e-3, 0.993, 1.0, 1e-4, 5.992, 1.0, 1e-3] 

<span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin_slsqp

X = fmin_slsqp(func, n0, f_eqcons=ec1, iter=300, acc=1e-12)

<span style="color: #8b0000;">for</span> s,x <span style="color: #8b0000;">in</span> <span style="color: #8b0000;">zip</span>(species, X):
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'{0:10s} {1:1.4g}'</span>.format(s, x)

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">check that constraints were met</span>
<span style="color: #8b0000;">print</span> np.dot(Aeq, X) - beq
<span style="color: #8b0000;">print</span> np.all( np.abs( np.dot(Aeq, X) - beq) &lt; 1e-12)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; Optimization terminated successfully.    (Exit mode 0)
            Current function value: -104.403947663
            Iterations: 217
            Function evaluations: 2937
            Gradient evaluations: 217
&gt;&gt;&gt; ... ... CH4        0.06694
C2H4       8.108e-08
C2H2       5.174e-08
CO2        0.5441
CO         1.389
O2         1.222e-14
H2         5.343
H2O        1.523
C2H6       8.44e-08
... [ -1.66977543e-13   1.77635684e-15   4.44089210e-16]
True
</pre>

<p>
I found it necessary to tighten the accuracy parameter to get pretty good matches to the solutions found in Matlab. It was also necessary to increase the number of iterations. Even still, not all of the numbers match well, especially the very small numbers. You can, however, see that the constraints were satisfied pretty well.
</p>


<p>
Interestingly there is a distribution of products! That is interesting because only steam and ethane enter the reactor, but a small fraction of methane is formed! The main product is hydrogen. The stoichiometry of steam reforming is ideally \(C_2H_6 + 4H_2O \rightarrow 2CO_2 + 7 H2\). Even though nearly all the ethane is consumed, we do not get the full yield of hydrogen. It appears that another equilibrium, one between CO, CO2, H2O and H2, may be limiting that, since the rest of the hydrogen is largely in the water. It is also of great importance that we have not said anything about reactions, i.e. how these products were formed. 
</p>

<p>
The water gas shift reaction is: \(CO + H_2O \rightleftharpoons CO_2 + H_2\). We can compute the Gibbs free energy of the reaction from the heats of formation of each species. Assuming these are the formation energies at 1000K, this is the reaction free energy at 1000K.
</p>

<div class="org-src-container">

<pre class="src src-python">G_wgs = Gjo[3] + Gjo[6] - Gjo[4] - Gjo[7]
<span style="color: #8b0000;">print</span> G_wgs

K = np.exp(-G_wgs / (R*T))
<span style="color: #8b0000;">print</span> K
</pre>
</div>

<pre class="example">
-0.638
&gt;&gt;&gt; &gt;&gt;&gt; 1.37887528109
</pre>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Equilibrium constant based on mole numbers</h2>
<div class="outline-text-2" id="text-3">
<p>
One normally uses activities to define the equilibrium constant. Since there are the same number of moles on each side of the reaction all factors that convert mole numbers to activity, concentration or pressure cancel, so we simply consider the ratio of mole numbers here.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> (X[3] * X[6]) / (X[4] * X[7])
</pre>
</div>

<pre class="example">
1.37450039394
</pre>

<p>
This is close, but not exactly the same as the equilibrium constant computed above. I think they should be exactly the same, and the difference is due to convergence errors in the solution to the problem.
</p>

<p>
Clearly, there is an equilibrium between these species that prevents the complete reaction of steam reforming.
</p>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Summary</h2>
<div class="outline-text-2" id="text-4">
<p>
This is an appealing way to minimize the Gibbs energy of a mixture. No assumptions about reactions are necessary, and the constraints are easy to identify. The Gibbs energy function is especially easy to code.
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Constrained-optimization"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/02/27/Constrained-optimization/" rel="bookmark" title="Permanent Link to Constrained optimization">Constrained optimization</a></h2>
      <p><small><span class="blog_post_date">Posted February 27, 2013 at 02:43 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/optimization/'>optimization</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/02/27/Constrained-optimization#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>


<a href="http://matlab.cheme.cmu.edu/2011/12/24/constrained-optimization/" >Matlab post</a>
</p>

<p>
adapted from <a href="http://en.wikipedia.org/wiki/Lagrange_multipliers" >http://en.wikipedia.org/wiki/Lagrange_multipliers</a>.
</p>

<p>
Suppose we seek to minimize the function \(f(x,y)=x+y\) subject to the constraint that \(x^2 + y^2 = 1\). The function we seek to maximize is an unbounded plane, while the constraint is a unit circle. We could setup a Lagrange multiplier approach to solving this problem, but we will use a constrained optimization approach instead.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin_slsqp

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">objective</span>(X):
    x, y = X
    <span style="color: #8b0000;">return</span> x + y

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">eqc</span>(X):
    <span style="color: #228b22;">'equality constraint'</span>
    x, y = X
    <span style="color: #8b0000;">return</span> x**2 + y**2 - 1.0

X0 = [-1, -1]
X = fmin_slsqp(objective, X0, eqcons=[eqc])
<span style="color: #8b0000;">print</span> X
</pre>
</div>

<pre class="example">
Optimization terminated successfully.    (Exit mode 0)
            Current function value: -1.41421356237
            Iterations: 5
            Function evaluations: 20
            Gradient evaluations: 5
[-0.70710678 -0.70710678]
</pre>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/27/Constrained-optimization.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/02/27/Constrained-optimization#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/optimization/2">Next Page Â»</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
Search
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kitchingroup.cheme.cmu.edu" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
    <li><a href="http://enthought.com">Enthought Python</a></li>
    <li><a href="/pycse">Pycse</a></li>
    <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2014/07/12/Org-mode-is-awesome/">Org-mode is awesome</a></li>
      <li><a href="/blog/2014/06/26/Another-parsing-of-links-for-citations-with-pre-and-post-text/">Another parsing of links for citations with pre and post text.</a></li>
      <li><a href="/blog/2014/06/24/Using-org-files-like-el-files/">Using org-files like el-files</a></li>
      <li><a href="/blog/2014/06/08/Better-integration-of-org-mode-and-email/">Better integration of org-mode and email</a></li>
      <li><a href="/blog/2014/06/05/Finding-emails-from-tags-from-org-contacts-database/">Finding emails from tags from org-contacts database</a></li>
    </ul>
  </section>

  <section>
 <h1 class="post_header_gradient theme_font"><a href="http://www.citeulike.org/user/jkitchin" class="external text" title="http://www.citeulike.org/user/jkitchin" rel="nofollow">CiteULike</a> Reading List</h1>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

var d = new Date();
curr_year = d.getFullYear();

$.getJSON('http://www.citeulike.org/json/user/jkitchin/,,?callback=?&per_page=5',
function(data) {
  var items = [];
  year=curr_year
  $.each(data, function(i) {
    year=data[i].published[0];
    var cit='<li id="' + i + '">' + '<a class="pap" href="http://dx.doi.org/'+data[i].doi+'">'+ data[i].title + '</a><br>';
    cit+='</li>';
    items.push( cit )      
  });

  $('<ul/>', {
    'class': 'my-new-list',
    html: items.join('')
  }).appendTo('#papers2');
});
});
</script>

<div id="papers2"></div>

  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
<ul id="my-github-projects">
    <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2014
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



