

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group: org-mode</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Exporting-numbered-citations-in-html-with-unsorted-numbered-bibliography"></div>
      <h2 class="blog_post_title"><a href="/blog/2015/12/03/Exporting-numbered-citations-in-html-with-unsorted-numbered-bibliography/" rel="bookmark" title="Permanent Link to Exporting numbered citations in html with unsorted numbered bibliography">Exporting numbered citations in html with unsorted numbered bibliography</a></h2>
      <p><small><span class="blog_post_date">Posted December 03, 2015 at 03:53 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
      <p><small><span class="blog_post_date">Updated December 03, 2015 at 04:49 PM</span></small>
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
In this <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/05/17/Exporting-citations-in-html/">post</a> we illustrated a simple export of org-ref citations to html. This was a simple export that simply replaced each citation with a hyperlink as defined in the export function for each type of link. Today we look at formatting in text citations with superscripted numbers, and having an unsorted (i.e. in order of citation) numbered bibliography. This will take one pass to get the citations and calculate replacements and the bibliography, and one pass to replace them and insert the bibliography.
</p>

<p>
This text is just some text with somewhat random citations in it for seeing it work. You might like my two data sharing articles <sup><a href="#kitchin-2015-examp">1</a>,<a href="#kitchin-2015-data-surfac-scien">2</a></sup>. We illustrate the use of org-mode in publishing computational work <sup><a href="#xu-2015-tunin-oxide">3</a>,<a href="#mehta-2014-ident-poten">4</a>,<a href="#curnan-2014-effec-concen">5</a></sup>, experimental <sup><a href="#hallenbeck-2013-effec-o2">6</a></sup>and mixed computational and experimental work <sup><a href="#miller-2014-simul-temper">7</a>,<a href="#boes-2015-estim-bulk">8</a></sup>. This example will correctly number multiple references to a citation, e.g.  <sup><a href="#kitchin-2015-examp">1</a></sup>and <sup><a href="#kitchin-2015-data-surfac-scien">2</a></sup>.
</p>

<p>
This post is somewhat long, and the way I worked it out is at the end (<a href="#sec-2">Long appendix illustrating how we got the code to work</a>). The short version is that we do some preprocessing to get the citations in the document, calculate replacement values for them and the bibliography, replace them in the org-buffer <i>before</i> the export in the backend (html) format we want, and then conclude with the export. This is proof of concept work.
</p>

<p>
The main issues you can see are:
</p>
<ol class="org-ol">
<li>Our formatting code is very rudimentary, and relies on reftex. It is not as good as bibtex, or presumably some citation processor. Major improvements would require abandoning the reftex approach to use something that builds up the bibliography entry, allows modification of author names, and accomodates missing information gracefully.
</li>
<li>The bibliography contents reflect the contents of my bibtex file, which is LaTeX compatible. We could clean it up more, by either post-processing to remove some things like escaped &amp;, or by breaking compatibility with LaTeX.
</li>
<li>The intext citations could use some fine tuning on spaces, e.g. to remove trailing spaces after words, or to move superscripts to the right of punctuation, or to adjust spaces after some citations.
</li>
<li>Changing the bibliography style for each entry amounts to changing a variable for the bibliography. We have to modify a function to change the intext citation style, e.g. to brackets, or (author year).
</li>
<li>I stuck with only cite links here, and only articles and books. It would not get a citenum format correct, e.g. it should not be superscripted in this case, or a citeauthor format correct. That would require some code in the replacement section that knows how to replace different types of citations.
</li>
</ol>

<p>
The  org-ref-unsrt-html-processor function could be broken up more, and could take some parameters to fine-tune some of these things, and generalize some things like getting the citation elements for the buffer. Overall, I think this shows that citations in org-mode with org-ref are actually pretty flexible. It is not as good as bibtex/LaTeX, and won't be for an unforseeably long time unless someone really needs high quality citations in a format other than LaTeX. Note for LaTeX export, we don't have to do any preprocessing at all. If you wanted to try Word export, you might make a pandoc processor that replaces everything in pandoc citation syntax, and then use pandoc for the conversion. If you didn't care to use the bibtex database for anything else, you could just use backend specific markup to make it exactly right for your output. I did this in reference <sup><a href="#boes-2015-estim-bulk">8</a></sup>where you can see the chemical formulas are properly subscripted.
</p>

<p>
If you would like to see the bibtex file used for this you can get it here: <a href="/media/numbered.bib">numbered.bib</a>
</p>



<h1>Bibliography</h1><ol><li><a name="kitchin-2015-examp"></a>Kitchin, Examples of Effective Data Sharing in Scientific Publishing, <i>ACS Catalysis</i>, <b>5(6)</b>, 3894-3899 (2015). <a href=" https://doi.org/10.1021/acscatal.5b00538 ">link</a>. <a href="https://doi.org/10.1021/acscatal.5b00538">doi</a>.</li><li><a name="kitchin-2015-data-surfac-scien"></a>John Kitchin, Data Sharing in Surface Science, <i>Surface Science </i>, <b>(0)</b>,  -  (2015). <a href="http://www.sciencedirect.com/science/article/pii/S0039602815001326">link</a>. <a href="https://doi.org/10.1016/j.susc.2015.05.007">doi</a>.</li><li><a name="xu-2015-tunin-oxide"></a>Zhongnan Xu & John R Kitchin, Tuning Oxide Activity Through Modification of the Crystal and  Electronic Structure: From Strain To Potential Polymorphs, <i>Phys. Chem. Chem. Phys.</i>, <b>17()</b>, 28943-28949 (2015). <a href="https://doi.org/10.1039/C5CP04840K">link</a>. <a href="https://doi.org/10.1039/c5cp04840k">doi</a>.</li><li><a name="mehta-2014-ident-poten"></a>Prateek Mehta, Paul Salvador & John Kitchin, Identifying Potential BO2 Oxide Polymorphs for Epitaxial  Growth Candidates, <i>ACS Appl. Mater. Interfaces</i>, <b>6(5)</b>, 3630-3639 (2014). <a href="https://doi.org/10.1021/am4059149">link</a>. <a href="https://doi.org/10.1021/am4059149">doi</a>.</li><li><a name="curnan-2014-effec-concen"></a>Curnan & Kitchin, Effects of Concentration, Crystal Structure, Magnetism, and  Electronic Structure Method on First-Principles Oxygen Vacancy  Formation Energy Trends in Perovskites, <i>The Journal of Physical Chemistry C</i>, <b>118(49)</b>, 28776-28790 (2014). <a href="https://doi.org/10.1021/jp507957n">link</a>. <a href="https://doi.org/10.1021/jp507957n">doi</a>.</li><li><a name="hallenbeck-2013-effec-o2"></a>Hallenbeck & Kitchin, Effects of O2 and SO2 on the Capture Capacity of a  Primary-Amine Based Polymeric CO2 Sorbent, <i>Industrial & Engineering Chemistry Research</i>, <b>52(31)</b>, 10788-10794 (2013). <a href="http://pubs.acs.org/doi/abs/10.1021/ie400582a">link</a>. <a href="https://doi.org/10.1021/ie400582a">doi</a>.</li><li><a name="miller-2014-simul-temper"></a>Spencer Miller, Vladimir Pushkarev, Andrew, Gellman & John Kitchin, Simulating Temperature Programmed Desorption of Oxygen on  Pt(111) Using DFT Derived Coverage Dependent Desorption  Barriers, <i>Topics in Catalysis</i>, <b>57(1-4)</b>, 106-117 (2014). <a href="https://doi.org/10.1007/s11244-013-0166-3">link</a>. <a href="https://doi.org/10.1007/s11244-013-0166-3">doi</a>.</li><li><a name="boes-2015-estim-bulk"></a>Jacob Boes, Gamze Gumuslu, James Miller, Andrew, Gellman & John Kitchin, Estimating Bulk-Composition-Dependent H<sub>2</sub> Adsorption Energies  on Cu<sub>x</sub>Pd<sub>1-x</sub> Alloy (111) Surfaces, <i>ACS Catalysis</i>, <b>5()</b>, 1020-1026 (2015). <a href="https://doi.org/10.1021/cs501585k">link</a>. <a href="https://doi.org/10.1021/cs501585k">doi</a>.</li></ol>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The working code</h2>
<div class="outline-text-2" id="text-1">
<p>
Here is a function to process the org file prior parsing during the export process. This function goes into org-export-before-parsing-hook, and takes one argument, the backend. We simply replace all the citation links with formatted HTML snippets or blocks. If the snippets get longer than a line, it will break.
</p>

<p>
We use org-ref-reftex-format-citation to generate the bibliography, which uses reftex to format a string with escape characters in it.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> org-ref-bibliography-entry-format
      '((<span style="color: #008000;">"article"</span> . <span style="color: #008000;">"&lt;li&gt;&lt;a name=\"\%k\"&gt;&lt;/a&gt;%a, %t, &lt;i&gt;%j&lt;/i&gt;, &lt;b&gt;%v(%n)&lt;/b&gt;, %p (%y). &lt;a href=\"%U\"&gt;link&lt;/a&gt;. &lt;a href=\"https://doi.org/%D\"&gt;doi&lt;/a&gt;.&lt;/li&gt;"</span>)
        (<span style="color: #008000;">"book"</span> . <span style="color: #008000;">"&lt;li&gt;&lt;a name=\"\%k\"&gt;&lt;/a&gt;%a, %t, %u (%y).&lt;/li&gt;"</span>)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-ref-unsrt-latex-processor</span> () nil)
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-ref-unsrt-html-processor</span> ()
  <span style="color: #036A07;">"Citation processor function for the unsrt style with html output."</span>
  (<span style="color: #0000FF;">let</span> (links
        unique-keys numbered-keys
        replacements
        bibliography-link
        bibliographystyle-link
        bibliography)
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">step 1 - get the citation links</span>
    (<span style="color: #0000FF;">setq</span> links (<span style="color: #0000FF;">loop</span> for link in (org-element-map
                                      (org-element-parse-buffer) 'link 'identity)
                      if (-contains?
                          org-ref-cite-types
                          (org-element-property <span style="color: #006FE0;">:type</span> link))
                      collect link))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">list of unique numbered keys. '((key number))</span>
    (<span style="color: #0000FF;">setq</span> unique-keys (<span style="color: #0000FF;">loop</span> for i from 1
                            for key in (org-ref-get-bibtex-keys)
                            collect (list key (number-to-string i))))


    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(start end replacement-text)</span>
    (<span style="color: #0000FF;">setq</span> replacements
          (<span style="color: #0000FF;">loop</span> for link in links
                collect
                (<span style="color: #0000FF;">let</span> ((path (org-element-property <span style="color: #006FE0;">:path</span> link)))
                  (<span style="color: #0000FF;">loop</span> for (key number) in unique-keys
                        do
                        (<span style="color: #0000FF;">setq</span>
                         path
                         (replace-regexp-in-string
                          key (format <span style="color: #008000;">"&lt;a href=\"#%s\"&gt;%s&lt;/a&gt;"</span> key number)
                          path)))
                  (list (org-element-property <span style="color: #006FE0;">:begin</span> link)
                        (org-element-property <span style="color: #006FE0;">:end</span> link)
                        (format <span style="color: #008000;">"@@html:&lt;sup&gt;%s&lt;/sup&gt;@@"</span> path)))))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">construct the bibliography string</span>
    (<span style="color: #0000FF;">setq</span> bibliography
          (concat <span style="color: #008000;">"#+begin_html</span>
<span style="color: #008000;">&lt;h1&gt;Bibliography&lt;/h1&gt;&lt;ol&gt;"</span>
                  (mapconcat
                   'identity
                   (<span style="color: #0000FF;">loop</span> for (key number) in unique-keys
                         collect
                         (<span style="color: #0000FF;">let*</span> ((result (org-ref-get-bibtex-key-and-file key))
                                (bibfile (cdr result))
                                (entry (<span style="color: #0000FF;">save-excursion</span>
                                         (<span style="color: #0000FF;">with-temp-buffer</span>
                                           (insert-file-contents bibfile)
                                           (bibtex-set-dialect
                                            (parsebib-find-bibtex-dialect) t)
                                           (bibtex-search-entry key)
                                           (bibtex-parse-entry t)))))
                           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">remove escaped &amp; in the strings</span>
                           (replace-regexp-in-string <span style="color: #008000;">"\\\\&amp;"</span> <span style="color: #008000;">"&amp;"</span>
                                           (org-ref-reftex-format-citation
                                            entry
                                            (cdr (assoc (cdr (assoc <span style="color: #008000;">"=type="</span> entry))
                                                        org-ref-bibliography-entry-format))))))
                   <span style="color: #008000;">""</span>)
                  <span style="color: #008000;">"&lt;/ol&gt;</span>
<span style="color: #008000;">#+end_html"</span>))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now, we need to replace each citation. We do that in reverse order so the</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">positions do not change.</span>
    (<span style="color: #0000FF;">loop</span> for (start end replacement) in (reverse replacements)
          do
          (<span style="color: #0000FF;">setf</span> (buffer-substring start end) replacement))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Eliminate bibliography style links</span>
    (<span style="color: #0000FF;">loop</span> for link in (org-element-map
                          (org-element-parse-buffer) 'link 'identity)
          if (string= <span style="color: #008000;">"bibliographystyle"</span>
                      (org-element-property <span style="color: #006FE0;">:type</span> link))
          do
          (<span style="color: #0000FF;">setf</span> (buffer-substring (org-element-property <span style="color: #006FE0;">:begin</span> link)
                                  (org-element-property <span style="color: #006FE0;">:end</span> link))
                <span style="color: #008000;">""</span>))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">replace the bibliography link with the bibliography text</span>
    (<span style="color: #0000FF;">setq</span> bibliography-link (<span style="color: #0000FF;">loop</span> for link in (org-element-map
                                                  (org-element-parse-buffer) 'link 'identity)
                                  if (string= <span style="color: #008000;">"bibliography"</span>
                                              (org-element-property <span style="color: #006FE0;">:type</span> link))
                                  collect link))
    (<span style="color: #0000FF;">if</span> (&gt; (length bibliography-link) 1)
        (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Only one bibliography link allowed"</span>))

    (<span style="color: #0000FF;">setq</span> bibliography-link (car bibliography-link))
    (<span style="color: #0000FF;">setf</span> (buffer-substring (org-element-property <span style="color: #006FE0;">:begin</span> bibliography-link)
                            (org-element-property <span style="color: #006FE0;">:end</span> bibliography-link))
          bibliography)))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-ref-citation-processor</span> (backend)
  <span style="color: #036A07;">"Figure out what to call and call it"</span>
  (<span style="color: #0000FF;">let</span> (bibliographystyle)
    (<span style="color: #0000FF;">setq</span>
     bibliographystyle
     (org-element-property
      <span style="color: #006FE0;">:path</span> (car
             (<span style="color: #0000FF;">loop</span> for link in
                   (org-element-map
                       (org-element-parse-buffer) 'link 'identity)
                   if (string= <span style="color: #008000;">"bibliographystyle"</span>
                               (org-element-property <span style="color: #006FE0;">:type</span> link))
                   collect link))))
    (funcall (intern (format <span style="color: #008000;">"org-ref-%s-%s-processor"</span> bibliographystyle backend)))))

(add-hook 'org-export-before-parsing-hook 'org-ref-citation-processor)

(browse-url (org-html-export-to-html))
</pre>
</div>

<pre class="example">
#&lt;process open ./blog.html&gt;
</pre>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a id="ID-1D63E1FB-55CD-48B7-B5E1-D0AC5E4D989B" name="ID-1D63E1FB-55CD-48B7-B5E1-D0AC5E4D989B"></a><span class="section-number-2">2</span> Long appendix illustrating how we got the code to work</h2>
<div class="outline-text-2" id="text-2">
<p>
The first thing we need is a list of all the citation links, in the order cited. Here they are.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(mapcar
 (<span style="color: #0000FF;">lambda</span> (link) (org-element-property <span style="color: #006FE0;">:path</span> link))
 (<span style="color: #0000FF;">loop</span> for link in (org-element-map (org-element-parse-buffer) 'link 'identity)
       if (-contains? org-ref-cite-types (org-element-property <span style="color: #006FE0;">:type</span> link))
       collect link))
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">kitchin-2015-examp,kitchin-2015-data-surfac-scien</td>
<td class="left">xu-2015-tunin-oxide,mehta-2014-ident-poten,curnan-2014-effec-concen</td>
<td class="left">hallenbeck-2013-effec-o2</td>
<td class="left">miller-2014-simul-temper,boes-2015-estim-bulk</td>
<td class="left">kitchin-2015-examp</td>
<td class="left">kitchin-2015-data-surfac-scien</td>
<td class="left">boes-2015-estim-bulk</td>
</tr>
</tbody>
</table>

<p>
Now, we need to compute replacements for each citation link, and construct the bibliography. We will make a numbered, unsorted bibliography, and we want to replace each citation with the corresponding numbers, hyperlinked to the entry.
</p>

<p>
We start with a list of the keys in the order cited, and a number we will use for each one.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">loop</span> for i from 1
      for key in (org-ref-get-bibtex-keys)
      collect (list key i))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="left">kitchin-2015-examp</td>
<td class="right">1</td>
</tr>

<tr>
<td class="left">kitchin-2015-data-surfac-scien</td>
<td class="right">2</td>
</tr>

<tr>
<td class="left">xu-2015-tunin-oxide</td>
<td class="right">3</td>
</tr>

<tr>
<td class="left">mehta-2014-ident-poten</td>
<td class="right">4</td>
</tr>

<tr>
<td class="left">curnan-2014-effec-concen</td>
<td class="right">5</td>
</tr>

<tr>
<td class="left">hallenbeck-2013-effec-o2</td>
<td class="right">6</td>
</tr>

<tr>
<td class="left">miller-2014-simul-temper</td>
<td class="right">7</td>
</tr>

<tr>
<td class="left">boes-2015-estim-bulk</td>
<td class="right">8</td>
</tr>
</tbody>
</table>

<p>
Now, we need to compute replacements for each cite link. This will be replacing each key with the number above. We will return a list of ((start end) . "replacement text") that we can use to replace each link. For fun, we make these superscripted html.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> ((links (<span style="color: #0000FF;">loop</span> for link in (org-element-map (org-element-parse-buffer) 'link 'identity)
                   if (-contains? org-ref-cite-types (org-element-property <span style="color: #006FE0;">:type</span> link))
                   collect link))
      (replacements (<span style="color: #0000FF;">loop</span> for i from 1
                          for key in (org-ref-get-bibtex-keys)
                          collect (list key (number-to-string i)))))
  (<span style="color: #0000FF;">loop</span> for link in links
        collect (<span style="color: #0000FF;">let</span> ((path (org-element-property <span style="color: #006FE0;">:path</span> link)))
                  (<span style="color: #0000FF;">dolist</span> (repl replacements)
                    (<span style="color: #0000FF;">setq</span> path (replace-regexp-in-string (car repl) (nth 1 repl) path)))
                  (list (org-element-property <span style="color: #006FE0;">:begin</span> link)
                        (org-element-property <span style="color: #006FE0;">:end</span> link)
                        (format <span style="color: #008000;">"&lt;sup&gt;%s&lt;/sup&gt;"</span> path)))))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="right">950</td>
<td class="right">1004</td>
<td class="left">&lt;sup&gt;1,2&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">1073</td>
<td class="right">1145</td>
<td class="left">&lt;sup&gt;3,4,5&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">1160</td>
<td class="right">1190</td>
<td class="left">&lt;sup&gt;6&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">1236</td>
<td class="right">1286</td>
<td class="left">&lt;sup&gt;7,8&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">1364</td>
<td class="right">1388</td>
<td class="left">&lt;sup&gt;1&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">1392</td>
<td class="right">1427</td>
<td class="left">&lt;sup&gt;2&lt;/sup&gt;</td>
</tr>

<tr>
<td class="right">4091</td>
<td class="right">4117</td>
<td class="left">&lt;sup&gt;8&lt;/sup&gt;</td>
</tr>
</tbody>
</table>

<p>
We also need to compute the bibliography for each key. We will use org-ref-reftex-format-citation to do this. For that we need the parsed bibtex entries, and a format string. org-ref provides most of this.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> org-ref-bibliography-entry-format
      '((<span style="color: #008000;">"article"</span> . <span style="color: #008000;">"&lt;li&gt;%a, %t, &lt;i&gt;%j&lt;/i&gt;, &lt;b&gt;%v(%n)&lt;/b&gt;, %p (%y). &lt;a href=\"%U\"&gt;link&lt;/a&gt;. &lt;a href=\"https://doi.org/%D\"&gt;doi&lt;/a&gt;.&lt;/li&gt;"</span>)
        (<span style="color: #008000;">"book"</span> . <span style="color: #008000;">"&lt;li&gt;%a, %t, %u (%y).&lt;/li&gt;"</span>)))

(concat <span style="color: #008000;">"&lt;h1&gt;Bibliography&lt;/h1&gt;&lt;br&gt;&lt;ol&gt;"</span>
        (mapconcat
         'identity
         (<span style="color: #0000FF;">loop</span> for key in (org-ref-get-bibtex-keys)
               collect
               (<span style="color: #0000FF;">let*</span> ((result (org-ref-get-bibtex-key-and-file key))
                      (bibfile (cdr result))
                      (entry (<span style="color: #0000FF;">save-excursion</span>
                               (<span style="color: #0000FF;">with-temp-buffer</span>
                                 (insert-file-contents bibfile)
                                 (bibtex-set-dialect (parsebib-find-bibtex-dialect) t)
                                 (bibtex-search-entry key)
                                 (bibtex-parse-entry)))))
                 (org-ref-reftex-format-citation
                  entry
                  (cdr (assoc (cdr (assoc <span style="color: #008000;">"=type="</span> entry))
                              org-ref-bibliography-entry-format)))))
         <span style="color: #008000;">""</span>)
        <span style="color: #008000;">"&lt;/ol&gt;"</span>)
</pre>
</div>

<h1>Bibliography</h1><br><ol><li>Kitchin, Examples of Effective Data Sharing in Scientific Publishing, <i>{ACS Catalysis}</i>, <b>5(6)</b>, 3894-3899 (2015). <a href=" https://doi.org/10.1021/acscatal.5b00538 ">link</a>. <a href="https://doi.org/10.1021/acscatal.5b00538">doi</a>.</li><li>"John Kitchin", Data Sharing in Surface Science, <i>"Surface Science "</i>, <b>(0)</b>,  -  (2015). <a href="http://www.sciencedirect.com/science/article/pii/S0039602815001326">link</a>. <a href="https://doi.org/10.1016/j.susc.2015.05.007">doi</a>.</li><li>Zhongnan Xu \& John R Kitchin, Tuning Oxide Activity Through Modification of the Crystal and  Electronic Structure: From Strain To Potential Polymorphs, <i>{Phys. Chem. Chem. Phys.}</i>, <b>17()</b>, 28943-28949 (2015). <a href="https://doi.org/10.1039/C5CP04840K">link</a>. <a href="https://doi.org/10.1039/c5cp04840k">doi</a>.</li><li>Prateek Mehta, Paul Salvador \& John Kitchin, Identifying Potential BO2 Oxide Polymorphs for Epitaxial  Growth Candidates, <i>{ACS Appl. Mater. Interfaces}</i>, <b>6(5)</b>, 3630-3639 (2014). <a href="https://doi.org/10.1021/am4059149">link</a>. <a href="https://doi.org/10.1021/am4059149">doi</a>.</li><li>Curnan \& Kitchin, Effects of Concentration, Crystal Structure, Magnetism, and  Electronic Structure Method on First-Principles Oxygen Vacancy  Formation Energy Trends in Perovskites, <i>{The Journal of Physical Chemistry C}</i>, <b>118(49)</b>, 28776-28790 (2014). <a href="https://doi.org/10.1021/jp507957n">link</a>. <a href="https://doi.org/10.1021/jp507957n">doi</a>.</li><li>"Hallenbeck \& Kitchin, Effects of O2 and SO2 on the Capture Capacity of a  Primary-Amine Based Polymeric CO2 Sorbent, <i>"Industrial \& Engineering Chemistry Research"</i>, <b>52(31)</b>, 10788-10794 (2013). <a href="http://pubs.acs.org/doi/abs/10.1021/ie400582a">link</a>. <a href="https://doi.org/10.1021/ie400582a">doi</a>.</li><li>Spencer Miller, Vladimir Pushkarev, Andrew, Gellman \& John Kitchin, Simulating Temperature Programmed Desorption of Oxygen on  Pt(111) Using DFT Derived Coverage Dependent Desorption  Barriers, <i>{Topics in Catalysis}</i>, <b>57(1-4)</b>, 106-117 (2014). <a href="https://doi.org/10.1007/s11244-013-0166-3">link</a>. <a href="https://doi.org/10.1007/s11244-013-0166-3">doi</a>.</li><li>Jacob Boes, Gamze Gumuslu, James Miller, Andrew, Gellman \& John Kitchin, Estimating Bulk-Composition-Dependent H<sub>2</sub> Adsorption Energies  on Cu<sub>x</sub>Pd<sub>1-x</sub> Alloy (111) Surfaces, <i>{ACS Catalysis}</i>, <b>5()</b>, 1020-1026 (2015). <a href="https://doi.org/10.1021/cs501585k">link</a>. <a href="https://doi.org/10.1021/cs501585k">doi</a>.</li></ol>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/12/03/Exporting-numbered-citations-in-html-with-unsorted-numbered-bibliography.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>


    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2015/12/03/Exporting-numbered-citations-in-html-with-unsorted-numbered-bibliography">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Another-parsing-of-links-for-citations-with-pre-and-post-text"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/06/26/Another-parsing-of-links-for-citations-with-pre-and-post-text/" rel="bookmark" title="Permanent Link to Another parsing of links for citations with pre and post text.">Another parsing of links for citations with pre and post text.</a></h2>
      <p><small><span class="blog_post_date">Posted June 26, 2014 at 08:16 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/org-ref/'>org-ref</a>, <a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
Some LaTeX citations look like \cite[pretext][post text]{key}. Here I explore parsing a link like <a href="#(pre text)(post text)key">(pre text)(post text)key</a>. Note you cannot use [] inside the link, as it breaks the link syntax. Also, these links must be wrapped in <code>[[]]</code> because of the parentheses and spaces in the parentheses. This is a very different approach than used <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/05/19/Exporting-citations-with-biblatex/">here</a> which used the description of the link to define the pre and post text. The disadvantage of that approach is that the key is hidden, whereas in this approach it is not; you can see the key and pre/post text.
</p>

<p>
The basic strategy will be to use a regexp to parse the link path. The regexp below is pretty hairy, but basically it looks for optional text in () and uses numbered groups to store what is found. Then, we use what we found to construct the LaTeX syntax. We redefine the function in org-ref that gets the key for clicking, and we redefine the cite format function. The result is that we retain the click functionality that shows us what the key refers to.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(defun org-ref-parse-key (s)
  "return pretext, posttext and bibtex key from a string like \"(pre text)(post text)bibtexkey\""
  (string-match "\\(?1:(\\(?2:[^)]*\\))\\)?\\(?3:(\\(?4:[^]]*\\))\\)?\\(?5:.*\\)" s)
  ;; return pretext postext key
  (list (match-string 2 s) (match-string 4 s) (match-string 5 s)))

(defun org-ref-get-bibtex-key-and-file (&amp;optional key)
  "returns the bibtex key and file that it is in. If no key is provided, get one under point"
 (interactive)
 (let ((org-ref-bibliography-files (org-ref-find-bibliography))
       (file))
   (unless key
     ;; get the key
     (setq key (nth 2 (org-ref-parse-key (org-ref-get-bibtex-key-under-cursor)))))
   (setq file     (catch 'result
		    (loop for file in org-ref-bibliography-files do
			  (if (org-ref-key-in-file-p key (file-truename file)) 
			      (throw 'result file)))))
   (cons key file)))

(defun org-ref-format-cite (keyword desc format)
   (cond
    ((eq format 'latex)
     (let* ((results (org-ref-parse-key keyword))
	    (pretext (nth 0 results))
	    (posttext (nth 1 results))
	    (key (nth 2 results)))
       (concat "\\cite" 
	       (when pretext (format "[%s]" pretext))
	       (when posttext (format "[%s]" posttext))
	       (format "{%s}" key))))))
</pre>
</div>

<pre class="example">
org-ref-format-cite
</pre>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-ref-format-cite "(pre text)(post text)key" nil 'latex)
</pre>
</div>

<pre class="example">
\cite[pre text][post text]{key}
</pre>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-ref-format-cite "(pre text)key" nil 'latex)
</pre>
</div>

<pre class="example">
\cite[pre text]{key}
</pre>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-ref-format-cite "key" nil 'latex)
</pre>
</div>

<pre class="example">
\cite{key}
</pre>

<p>
It looks like they all work! Let us test the links: <a href="#mehta-2014-ident-poten">mehta-2014-ident-poten</a>, <a href="#(pre text)mehta-2014-ident-poten">(pre text)mehta-2014-ident-poten</a> and <a href="#(pre text)(post text)biskup-2014-insul-ferrom-films">(pre text)(post text)biskup-2014-insul-ferrom-films</a>. a multiple citation <a href="#mehta-2014-ident-poten">mehta-2014-ident-poten</a>,<a href="#thompson-2014-co2-react">thompson-2014-co2-react</a>,<a href="#calle-vallejo-2013-number">calle-vallejo-2013-number</a>.
</p>

<p>
This seems to work from an export point of view. You can not mix multiple citations with this syntax, and I did not define the html export above. Otherwise, it looks like this might be a reasonable addition to org-ref.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/06/26/Another-parsing-of-links-for-citations-with-pre-and-post-text..org">org-mode source</a><p><p>Org-mode version = 8.2.6</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2014/06/26/Another-parsing-of-links-for-citations-with-pre-and-post-text">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Using-org-files-like-el-files"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/06/24/Using-org-files-like-el-files/" rel="bookmark" title="Permanent Link to Using org-files like el-files">Using org-files like el-files</a></h2>
      <p><small><span class="blog_post_date">Posted June 24, 2014 at 09:32 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
      <p><small><span class="blog_post_date">Updated June 24, 2014 at 09:34 PM</span></small>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I wrote some emacs-lisp code in org-mode, and load them with org-babel-load-file. I thought it would be nice if there was load path for org-files, similar to the one for lisp files. Here I document what it might look like.
</p>

<p>
We need a load path to search for the org-file.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq org-load-path '("~/Dropbox/kitchingroup/jmax/"))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">~/Dropbox/kitchingroup/jmax/</td>
</tr>
</tbody>
</table>

<p>
Next, we need the function to do the loading. We need to find the org-file, and then load it.
</p>



<div class="org-src-container">

<pre class="src src-emacs-lisp">(defun org-require (orgfile)
  "orgfile is a symbol to be loaded"
  (let ((org-file (concat (symbol-name orgfile) ".org"))
	(path))

  ;; find the org-file
  (catch 'result
    (loop for dir in org-load-path do
	  (when (file-exists-p
		 (setq path
		       (concat
			(directory-file-name dir)
			"/"
			org-file)))
	    (throw 'result path))))
  (org-babel-load-file path)))


(org-require 'org-ref)
</pre>
</div>

<pre class="example">
Loaded ~/Dropbox/kitchingroup/jmax/org-ref.el
</pre>

<p>
That looks pretty simple. You do need write access to the location where the org-file is though. Let us look at a version that copies the file to a temporary directory. For some reason, I am not able to use org-babel-load-file with this. But, it does look like I can tangle the file, and assuming (big assumption) that the file tangles to a regularly named .el file, this seems to work too.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(defun org-require (orgfile)
  "orgfile is a symbol to be loaded"
  (let ((org-file (concat (symbol-name orgfile) ".org"))
        (el-file (concat (symbol-name orgfile) ".el"))
	(path))

  ;; find the org-file
  (catch 'result
    (loop for dir in org-load-path do
	  (when (file-exists-p
		 (setq path
		       (concat
			(directory-file-name dir)
			"/"
			org-file)))
	    (throw 'result path))))
  (copy-file path temporary-file-directory t)

  (org-babel-tangle-file (concat temporary-file-directory (file-name-nondirectory path)))
  (load-file (concat temporary-file-directory el-file))
))

(org-require 'org-ref)
</pre>
</div>

<pre class="example">
t
</pre>

<p>
This actually seems pretty reasonable. I have not thought about complications but for simple cases, e.g. single org-file, it looks ok.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/06/24/Using-org-files-like-el-files.org">org-mode source</a><p><p>Org-mode version = 8.2.6</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2014/06/24/Using-org-files-like-el-files">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Better-integration-of-org-mode-and-email"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/06/08/Better-integration-of-org-mode-and-email/" rel="bookmark" title="Permanent Link to Better integration of org-mode and email">Better integration of org-mode and email</a></h2>
      <p><small><span class="blog_post_date">Posted June 08, 2014 at 08:57 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/email/'>email</a>, <a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I like to email org-mode headings and content to people. It would be nice to have some records of when a heading was sent, and to whom. We store this information in a heading. It is pretty easy to write a simple function that emails a selected region.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(defun email-region (start end)
  "Send region as the body of an email."
  (interactive "r")
  (let ((content (buffer-substring start end)))
    (compose-mail)
    (message-goto-body)
    (insert content)
    (message-goto-to)))
</pre>
</div>

<p>
that function is not glamorous, and you still have to fill in the email fields, and unless you use gnus and org-contacts, the only record keeping is through the email provider. 
</p>

<p>
What I would like is to send a whole heading in an email. The headline should be the subject, and if there are TO, CC or BCC properties, those should be used. If there is <i>no TO</i>, then I want to grab the TO from the email after you enter it and store it as a property. You should be able to set OTHER-HEADERS as a property (this is just for fun. There is no practical reason for this yet). After you send the email, it should record in the heading when it was sent.
</p>

<p>
It turned out that is a relatively tall order. While it is easy to setup the email if you have everything in place, it is tricky to get the information on TO and the time sent <i>after</i> the email is sent. Past lispers had a lot of ideas to make this possible, and a day of digging got me to the answer. You can specify some "action" functions that get called at various times, e.g. after sending, and a return action when the compose window is done. Unfortunately, I could not figure out any way to do things except to communicate through some global variables.
</p>

<p>
So here is the code that lets me send org-headings, with the TO, CC, BCC properties, and that records when I sent the email after it is sent.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(defvar *email-heading-point* nil
  "global variable to store point in for returning")

(defvar *email-to-addresses* nil
  "global variable to store to address in email")

(defun email-heading-return ()
  "after returning from compose do this"
  (switch-to-buffer (marker-buffer  *email-heading-point*))
  (goto-char (marker-position  *email-heading-point*))
  (setq *email-heading-point* nil)
  (org-set-property "SENT-ON" (current-time-string))
  ;; reset this incase you added new ones
  (org-set-property "TO" *email-to-addresses*)
  )

(defun email-send-action ()
  "send action for compose-mail"
  (setq *email-to-addresses* (mail-fetch-field "To")))

(defun email-heading ()
  "Send the current org-mode heading as the body of an email, with headline as the subject.

use these properties
TO
OTHER-HEADERS is an alist specifying additional
header fields.  Elements look like (HEADER . VALUE) where both
HEADER and VALUE are strings.

save when it was sent as s SENT property. this is overwritten on
subsequent sends. could save them all in a logbook?
"
  (interactive)
  ; store location.
  (setq *email-heading-point* (set-marker (make-marker) (point)))
  (org-mark-subtree)
  (let ((content (buffer-substring (point) (mark)))
	(TO (org-entry-get (point) "TO" t))
	(CC (org-entry-get (point) "CC" t))
	(BCC (org-entry-get (point) "BCC" t))
	(SUBJECT (nth 4 (org-heading-components)))
	(OTHER-HEADERS (eval (org-entry-get (point) "OTHER-HEADERS")))
	(continue nil)
	(switch-function nil)
	(yank-action nil)
	(send-actions '((email-send-action . nil)))
	(return-action '(email-heading-return)))
    
    (compose-mail TO SUBJECT OTHER-HEADERS continue switch-function yank-action send-actions return-action)
    (message-goto-body)
    (insert content)
    (when CC
      (message-goto-cc)
      (insert CC))
    (when BCC
      (message-goto-bcc)
      (insert BCC))
    (if TO
	(message-goto-body)
      (message-goto-to))       
    ))
</pre>
</div>

<p>
This works pretty well for me. Since I normally use this to send tasks to people, it keeps the task organized where I want it, and I can embed an org-id in the email so if the person replies to it telling me the task is done, I can easily navigate to the task to mark it off. Pretty handy.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/06/08/Better-integration-of-org-mode-and-email.org">org-mode source</a><p><p>Org-mode version = 8.2.6</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2014/06/08/Better-integration-of-org-mode-and-email">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Finding-emails-from-tags-from-org-contacts-database"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/06/05/Finding-emails-from-tags-from-org-contacts-database/" rel="bookmark" title="Permanent Link to Finding emails from tags from org-contacts database">Finding emails from tags from org-contacts database</a></h2>
      <p><small><span class="blog_post_date">Posted June 05, 2014 at 02:42 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      




<p>
Org-mode has a contacts manager called org-contacts. If you set it up, you can use it to insert email addresses using a tag in message-mode. Out of the box though, it only works on one tag. You cannot do something like +group-phd to get entries tagged group but not tagged phd. Here we develop a function to do that for us. 
</p>

<p>
We could use the org-files and map the headings to do this, but org-contacts has already done this and has a database we can use instead. We get the database from org-contacts-filter. Here is the first entry.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(car (org-contacts-filter))
</pre>
</div>

<p>
(Chris Jones #&lt;marker at 1 in contacts.org&gt; ((FILE . c:/Users/jkitchin/Dropbox/org-mode/contacts.org) (TAGS . :co2:) (ALLTAGS . :co2:) (BLOCKED . ) (COMPANY . Georgia Tech, Chemical Engineering) (EMAIL . Christopher.Jones@chbe.gatech.edu) (CATEGORY . contacts)))
</p>

<p>
It looks like we have (name marker (cons cells)) for each entry. We can get the tags associated with that entry like this.
</p>

<p>
We can get the tags for an entry with this code:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(let ((entry (car (org-contacts-filter))))
  (cdr (assoc "TAGS" (nth 2 entry))))
</pre>
</div>

<pre class="example">
:co2:
</pre>

<p>
We will use some code for org tags. Notably, from a tags expression, we can automatically generate code that tells us if we have a match. Here we generate the code to test for a match on "+co2-group".
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(let ((todo-only nil))
  (cdr (org-make-tags-matcher "+co2-group")))
</pre>
</div>

<p>
(and (progn (setq org-cached-props nil) (and (not (member group tags-list)) (member co2 tags-list))) t)
</p>

<p>
Note we will have to bind tags-list before we eval this.
</p>

<p>
So to use it, we need to split the tags from an org-contacts entry into a list of strings. It appears each entry just has the tag string, so we split the substring (skipping first and last characters) by ":" to get the list. We do that here, and test if a list of tags containing "co2" is matched by the expression "co2-junior".
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(let* ((tags-list (split-string (substring ":co2:" 1 -1) ":"))
       (todo-only nil))
  (eval (cdr (org-make-tags-matcher "co2-junior"))))
</pre>
</div>

<pre class="example">
t
</pre>

<p>
It is. So, now we just need to loop through the database, and collect entries that match.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(defun insert-emails-from-tags (tag-expression)
  "insert emails from org-contacts that match the tags expression. For example:
group-phd will match entries tagged with group but not with phd."
  (interactive "sTags: ")
  (insert
   (mapconcat 'identity
	      (loop for contact in (org-contacts-filter)
		    for contact-name = (car contact)
		    for email = (org-contacts-strip-link (car (org-contacts-split-property
							       (or
								(cdr (assoc-string org-contacts-email-property
										   (caddr contact)))
								""))))
		    for tags = (cdr (assoc "TAGS" (nth 2 contact)))
		    for tags-list = (if tags
					(split-string (substring (cdr (assoc "TAGS" (nth 2 contact))) 1 -1) ":")
				      '())
		    if (let ((todo-only nil))
			 (eval (cdr (org-make-tags-matcher tag-expression))))
		    
		    collect (org-contacts-format-email contact-name email))
	      ",")))
</pre>
</div>

<p>
This is not quite completion in message-mode, but it is good enough. You put your cursor in the To field, and run that command, enter the tag expression, and you will get your emails!
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/06/05/Finding-emails-from-tags-from-org-contacts-database.org">org-mode source</a><p><p>Org-mode version = 8.2.6</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2014/06/05/Finding-emails-from-tags-from-org-contacts-database">Discuss on Twitter</a>

  <hr class="interblog" />
 <a href="/blog/category/org-mode/2">Next Page </a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2021/06/21/New-publication-Machine-learning-accelerated-geometry-optimization-in-molecular-simulation/">New publication "Machine-learning accelerated geometry optimization in molecular simulation"</a></li>
      <li><a href="/blog/2021/03/07/New-publication-Semi-grand-Canonical-Monte-Carlo-Simulation-of-the-Acrolein-induced-Surface-Segregation-and-Aggregation-of-AgPd-with-Machine-Learning-Surrogate-Models/">New publication - Semi-grand Canonical Monte Carlo Simulation of the Acrolein induced Surface Segregation and Aggregation of AgPd with Machine Learning Surrogate Models</a></li>
      <li><a href="/blog/2020/07/09/New-publication-SingleNN-Modified-Behler-Parrinello-Neural-Network-with-Shared-Weights-for-Atomistic-Simulations-with-Transferability/">New publication SingleNN - Modified BehlerParrinello Neural Network with Shared Weights for Atomistic Simulations with Transferability</a></li>
      <li><a href="/blog/2020/03/10/New-publication-Parallelized-Screening-of-Characterized-and-DFT-Modelled-Bimetallic-Colloidal-Co-Catalysts-for-Photocatalytic-Hydrogen-Evolution/">New publication - Parallelized Screening of Characterized and DFT-Modelled Bimetallic Colloidal Co-Catalysts for Photocatalytic Hydrogen Evolution</a></li>
      <li><a href="/blog/2019/10/02/Using-autograd-to-plot-implicit-functions/">Using autograd to plot implicit functions</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2021
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



