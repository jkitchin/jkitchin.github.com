

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group: ipython</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="An-improvement-for-figures-in-ipython-+-scimax"></div>
      <h2 class="blog_post_title"><a href="/blog/2019/03/12/An-improvement-for-figures-in-ipython-+-scimax/" rel="bookmark" title="Permanent Link to An improvement for figures in ipython + scimax">An improvement for figures in ipython + scimax</a></h2>
      <p><small><span class="blog_post_date">Posted March 12, 2019 at 02:18 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/ipython/'>ipython</a></span> | tags: 
      <p><small><span class="blog_post_date">Updated March 12, 2019 at 03:15 PM</span></small>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
One of the best features of ipython in scimax is automatic inline images that you do not have to name. This has had a downside though, and that is it is not easy to use this <i>and</i> put attributes like names (so you can reference them later) or captions, or if you want a specific filename to get that. No more. Now you can use the <code>:ipyfile</code> header argument to control these. For example, if you use this in the header of the next block, it will save the images into the filenames you specified (in the order they are defined), and add attributes to the output. The syntax is just a list of plists (in elispese).
</p>

<pre class="example">
:ipyfile '((:name "clockwise" :filename "obipy-resources/clockwise.png" :caption "A clockwise spiral.") (:name "counterclockwise" :filename "obipy-resources/counterclockwise.png" :caption "A counterclockwise spiral."))
</pre>

<p>
That allows you to refer to the clockwise one in Figure <a href="#clockwise">clockwise</a> and the counterclockwise in Fig.  <a href="#counterclockwise">counterclockwise</a>. That may be helpful when using Ipython to write papers or for presentations where you might prefer named figures that are easy to find. Enjoy!
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #BA36A5;">t</span> = np.linspace(0, 20 * np.pi, 350)
<span style="color: #BA36A5;">x</span> = np.exp(-0.1 * t) * np.sin(t)
<span style="color: #BA36A5;">y</span> = np.exp(-0.1 * t) * np.cos(t)

plt.plot(x, y)
plt.axis(<span style="color: #008000;">'equal'</span>)

plt.figure()
plt.plot(y, x)

plt.axis(<span style="color: #008000;">'equal'</span>)

<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'Length of t = {}'</span>.<span style="color: #006FE0;">format</span>(<span style="color: #006FE0;">len</span>(t)))
<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'x .dot. y = {}'</span>.<span style="color: #006FE0;">format</span>(x @ y))
</pre>
</div>

<p>
Length of t = 350
x .dot. y = 1.3598389888491538
</p>



<p>
<figure><img src="/media/clockwise.png"><figcaption>A clockwise spiral.</figcaption></figure> 
</p>



<p>
<figure><img src="/media/counterclockwise.png"><figcaption>A counterclockwise spiral.</figcaption></figure> 
</p>
<p>Copyright (C) 2019 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2019/03/12/An-improvement-for-figures-in-ipython-+-scimax.org">org-mode source</a></p>
<p>Org-mode version = 9.2.1</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2019/03/12/An-improvement-for-figures-in-ipython-+-scimax">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Org-mode-and-ipython-enhancements-in-scimax"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax/" rel="bookmark" title="Permanent Link to Org-mode and ipython enhancements in scimax">Org-mode and ipython enhancements in scimax</a></h2>
      <p><small><span class="blog_post_date">Posted May 26, 2017 at 04:54 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a>, <a href='/blog/category/ipython/'>ipython</a>, <a href='/blog/category/emacs/'>emacs</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org696d7c2">1. Some convenience functions</a></li>
<li><a href="#orgef414e8">2. ob-ipython-inspect works</a></li>
<li><a href="#orgd62ef75">3. Getting selective output from Ipython</a></li>
<li><a href="#org5cac271">4. Where was that error?</a></li>
<li><a href="#org3ebd0a8">5. Asynchronous Ipython</a></li>
</ul>
</div>
</div>
<p>
We have made some improvements to using Ipython in org-mode in the past including:
</p>

<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/29/ob-ipython-and-inline-figures-in-org-mode/">Inline figures</a></li>
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/21/Exporting-org-mode-to-Jupyter-notebooks/">Export to Jupyter notebooks</a></li>
</ol>

<p>
Today I will talk about a few new features and improvements I have introduced to scimax for using org-mode and Ipython together.
</p>

<p>
The video for this post might be more obvious than the post:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/dMira3QsUdg" frameborder="0" allowfullscreen></iframe>

<div id="outline-container-org696d7c2" class="outline-2">
<h2 id="org696d7c2"><span class="section-number-2">1</span> Some convenience functions</h2>
<div class="outline-text-2" id="text-1">
<p>
There are a few nice shortcuts in the Jupyter notebook. Now we have some convenient commands in scimax to mimic those. My favorites are adding cells above or below the current cell. You can insert a new src block above the current one with (M-x <code>org-babel-insert-block</code>). You can use a prefix arg to insert it below the current block.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">code</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">below</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">some code</span>
</pre>
</div>

<p>
I am particularly fond of splitting a large block into two smaller blocks. Use (M-x <code>org-babel-split-src-block</code>) to do that and leave the point in the upper block. Use a prefix arg to leave the point in the lower block.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">lots of code in large block</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Even more code</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The end of the long block</span>
</pre>
</div>

<p>
You can execute all the blocks up to the current point with (M-x <code>org-babel-execute-to-point</code>).
</p>
</div>
</div>

<div id="outline-container-orgef414e8" class="outline-2">
<h2 id="orgef414e8"><span class="section-number-2">2</span> ob-ipython-inspect works</h2>
<div class="outline-text-2" id="text-2">
<p>
In the original ob-ipython I found that ob-ipython-inspect did not work unless you were in special edit mode. That is too inconvenient. I modified a few functions to work directly from the org-buffer. I bind this to M-. in org-mode.
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Compute areas and colors</span>
<span style="color: #BA36A5;">N</span> = 150
<span style="color: #BA36A5;">r</span> = 2 * np.random.rand(N)
<span style="color: #BA36A5;">theta</span> = 2 * np.pi * np.random.rand(N)
<span style="color: #BA36A5;">area</span> = 200 * r**2
<span style="color: #BA36A5;">colors</span> = theta

<span style="color: #BA36A5;">ax</span> = plt.subplot(111, projection=<span style="color: #008000;">'polar'</span>)
<span style="color: #BA36A5;">c</span> = ax.scatter(theta, r, c=colors, s=area, cmap=<span style="color: #008000;">'hsv'</span>, alpha=0.75)
</pre>
</div>

<p>

</p>

<p>
&lt;matplotlib.figure.Figure at 0x114ded710&gt;
<img src="/media/ob-ipython-1758dfdd7a96829c50791c7cc9a39f3a.png"> 
</p>
</div>
</div>



<div id="outline-container-orgd62ef75" class="outline-2">
<h2 id="orgd62ef75"><span class="section-number-2">3</span> Getting selective output from Ipython</h2>
<div class="outline-text-2" id="text-3">
<p>
Out of the box Ipython returns a lot of results. This block, for example returns a plain text, image and latex result as output.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span> sympy <span style="color: #0000FF;">import</span> *
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">commenting out init_printing() results in no output</span>
init_printing()

var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>

</p>

<p>
 2
x  + y
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
We can select which one we want with a new header argument :ob-ipython-results. For this block you can give it the value of text/plain, text/latex or image/png.
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
 2
x  + y
</p>

<p>
Or to get the image:
</p>


<div class="org-src-container">
<pre class="src src-ipython">var(<span style="color: #008000;">'x y'</span>)
x**2 + y
</pre>
</div>

<p>
<img src="/media/ob-ipython-da6fb3a34919a4f694cfaae45b6f0868.png"> 
</p>


<p>
This shows up with <a href="https://emacs.stackexchange.com/questions/33005/python-org-mode-babel-output-column-headers-misaligned/33016#33016">pandas too</a>. This block creates a table of data and then shows the first 5 rows. Ipython returns both plain text and html here.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>

</p>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      10    1  64.311947     0        8  False   False   8.036793
1          1       6    0  82.951484     1       73   True   False   7.996024
2          2      27    1  53.064501     3       95  False   False   9.015144
3          3      37    0  64.799128     0       93  False   False  10.099032
4          4      46    0  99.111394     2       25  False   False  11.711427
</p>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientid</th>
      <th>hospid</th>
      <th>sex</th>
      <th>age</th>
      <th>race</th>
      <th>cptCode</th>
      <th>rdm30d</th>
      <th>mort30d</th>
      <th>los</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>10</td>
      <td>1</td>
      <td>64.311947</td>
      <td>0</td>
      <td>8</td>
      <td>False</td>
      <td>False</td>
      <td>8.036793</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
      <td>0</td>
      <td>82.951484</td>
      <td>1</td>
      <td>73</td>
      <td>True</td>
      <td>False</td>
      <td>7.996024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>27</td>
      <td>1</td>
      <td>53.064501</td>
      <td>3</td>
      <td>95</td>
      <td>False</td>
      <td>False</td>
      <td>9.015144</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>37</td>
      <td>0</td>
      <td>64.799128</td>
      <td>0</td>
      <td>93</td>
      <td>False</td>
      <td>False</td>
      <td>10.099032</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>46</td>
      <td>0</td>
      <td>99.111394</td>
      <td>2</td>
      <td>25</td>
      <td>False</td>
      <td>False</td>
      <td>11.711427</td>
    </tr>
  </tbody>
</table>
</div>


<p>
We can use the header to select only the plain text output!
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> datetime <span style="color: #0000FF;">as</span> dt

<span style="color: #0000FF;">def</span> <span style="color: #006699;">makeSim</span>(nHosps, nPatients):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span> = pd.DataFrame()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'patientid'</span>] = <span style="color: #006FE0;">range</span>(nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'hospid'</span>] = np.random.randint(0, nHosps, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'sex'</span>] = np.random.randint(0, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'age'</span>] = np.random.normal(65,18, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'race'</span>] = np.random.randint(0, 4, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'cptCode'</span>] = np.random.randint(1, 100, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'rdm30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'mort30d'</span>] = np.random.uniform(0, 1, nPatients) &lt; 0.2
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">df</span>[<span style="color: #008000;">'los'</span>] = np.random.normal(8, 2, nPatients)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> df

<span style="color: #BA36A5;">discharges</span> = makeSim(50, 10000)
discharges.head()
</pre>
</div>

<p>
   patientid  hospid  sex        age  race  cptCode rdm30d mort30d        los
0          0      21    0  73.633836     1       38  False   False   7.144019
1          1      16    1  67.518804     3       23  False   False   3.340534
2          2      15    0  44.139033     0        8  False   False   9.258706
3          3      29    1  45.510276     2        5  False   False  10.590245
4          4       7    0  52.974924     2        4  False    True   5.811064
</p>
</div>
</div>

<div id="outline-container-org5cac271" class="outline-2">
<h2 id="org5cac271"><span class="section-number-2">4</span> Where was that error?</h2>
<div class="outline-text-2" id="text-4">
<p>
A somewhat annoying feature of running cells in org-mode is when there is an exception there has not been a good way to jump to the line that caused the error to edit it. The lines in the src block are not numbered, so in a large block it can be tedious to find the line. In scimax, when you get an exception it will number the lines in the src block, and when you press q in the exception traceback buffer it will jump to the line in the block where the error occurred.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">print</span>(1)
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">raise Exception('Here')</span>
<span style="color: #0000FF;">print</span>(2)
</pre>
</div>

<p>
1
2
</p>



<p>
If you don't like the numbers add this to your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> ob-ipython-number-on-exception nil)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ebd0a8" class="outline-2">
<h2 id="org3ebd0a8"><span class="section-number-2">5</span> Asynchronous Ipython</h2>
<div class="outline-text-2" id="text-5">
<p>
I have made a few improvements to the asynchronous workflow in Ipython. We now have a calculation queue, so you can use C-c C-c to execute several blocks in a row, and they will run asynchronously in the order you ran them. While they are running you can continue using Emacs, e.g. writing that paper, reading email, checking RSS feeds, tetris, &#x2026; This also lets you run all the blocks up to the current point (M-x <code>org-babel-execute-ipython-buffer-to-point-async</code>) or the whole buffer (of Ipython) blocks asynchronously (M-x <code>org-babel-execute-ipython-buffer-async</code>).
</p>

<p>
To turn this on by default put this in your init file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">setq</span> org-babel-async-ipython t)
</pre>
</div>

<p>
This requires all src blocks to have a name, and running the block will give it a name if you have not named the block. By default we use human-readable names. While the block is running, there will be a link indicating it is running. You can click on the link to cancel it. Running subsequent blocks will queue them to be run when the first block is done.
</p>

<p>
Here is an example:
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="orgb3ddac3"><span style="color: #0000FF;">import</span> time
time.sleep(5)
<span style="color: #BA36A5;">a</span> = 5
<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'done'</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython" id="org5b7e30b"><span style="color: #0000FF;">print</span>(3 * a)
</pre>
</div>

<p>
15
</p>




<p>
Occasionally you will run into an issue. You can clear the queue with <code>org-babel-async-ipython-clear-queue</code>.</p>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax.org">org-mode source</a></p>
<p>Org-mode version = 9.0.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax">Discuss on Twitter</a>

  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="ob-ipython-and-inline-figures-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2017/01/29/ob-ipython-and-inline-figures-in-org-mode/" rel="bookmark" title="Permanent Link to ob-ipython and inline figures in org-mode">ob-ipython and inline figures in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted January 29, 2017 at 04:05 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/ipython/'>ipython</a>, <a href='/blog/category/python/'>python</a></span> | tags: 
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org36f9eed">1. code for getting output and inline figures</a></li>
</ul>
</div>
</div>
<p>
<a href="https://github.com/gregsexton/ob-ipython">ob-ipython</a> provides some nice support for inline images, but it is a little limited. You can only have one inline plot, and you cannot capture the printed output. I often want both, and use more than one figure in a code block. So, here I look at a way to get that. 
</p>

<p>
When ob-ipython executes a cell, it gets two things internally: the output and a list of result elements. The output is all the stuff that is printed, and the result contains result cells. So, we just have to check these for images, and append them to the output in an appropriate way.  I will do that using file links so that org automatically renders them. We will save the images as temp files, since they are regenerated each time you run the cell. 
</p>

<p>
I want output and inline figures. This ipython block should output some text and two figures. Note we do not define file names anywhere! See <a href="#org36f9eed">this section</a> for details on how to get ob-ipython to do this.
</p>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #BA36A5;">t</span> = np.linspace(0, 20 * np.pi, 350)
<span style="color: #BA36A5;">x</span> = np.exp(-0.1 * t) * np.sin(t)
<span style="color: #BA36A5;">y</span> = np.exp(-0.1 * t) * np.cos(t)

plt.plot(x, y)
plt.axis(<span style="color: #008000;">'equal'</span>)

plt.figure()
plt.plot(y, x)
plt.axis(<span style="color: #008000;">'equal'</span>)

<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'Length of t = {}'</span>.<span style="color: #006FE0;">format</span>(<span style="color: #006FE0;">len</span>(t)))
<span style="color: #0000FF;">print</span>(<span style="color: #008000;">'x .dot. y = {}'</span>.<span style="color: #006FE0;">format</span>(x @ y))
</pre>
</div>

<p>
Length of t = 350
x .dot. y = 1.3598389888491538
<img src="/media/ob-ipython-86557tr2.png"> 
<img src="/media/ob-ipython-86557f1F.png"> 
</p>

<p>
Nice, success! Now my code blocks <a href="http://kitchingroup.cheme.cmu.edu/blog/2017/01/21/Exporting-org-mode-to-Jupyter-notebooks/">export more cleanly to jupyter notebooks</a>. Speaking of which, if you liked the post on that, there is a new library for it in scimax: <a href="https://github.com/jkitchin/scimax/blob/master/ox-ipynb.el">https://github.com/jkitchin/scimax/blob/master/ox-ipynb.el</a>. Yes, one day I will put it in its own repo, and probably put it up on MELPA. If it turns out to be useful over the next semester. 
</p>



<div id="outline-container-org36f9eed" class="outline-2">
<h2 id="org36f9eed"><a id="ID-44FC1FFF-A6EA-466E-B61C-85B22E58781D"></a><span class="section-number-2">1</span> code for getting output and inline figures</h2>
<div class="outline-text-2" id="text-1">
<p>
I wrote one new function that writes the base64 data out to a temporary file and returns a link to it. Then, I modified the org-babel-execute:ipython function to append these links onto the output. It seems like you need to use a header like this in your ob-ipython block, notably the results need to be in a drawer like this if you want org-mode to render the images. They do not show up in the results that have colons starting them.
</p>

<pre class="example">
#+BEGIN_SRC ipython :session :results output drawer
</pre>

<p>
Here is the code.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ob-ipython-inline-image</span> (b64-string)
  <span style="color: #036A07;">"Write the b64-string to a temporary file.</span>
<span style="color: #036A07;">Returns an org-link to the file."</span>
  (<span style="color: #0000FF;">let*</span> ((tfile (make-temp-file <span style="color: #008000;">"ob-ipython-"</span> nil <span style="color: #008000;">".png"</span>))
         (link (format <span style="color: #008000;">"[[file:%s]]"</span> tfile)))
    (ob-ipython--write-base64-string tfile b64-string)
    link))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-execute:ipython</span> (body params)
  <span style="color: #036A07;">"Execute a block of IPython code with Babel.</span>
<span style="color: #036A07;">This function is called by `</span><span style="color: #D0372D;">org-babel-execute-src-block</span><span style="color: #036A07;">'."</span>
  (<span style="color: #0000FF;">let*</span> ((file (cdr (assoc <span style="color: #006FE0;">:file</span> params)))
         (session (cdr (assoc <span style="color: #006FE0;">:session</span> params)))
         (result-type (cdr (assoc <span style="color: #006FE0;">:result-type</span> params))))
    (org-babel-ipython-initiate-session session params)
    (<span style="color: #0000FF;">-when-let</span> (ret (ob-ipython--eval
                     (ob-ipython--execute-request
                      (org-babel-expand-body:generic (encode-coding-string body 'utf-8)
                                                     params (org-babel-variable-assignments:python params))
                      (ob-ipython--normalize-session session))))
      (<span style="color: #0000FF;">let</span> ((result (cdr (assoc <span style="color: #006FE0;">:result</span> ret)))
            (output (cdr (assoc <span style="color: #006FE0;">:output</span> ret))))
        (<span style="color: #0000FF;">if</span> (eq result-type 'output)
            (concat
             output 
             (format <span style="color: #008000;">"%s"</span>
                     (mapconcat 'identity
                                (<span style="color: #0000FF;">loop</span> for res in result
                                      if (eq 'image/png (car res))
                                      collect (ob-ipython-inline-image (cdr res)))
                                <span style="color: #008000;">"\n"</span>)))
          (ob-ipython--create-stdout-buffer output)
          (<span style="color: #0000FF;">cond</span> ((<span style="color: #0000FF;">and</span> file (string= (f-ext file) <span style="color: #008000;">"png"</span>))
                 (<span style="color: #0000FF;">-&gt;&gt;</span> result (assoc 'image/png) cdr (ob-ipython--write-base64-string file)))
                ((<span style="color: #0000FF;">and</span> file (string= (f-ext file) <span style="color: #008000;">"svg"</span>))
                 (<span style="color: #0000FF;">-&gt;&gt;</span> result (assoc 'image/svg+xml) cdr (ob-ipython--write-string-to-file file)))
                (file (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"%s is currently an unsupported file extension."</span> (f-ext file)))
                (t (<span style="color: #0000FF;">-&gt;&gt;</span> result (assoc 'text/plain) cdr))))))))
</pre>
</div>

<pre class="example">
org-babel-execute:ipython
</pre>
</div>
</div>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/01/29/ob-ipython-and-inline-figures-in-org-mode.org">org-mode source</a></p>
<p>Org-mode version = 9.0.3</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Share on Twitter</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<a href="https://twitter.com/search?q=https://kitchingroup.cheme.cmu.edu/blog/2017/01/29/ob-ipython-and-inline-figures-in-org-mode">Discuss on Twitter</a>

  <hr class="interblog" />

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2025/05/07/New-publication-The-Evolving-Role-of-Programming-and-Llms-in-the-Development-of-Self-Driving-Laboratories/">New publication - The Evolving Role of Programming and Llms in the Development of Self-Driving Laboratories</a></li>
      <li><a href="/blog/2025/04/11/New-publication-A-Classification-based-Methodology-for-the-Estimation-of-Binary-Surfactant-Critical-Micelle-Concentrations/">New publication - A Classification-based Methodology for the Estimation of Binary Surfactant Critical Micelle Concentrations</a></li>
      <li><a href="/blog/2025/03/17/New-publication-CatTsunami-Accelerating-Transition-State-Energy-Calculations-With-Pretrained-Graph-Neural-Networks/">New publication - CatTsunami Accelerating Transition State Energy Calculations With Pretrained Graph Neural Networks</a></li>
      <li><a href="/blog/2025/02/11/New-publication-Accessing-Numerical-Energy-Hessians-With-Graph-Neural-Network-Potentials-and-Their-Application-in-Heterogeneous-Catalysis/">New publication - Accessing Numerical Energy Hessians With Graph Neural Network Potentials and Their Application in Heterogeneous Catalysis</a></li>
      <li><a href="/blog/2025/02/05/New-publication-Beyond-the-Fourth-Paradigm-of-Modeling-in-Chemical-Engineering/">New publication - Beyond the Fourth Paradigm of Modeling in Chemical Engineering</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2025
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
 
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PH8NF4F0RE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PH8NF4F0RE');
</script>


  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



