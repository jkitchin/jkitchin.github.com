

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications/index.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Better-equation-numbering-in-LaTeX-fragments-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2016/11/07/Better-equation-numbering-in-LaTeX-fragments-in-org-mode/" rel="bookmark" title="Permanent Link to Better equation numbering in LaTeX fragments in org-mode">Better equation numbering in LaTeX fragments in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted November 07, 2016 at 07:02 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/latex/'>latex</a>, <a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2016/11/07/Better-equation-numbering-in-LaTeX-fragments-in-org-mode#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
In org-mode we can use LaTeX equations, and toggle an overlay that shows what the rendered equation will look like. One thing that has always bothered me though, is that each fragment is created in isolation. That means numbering is almost always wrong, and typically with each numbered equation starting with (1). Here we look at a way to fix that. Fixing it means we have to find a way to not create each fragment image in isolation; each one needs a context that enables the numbering to be correct. The idea we try here is simple: we just figure out in advance what the numbering for each equation should be, and then figure out how to get that information to the image generation.
</p>

<p>
See this video of the post in action:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/pcMuJlUvKCw" frameborder="0" allowfullscreen></iframe>

<p>
Here are some example equations to see how it works.
</p>

<p>
This should be numbered (1)
</p>
\begin{equation}
\int x^2 dx
\end{equation}

<p>
This is a numbered equation with a custom number. This should have (E1) as the number.
</p>
\begin{equation}\tag{E1}
\int x^2 dx
\end{equation}

<p>
But equation* is not numbered
</p>
\begin{equation*}
\int x^2 dx
\end{equation*}

<p>
LaTeX align environments are numbered. The first line is (2), the second line is not numbered (because we put <code>\nonumber</code> in the line), and the third line is (3).
</p>
\begin{align}
a = 5 \\
b=6 \nonumber \\
c = 8
\end{align}

<p>
But align* environments are not numbered.
</p>
\begin{align*}
a = 5 \\
b=6
\end{align*}

<p>
This should be numbered (4).
</p>

\begin{equation}
\int x^3 dx
\end{equation}

<p>
These should be numbered (5), (6) and (7).
</p>
\begin{align}
a = 5 \\
b=6  \\
c = 8
\end{align}

<p>
This should be numbered with (E2).
</p>
\begin{equation}\tag{E2}
\int x^2 dx 
\end{equation}

<p>
And this should be numbered (8).
</p>
\begin{equation}
\int x^2 dx 
\end{equation}

<p>
Note: This will be numbered (1) because it is exactly the same equation as a previous one! 
</p>
\begin{equation}
\int x^2 dx
\end{equation}


<p>
We can change the numbering of an equation with code like this. After this code, the next equation will be numbered (5).
</p>

<p>
The only fragments that should be numbered are equation environments, and align environments (these are the main ones that we consider here). The align environment is tricky since there is potentially more than one number in the environment. 
</p>

<p>
So, we get all the fragments, and generate a list of which ones should be numbered, and if they should what the number should be. That means we will need to count the number of numbered equations in an align environment. We will do that by getting the number of line breaks, and subtracting the number of nonumbers.
</p>

<p>
Here is the code block that does that, using advice again. A downside of this approach is that we generate the list for every fragment, which is not efficient, since it should not change in a synchronous approach to generating them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-renumber-environment</span> (orig-func <span style="color: #6434A3;">&amp;rest</span> args)
  (<span style="color: #0000FF;">let</span> ((results '()) 
        (counter -1)
        (numberp))

    (<span style="color: #0000FF;">setq</span> results (<span style="color: #0000FF;">loop</span> for (begin .  env) in 
                        (org-element-map (org-element-parse-buffer) 'latex-environment
                          (<span style="color: #0000FF;">lambda</span> (env)
                            (cons
                             (org-element-property <span style="color: #006FE0;">:begin</span> env)
                             (org-element-property <span style="color: #006FE0;">:value</span> env))))
                        collect
                        (<span style="color: #0000FF;">cond</span>
                         ((<span style="color: #0000FF;">and</span> (string-match <span style="color: #008000;">"\\\\begin{equation}"</span> env)
                               (not (string-match <span style="color: #008000;">"\\\\tag{"</span> env)))
                          (<span style="color: #0000FF;">incf</span> counter)
                          (cons begin counter))
                         ((string-match <span style="color: #008000;">"\\\\begin{align}"</span> env)
                          (<span style="color: #0000FF;">prog2</span>
                              (<span style="color: #0000FF;">incf</span> counter)
                              (cons begin counter)                          
                            (<span style="color: #0000FF;">with-temp-buffer</span>
                              (insert env)
                              (goto-char (point-min))
                              <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">\\ is used for a new line. Each one leads to a number</span>
                              (<span style="color: #0000FF;">incf</span> counter (count-matches <span style="color: #008000;">"\\\\$"</span>))
                              <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">unless there are nonumbers.</span>
                              (goto-char (point-min))
                              (<span style="color: #0000FF;">decf</span> counter (count-matches <span style="color: #008000;">"\\nonumber"</span>)))))
                         (t
                          (cons begin nil)))))

    (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">setq</span> numberp (cdr (assoc (point) results)))
      (<span style="color: #0000FF;">setf</span> (car args)
            (concat
             (format <span style="color: #008000;">"\\setcounter{equation}{%s}\n"</span> numberp)
             (car args)))))
  
  (apply orig-func args))

(advice-add 'org-create-formula-image <span style="color: #006FE0;">:around</span> #'org-renumber-environment)
</pre>
</div>

<p>
You can remove the advice like this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(advice-remove 'org-create-formula-image #'org-renumber-environment)
</pre>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/11/07/Better-equation-numbering-in-LaTeX-fragments-in-org-mode.org">org-mode source</a></p>
<p>Org-mode version = 9.0</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2016/11/07/Better-equation-numbering-in-LaTeX-fragments-in-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Justifying-LaTeX-preview-fragments-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2016/11/06/Justifying-LaTeX-preview-fragments-in-org-mode/" rel="bookmark" title="Permanent Link to Justifying LaTeX preview fragments in org-mode">Justifying LaTeX preview fragments in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted November 06, 2016 at 08:44 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/latex/'>latex</a>, <a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2016/11/06/Justifying-LaTeX-preview-fragments-in-org-mode#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
A colleague asked if I knew how to center the preview images of LaTeX equations in an org-buffer. This might make org-mode notes look nicer when lecturing, for example. We thought it might be possible to just offset the overlay with a before-string made up of the right number of spaces. I worked out a full solution that lets you "justify" the preview images. You have to add a :justify option to org-format-latex-options, and the option is either 'center or 'right (anything else means left-justified as the default). This will only justify equations that start at the beginning of a line to avoid modifying fragments that are in text. You should see the video to see this in action:
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/nA9YzooqpWY" frameborder="0" allowfullscreen></iframe>

<p>
Equation 1:
\(e^{i\pi} + 1 = 0\)
</p>

<p>
An \(x^2 = -1\) equation in the text is not affected.
</p>

<p>
A display equation with some space after the equation:
\[e^{i \cdot \pi} + 1 = 0\]     
</p>

<p>
This is a numbered equation.
</p>

\begin{equation}
\int x^2 dx
\end{equation}

<p>
The idea is pretty simple, we get the width of the window, and the width of the image, and compute the offset that approximately centers or right justifies the overlay, and then add the before-string property to the overlay. While we are at it, I will add a tooltip to the image so you can see the LaTeX code that created it, and make it clickable so you can toggle it back to the code. 
I apply the functions as after advice to the function that creates the overlay, so we do not have to adapt the org code at all. Here is the code that does it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">specify the justification you want</span>
(plist-put org-format-latex-options <span style="color: #006FE0;">:justify</span> 'center)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-justify-fragment-overlay</span> (beg end image imagetype)
  <span style="color: #036A07;">"Adjust the justification of a LaTeX fragment.</span>
<span style="color: #036A07;">The justification is set by :justify in</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">org-format-latex-options</span><span style="color: #036A07;">'. Only equations at the beginning of a</span>
<span style="color: #036A07;">line are justified."</span>
  (<span style="color: #0000FF;">cond</span>
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Centered justification</span>
   ((<span style="color: #0000FF;">and</span> (eq 'center (plist-get org-format-latex-options <span style="color: #006FE0;">:justify</span>)) 
         (= beg (line-beginning-position)))
    (<span style="color: #0000FF;">let*</span> ((img (create-image image 'imagemagick t))
           (width (car (image-size img)))
           (offset (floor (- (/ (window-text-width) 2) (/ width 2)))))
      (overlay-put (ov-at) 'before-string (make-string offset ? ))))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Right justification</span>
   ((<span style="color: #0000FF;">and</span> (eq 'right (plist-get org-format-latex-options <span style="color: #006FE0;">:justify</span>)) 
         (= beg (line-beginning-position)))
    (<span style="color: #0000FF;">let*</span> ((img (create-image image 'imagemagick t))
           (width (car (image-display-size (overlay-get (ov-at) 'display))))
           (offset (floor (- (window-text-width) width (- (line-end-position) end)))))
      (overlay-put (ov-at) 'before-string (make-string offset ? ))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-latex-fragment-tooltip</span> (beg end image imagetype)
  <span style="color: #036A07;">"Add the fragment tooltip to the overlay and set click function to toggle it."</span>
  (overlay-put (ov-at) 'help-echo
               (concat (buffer-substring beg end)
                       <span style="color: #008000;">"mouse-1 to toggle."</span>))
  (overlay-put (ov-at) 'local-map (<span style="color: #0000FF;">let</span> ((map (make-sparse-keymap)))
                                    (define-key map [mouse-1]
                                      `(<span style="color: #0000FF;">lambda</span> ()
                                         (<span style="color: #0000FF;">interactive</span>)
                                         (org-remove-latex-fragment-image-overlays ,beg ,end)))
                                    map)))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">advise the function to a</span>
(advice-add 'org--format-latex-make-overlay <span style="color: #006FE0;">:after</span> 'org-justify-fragment-overlay)
(advice-add 'org--format-latex-make-overlay <span style="color: #006FE0;">:after</span> 'org-latex-fragment-tooltip)
</pre>
</div>

<p>
That is it. If you get tired of the advice, remove it like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(advice-remove 'org--format-latex-make-overlay 'org-justify-fragment-overlay)
(advice-remove 'org--format-latex-make-overlay 'org-latex-fragment-tooltip)
</pre>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/11/06/Justifying-LaTeX-preview-fragments-in-org-mode.org">org-mode source</a></p>
<p>Org-mode version = 9.0</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2016/11/06/Justifying-LaTeX-preview-fragments-in-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="New-link-features-in-org-9"></div>
      <h2 class="blog_post_title"><a href="/blog/2016/11/04/New-link-features-in-org-9/" rel="bookmark" title="Permanent Link to New link features in org 9">New link features in org 9</a></h2>
      <p><small><span class="blog_post_date">Posted November 04, 2016 at 06:14 AM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2016/11/04/New-link-features-in-org-9#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated November 04, 2016 at 07:02 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4d40e92">1. A colored link with a static tooltip.</a></li>
<li><a href="#org1bc1061">2. A colored link with a static tooltip and no folding.</a></li>
<li><a href="#org1c56ce9">3. A dynamic tooltip</a></li>
<li><a href="#orgc074278">4. A better file link</a></li>
<li><a href="#orgc12de23">5. A link with a new keymap.</a></li>
<li><a href="#org479a559">6. A completion example with a dynamic face for validation</a></li>
<li><a href="#org6b336b6">7. A store link example</a></li>
<li><a href="#org069cbfa">8. An activate-func example</a></li>
</ul>
</div>
</div>
<p>
Org 9.0 is finally out, and it comes with a totally overhauled link capability! This post documents some of those capabilities. These new capabilities include support for:
</p>

<ol class="org-ol">
<li>Custom link faces</li>
<li>Custom tooltips on links</li>
<li>More consistent interface for completion</li>
<li>Special keymaps on links</li>
<li>Customized folding of bracketed links</li>
</ol>

<p>
This post will make more sense with this video: <a href="https://www.youtube.com/watch?v=5haX95nk02E">https://www.youtube.com/watch?v=5haX95nk02E</a>
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/5haX95nk02E" frameborder="0" allowfullscreen></iframe>

<div id="outline-container-org4d40e92" class="outline-2">
<h2 id="org4d40e92"><span class="section-number-2">1</span> A colored link with a static tooltip.</h2>
<div class="outline-text-2" id="text-1">
<p>
All links in elisp are now defined with org-link-set-parameters.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span style="color: #008000;">"red"</span>
 <span style="color: #006FE0;">:follow</span> (<span style="color: #0000FF;">lambda</span> (path) (message <span style="color: #008000;">"You clicked me."</span>))
 <span style="color: #006FE0;">:export</span> (<span style="color: #0000FF;">lambda</span> (path desc backend)
           (<span style="color: #0000FF;">cond</span>
            ((eq 'html backend)
             (format <span style="color: #008000;">"&lt;font color=\"red\"&gt;%s&lt;/font&gt;"</span>
                     (<span style="color: #0000FF;">or</span> desc path)))))
 <span style="color: #006FE0;">:face</span> '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"red"</span>)
 <span style="color: #006FE0;">:help-echo</span> <span style="color: #008000;">"Click me for a message."</span>)
</pre>
</div>

<p>
A <font color="red">link</font> that is colored red.  In bracketed form:  A <font color="red">link with a description</font>.                   
</p>

<p>
You can change a parameter like this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span style="color: #008000;">"red"</span>
 <span style="color: #006FE0;">:face</span> '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"red"</span> <span style="color: #006FE0;">:underline</span> t))
</pre>
</div>

<p>
A <font color="red">link</font> that is colored red and underlined.
</p>

<p>
You can use any face for a link. Here we define one and use it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defface</span> <span style="color: #BA36A5;">org-link-green</span>
  '((t (<span style="color: #006FE0;">:inherit</span> org-link <span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"green"</span>)))
  <span style="color: #036A07;">"A green link."</span>)

(org-link-set-parameters
   <span style="color: #008000;">"green"</span>
   <span style="color: #006FE0;">:follow</span> (<span style="color: #0000FF;">lambda</span> (path) (message <span style="color: #008000;">"You clicked me."</span>))
   <span style="color: #006FE0;">:export</span> (<span style="color: #0000FF;">lambda</span> (path desc backend)
     (<span style="color: #0000FF;">cond</span>
      ((eq 'html backend)
       (format <span style="color: #008000;">"&lt;font color=\"green\"&gt;%s&lt;/font&gt;"</span>
               (<span style="color: #0000FF;">or</span> desc path)))))
   <span style="color: #006FE0;">:face</span> 'org-link-green
   <span style="color: #006FE0;">:help-echo</span> <span style="color: #008000;">"Click me for a message."</span>)
</pre>
</div>

<p>
A <font color="green">link</font> works.        
</p>
</div>
</div>

<div id="outline-container-org1bc1061" class="outline-2">
<h2 id="org1bc1061"><span class="section-number-2">2</span> A colored link with a static tooltip and no folding.</h2>
<div class="outline-text-2" id="text-2">
<p>
This link will be shown in full unfolded form even when other links are folded in descriptive format.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span style="color: #008000;">"red-full"</span>
 <span style="color: #006FE0;">:follow</span> (<span style="color: #0000FF;">lambda</span> (path) (message <span style="color: #008000;">"You clicked me."</span>))
 <span style="color: #006FE0;">:export</span> (<span style="color: #0000FF;">lambda</span> (path desc backend)
           (<span style="color: #0000FF;">cond</span>
            ((eq 'html backend)
             (format <span style="color: #008000;">"&lt;font color=\"red\"&gt;%s&lt;/font&gt;"</span>
                     (<span style="color: #0000FF;">or</span> desc path)))))
 <span style="color: #006FE0;">:face</span> '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"red"</span>)
 <span style="color: #006FE0;">:display</span> 'full
 <span style="color: #006FE0;">:help-echo</span> <span style="color: #008000;">"Click me for a message."</span>)
</pre>
</div>

<p>
A <font color="red">link</font> that is colored red.  In bracketed form:  A <font color="red">link with a description</font>.  This regular <a href="http://dx.doi.org/test">bracketed doi</a> is still folded.   
</p>
</div>
</div>

<div id="outline-container-org1c56ce9" class="outline-2">
<h2 id="org1c56ce9"><span class="section-number-2">3</span> A dynamic tooltip</h2>
<div class="outline-text-2" id="text-3">
<p>
You can make tooltips dynamic. The function must take these arguments (window object position), and construct the tooltip from that information. Here we show what the cursor is on and the point that it is on. \(x^2\)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">redd-tip</span> (window object position)
  (<span style="color: #0000FF;">save-excursion</span>
    (goto-char position)
    (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> (org-element-context)))
    (<span style="color: #0000FF;">cond</span> ((looking-at org-plain-link-re)
           (format <span style="color: #008000;">"Looking at %s with mouse at %s"</span> (match-string 0) position))
          ((looking-at org-bracket-link-regexp)
           (format <span style="color: #008000;">"Looking at %s in a bracketed link with mouse at %s"</span>
                   (match-string 0) position))
          (t
           <span style="color: #008000;">"No match"</span>))))

(org-link-set-parameters
 <span style="color: #008000;">"redd"</span>
 <span style="color: #006FE0;">:face</span> '(<span style="color: #006FE0;">:underline</span> t)
 <span style="color: #006FE0;">:help-echo</span> 'redd-tip)
</pre>
</div>

<p>
A link with a dynamic tooltip: <a href="link">link</a> or this one <a href="another-link">another-link</a>     <a href="test">bracketed redd</a>             
</p>
</div>
</div>

<div id="outline-container-orgc074278" class="outline-2">
<h2 id="orgc074278"><span class="section-number-2">4</span> A better file link</h2>
<div class="outline-text-2" id="text-4">
<p>
Say you want to get a menu of options for file links. For example to find the file, open it in dired, copy the link, etc&#x2026; We use helm here to make that happen.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span style="color: #008000;">"file"</span>
 <span style="color: #006FE0;">:follow</span> (<span style="color: #0000FF;">lambda</span> (path)
           (funcall
            (helm <span style="color: #006FE0;">:sources</span>
                  `((name . <span style="color: #008000;">"Action"</span>)
                    (candidates . ,(append
                                    (<span style="color: #0000FF;">loop</span> for f in '(find-file
                                                     org-open-file)
                                          collect (cons (symbol-name f) f))
                                    '((<span style="color: #008000;">"dired"</span> . (<span style="color: #0000FF;">lambda</span> (path)
                                                   (dired (file-name-directory path))
                                                   (re-search-forward (file-name-nondirectory path))))
                                      (<span style="color: #008000;">"copy org link"</span> . (<span style="color: #0000FF;">lambda</span> (path)
                                                           (kill-new (format <span style="color: #008000;">"[[file:%s]]"</span> path)))))))
                    (action . identity)))
            path)))
</pre>
</div>

<p>
<img src="/media/hy-test.png"> 
</p>
</div>
</div>

<div id="outline-container-orgc12de23" class="outline-2">
<h2 id="orgc12de23"><span class="section-number-2">5</span> A link with a new keymap.</h2>
<div class="outline-text-2" id="text-5">
<p>
To get a special keymap, we have to create a new keymap. We can make a copy of org-mouse-map and add new keys to it that are specific to this link. With this link, you can use arrow-keys with a modifier key to jump between links. We define C-left and C-right to go to the previous and next links, and for fun a C-up and super-mouse-1 bindings that are in effect only on the links.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">prev-link</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (re-search-backward <span style="color: #008000;">"keym:"</span> nil t))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">next-link</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (re-search-forward <span style="color: #008000;">"keym:"</span> nil t))

(org-link-set-parameters
 <span style="color: #008000;">"keym"</span>
 <span style="color: #006FE0;">:follow</span> (<span style="color: #0000FF;">lambda</span> (path)
           (<span style="color: #0000FF;">interactive</span>)
           (message <span style="color: #008000;">"You followed me."</span>))
 <span style="color: #006FE0;">:keymap</span> (<span style="color: #0000FF;">let</span> ((map (copy-keymap org-mouse-map)))
           (define-key map (kbd <span style="color: #008000;">"C-&lt;left&gt;"</span>) 'prev-link)
           (define-key map (kbd <span style="color: #008000;">"C-&lt;right&gt;"</span>) 'next-link)
           (define-key map (kbd <span style="color: #008000;">"C-&lt;up&gt;"</span>)
             (<span style="color: #0000FF;">lambda</span> ()
               (<span style="color: #0000FF;">interactive</span>)(message-box <span style="color: #008000;">"special C-up"</span>)))
           (define-key map [s-mouse-1]
             (<span style="color: #0000FF;">lambda</span> ()
               (<span style="color: #0000FF;">interactive</span>)
               (message-box <span style="color: #008000;">"s-Followed"</span>)))
           map))
</pre>
</div>


<p>
<a href="one">one</a>  then <a href="two">two</a> and finally <a href="three">three</a>                  
</p>
</div>
</div>

<div id="outline-container-org479a559" class="outline-2">
<h2 id="org479a559"><span class="section-number-2">6</span> A completion example with a dynamic face for validation</h2>
<div class="outline-text-2" id="text-6">
<p>
This example shows how to add a completion function, and use a dynamic face to show when a bad link has been made (in this case there are 4 allowed fruits, and anything else should be red.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">my-comp</span> (<span style="color: #6434A3;">&amp;optional</span> arg)
  (format <span style="color: #008000;">"fruit:%s"</span>
          (completing-read <span style="color: #008000;">"Choose a fruit: "</span> '(<span style="color: #008000;">"apple"</span> <span style="color: #008000;">"orange"</span> <span style="color: #008000;">"grapes"</span> <span style="color: #008000;">"kiwi"</span>))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">fruit-link-face</span> (path)
  (<span style="color: #0000FF;">if</span> (member path '(<span style="color: #008000;">"apple"</span> <span style="color: #008000;">"orange"</span> <span style="color: #008000;">"grapes"</span> <span style="color: #008000;">"kiwi"</span>))
      'org-link
    '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"red"</span>)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">fruit-tooltip</span> (_win _obj position)
  (<span style="color: #0000FF;">save-match-data</span>
    (<span style="color: #0000FF;">save-excursion</span>
      (goto-char position)
      (<span style="color: #0000FF;">let</span> ((path (org-element-property <span style="color: #006FE0;">:path</span> (org-element-context))))
        (<span style="color: #0000FF;">if</span> (member path '(<span style="color: #008000;">"apple"</span> <span style="color: #008000;">"orange"</span> <span style="color: #008000;">"grapes"</span> <span style="color: #008000;">"kiwi"</span>))
            <span style="color: #008000;">"A fruit"</span>
          (format <span style="color: #008000;">"%s: Illegal value. Must be one of apple, orange, grapes or kiwi."</span>
                  path))))))

(org-link-set-parameters <span style="color: #008000;">"fruit"</span>             
                         <span style="color: #006FE0;">:help-echo</span> 'fruit-tooltip
                         <span style="color: #006FE0;">:face</span> 'fruit-link-face
                         <span style="color: #006FE0;">:complete</span> 'my-comp)
</pre>
</div>


<p>
<a href="apple">apple</a>      <a href="orange">an orange in brackets</a>             
</p>

<p>
a bad <a href="grapefruit">grapefruit</a>.        <a href="kiwi">kiwi</a> 
</p>

<p>
<a href="kiwi">kiwi</a>  
</p>
</div>
</div>

<div id="outline-container-org6b336b6" class="outline-2">
<h2 id="org6b336b6"><span class="section-number-2">7</span> A store link example</h2>
<div class="outline-text-2" id="text-7">
<p>
<a href="*A%20store%20link%20example">A store link example</a>
Put your  cursor on a headline, and type C-c l. Then move it and type C-c C-l to insert the link.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">store-my-headline</span> ()
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (eq major-mode 'org-mode)
             (org-at-heading-p))
    (org-store-link-props
     <span style="color: #006FE0;">:type</span> <span style="color: #008000;">"head"</span>
     <span style="color: #006FE0;">:link</span> (format <span style="color: #008000;">"head:*%s"</span> (nth 4 (org-heading-components)))
     <span style="color: #006FE0;">:description</span> (nth 4 (org-heading-components)))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">follow-head</span> (path)
  (org-open-link-from-string (format <span style="color: #008000;">"[[%s]]"</span> path)))

(org-link-set-parameters
 <span style="color: #008000;">"head"</span> <span style="color: #006FE0;">:follow</span> 'follow-head <span style="color: #006FE0;">:store</span> 'store-my-headline)
</pre>
</div>
</div>
</div>

<div id="outline-container-org069cbfa" class="outline-2">
<h2 id="org069cbfa"><span class="section-number-2">8</span> An activate-func example</h2>
<div class="outline-text-2" id="text-8">
<p>
You may want to do some additional things when a link is activated. For example, maybe it makes sense for different parts of the link to have different actions,  or colors. Here is an example where we make an rgb link of three numbers, and color each number, and make the link color dynamic.
</p>

<p>
We make a keymap so C-up increments a color, and C-down decrements a color.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">color</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">rgb-face</span> (path)
  (<span style="color: #0000FF;">let*</span> ((f (split-string path <span style="color: #008000;">","</span>))
         (red (/ (string-to-number (nth 0 f)) 255.0))
         (green (/ (string-to-number (nth 1 f)) 255.0))
         (blue (/ (string-to-number (nth 2 f)) 255.0))
         (hex (color-rgb-to-hex red green blue)))
    (list <span style="color: #006FE0;">:foreground</span> hex)))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">rgb-func</span> (start end path bracketp) 
  (<span style="color: #0000FF;">save-excursion</span>
    (goto-char start)
    (<span style="color: #0000FF;">save-match-data</span>
      (<span style="color: #0000FF;">cl-loop</span> for num in (split-string path <span style="color: #008000;">","</span>)
               for face in (list '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"red"</span>)
                                 '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"green"</span>)
                                 '(<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"blue"</span>))
               do
               (<span style="color: #0000FF;">progn</span>
                 (re-search-forward num end t)
                 (add-text-properties
                  (match-beginning 0)
                  (match-end 0)
                  (list 'face face)))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ninc</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (skip-chars-backward <span style="color: #008000;">"0-9"</span>)
  (<span style="color: #0000FF;">or</span> (looking-at <span style="color: #008000;">"[0-9]+"</span>)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"No number at point"</span>))
  (replace-match (number-to-string (1+ (string-to-number (match-string 0))))))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">NINC</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((link (org-element-context))
         (path (org-element-property <span style="color: #006FE0;">:path</span> link))
         (beg (org-element-property <span style="color: #006FE0;">:begin</span> link))
         (end (org-element-property <span style="color: #006FE0;">:end</span> link))
         (rgb (mapcar 'string-to-number (split-string path <span style="color: #008000;">","</span>))))
    (<span style="color: #0000FF;">setq</span> rgb (mapcar (<span style="color: #0000FF;">lambda</span> (x) (+ x 10)) rgb))
    (<span style="color: #0000FF;">setf</span> (buffer-substring beg end)
          (format <span style="color: #008000;">"rgb:%s"</span> (mapconcat 'identity (mapcar 'number-to-string rgb) <span style="color: #008000;">","</span>)))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">NDEC</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((link (org-element-context))
         (path (org-element-property <span style="color: #006FE0;">:path</span> link))
         (beg (org-element-property <span style="color: #006FE0;">:begin</span> link))
         (end (org-element-property <span style="color: #006FE0;">:end</span> link))
         (rgb (mapcar 'string-to-number (split-string path <span style="color: #008000;">","</span>))))
    (<span style="color: #0000FF;">setq</span> rgb (mapcar (<span style="color: #0000FF;">lambda</span> (x) (- x 10)) rgb))
    (<span style="color: #0000FF;">setf</span> (buffer-substring beg end)
          (format <span style="color: #008000;">"rgb:%s"</span> (mapconcat 'identity (mapcar 'number-to-string rgb) <span style="color: #008000;">","</span>)))))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">ndec</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (skip-chars-backward <span style="color: #008000;">"0-9"</span>)
  (<span style="color: #0000FF;">or</span> (looking-at <span style="color: #008000;">"[0-9]+"</span>)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"No number at point"</span>))
  (replace-match (number-to-string (1- (string-to-number (match-string 0))))))

(org-link-set-parameters <span style="color: #008000;">"rgb"</span> <span style="color: #006FE0;">:face</span> 'rgb-face
                         <span style="color: #006FE0;">:activate-func</span> 'rgb-func
                         <span style="color: #006FE0;">:keymap</span> (<span style="color: #0000FF;">let</span> ((map (copy-keymap org-mouse-map)))
                                   (define-key map (kbd <span style="color: #008000;">"C-&lt;up&gt;"</span>) 'ninc)
                                   (define-key map (kbd <span style="color: #008000;">"C-&lt;down&gt;"</span>) 'ndec)
                                   (define-key map (kbd <span style="color: #008000;">"s-&lt;up&gt;"</span>) 'NINC)
                                   (define-key map (kbd <span style="color: #008000;">"s-&lt;down&gt;"</span>) 'NDEC)
                                   map))
</pre>
</div>


<p>
<a href="83,29,238">83,29,238</a>   This is a violet color.   <a href="112,17,19">112,17,19</a>
</p>

<p>
This is an rgb link with three comma separated numbers. We color each number accordingly, and set the rgb link to the color represented by the RGB pair.
</p>

<p>
<a href="225,225,225">225,225,225</a>  This is a light gray.            
</p>

<p>
A subtle point in this example is the need to save-match-data. Some functions modify the match-data, and this will mess up the whole font-lock system. I learned that by trial and error.
</p>
</div>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/11/04/New-link-features-in-org-9.org">org-mode source</a></p>
<p>Org-mode version = 9.0</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2016/11/04/New-link-features-in-org-9#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Sending-html-emails-from-org-mode-with-org-mime"></div>
      <h2 class="blog_post_title"><a href="/blog/2016/10/29/Sending-html-emails-from-org-mode-with-org-mime/" rel="bookmark" title="Permanent Link to Sending html emails from org-mode with org-mime">Sending html emails from org-mode with org-mime</a></h2>
      <p><small><span class="blog_post_date">Posted October 29, 2016 at 02:33 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/email/'>email</a>, <a href='/blog/category/orgmode/'>orgmode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2016/10/29/Sending-html-emails-from-org-mode-with-org-mime#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline10">1. From an org-headline in an org-file</a>
<ul>
<li><a href="#orgheadline3">1.1. Markup</a></li>
<li><a href="#orgheadline4">1.2. Equations</a></li>
<li><a href="#orgheadline5">1.3. Tables</a></li>
<li><a href="#orgheadline6">1.4. Lists</a></li>
<li><a href="#orgheadline7">1.5. Code block</a></li>
<li><a href="#orgheadline8">1.6. An image from somewhere other than this directory</a></li>
<li><a href="#orgheadline9">1.7. Citations with org-ref</a></li>
</ul>
</li>
<li><a href="#orgheadline2">2. In a mail message</a></li>
<li><a href="#orgheadline1">3. Equations and file attachments do not seem to work out of the box</a></li>
<li><a href="#orgheadline11">4. Summary</a></li>
</ul>
</div>
</div>
<p>
On the org-mode mailing list there was some discussion about sending html mail using orgmode. The support for this in mu4e is deprecated. There is the org-mime library though, and it supports a lot of what is needed for this. As I played around with it though, I came across some limitations:
</p>

<ol class="org-ol">
<li>I found equations were not rendered as images in the html, and files (in links) were not attached out of the box. I fixed that <a href="#orgheadline1">here</a>.</li>
<li>I found it useful to modify the org-mime commands to leave point in the To: field when composing emails from org-buffers.</li>
<li>For use with mu4e, I created a function to open a message in org-mu4e-compose-org-mode, and added a C-cC-c hook to allow me to send it easily <a href="#orgheadline2">(here)</a>.</li>
</ol>

<p>
This post documents some work I did figuring out how to send html mails. After some testing, some of these should probably be patched in org-mime.
</p>

<p>
First, you need to require this library.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">org-mime</span>)
</pre>
</div>

<p>
You can send a whole org buffer in html like with this command: <a href="org-mime-org-buffer-htmlize">org-mime-org-buffer-htmlize</a>. Not all of the internal links work for me (at least in gmail).
</p>

<p>
The default behavior leaves you at the end of the buffer, which is not too nice. We lightly modify the function here to leave in the To: field.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-mime-org-buffer-htmlize</span> ()
  <span style="color: #036A07;">"Create an email buffer containing the current org-mode file</span>
<span style="color: #036A07;">  exported to html and encoded in both html and in org formats as</span>
<span style="color: #036A07;">  mime alternatives."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (org-mime-send-buffer 'html)
  (message-goto-to))
</pre>
</div>

<div id="outline-container-orgheadline10" class="outline-2">
<h2 id="orgheadline10"><span class="section-number-2">1</span> From an org-headline in an org-file</h2>
<div class="outline-text-2" id="text-1">
<p>
You can compose an email as an org-heading in any org-buffer, and send it as html. In an org-heading, you need to specify a MAIL_FMT property of html, e.g.:
</p>

<pre class="example">
   :PROPERTIES:
   :MAIL_FMT: html
   :END:
</pre>

<p>
Note the following properties can also be set to modify the composed email.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">           (subject (<span style="color: #0000FF;">or</span> (funcall mp <span style="color: #008000;">"MAIL_SUBJECT"</span>) (nth 4 (org-heading-components))))
           (to (funcall mp <span style="color: #008000;">"MAIL_TO"</span>))
           (cc (funcall mp <span style="color: #008000;">"MAIL_CC"</span>))
           (bcc (funcall mp <span style="color: #008000;">"MAIL_BCC"</span>))
</pre>
</div>

<p>
Then, send it with <a href="org-mime-subtree">org-mime-subtree</a>
</p>

<p>
Here I modify this function to leave me in the To: field.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-mime-subtree</span> ()
  <span style="color: #036A07;">"Create an email buffer containing the current org-mode subtree</span>
<span style="color: #036A07;">  exported to a org format or to the format specified by the</span>
<span style="color: #036A07;">  MAIL_FMT property of the subtree."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (org-mime-send-subtree
   (<span style="color: #0000FF;">or</span> (org-entry-get nil <span style="color: #008000;">"MAIL_FMT"</span> org-mime-use-property-inheritance) 'org))
  (message-goto-to))
</pre>
</div>

<p>
Here are some sample elements to see if they convert to html reasonably.
</p>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">1.1</span> Markup</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<b>bold</b>
</p>

<p>
<span class="underline">underlined</span>
</p>

<p>
<i>italics</i>
</p>

<p>
<del>strikethrough</del>
</p>

<p>
<code>code</code>
</p>

<p>
Subscripts: H<sub>2</sub>O
Superscripts: H<sup>+</sup>
An entity: To &infin; and beyond
</p>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">1.2</span> Equations</h3>
<div class="outline-text-3" id="text-1-2">
<p>
\(x^2\)
</p>

<p>
\[x^4\]
</p>

<p>
\(e^x\)
</p>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><span class="section-number-3">1.3</span> Tables</h3>
<div class="outline-text-3" id="text-1-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> A table for you.</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">x</td>
<td class="org-right">y</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-3">
<h3 id="orgheadline6"><span class="section-number-3">1.4</span> Lists</h3>
<div class="outline-text-3" id="text-1-4">
<p>
A nested list.
</p>
<ul class="org-ul">
<li>one
<ul class="org-ul">
<li>Subentry under one.</li>
</ul></li>
<li>two</li>
</ul>


<p>
A definition list:
</p>

<dl class="org-dl">
<dt>def1</dt><dd>first definition</dd>
</dl>

<p>
A checklist:
</p>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> A checkbox</li>
</ul>


<p>
Here is a numbered list:
</p>

<ol class="org-ol">
<li>number 1</li>
<li>number 2</li>
</ol>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-3">
<h3 id="orgheadline7"><span class="section-number-3">1.5</span> Code block</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #BA36A5;">t</span> = np.linspace(0, 10)
<span style="color: #BA36A5;">x</span> = np.cos(t) * np.exp(-t)
<span style="color: #BA36A5;">y</span> = np.sin(t) * np.exp(-t)

plt.plot(x, y)
plt.savefig(<span style="color: #008000;">'spiral.png'</span>)
</pre>
</div>

<p>
<img src="/media/spiral.png"> 
</p>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-3">
<h3 id="orgheadline8"><span class="section-number-3">1.6</span> An image from somewhere other than this directory</h3>
<div class="outline-text-3" id="text-1-6">
<p>
<img src="/media/Au-icosahedron-3.png"> 
</p>
</div>
</div>

<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="orgheadline9"><span class="section-number-3">1.7</span> Citations with org-ref</h3>
<div class="outline-text-3" id="text-1-7">
<table id="orgtable1" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-left">b</td>
<td class="org-left">c</td>
</tr>
</tbody>
</table>

<p>
See Table <a href="#table-1">table-1</a>.
</p>

<p>
<a class='org-ref-reference' href="#Dominik201408">Dominik201408</a>
</p>

<p>
<h1 class='org-ref-bib-h1'>Bibliography</h1>
<ul class='org-ref-bib'><li><a id="Dominik201408">[Dominik201408] Carsten Dominik, The Org Mode 8 Reference Manual - Organize your life with GNU  Emacs, Samurai Media Limited (2014).</a></li>
</ul>
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2"><a id="ID-D44F059D-180C-41C5-BA0A-873723E0DDFB"></a><span class="section-number-2">2</span> In a mail message</h2>
<div class="outline-text-2" id="text-2">
<p>
You might prefer to do this directly in an email. Here is how you can do it in mu4e. I use this command to open a message in org-mode. The mode switches if you are in the header, or in the body. If you always do this, you could use a hook instead on message-mode. I do not want default html so I do not do it. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">mu4e-compose-org-mail</span> ()
 (<span style="color: #0000FF;">interactive</span>)
 (mu4e-compose-new)
 (org-mu4e-compose-org-mode))
</pre>
</div>

<p>
For sending, we will use org-mime to htmlize it, and add a C-c C-c hook function to send it.  This hook is a little tricky, we want to preserve C-c C-c behavior in org-mode, e.g. in code blocks, but send it if there is no other C-c C-c action that makes sense, so we add it to the end of the hook. Alternatively, you could bind a special key for it, or run the special command. Note the C-c C-c hook only works in the body of the email. From the header, a plain text message is sent.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">htmlize-and-send</span> ()
  <span style="color: #036A07;">"When in an org-mu4e-compose-org-mode message, htmlize and send it."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">when</span> (member 'org~mu4e-mime-switch-headers-or-body post-command-hook)
    (org-mime-htmlize) 
    (message-send-and-exit)))

(add-hook 'org-ctrl-c-ctrl-c-hook 'htmlize-and-send t)
</pre>
</div>

<p>
Here is a way to do this for non-mu4e users. It doesn't have the nice mode switching capability though, so you lose completion in emails, and header specific functions. You can switch back to message-mode to regain those.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">compose-html-org</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (compose-mail)
  (message-goto-body)
  (<span style="color: #0000FF;">setq</span> *compose-html-org* t)
  (org-mode))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-htmlize-and-send</span> ()
  <span style="color: #036A07;">"When in an org-mu4e-compose-org-mode message, htmlize and send it."</span>
  (<span style="color: #0000FF;">interactive</span>)
  
  (<span style="color: #0000FF;">when</span> *compose-html-org*
    (<span style="color: #0000FF;">setq</span> *compose-html-org* nil)
    (message-mode)
    (org-mime-htmlize) 
    (message-send-and-exit)))

(add-hook 'org-ctrl-c-ctrl-c-hook 'org-htmlize-and-send t)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><a id="ID-14317E51-C65E-48DD-9B52-B94D6B458E8F"></a><span class="section-number-2">3</span> Equations and file attachments do not seem to work out of the box</h2>
<div class="outline-text-2" id="text-3">
<p>
\(e^{i\pi} - 1 = 0\)
</p>

<p>
Out of the box, org-mime does not seem to attach file links to emails or make images for equations..
</p>

<p>
<a href="/media/html-email.org">html-email.org</a> 
</p>

<p>
Here is an adaptation of org-mime-compose that does that for html messages.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-mime-compose</span> (body fmt file <span style="color: #6434A3;">&amp;optional</span> to subject headers)
  (<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">message</span>)
  (<span style="color: #0000FF;">let</span> ((bhook
         (<span style="color: #0000FF;">lambda</span> (body fmt)
           (<span style="color: #0000FF;">let</span> ((hook (intern (concat <span style="color: #008000;">"org-mime-pre-"</span>
                                       (symbol-name fmt)
                                       <span style="color: #008000;">"-hook"</span>))))
             (<span style="color: #0000FF;">if</span> (&gt; (eval `(length ,hook)) 0)
                 (<span style="color: #0000FF;">with-temp-buffer</span>
                   (insert body)
                   (goto-char (point-min))
                   (eval `<span style="color: #D0372D;">(run-hooks </span>',hook))
                   (buffer-string))
               body))))
        (fmt (<span style="color: #0000FF;">if</span> (symbolp fmt) fmt (intern fmt)))
        (files (org-element-map (org-element-parse-buffer) 'link
                 (<span style="color: #0000FF;">lambda</span> (link)
                   (<span style="color: #0000FF;">when</span> (string= (org-element-property <span style="color: #006FE0;">:type</span> link) <span style="color: #008000;">"file"</span>)
                     (file-truename (org-element-property <span style="color: #006FE0;">:path</span> link)))))))
    (compose-mail to subject headers nil)
    (message-goto-body)
    (<span style="color: #0000FF;">cond</span>
     ((eq fmt 'org)
      (<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-org</span>)
      (insert (org-export-string-as
               (org-babel-trim (funcall bhook body 'org)) 'org t)))
     ((eq fmt 'ascii)
      (<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-ascii</span>)
      (insert (org-export-string-as
               (concat <span style="color: #008000;">"#+Title:\n"</span> (funcall bhook body 'ascii)) 'ascii t)))
     ((<span style="color: #0000FF;">or</span> (eq fmt 'html) (eq fmt 'html-ascii))
      (<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-ascii</span>)
      (<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-org</span>)
      (<span style="color: #0000FF;">let*</span> ((org-link-file-path-type 'absolute)
             <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">we probably don't want to export a huge style file</span>
             (org-export-htmlize-output-type 'inline-css)
             (org-html-with-latex 'dvipng)
             (html-and-images
              (org-mime-replace-images
               (org-export-string-as (funcall bhook body 'html) 'html t)))
             (images (cdr html-and-images))
             (html (org-mime-apply-html-hook (car html-and-images))))
        (insert (org-mime-multipart
                 (org-export-string-as
                  (org-babel-trim
                   (funcall bhook body (<span style="color: #0000FF;">if</span> (eq fmt 'html) 'org 'ascii)))
                  (<span style="color: #0000FF;">if</span> (eq fmt 'html) 'org 'ascii) t)
                 html)
                (mapconcat 'identity images <span style="color: #008000;">"\n"</span>)))))
    (mapc #'mml-attach-file files)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline11" class="outline-2">
<h2 id="orgheadline11"><span class="section-number-2">4</span> Summary</h2>
<div class="outline-text-2" id="text-4">
<p>
This makes it pretty nice to send rich-formatted html text to people.
</p>
</div>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/10/29/Sending-html-emails-from-org-mode-with-org-mime.org">org-mode source</a></p>
<p>Org-mode version = 8.3.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2016/10/29/Sending-html-emails-from-org-mode-with-org-mime#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Using-Twitter-cards-for-better-tweets"></div>
      <h2 class="blog_post_title"><a href="/blog/2016/08/26/Using-Twitter-cards-for-better-tweets/" rel="bookmark" title="Permanent Link to Using Twitter cards for better tweets">Using Twitter cards for better tweets</a></h2>
      <p><small><span class="blog_post_date">Posted August 26, 2016 at 03:56 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/publication/'>publication</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2016/08/26/Using-Twitter-cards-for-better-tweets#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated August 26, 2016 at 04:32 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
<img src="/media/ss-vdw.png"> 
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #006699;">@article</span>{<span style="color: #D0372D;">thirumalai-2015-pt-pd</span>,
  <span style="color: #BA36A5;">author</span> =       "Hari Thirumalai and John R. Kitchin",
  <span style="color: #BA36A5;">title</span> =        {The Role of Vdw Interactions in Coverage Dependent Adsorption
                  Energies of Atomic Adsorbates on Pt(111) and Pd(111)},
  <span style="color: #BA36A5;">journal</span> =      "Surface Science ",
  <span style="color: #BA36A5;">pages</span> =        " - ",
  <span style="color: #BA36A5;">year</span> =         2015,
  <span style="color: #BA36A5;">doi</span> =          {<span style="color: #006DAF; text-decoration: underline;">10.1016/j.susc.2015.10.001</span>},
  <span style="color: #BA36A5;">url</span> =
                  "http://www.sciencedirect.com/science/article/pii/S0039602815003052",
  <span style="color: #BA36A5;">issn</span> =         "0039-6028",
}
</pre>
</div>

<p>
See it here: <a href="http://www.sciencedirect.com/science/article/pii/S0039602815003052">http://www.sciencedirect.com/science/article/pii/S0039602815003052</a>.
</p>

<p>
The main goal of this post is to test run using a <a href="https://dev.twitter.com/cards/types/summary-large-image">Twitter card</a> to make better tweets about publications.
</p>

<p>
This post did not work quite like I anticipated, mostly because of the way I publish my blog which focuses only on the HTML body. The meta tags that are needed for Twitter do not seem to get put in the header as needed. If I do a regular org export with HTML_HEAD options to get this page: <a href="http://kitchingroup.cheme.cmu.edu/publications/twitter-card.html">http://kitchingroup.cheme.cmu.edu/publications/twitter-card.html</a>, it did work. The page is pretty bare, but it could be embellished without much work. 
</p>

<p>
Tweeting that URL led to this tweet: 
</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Test tweet with a twitter card: <a href="https://t.co/TagjgTgFmZ">https://t.co/TagjgTgFmZ</a></p>&mdash; John Kitchin (@johnkitchin) <a href="https://twitter.com/johnkitchin/status/769267071645540352">August 26, 2016</a></blockquote> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>
On Twitter, this showed an image of the picture on the page, and linked directly to the page I made. The image is sized a little large and doesn't fit in card quite right, but this is probably fixable. This whole process could be smoothed out a lot with a custom export to get the twitter meta tags in the right place, and maybe provide links to bibtex files, analytics, etc. Sounds like a fun project ;) 
</p>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/08/26/Using-Twitter-cards-for-better-tweets.org">org-mode source</a></p>
<p>Org-mode version = 8.3.5</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2016/08/26/Using-Twitter-cards-for-better-tweets#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="../6"> Previous Page</a>
  --  
 <a href="../8">Next Page </a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook/">Adding keymaps to src blocks via org-font-lock-hook</a></li>
      <li><a href="/blog/2017/05/26/Org-mode-and-ipython-enhancements-in-scimax/">Org-mode and ipython enhancements in scimax</a></li>
      <li><a href="/blog/2017/05/21/A-partial-symbolic-numeric-solver-in-emacs-lisp/">A partial symbolic numeric solver in emacs-lisp</a></li>
      <li><a href="/blog/2017/05/05/A-new-and-improved-Emacs-gnuplot-DSL/">A new and improved Emacs gnuplot DSL</a></li>
      <li><a href="/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/">An emacs-lisp dsl for gnuplot</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2017
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



