

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Enabling-right-clicks-in-org-mode-links"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links/" rel="bookmark" title="Permanent Link to Enabling right-clicks in org-mode links">Enabling right-clicks in org-mode links</a></h2>
      <p><small><span class="blog_post_date">Posted October 21, 2013 at 07:58 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 21, 2013 at 08:45 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
Out of the box you can click on org-mode links to make the do things. On my machine, all clicks are equal, left mouse, middle mouse, and right mouse all act as a "click". I was curious about whether I could get different behavior on a link with a left or right mouse click. It is easy enough to <a href="http://orgmode.org/manual/Adding-hyperlink-types.html">define a new link type</a> . You define a function that is run when you click on the link.
</p>

<p>
To figure out what to do here, I looked into the events handling in emacs. According to this <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Click-Events.html">page</a> , there are click events. So, after we click on a link, there should be a click event which was the last input event. We can get that, figure out which button was pressed, and run code accordingly. We will make the code add some lines to the buffer after the link about what happened.
</p>

<p>
Here is my link definition. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq counter 1)
(org-add-link-type
 <span style="color: #228b22;">"test"</span>
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this function is run when you click</span>
 (<span style="color: #8b0000;">lambda</span> (link-string) 
   (<span style="color: #8b0000;">let</span> ((button (car last-input-event)))
     (<span style="color: #8b0000;">cond</span> ((eq button 'mouse-1) 
            (end-of-line)
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-1 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1)))
           ((eq button 'mouse-2) 
            (end-of-line) 
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-2 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1)))
           ((eq button 'mouse-3) 
            (end-of-line)
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-3 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1))))))
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">formatting</span>
(<span style="color: #8b0000;">lambda</span> (keyword desc format)
   (<span style="color: #8b0000;">cond</span>
    ((eq format 'html) (format <span style="color: #228b22;">"&lt;pre&gt;%s:%s&lt;/pre&gt;"</span> keyword desc)))))
</pre>
</div>


<p>
Here we make a link. When you click on it, it adds lines right after the link telling you what was clicked on. I left-clicked, middle-clicked and right-clicked. The right-clicked result is the first line.
</p>

<p>
<pre>test:which-button</pre> 
click 3. mouse-3 pressed (mouse-3 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320964819 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>

<p>
click 2. mouse-2 pressed (mouse-2 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320965724 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>

<p>
click 1. mouse-2 pressed (mouse-2 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320966660 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>


<p>
Curiously, this only shows that mouse-2 (for left or middle mouse) or mouse-3 (for right click) was pressed, never mouse-1. I am not sure what causes that. If I try to capture an event it does show mouse-1 is active.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(princ (read-event))
</pre>
</div>

<pre class="example">
(down-mouse-1 (#&lt;window 34 on blog.org&gt; 56437 (253 . 308) -322917920 nil 56437 (31 . 19) nil (93 . 4) (8 . 16)))
</pre>

<p>
Anyway, it looks conceivable that you could have different link actions occur for different mouse clicks. I could see using this in a citation link, where a left click might open the citation in my bibtex file, and right clicking would open a pdf of the citation if it existed. 
</p>

<p>
I have not figured out how flexible this might be, for example could you use modifier keys with mouse clicks? This code suggests that it is possible in emacs, but so far none of these make it into the last-input-event in the org-link clicks.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(princ (read-event))
</pre>
</div>

<pre class="example">
(S-down-mouse-1 (#&lt;window 34 on blog.org&gt; 56725 (1 . 299) -322897656 nil 56725 (0 . 18) nil (1 . 11) (8 . 16)))
</pre>

<p>
It might be difficult remembering all the modifiers and clicks, but it would be cool if it was possible!
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/21/Enabling-right-clicks-in-org-mode-links.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Posting-articles-to-CiteULike-from-bibtex"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/20/Posting-articles-to-CiteULike-from-bibtex/" rel="bookmark" title="Permanent Link to Posting articles to CiteULike from bibtex">Posting articles to CiteULike from bibtex</a></h2>
      <p><small><span class="blog_post_date">Posted October 20, 2013 at 03:33 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/python/'>python</a>, <a href='/blog/category/emacs/'>emacs</a>, <a href='/blog/category/citeulike/'>citeulike</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/20/Posting-articles-to-CiteULike-from-bibtex#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 20, 2013 at 07:35 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Doing this in emacs</a></li>
</ul>
</div>
</div>

<p>
I have been using <a href="http://www.citeulike.org/user/jkitchin">CiteULike</a> for a while now to keep a list of articles that are probably worth reading. Basically, each month I get a table of contents from many journals, and as I read through them, if an article catches my attention I add it to my CiteULike account. 
</p>

<p>
This list is not synchronized with my bibtex database however. These serve different purposes. The CiteULike list is for articles that are probably worth reading, while the bibtex file contains articles I am probably going to cite. It should be that every article in my bibtex file is on CiteULike, but not necessarily the other way around. The problem is I do not have a way to push files from my bibtex file to CiteULike easily.
</p>

<p>
CiteULike allows you to <a href="http://www.citeulike.org/profile/jkitchin/import_go">import</a> a bibtex file though. I want to explore automatically importing a bibtex file by simulating the form. We need a set of cookies to make this happen so CiteULike knows who we are. I stored my username and password in a file called citeulike.json and use them to get cookies that I save here in a pickle file. I think this cookie gives you access to your CiteULike account, so it should be kept secret.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> json, pickle, requests

<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'citeulike.json'</span>) <span style="color: #8b0000;">as</span> f:
    <span style="color: #8b008b;">d</span> = json.loads(f.read())

<span style="color: #8b008b;">url</span> = <span style="color: #228b22;">'http://www.citeulike.org/login.do'</span>

<span style="color: #8b008b;">data</span> = <span style="color: #228b22;">"username={0}&amp;password={1}&amp;perm=1"</span>.<span style="color: #cd0000;">format</span>(d[<span style="color: #228b22;">'username'</span>], d[<span style="color: #228b22;">'password'</span>])

<span style="color: #8b008b;">r</span> = requests.post(url, data=data, allow_redirects=<span style="color: #cd0000;">False</span>)

<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'cookies.pckl'</span>, <span style="color: #228b22;">'wb'</span>) <span style="color: #8b0000;">as</span> f:
    pickle.dump(r.cookies, f)
</pre>
</div>

<p>
By inspecting the <a href="http://www.citeulike.org/profile/jkitchin/import_go">import</a> page with Firebug, I constructed this http request to upload a bibtex string.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> pickle, requests

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">reload cookies</span>
<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'cookies.pckl'</span>, <span style="color: #228b22;">'rb'</span>) <span style="color: #8b0000;">as</span> f:
    <span style="color: #8b008b;">cookies</span> = pickle.load(f)

<span style="color: #8b008b;">url</span> = <span style="color: #228b22;">'http://www.citeulike.org/profile/jkitchin/import_do'</span>

<span style="color: #8b008b;">bibtex</span> = <span style="color: #228b22;">'''</span>
<span style="color: #228b22;">@article{zhuo-2010-co2-induc,</span>
<span style="color: #228b22;">  author =       {Zhuo, Shengchi and Huang, Yongmin and Peng, Changjun</span>
<span style="color: #228b22;">                  and Liu, Honglai and Hu, Ying and Jiang, Jianwen},</span>
<span style="color: #228b22;">  title =        {CO2-Induced Microstructure Transition of Surfactant</span>
<span style="color: #228b22;">                  in Aqueous Solution: Insight from Molecular Dynamics</span>
<span style="color: #228b22;">                  Simulation},</span>
<span style="color: #228b22;">  journal =      {The Journal of Physical Chemistry B},</span>
<span style="color: #228b22;">  volume =       114,</span>
<span style="color: #228b22;">  number =       19,</span>
<span style="color: #228b22;">  pages =        {6344-6349},</span>
<span style="color: #228b22;">  year =         2010,</span>
<span style="color: #228b22;">  doi =          {10.1021/jp910253b},</span>
<span style="color: #228b22;">  URL =          {http://pubs.acs.org/doi/abs/10.1021/jp910253b},</span>
<span style="color: #228b22;">  eprint =       {http://pubs.acs.org/doi/pdf/10.1021/jp910253b}</span>
<span style="color: #228b22;">}'''</span>

<span style="color: #8b008b;">data</span> = {<span style="color: #228b22;">'pasted'</span>:bibtex,
        <span style="color: #228b22;">'to_read'</span>:2,
        <span style="color: #228b22;">'tag_parsing'</span>:<span style="color: #228b22;">'simple'</span>,
        <span style="color: #228b22;">'strip_brackets'</span>:<span style="color: #228b22;">'no'</span>,
        <span style="color: #228b22;">'update_id'</span>:<span style="color: #228b22;">'bib-key'</span>,
        <span style="color: #228b22;">'btn_bibtex'</span>:<span style="color: #228b22;">'Import BibTeX file ...'</span>}

<span style="color: #8b008b;">headers</span> = {<span style="color: #228b22;">'content-type'</span>: <span style="color: #228b22;">'multipart/form-data'</span>,
           <span style="color: #228b22;">'User-Agent'</span>:<span style="color: #228b22;">'jkitchin/johnrkitchin@gmail.com bibtexupload'</span>}

<span style="color: #8b008b;">r</span> = requests.post(url, headers=headers, data=data, cookies=cookies, files={})
</pre>
</div>

<p>
The result is that article is now listed in my CiteULike at <a href="http://www.citeulike.org/user/jkitchin/article/12728895">http://www.citeulike.org/user/jkitchin/article/12728895</a> .  This opens the possibility of integrating this into my bibtex workflow. I could implement this in emacs-lisp, and have it automatically upload new entries in the bibtex file to CiteULike. 
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Doing this in emacs</h2>
<div class="outline-text-2" id="text-1">
<p>
I think the easiest thing to do here is to write a python script that takes the bibtex string and posts it. We will use emacs to get the bibtex string. We will use the example at  <a href="http://ergoemacs.org/emacs/elisp_perl_wrapper.html">http://ergoemacs.org/emacs/elisp_perl_wrapper.html</a> to put this together. This example uses an external script that takes a string on stdin, and returns a result on stdout.
</p>

<p>
We will run the function in a bibtex buffer. We will narrow the buffer to the current entry, and use that to define the boundaries of the string. We do the command in a temp-buffer to prevent it from modifying our bibtex file. There is some way to make the command not do this with optional arguments, but I did not figure it out. It is a little ugly I had to use an absolute path below. An alternative would be to put the script into a directory on your path. Here is the function.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">j/upload-bibtex-entry-to-citeulike</span> ()
  <span style="color: #228b22;">"get bibtex string and submit to citeulike"</span>
  (interactive)
  (<span style="color: #8b0000;">save-restriction</span>
    (bibtex-narrow-to-entry)
    (<span style="color: #8b0000;">let</span> ((startpos (point-min))
          (endpos (point-max))
          (bibtex-string (buffer-string))
          (script <span style="color: #228b22;">"python c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/upload_bibtex_citeulike.py"</span>))
      (<span style="color: #8b0000;">with-temp-buffer</span> (insert bibtex-string)
                        (shell-command-on-region (point-min) (point-max) script t nil nil t)))))
</pre>
</div>

<p>
Now, let us define the python script.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff0000; font-weight: bold;">#</span><span style="color: #ff0000; font-weight: bold;">!python</span>
<span style="color: #8b0000;">import</span> pickle, requests, sys

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">reload cookies</span>
<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/cookies.pckl'</span>, <span style="color: #228b22;">'rb'</span>) <span style="color: #8b0000;">as</span> f:
    <span style="color: #8b008b;">cookies</span> = pickle.load(f)

<span style="color: #8b008b;">url</span> = <span style="color: #228b22;">'http://www.citeulike.org/profile/jkitchin/import_do'</span>

<span style="color: #8b008b;">bibtex</span> = sys.stdin.read()

<span style="color: #8b008b;">data</span> = {<span style="color: #228b22;">'pasted'</span>:bibtex,
        <span style="color: #228b22;">'to_read'</span>:2,
        <span style="color: #228b22;">'tag_parsing'</span>:<span style="color: #228b22;">'simple'</span>,
        <span style="color: #228b22;">'strip_brackets'</span>:<span style="color: #228b22;">'no'</span>,
        <span style="color: #228b22;">'update_id'</span>:<span style="color: #228b22;">'bib-key'</span>,
        <span style="color: #228b22;">'btn_bibtex'</span>:<span style="color: #228b22;">'Import BibTeX file ...'</span>}

<span style="color: #8b008b;">headers</span> = {<span style="color: #228b22;">'content-type'</span>: <span style="color: #228b22;">'multipart/form-data'</span>,
           <span style="color: #228b22;">'User-Agent'</span>:<span style="color: #228b22;">'jkitchin/johnrkitchin@gmail.com bibtexupload'</span>}

<span style="color: #8b008b;">r</span> = requests.post(url, headers=headers, data=data, cookies=cookies, files={})
</pre>
</div>

<p>
That is it. Now, in my bibtex file with the cursor in an entry, I type M-x j/upload-bibtex-entry-to-citeulike, and a few seconds later the entry has been uploaded! 
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/20/Posting-articles-to-CiteULike-from-bibtex.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/20/Posting-articles-to-CiteULike-from-bibtex#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Serializing-jasp-calculations-as-json-data"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/19/Serializing-jasp-calculations-as-json-data/" rel="bookmark" title="Permanent Link to Serializing jasp calculations as json data">Serializing jasp calculations as json data</a></h2>
      <p><small><span class="blog_post_date">Posted October 19, 2013 at 02:33 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/vasp/'>vasp</a>, <a href='/blog/category/ase/'>ase</a>, <a href='/blog/category/jasp/'>jasp</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/19/Serializing-jasp-calculations-as-json-data#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 19, 2013 at 03:10 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. The simplest case of a simple calculation</a></li>
<li><a href="#sec-2">2. Including extra information in the JSON file</a></li>
<li><a href="#sec-3">3. Limitations?</a></li>
</ul>
</div>
</div>

<p>
We use <a href="http://www.vasp.at/">VASP</a>to calculate materials properties in our research We use the <a href="https://github.com/jkitchin/jasp/tree/dev">jasp</a>python module we have developed to setup, run and analyze those calculations. One of the things we have worked on developing recently is to more transparently share how do this kind of work by using org-mode supporting information files. Doing this should make our research more reproducible, and allow others to build off of it more easily.
</p>

<p>
We have run into the following problem trying to share VASP results however. The VASP license prohibits us from sharing the POTCAR files that are used to run the calculations. That is unfortunate, but since these files are also what give VASP some competitive advantage, they are protected, and we agreed to that when we bought the license. The problem is that the <code>jasp</code> module requires the POTCAR files to work, so without them, our scripts are not reproducible by researchers without a VASP license. 
</p>

<p>
So, we have been looking at new ways to share the data from our calculations. In this post, we consider representing the calculation as a JSON file. We will look at a couple of new features built into the development branch of <code>jasp</code>
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The simplest case of a simple calculation</h2>
<div class="outline-text-2" id="text-1">
<p>
Here we setup and run a simple calculation, and output the JSON file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> ase <span style="color: #8b0000;">import</span> Atoms, Atom
<span style="color: #8b0000;">from</span> jasp <span style="color: #8b0000;">import</span> *
<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
np.set_printoptions(precision=3, suppress=<span style="color: #cd0000;">True</span>)

<span style="color: #8b008b;">co</span> = Atoms([Atom(<span style="color: #228b22;">'C'</span>,[0,   0, 0]),
            Atom(<span style="color: #228b22;">'O'</span>,[1.2, 0, 0])],
            cell=(6., 6., 6.))

<span style="color: #8b0000;">with</span> jasp(<span style="color: #228b22;">'molecules/simple-co'</span>, <span style="color: #ff0000; font-weight: bold;">#</span><span style="color: #ff0000; font-weight: bold;">output dir</span>
          xc=<span style="color: #228b22;">'PBE'</span>,  <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">the exchange-correlation functional</span>
          nbands=6,  <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">number of bands</span>
          encut=350, <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">planewave cutoff</span>
          ismear=1,  <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">Methfessel-Paxton smearing</span>
          sigma=0.01,<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">very small smearing factor for a molecule</span>
          atoms=co) <span style="color: #8b0000;">as</span> calc:
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'energy = {0} eV'</span>.<span style="color: #cd0000;">format</span>(co.get_potential_energy())
    <span style="color: #8b0000;">print</span> co.get_forces()
    <span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'JSON'</span>, <span style="color: #228b22;">'w'</span>) <span style="color: #8b0000;">as</span> f:
        f.write(calc.json)
</pre>
</div>

<pre class="example">
energy = -14.687906 eV
[[ 5.095  0.     0.   ]
 [-5.095  0.     0.   ]]
</pre>

<p>
Now, we can analyze the JSON file independently of jasp. The json data contains all the inputs we used for the VASP calculation, the atomic geometry, and many of the outputs of the calculation. Here is the <a href="/media/2013-10-19-Serializing-jasp-calculations-as-json-data/JSON">JSON</a>file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> json
<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'molecules/simple-co/JSON'</span>, <span style="color: #228b22;">'rb'</span>) <span style="color: #8b0000;">as</span> f:
    <span style="color: #8b008b;">d</span> = json.loads(f.read())

<span style="color: #8b0000;">print</span>(<span style="color: #228b22;">'The energy is {0}'</span>.<span style="color: #cd0000;">format</span>(d[<span style="color: #228b22;">'data'</span>][<span style="color: #228b22;">'total_energy'</span>]))
<span style="color: #8b0000;">print</span>(<span style="color: #228b22;">'The forces are {0}'</span>.<span style="color: #cd0000;">format</span>(d[<span style="color: #228b22;">'data'</span>][<span style="color: #228b22;">'forces'</span>]))
</pre>
</div>

<pre class="example">
The energy is -14.687906
The forces are [[5.095488, 0.0, 0.0], [-5.095488, 0.0, 0.0]]
</pre>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Including extra information in the JSON file</h2>
<div class="outline-text-2" id="text-2">
<p>
If we use a slightly different syntax, we can also include the total DOS in the JSON file.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> jasp <span style="color: #8b0000;">import</span> *

<span style="color: #8b0000;">with</span> jasp(<span style="color: #228b22;">'molecules/simple-co'</span>) <span style="color: #8b0000;">as</span> calc:
    <span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'JSON-DOS'</span>, <span style="color: #228b22;">'w'</span>) <span style="color: #8b0000;">as</span> f:
        f.write(calc_to_json(calc, dos=<span style="color: #cd0000;">True</span>))
</pre>
</div>

<p>
To illustrate that we have done that, let us plot the DOS without using <code>jasp</code> from the <a href="/media/2013-10-19-Serializing-jasp-calculations-as-json-data/JSON-DOS">JSON-DOS</a>file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> json
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

<span style="color: #8b0000;">with</span> <span style="color: #cd0000;">open</span>(<span style="color: #228b22;">'molecules/simple-co/JSON-DOS'</span>, <span style="color: #228b22;">'rb'</span>) <span style="color: #8b0000;">as</span> f:
    <span style="color: #8b008b;">d</span> = json.loads(f.read())

<span style="color: #8b008b;">energies</span> = d[<span style="color: #228b22;">'data'</span>][<span style="color: #228b22;">'dos'</span>][<span style="color: #228b22;">'e'</span>]
<span style="color: #8b008b;">dos</span> = d[<span style="color: #228b22;">'data'</span>][<span style="color: #228b22;">'dos'</span>][<span style="color: #228b22;">'dos'</span>]
plt.plot(energies, dos)
plt.savefig(<span style="color: #228b22;">'molecules/simple-co/dos.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2013-10-19-Serializing-jasp-calculations-as-json-data/dos.png">
</p>
</div>

<p>
We are still working on getting atom-projected DOS into the json file, and ensuring that all the spin cases are handled (e.g. the spin-up and spin-down DOS).
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Limitations?</h2>
<div class="outline-text-2" id="text-3">
<p>
JSON is flexible, and can store text and numeric data. It does not store numpy arrays, but rather it is limited to storing lists of data. You would have to convert them back to arrays if you want to do array math. You probably wouldn't want to store a 3d array of electron density in this format, although it probably isn't worse than a CUBE file format. We haven't tested these files very significantly yet at a large scale to see how fast it is to read from lots of them.
</p>

<p>
Nonetheless, this looks like a reasonable format to share data in human and machine readable form, without violating the VASP licence conditions.
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/19/Serializing-jasp-calculations-as-json-data.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/19/Serializing-jasp-calculations-as-json-data#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Limitations"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/19/Limitations/" rel="bookmark" title="Permanent Link to Limitations?">Limitations?</a></h2>
      <p><small><span class="blog_post_date">Posted October 19, 2013 at 02:32 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/uncategorized/'>uncategorized</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/19/Limitations#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
JSON is flexible, and can store text and numeric data. It does not store numpy arrays, but rather it is limited to storing lists of data. You would have to convert them back to arrays if you want to do array math. You probably wouldn't want to store a 3d array of electron density in this format, although it probably isn't worse than a CUBE file format. We haven't tested these files very significantly yet at a large scale to see how fast it is to read from lots of them.
</p>

<p>
Nonetheless, this looks like a reasonable format to share data in human and machine readable form, without violating the VASP licence conditions.
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/19/Limitations?.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/19/Limitations#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Lisp-links-in-org-mode-to-dynamically-generated-content"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content/" rel="bookmark" title="Permanent Link to Lisp links in org-mode to dynamically generated content">Lisp links in org-mode to dynamically generated content</a></h2>
      <p><small><span class="blog_post_date">Posted October 14, 2013 at 10:49 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 20, 2013 at 10:19 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Converting elisp links to their value on export</a>
<ul>
<li><a href="#sec-1-1">1.1. empty section</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Converting elisp links to their value on export</h2>
<div class="outline-text-2" id="text-1">
<p>
Someone asked on the mailing list if it would be possible to replace a lisp expression in org-mode with its value. I thought this should work with the filter system I have been exploring.  The idea is to preprocess the org buffer, get all the links, and handle the elisp links specially. Then, we use a filter to replace elisp links with the output we got from preprocessing. We need to have a few different links in this file to make it more obvious what we are doing. For example we do not want this <a href="#sec-1-1">link</a> to be changed. The link to <a href="http://orgmode.org">http://orgmode.org</a> should not be changed. But we want a link like <code>elisp:(+ 2 3)</code> to be replaced by <code>5</code>.
</p>

<p>
The following text:
</p>
<pre class="example">
This file was exported on [[elisp:(format-time-string "%Y-%m-%d at %H:%m %p")]].

The answer to 2 + 3 is [[elisp:(+ 2 3)]].
</pre>
<p>
Renders like this:
</p>

<p>
This file was exported on 2013-10-20 at 10:10 AM.
</p>

<p>
The answer to 2 + 3 is 5.
</p>

<p>
First, we get the links. If there is an elisp link we set the list value to the value of the link evaluated, otherwise we set it to nil. In the filter, we will replace the output of the link if the value in this list is not nil.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq link-list (<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
                      (counter 0))
                  (org-element-map parsetree 'link
                    (<span style="color: #8b0000;">lambda</span> (link) 
                      (<span style="color: #8b0000;">let*</span> ((plist (nth 1 link))
                             (content (plist-get plist <span style="color: #cd0000;">:content</span>))
                             (path (plist-get plist <span style="color: #cd0000;">:path</span>))
                             (type (plist-get plist '<span style="color: #cd0000;">:type</span>))
                             (fname (car (last (split-string path <span style="color: #228b22;">"/"</span>))))
                             )
                       (<span style="color: #8b0000;">if</span> (string-match <span style="color: #228b22;">"elisp"</span> type) (format <span style="color: #228b22;">"%s"</span> (eval (read (plist-get plist <span style="color: #cd0000;">:path</span>)))) <span style="color: #228b22;">"nil"</span>))))))

(princ link-list)
</pre>
</div>

<pre class="example">
(nil nil 2013-10-20 at 10:10 AM 5 nil)
</pre>

<p>
Now, we have the output of what we want for each link. Now, we will setup the filter, and export this file to a blogpost.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((counter 0))

  (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-link</span> (text back-end info)
    (<span style="color: #8b0000;">let</span> ((link-content (nth counter link-list)))
      (<span style="color: #8b0000;">if</span> (not (string= link-content <span style="color: #228b22;">"nil"</span>)) 
          (setq output (format <span style="color: #228b22;">"%s"</span> link-content)) <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this was an elisp link</span>
        (setq output text))) <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">this was some other kind of link</span>
      (setq counter (+ counter 1))
      output)

  (<span style="color: #8b0000;">let</span> ((org-export-filter-link-functions '(ox-mrkup-filter-link))
        (async nil)
        (subtreep nil)
        (visible-only nil)
        (body-only t)
        (ext-plist '()))
    (org-html-export-as-html async subtreep visible-only body-only ext-plist))

    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">now get the output into the org output</span>
    (switch-to-buffer <span style="color: #228b22;">"*Org HTML Export*"</span>)

    (setq HTML (buffer-string))
    (setq YAML <span style="color: #228b22;">"---</span>
<span style="color: #228b22;">title: Lisp links in org-mode to dynamically generated content</span>
<span style="color: #228b22;">date: 2013/10/14 22:49:00</span>
<span style="color: #228b22;">updated: 2013/10/20 10:19:00</span>
<span style="color: #228b22;">categories: org-mode</span>
<span style="color: #228b22;">---</span>



<span style="color: #228b22;">"</span>)
  (<span style="color: #8b0000;">with-temp-buffer</span>
(insert YAML)
(insert HTML)
(write-region (point-min) (point-max) <span style="color: #228b22;">"../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html"</span>)))
(princ <span style="color: #228b22;">"Done."</span>)
</pre>
</div>

<pre class="example">
Done.
</pre>


<p>
Finally, let us check <a href="../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html">../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html</a>.
</p>
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> empty section</h3>
</div>
</div>


    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="../67">« Previous Page</a>
  --  
 <a href="../69">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/01/27/New-publication-in-Topics-in-Catalysis/">New publication in Topics in Catalysis</a></li>
      <li><a href="/blog/2018/01/03/New-publication-in-Molecular-Simulation/">New publication in Molecular Simulation</a></li>
      <li><a href="/blog/2017/12/31/2017-in-a-nutshell-for-the-Kitchin-Research-group/">2017 in a nutshell for the Kitchin Research group</a></li>
      <li><a href="/blog/2017/11/29/Solving-an-eigenvalue-differential-equation-with-a-neural-network/">Solving an eigenvalue differential equation with a neural network</a></li>
      <li><a href="/blog/2017/11/28/Solving-ODEs-with-a-neural-network-and-autograd/">Solving ODEs with a neural network and autograd</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



