

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="/publications.html">Publications</a></li>
      <li><a href="/group.html">Group</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>

      <li><a href="/subscribe.html">Subscribe</a></li>

    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers/" rel="bookmark" title="Permanent Link to Finding equilibrium composition by direct minimization of Gibbs free energy on mole numbers">Finding equilibrium composition by direct minimization of Gibbs free energy on mole numbers</a></h2>
      <p><small><span class="blog_post_date">Posted March 01, 2013 at 12:27 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/optimization/'>optimization</a></span> | tags: <a href='/blog/tag/thermodynamics/'>thermodynamics</a>
        | <a href="http://jkitchin.github.io/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated September 10, 2014 at 01:15 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. The Gibbs energy of a mixture</a></li>
<li><a href="#sec-2">2. Linear equality constraints for atomic mass conservation</a></li>
<li><a href="#sec-3">3. Equilibrium constant based on mole numbers</a></li>
<li><a href="#sec-4">4. Summary</a></li>
</ul>
</div>
</div>
<p>
<a href="http://matlab.cheme.cmu.edu/2011/12/25/finding-equilibrium-composition-by-direct-minimization-of-gibbs-free-energy-on-mole-numbers/">Matlab post</a> 
Adapted from problem 4.5 in Cutlip and Shacham
Ethane and steam are fed to a steam cracker at a total pressure of 1 atm and at 1000K at a ratio of 4 mol H2O to 1 mol ethane. Estimate the equilibrium distribution of products (CH4, C2H4, C2H2, CO2, CO, O2, H2, H2O, and C2H6).
</p>

<p>
Solution method: We will construct a Gibbs energy function for the mixture, and obtain the equilibrium composition by minimization of the function subject to elemental mass balance constraints.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">R</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">00198588</span> <span style="color: #ff0000; font-weight: bold;"># kcal/mol/K</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">T</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1000</span> <span style="color: #ff0000; font-weight: bold;"># K</span>

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">species</span> = [<span style="color: #228b22;">'CH4'</span>, <span style="color: #228b22;">'C2H4'</span>, <span style="color: #228b22;">'C2H2'</span>, <span style="color: #228b22;">'CO2'</span>, <span style="color: #228b22;">'CO'</span>, <span style="color: #228b22;">'O2'</span>, <span style="color: #228b22;">'H2'</span>, <span style="color: #228b22;">'H2O'</span>, <span style="color: #228b22;">'C2H6'</span>]

# <span style="color: #ff0000; font-weight: bold;">$G_^\circ for each species. These are the heats of formation for each</span>
# <span style="color: #ff0000; font-weight: bold;">species.</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">Gjo</span> = np.array([<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">61</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">28</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">249</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">40</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">604</span>, -<span style="color: #000000; background-color: #cccccc; font-weight: bold;">94</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">61</span>, -<span style="color: #000000; background-color: #cccccc; font-weight: bold;">47</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">942</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>, -<span style="color: #000000; background-color: #cccccc; font-weight: bold;">46</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">03</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">26</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">13</span>]) <span style="color: #ff0000; font-weight: bold;"># kcal/mol</span>
</pre>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The Gibbs energy of a mixture</h2>
<div class="outline-text-2" id="text-1">
<p>
We start with \(G=\sum\limits_j n_j \mu_j\). Recalling that we define \(\mu_j = G_j^\circ + RT \ln a_j\), and in the ideal gas limit, \(a_j = y_j P/P^\circ\), and that \(y_j = \frac{n_j}{\sum n_j}\). Since in this problem, P = 1 atm, this leads to the function \(\frac{G}{RT} = \sum\limits_{j=1}^n n_j\left(\frac{G_j^\circ}{RT} + \ln \frac{n_j}{\sum n_j}\right)\).
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">func</span>(nj):
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">nj</span> = np.array(nj)
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">Enj</span> = np.sum(nj);
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">G</span> = np.sum(nj * (Gjo / R / T + np.log(nj / Enj)))
    <span style="color: #8b0000;">return</span> G
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Linear equality constraints for atomic mass conservation</h2>
<div class="outline-text-2" id="text-2">
<p>
The total number of each type of atom must be the same as what entered the reactor. These form equality constraints on the equilibrium composition. We express these constraints as: \(A_{eq} n = b\) where \(n\) is a vector of the moles of each species present in the mixture. CH4 C2H4 C2H2 CO2 CO O2 H2 H2O C2H6
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #000000; background-color: #cccccc; font-weight: bold;">Aeq</span> = np.array([[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>],      <span style="color: #ff0000; font-weight: bold;"># oxygen balance</span>
                [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>,    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">6</span>],      <span style="color: #ff0000; font-weight: bold;"># hydrogen balance</span>
                [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,  <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>,   <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>]])     <span style="color: #ff0000; font-weight: bold;"># carbon balance</span>

# <span style="color: #ff0000; font-weight: bold;">the incoming feed was 4 mol H2O and 1 mol ethane</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">beq</span> = np.array([<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>,  <span style="color: #ff0000; font-weight: bold;"># moles of oxygen atoms coming in</span>
                <span style="color: #000000; background-color: #cccccc; font-weight: bold;">14</span>, <span style="color: #ff0000; font-weight: bold;"># moles of hydrogen atoms coming in</span>
                <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>]) <span style="color: #ff0000; font-weight: bold;"># moles of carbon atoms coming in</span>

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">ec1</span>(n):
    <span style="color: #228b22;">'equality constraint'</span>
    <span style="color: #8b0000;">return</span> np.dot(Aeq, n) - beq

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">ic1</span>(n):
    <span style="color: #228b22;">'''inequality constraint</span>
<span style="color: #228b22;">       all n&gt;=0</span>
<span style="color: #228b22;">    '''</span>   
    <span style="color: #8b0000;">return</span> n
</pre>
</div>

<p>
Now we solve the problem.
</p>

<div class="org-src-container">

<pre class="src src-python"># <span style="color: #ff0000; font-weight: bold;">initial guess suggested in the example</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">n0</span> = [1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>, 1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>, 1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">993</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>, 1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">992</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>, 1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>] 

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">n0</span> = [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">066</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">8</span>.7e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">08</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>.1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">14</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">545</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">39</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>.7e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">14</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">346</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>.<span style="color: #000000; background-color: #cccccc; font-weight: bold;">521</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>.58e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">7</span>]

<span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fmin_slsqp

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">X</span> = fmin_slsqp(func, n0, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">f_eqcons</span>=ec1,<span style="color: #000000; background-color: #cccccc; font-weight: bold;">f_ieqcons</span>=ic1,<span style="color: #cd0000;"> iter</span>=<span style="color: #000000; background-color: #cccccc; font-weight: bold;">300</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">acc</span>=1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">12</span>)

<span style="color: #8b0000;">for</span> s,x <span style="color: #8b0000;">in</span><span style="color: #cd0000;"> zip</span>(species, X):
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'{0:10s} {1:1.4g}'</span>.format(s, x)

# <span style="color: #ff0000; font-weight: bold;">check that constraints were met</span>
<span style="color: #8b0000;">print</span> np.dot(Aeq, X) - beq
<span style="color: #8b0000;">print</span> np.all( np.abs( np.dot(Aeq, X) - beq) &lt; 1e-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">12</span>)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; Optimization terminated successfully.    (Exit mode 0)
            Current function value: -104.403951524
            Iterations: 16
            Function evaluations: 193
            Gradient evaluations: 15
&gt;&gt;&gt; ... ... CH4        0.06644
C2H4       9.48e-08
C2H2       1.487e-13
CO2        0.545
CO         1.389
O2         3.096e-13
H2         5.346
H2O        1.521
C2H6       1.581e-07
... [  0.00000000e+00   0.00000000e+00   4.44089210e-16]
True
</pre>

<p>
I found it necessary to tighten the accuracy parameter to get pretty good matches to the solutions found in Matlab. It was also necessary to increase the number of iterations. Even still, not all of the numbers match well, especially the very small numbers. You can, however, see that the constraints were satisfied pretty well.
</p>


<p>
Interestingly there is a distribution of products! That is interesting because only steam and ethane enter the reactor, but a small fraction of methane is formed! The main product is hydrogen. The stoichiometry of steam reforming is ideally \(C_2H_6 + 4H_2O \rightarrow 2CO_2 + 7 H2\). Even though nearly all the ethane is consumed, we do not get the full yield of hydrogen. It appears that another equilibrium, one between CO, CO2, H2O and H2, may be limiting that, since the rest of the hydrogen is largely in the water. It is also of great importance that we have not said anything about reactions, i.e. how these products were formed. 
</p>

<p>
The water gas shift reaction is: \(CO + H_2O \rightleftharpoons CO_2 + H_2\). We can compute the Gibbs free energy of the reaction from the heats of formation of each species. Assuming these are the formation energies at 1000K, this is the reaction free energy at 1000K.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #000000; background-color: #cccccc; font-weight: bold;">G_wgs</span> = Gjo[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>] + Gjo[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">6</span>] - Gjo[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>] - Gjo[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">7</span>]
<span style="color: #8b0000;">print</span> G_wgs

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">K</span> = np.exp(-G_wgs / (R*T))
<span style="color: #8b0000;">print</span> K
</pre>
</div>

<pre class="example">
-0.638
&gt;&gt;&gt; &gt;&gt;&gt; 1.37887528109
</pre>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Equilibrium constant based on mole numbers</h2>
<div class="outline-text-2" id="text-3">
<p>
One normally uses activities to define the equilibrium constant. Since there are the same number of moles on each side of the reaction all factors that convert mole numbers to activity, concentration or pressure cancel, so we simply consider the ratio of mole numbers here.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> (X[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>] * X[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">6</span>]) / (X[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>] * X[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">7</span>])
</pre>
</div>

<pre class="example">
1.37887525547
</pre>

<p>
This is very close to the equilibrium constant computed above. 
</p>

<p>
Clearly, there is an equilibrium between these species that prevents the complete reaction of steam reforming.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Summary</h2>
<div class="outline-text-2" id="text-4">
<p>
This is an appealing way to minimize the Gibbs energy of a mixture. No assumptions about reactions are necessary, and the constraints are easy to identify. The Gibbs energy function is especially easy to code.</p>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/03/01/Finding-equilibrium-composition-by-direct-minimization-of-Gibbs-free-energy-on-mole-numbers#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Meet-the-steam-tables"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/02/28/Meet-the-steam-tables/" rel="bookmark" title="Permanent Link to Meet the steam tables">Meet the steam tables</a></h2>
      <p><small><span class="blog_post_date">Posted February 28, 2013 at 10:09 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/uncategorized/'>uncategorized</a></span> | tags: <a href='/blog/tag/steam/'>steam</a>, <a href='/blog/tag/thermodynamics/'>thermodynamics</a>
        | <a href="http://jkitchin.github.io/blog/2013/02/28/Meet-the-steam-tables#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated June 26, 2013 at 07:00 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Starting point in the Rankine cycle in condenser.</a></li>
<li><a href="#sec-2">2. Isentropic compression of liquid to point 2</a></li>
<li><a href="#sec-3">3. Isobaric heating to T3 in boiler where we make steam</a></li>
<li><a href="#sec-4">4. Isentropic expansion through turbine to point 4</a></li>
<li><a href="#sec-5">5. To get from point 4 to point 1</a></li>
<li><a href="#sec-6">6. Efficiency</a></li>
<li><a href="#sec-7">7. Entropy-temperature chart</a></li>
<li><a href="#sec-8">8. Summary</a></li>
</ul>
</div>
</div>
<p>
<a href="http://matlab.cheme.cmu.edu/2011/10/31/matlab-meets-the-steam-tables/">Matlab post</a>
</p>

<p>
We will use the <a href="https://pypi.python.org/pypi/iapws">iapws</a> module. Install it like this:
</p>

<div class="org-src-container">

<pre class="src src-sh">pip install iapws
</pre>
</div>

<p>
Problem statement: A Rankine cycle operates using steam with the condenser at 100 degC, a pressure of 3.0 MPa and temperature of 600 degC in the boiler. Assuming the compressor and turbine operate reversibly, estimate the efficiency of the cycle.
</p>

<p>
Starting point in the Rankine cycle in condenser.
</p>

<p>
we have saturated liquid here, and we get the thermodynamic properties for the given temperature. In this python module, these properties are all in attributes of an IAPWS object created at a set of conditions.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Starting point in the Rankine cycle in condenser.</h2>
<div class="outline-text-2" id="text-1">
<p>
We have saturated liquid here, and we get the thermodynamic properties for the given temperature.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> iapws <span style="color: #8b0000;">import</span> IAPWS97

T1 = 100 + 273.15 <span style="color: #ff0000; font-weight: bold;">#in K</span>

sat_liquid1  = IAPWS97(T=T1, x=0) <span style="color: #ff0000; font-weight: bold;"># x is the steam quality. 0 = liquid</span>

P1 = sat_liquid1.P
s1 = sat_liquid1.s
h1 = sat_liquid1.h
v1 = sat_liquid1.v
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Isentropic compression of liquid to point 2</h2>
<div class="outline-text-2" id="text-2">
<p>
The final pressure is given, and we need to compute the new temperatures, and enthalpy.
</p>

<div class="org-src-container">

<pre class="src src-python">P2 = 3.0 <span style="color: #ff0000; font-weight: bold;"># MPa</span>
s2 = s1 <span style="color: #ff0000; font-weight: bold;"># this is what isentropic means</span>

sat_liquid2 = IAPWS97(P=P2, s=s1)
T2, = sat_liquid2.T
h2 = sat_liquid2.h

<span style="color: #ff0000; font-weight: bold;"># work done to compress liquid. This is an approximation, since the</span>
<span style="color: #ff0000; font-weight: bold;"># volume does change a little with pressure, but the overall work here</span>
<span style="color: #ff0000; font-weight: bold;"># is pretty small so we neglect the volume change.</span>
WdotP = v1*(P2 - P1);
<span style="color: #8b0000;">print</span>
<span style="color: #8b0000;">print</span>(<span style="color: #228b22;">'The compressor work is: {0:1.4f} kJ/kg'</span>.format(WdotP))
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; ... ... ... &gt;&gt;&gt;
The compressor work is: 0.0030 kJ/kg
</pre>

<p>
The compression work is almost negligible. This number is 1000 times smaller than we computed with Xsteam. I wonder what the units of v1 actually are.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Isobaric heating to T3 in boiler where we make steam</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-python">T3 = 600 + 273.15 <span style="color: #ff0000; font-weight: bold;"># K</span>
P3 = P2 <span style="color: #ff0000; font-weight: bold;"># definition of isobaric</span>
steam = IAPWS97(P=P3, T=T3)

h3 = steam.h
s3 = steam.s

Qb, = h3 - h2 <span style="color: #ff0000; font-weight: bold;"># heat required to make the steam</span>

<span style="color: #8b0000;">print</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'The boiler heat duty is: {0:1.2f} kJ/kg'</span>.format(Qb)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt;
The boiler heat duty is: 3260.69 kJ/kg
</pre>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Isentropic expansion through turbine to point 4</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-python">steam =  IAPWS97(P=P1, s=s3)
T4, = steam.T
h4 = steam.h
s4 = s3 <span style="color: #ff0000; font-weight: bold;"># isentropic</span>
Qc, = h4 - h1 <span style="color: #ff0000; font-weight: bold;"># work required to cool from T4 to T1</span>
<span style="color: #8b0000;">print</span> 
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'The condenser heat duty is {0:1.2f} kJ/kg'</span>.format(Qc)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt;
The condenser heat duty is 2317.00 kJ/kg
</pre>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> To get from point 4 to point 1</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-python">WdotTurbine, = h4 - h3 <span style="color: #ff0000; font-weight: bold;"># work extracted from the expansion</span>
<span style="color: #8b0000;">print</span>(<span style="color: #228b22;">'The turbine work is: {0:1.2f} kJ/kg'</span>.format(WdotTurbine))
</pre>
</div>

<pre class="example">
The turbine work is: -946.71 kJ/kg
</pre>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Efficiency</h2>
<div class="outline-text-2" id="text-6">
<p>
This is a ratio of the work put in to make the steam, and the net work obtained from the turbine. The answer here agrees with the efficiency calculated in Sandler on page 135.
</p>

<div class="org-src-container">

<pre class="src src-python">eta = -(WdotTurbine - WdotP) / Qb
<span style="color: #8b0000;">print</span>(<span style="color: #228b22;">'The overall efficiency is {0:1.2%}.'</span>.format(eta))
</pre>
</div>

<pre class="example">
The overall efficiency is 29.03%.
</pre>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Entropy-temperature chart</h2>
<div class="outline-text-2" id="text-7">
<p>
The IAPWS module makes it pretty easy to generate figures of the steam tables. Here we generate an entropy-Temperature graph. We do this to illustrate the path of the Rankine cycle. We need to compute the values of steam entropy for a range of pressures and temperatures.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

plt.figure()
plt.clf()
T = np.linspace(300, 372+273, 200) <span style="color: #ff0000; font-weight: bold;"># range of temperatures</span>
<span style="color: #8b0000;">for</span> P <span style="color: #8b0000;">in</span> [0.1, 1, 2, 5, 10, 20]: <span style="color: #ff0000; font-weight: bold;">#MPa</span>
    steam = [IAPWS97(T=t, P=P) <span style="color: #8b0000;">for</span> t <span style="color: #8b0000;">in</span> T]
    S = [s.s <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> steam]
    plt.plot(S, T, <span style="color: #228b22;">'k-'</span>)

<span style="color: #ff0000; font-weight: bold;"># saturated vapor and liquid entropy lines</span>
svap = [s.s <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> [IAPWS97(T=t, x=1) <span style="color: #8b0000;">for</span> t <span style="color: #8b0000;">in</span> T]]
sliq = [s.s <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> [IAPWS97(T=t, x=0) <span style="color: #8b0000;">for</span> t <span style="color: #8b0000;">in</span> T]]

plt.plot(svap, T, <span style="color: #228b22;">'r-'</span>)
plt.plot(sliq, T, <span style="color: #228b22;">'b-'</span>)

plt.xlabel(<span style="color: #228b22;">'Entropy (kJ/(kg K)'</span>)
plt.ylabel(<span style="color: #228b22;">'Temperature (K)'</span>)
plt.savefig(<span style="color: #228b22;">'images/iawps-steam.png'</span>)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &lt;matplotlib.figure.Figure object at 0x000000000638BC18&gt;
&gt;&gt;&gt; &gt;&gt;&gt; ... ... ... ... [&lt;matplotlib.lines.Line2D object at 0x0000000007F9C208&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9C400&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9C8D0&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9CD30&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9E1D0&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9E630&gt;]
... &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; [&lt;matplotlib.lines.Line2D object at 0x0000000001FDCEB8&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000007F9EA90&gt;]
&gt;&gt;&gt; &lt;matplotlib.text.Text object at 0x0000000007F7BE48&gt;
&lt;matplotlib.text.Text object at 0x0000000007F855F8&gt;
</pre>


<p><img src="/img/./images/iawps-steam.png"><p>


<p>
We can plot our Rankine cycle path like this. We compute the entropies along the non-isentropic paths.
</p>

<div class="org-src-container">

<pre class="src src-python">T23 = np.linspace(T2, T3)
S23 = [s.s <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> [IAPWS97(P=P2, T=t) <span style="color: #8b0000;">for</span> t <span style="color: #8b0000;">in</span> T23]]

T41 = np.linspace(T4, T1 - 0.01) <span style="color: #ff0000; font-weight: bold;"># subtract a tiny bit to make sure we get a liquid</span>
S41 = [s.s <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> [IAPWS97(P=P1, T=t) <span style="color: #8b0000;">for</span> t <span style="color: #8b0000;">in</span> T41]]
</pre>
</div>

<p>
And then we plot the paths.
</p>

<div class="org-src-container">

<pre class="src src-python">plt.plot([s1, s2], [T1, T2], <span style="color: #228b22;">'r-'</span>, lw=4) <span style="color: #ff0000; font-weight: bold;"># Path 1 to 2</span>
plt.plot(S23, T23, <span style="color: #228b22;">'b-'</span>, lw=4) <span style="color: #ff0000; font-weight: bold;"># path from 2 to 3 is isobaric</span>
plt.plot([s3, s4], [T3, T4], <span style="color: #228b22;">'g-'</span>, lw=4) <span style="color: #ff0000; font-weight: bold;"># path from 3 to 4 is isentropic</span>
plt.plot(S41, T41, <span style="color: #228b22;">'k-'</span>, lw=4) <span style="color: #ff0000; font-weight: bold;"># and from 4 to 1 is isobaric</span>
plt.savefig(<span style="color: #228b22;">'images/iawps-steam-2.png'</span>)
plt.savefig(<span style="color: #228b22;">'images/iawps-steam-2.svg'</span>)
</pre>
</div>

<pre class="example">
[&lt;matplotlib.lines.Line2D object at 0x0000000008350908&gt;]
[&lt;matplotlib.lines.Line2D object at 0x00000000083358D0&gt;]
[&lt;matplotlib.lines.Line2D object at 0x000000000835BEB8&gt;]
[&lt;matplotlib.lines.Line2D object at 0x0000000008357160&gt;]
</pre>

<p><img src="/img/./images/iawps-steam-2.png"><p>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Summary</h2>
<div class="outline-text-2" id="text-8">
<p>
This was an interesting exercise. On one hand, the tedium of interpolating the steam tables is gone. On the other hand, you still have to know exactly what to ask for to get an answer that is correct. The iapws interface is a little clunky, and takes some getting used to. It does not seem as robust as the Xsteam module I used in Matlab.
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/28/Meet-the-steam-tables.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/02/28/Meet-the-steam-tables#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Interesting-online-python-sites"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/02/28/Interesting-online-python-sites/" rel="bookmark" title="Permanent Link to Interesting online python sites">Interesting online python sites</a></h2>
      <p><small><span class="blog_post_date">Posted February 28, 2013 at 06:58 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/python/'>python</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/02/28/Interesting-online-python-sites#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated February 28, 2013 at 07:01 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
I have come across some very interesting online, <i>interactive</i> python sites recently.
</p>

<ul>
<li><a href="http://interactivepython.org" >http://interactivepython.org</a> has some interactive books with embedded python interpreters in the exercises. 
</li>

<li>sympy actually has an <a href="http://live.sympy.org/" >online shell</a>! The <a href="http://docs.sympy.org/0.7.2/index.html" >documentation</a> has live examples in a shell you can use that is integrated with Sphinx. 
</li>
</ul>

<p>
Here are a few others I came across:
</p>
<ul>
<li><a href="https://www.pythonanywhere.com/try-ipython/" >https://www.pythonanywhere.com/try-ipython/</a> Ipython in your browser!
</li>
<li><a href="http://www.trypython.org/" >http://www.trypython.org/</a>#
</li>
<li><a href="http://www.pythontutor.com/" >http://www.pythontutor.com/</a>
</li>
<li><a href="http://py-ide-online.appspot.com/" >http://py-ide-online.appspot.com/</a>
</li>
</ul>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/28/Interesting-online-python-sites.org">org-mode source</a><p>


    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/02/28/Interesting-online-python-sites#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Smooth-transitions-between-two-constants"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/02/27/Smooth-transitions-between-two-constants/" rel="bookmark" title="Permanent Link to Smooth transitions between two constants">Smooth transitions between two constants</a></h2>
      <p><small><span class="blog_post_date">Posted February 27, 2013 at 02:53 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/math/'>math</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/02/27/Smooth-transitions-between-two-constants#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated March 06, 2013 at 06:26 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
Suppose we have a parameter that has two different values depending on the value of a dimensionless number. For example when the dimensionless number is much less than 1, x = 2/3, and when x is much greater than 1, x = 1. We desire a smooth transition from 2/3 to 1  as a function of x to avoid discontinuities in functions of x. We will adapt the smooth transitions between functions to be a smooth transition between constants.
</p>

<p>
We define our function as \(x(D) = x0 + (x1 - x0)*(1 - sigma(D,w)\). We control the rate of the transition by the variable \(w\)
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

x0 = 2.0 / 3.0
x1 = 1.5

w = 0.05

D = np.linspace(0,2, 500)

sigmaD = 1.0 / (1.0 + np.exp(-(1 - D) / w))

x =  x0 + (x1 - x0)*(1 - sigmaD)

plt.plot(D, x)
plt.xlabel(<span style="color: #228b22;">'D'</span>); plt.ylabel(<span style="color: #228b22;">'x'</span>)
plt.savefig(<span style="color: #228b22;">'images/smooth-transitions-constants.png'</span>)
</pre>
</div>

<p><img src="/img/./images/smooth-transitions-constants.png"><p>

<p>
This is a nice trick to get an analytical function with continuous derivatives for a transition between two constants. You could have the transition occur at a value other than D = 1, as well by changing the argument to the exponential function.
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/27/Smooth-transitions-between-two-constants.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/02/27/Smooth-transitions-between-two-constants#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="A-novel-way-to-numerically-estimate-the-derivative-of-a-function-complex-step-derivative-approximation"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/02/27/A-novel-way-to-numerically-estimate-the-derivative-of-a-function-complex-step-derivative-approximation/" rel="bookmark" title="Permanent Link to A novel way to numerically estimate the derivative of a function - complex-step derivative approximation">A novel way to numerically estimate the derivative of a function - complex-step derivative approximation</a></h2>
      <p><small><span class="blog_post_date">Posted February 27, 2013 at 02:51 PM</span> | categories:
        <span class="blog_post_categories"><a href='/blog/category/math/'>math</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/02/27/A-novel-way-to-numerically-estimate-the-derivative-of-a-function-complex-step-derivative-approximation#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated July 09, 2013 at 08:53 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>

</p>

<p>
<a href="http://matlab.cheme.cmu.edu/2011/12/24/a-novel-way-to-numerically-estimate-the-derivative-of-a-function-complex-step-derivative-approximation/">Matlab post</a>
</p>

<p>
Adapted from <a href="http://biomedicalcomputationreview.org/2/3/8.pdf">http://biomedicalcomputationreview.org/2/3/8.pdf</a> and
<a href="http://dl.acm.org/citation.cfm?id=838250.838251">http://dl.acm.org/citation.cfm?id=838250.838251</a>
</p>

<p>
This posts introduces a novel way to numerically estimate the derivative
of a function that does not involve finite difference schemes. Finite
difference schemes are approximations to derivatives that become more and
more accurate as the step size goes to zero, except that as the step size
approaches the limits of machine accuracy, new errors can appear in the
approximated results. In the references above, a new way to compute the
derivative is presented that does not rely on differences!
</p>

<p>
The new way is: \(f'(x) = \rm{imag}(f(x + i\Delta x)/\Delta x)\) where the
function \(f\) is evaluated in imaginary space with a small \(\Delta x\) in
the complex plane. The derivative is miraculously equal to the imaginary
part of the result in the limit of \(\Delta x \rightarrow 0\)!
</p>

<p>
This example comes from the first link. The derivative must be evaluated
using the chain rule.  We compare a forward difference, central
difference and complex-step derivative approximations.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">f</span>(x):   <span style="color: #8b0000;">return</span> np.sin(3*x)*np.log(x)

x = 0.7
h = 1e-7

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">analytical derivative</span>
dfdx_a = 3 * np.cos( 3*x)*np.log(x) + np.sin(3*x) / x

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">finite difference</span>
dfdx_fd = (f(x + h) - f(x))/h

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">central difference</span>
dfdx_cd = (f(x+h)-f(x-h))/(2*h)

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">complex method</span>
dfdx_I = np.imag(f(x + np.complex(0, h))/h)

<span style="color: #8b0000;">print</span> dfdx_a
<span style="color: #8b0000;">print</span> dfdx_fd
<span style="color: #8b0000;">print</span> dfdx_cd
<span style="color: #8b0000;">print</span> dfdx_cd
</pre>
</div>

<pre class="example">
1.77335410624
1.7733539398
1.77335410523
1.77335410523
</pre>

<p>
These are all the same to 4 decimal places. The simple finite difference is the least accurate, and the central differences is practically the same as the complex number approach.
</p>

<p>
Let us use this method to verify the fundamental Theorem of Calculus, i.e.
to evaluate the derivative of an integral function. Let \(f(x) =
\int\limits_1^{x^2} tan(t^3)dt\), and we now want to compute df/dx.
Of course, this can be done
<a href="http://mathmistakes.info/facts/CalculusFacts/learn/doi/doif.html">analytically</a>, but it is not trivial!
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">from</span> scipy.integrate <span style="color: #8b0000;">import</span> quad

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">f_</span>(z):
    <span style="color: #8b0000;">def</span> <span style="color: #8b2323;">integrand</span>(t):
        <span style="color: #8b0000;">return</span> np.tan(t**3)
    <span style="color: #8b0000;">return</span> quad(integrand, 0, z**2)

f = np.vectorize(f_)

x = np.linspace(0, 1)

h = 1e-7

dfdx = np.imag(f(x + <span style="color: #8b0000;">complex</span>(0, h)))/h
dfdx_analytical = 2 * x * np.tan(x**6)

<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

plt.plot(x, dfdx, x, dfdx_analytical, <span style="color: #228b22;">'r--'</span>)
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; ... ... ... ... &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; c:\Python27\lib\site-packages\scipy\integrate\quadpack.py:312: ComplexWarning: Casting complex values to real discards the imaginary part
  return _quadpack._qagse(func,a,b,args,full_output,epsabs,epsrel,limit)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "c:\Python27\lib\site-packages\numpy\lib\function_base.py", line 1885, in __call__
    for x, c in zip(self.ufunc(*newargs), self.otypes)])
  File "&lt;stdin&gt;", line 4, in f_
  File "c:\Python27\lib\site-packages\scipy\integrate\quadpack.py", line 247, in quad
    retval = _quad(func,a,b,args,full_output,epsabs,epsrel,limit,points)
  File "c:\Python27\lib\site-packages\scipy\integrate\quadpack.py", line 312, in _quad
    return _quadpack._qagse(func,a,b,args,full_output,epsabs,epsrel,limit)
TypeError: can't convert complex to float
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
NameError: name 'dfdx' is not defined
</pre>

<p>
Interesting this fails.</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/27/A-novel-way-to-numerically-estimate-the-derivative-of-a-function---complex-step-derivative-approximation.org">org-mode source</a><p>

    </div>
  </div>
</article>



<a href="https://twitter.com/share" class="twitter-share-button" data-via="johnkitchin">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/02/27/A-novel-way-to-numerically-estimate-the-derivative-of-a-function-complex-step-derivative-approximation#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="../85">« Previous Page</a>
  --  
 <a href="../87">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
<script>
  (function() {
    var cx = '002533177287215655227:l7uvu35ssbc';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</section>

<section>
    <h1 class="post_header_gradient theme_font">Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/johnkitchin" data-widget-id="545217643582881792">Tweets by @johnkitchin</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
      <li><a href="https://www.continuum.io">Anaconda Python</a></li>
      <li><a href="/pycse">Pycse</a></li>
      <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2018/09/04/A-new-ode-integrator-function-in-scipy/">A new ode integrator function in scipy</a></li>
      <li><a href="/blog/2018/07/01/Getting-geo-tagged-information-from-photos-for-blogging/">Getting geo-tagged information from photos for blogging</a></li>
      <li><a href="/blog/2018/05/17/Literate-programming-with-python-doctests/">Literate programming with python doctests</a></li>
      <li><a href="/blog/2018/05/14/f-strings-in-emacs-lisp/">f-strings in emacs-lisp</a></li>
      <li><a href="/blog/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions/">Making it easier to extend the export of org-mode links with generic functions</a></li>
    </ul>
  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
  <ul id="my-github-projects">
        <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2018
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



