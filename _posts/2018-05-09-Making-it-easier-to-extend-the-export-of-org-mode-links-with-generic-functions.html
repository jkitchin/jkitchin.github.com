---
title: Making it easier to extend the export of org-mode links with generic functions
date: 2018/05/09 19:49:14
updated: 2018/05/09 19:49:14
categories: emacs,orgmode
tags: 
---


<p>
I am a big fan of org-mode links. Lately, I have had a need to modify how some links are exported, e.g. defining new exports for different backends, or fine-tuning a particular backend. This can be difficult, depending on how the link was set up. Here is a typical setup I am used to using, where the different options for the backends are handled in a conditional statement in a single function. I will just use a link that just serves to illustrate the issues here. These links are just sytactic sugar for markup, they don't do anything else. We start with an example that just converts text to italic text for different backends like html or latex.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-export</span> (path desc backend)
  (<span style="color: #0000FF;">cond</span>
   ((eq 'html backend)
    (format <span style="color: #008000;">"&lt;em&gt;%s&lt;/em&gt;"</span> path))
   ((eq 'latex backend)
    (format <span style="color: #008000;">"\\textit{%s}"</span> path))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fall-through case for everything else</span>
   (t
    path)))

(org-link-set-parameters <span style="color: #008000;">"italic"</span> <span style="color: #006FE0;">:export</span> 'italic-link-export)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:export</td>
<td class="org-left">italic-link-export</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'html t)
</pre>
</div>

<pre class="example">
&lt;p&gt;
&lt;em&gt;text&lt;/em&gt;&lt;/p&gt;

</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'latex t)
</pre>
</div>

<pre class="example">
\textit{text}

</pre>

<p>
This falls through though to the default case.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-md</span>)
(org-export-string-as <span style="color: #008000;">"italic:text"</span> 'md t)
</pre>
</div>

<pre class="example">

# Table of Contents



text


</pre>

<p>
The point I want to make here is that this is not easy to extend as a user. You have to either modify the italic-link-export function, advise it, or monkey-patch it. None of these are especially nice.
</p>

<p>
I could define italic-link-export in a way that it retrieves the function to use from an alist or hash-table using the backend, but then you have to do two things to modify the behavior: define a backend specific function <i>and</i> register it in the lookup variable. It is also possible to just look up a function by a derived symbol, e.g. using fboundp, and then using funcall to execute it. This looks something like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a user definable function for exporting to latex</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-export-latex</span> (path desc backend)
  (format <span style="color: #008000;">"\\textit{%s}"</span> path))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">generic export function that looks up functions or defaults to</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">italic-link-exporter</span> (path desc backend)
  <span style="color: #036A07;">"Run `</span><span style="color: #D0372D;">italic-link-export-BACKEND</span><span style="color: #036A07;">' if it exists, or return path."</span>
  (<span style="color: #0000FF;">let</span> ((func (intern-soft (format <span style="color: #008000;">"italic-link-export-%s"</span> backend))))
    (<span style="color: #0000FF;">if</span> (fboundp func)
        (funcall func path desc backend)
      path)))
</pre>
</div>

<p>
This has some indirection, but allows you to just define new functions to add new export backends, or replace single backend exports. It isn't bad, but there is room for improvement.
</p>

<p>
In this <a href="https://github.com/jkitchin/org-ref/issues/492#issuecomment-387806180">comment</a> in org-ref, I saw a new opportunity to address this issue using generic functions in elisp! The idea is to define a generic function that handles the general export case, and then define additional functions for each specific backend based on the signature of the export function. I will switch to bold markup for this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-defgeneric</span> <span style="color: #006699;">bold-link-export</span> (path desc backend)
 <span style="color: #036A07;">"Generic function to export a bold link."</span>
 path)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this one runs when the backend is equal to html</span>
(<span style="color: #0000FF;">cl-defmethod</span> <span style="color: #006699;">bold-link-export</span> ((path t) (desc t) (backend (eql html)))
 (format <span style="color: #008000;">"&lt;b&gt;%s&lt;/b&gt;"</span> path))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this one runs when the backend is equal to latex</span>
(<span style="color: #0000FF;">cl-defmethod</span> <span style="color: #006699;">bold-link-export</span> ((path t) (desc t) (backend (eql latex)))
 (format <span style="color: #008000;">"\\textit{%s}"</span> path))

(org-link-set-parameters <span style="color: #008000;">"bold"</span> <span style="color: #006FE0;">:export</span> 'bold-link-export)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:export</td>
<td class="org-left">bold-link-export</td>
</tr>
</tbody>
</table>

<p>
Here it is in action:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'html t)
</pre>
</div>

<pre class="example">
&lt;p&gt;
some &lt;b&gt;text&lt;/b&gt;&lt;/p&gt;

</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'latex t)
</pre>
</div>

<p>
This uses the generic function.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ox-md</span>)
(org-export-string-as <span style="color: #008000;">"some bold:text"</span> 'md t)
</pre>
</div>

<pre class="example">

# Table of Contents



some text


</pre>

<p>
The syntax for defining the generic function is pretty similar to a regular function. The specific methods are a little different since they have to provide the specific "signature" that triggers each method. Here we only differentiate on the type of the backend. It is nice these are all separate functions though. It makes it trivial to add new ones, and less intrusive to replace in my opinion.
</p>

<p>
Generic functions have many other potential applications to replace functions that use lots of conditions to control flow, with a fall-through option at the end. You can learn more about them here: <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html">https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html</a>. There is a lot more to them than I have illustrated here.
</p>
<p>Copyright (C) 2018 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions.org">org-mode source</a></p>
<p>Org-mode version = 9.1.13</p>