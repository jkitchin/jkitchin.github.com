---
title: A context-sensitive file link menu in org-mode
date: 2014/11/08 10:24:14
updated: 2014/11/08 10:26:22
categories: org
tags:
---


<p>
I am still interested in various ways to get more functionality of org-links. For example, we looked at:
</p>
<ol class="org-ol">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links/">enabling right clicks</a> on links
</li>
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2014/11/02/A-generalized-org-link-with-an-extendable-menu-of-actions/">new links with menus</a>
</li>
</ol>

<p>
When you click on a link, the function org-open-at-point runs, which is a <i>large</i> function that does a lot of things. One of them is to check if the link is defined in org-link-protocols, and to run the function definition there if it is. Here is a list of links defined for me. I defined a lot of these in org-ref, and my own init files, so you may not see these on your system.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(mapcar 'car org-link-protocols)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">google</td>
<td class="left">ResearcherID</td>
<td class="left">orcid</td>
<td class="left">message</td>
<td class="left">mac-outlook</td>
<td class="left">skim</td>
<td class="left">addressbook</td>
<td class="left">x-together-item</td>
<td class="left">rmail</td>
<td class="left">mhe</td>
<td class="left">irc</td>
<td class="left">info</td>
<td class="left">gnus</td>
<td class="left">docview</td>
<td class="left">bibtex</td>
<td class="left">bbdb</td>
<td class="left">ans</td>
<td class="left">exercise</td>
<td class="left">solution</td>
<td class="left">assignment</td>
<td class="left">doi</td>
<td class="left">bibentry</td>
<td class="left">Autocites</td>
<td class="left">autocites</td>
<td class="left">supercites</td>
<td class="left">Textcites</td>
<td class="left">textcites</td>
<td class="left">Smartcites</td>
<td class="left">smartcites</td>
<td class="left">footcitetexts</td>
<td class="left">footcites</td>
<td class="left">Parencites</td>
<td class="left">parencites</td>
<td class="left">Cites</td>
<td class="left">cites</td>
<td class="left">fnotecite</td>
<td class="left">Pnotecite</td>
<td class="left">pnotecite</td>
<td class="left">Notecite</td>
<td class="left">notecite</td>
<td class="left">footfullcite</td>
<td class="left">fullcite</td>
<td class="left">citeurl</td>
<td class="left">citedate*</td>
<td class="left">citedate</td>
<td class="left">citetitle*</td>
<td class="left">citetitle</td>
<td class="left">Citeauthor*</td>
<td class="left">Autocite*</td>
<td class="left">autocite*</td>
<td class="left">Autocite</td>
<td class="left">autocite</td>
<td class="left">supercite</td>
<td class="left">parencite*</td>
<td class="left">cite*</td>
<td class="left">Smartcite</td>
<td class="left">smartcite</td>
<td class="left">Textcite</td>
<td class="left">textcite</td>
<td class="left">footcitetext</td>
<td class="left">footcite</td>
<td class="left">Parencite</td>
<td class="left">parencite</td>
<td class="left">Cite</td>
<td class="left">Citeauthor</td>
<td class="left">Citealp</td>
<td class="left">Citealt</td>
<td class="left">Citep</td>
<td class="left">Citet</td>
<td class="left">citeyear*</td>
<td class="left">citeyear</td>
<td class="left">citeauthor*</td>
<td class="left">citeauthor</td>
<td class="left">citetext</td>
<td class="left">citenum</td>
<td class="left">citealp*</td>
<td class="left">citealp</td>
<td class="left">citealt*</td>
<td class="left">citealt</td>
<td class="left">citep*</td>
<td class="left">citep</td>
<td class="left">citet*</td>
<td class="left">citet</td>
<td class="left">nocite</td>
<td class="left">cite</td>
<td class="left">eqref</td>
<td class="left">nameref</td>
<td class="left">pageref</td>
<td class="left">ref</td>
<td class="left">label</td>
<td class="left">list-of-tables</td>
<td class="left">list-of-figures</td>
<td class="left">addbibresource</td>
<td class="left">bibliographystyle</td>
<td class="left">printbibliography</td>
<td class="left">nobibliography</td>
<td class="left">bibliography</td>
<td class="left">pydoc</td>
<td class="left">index</td>
<td class="left">attachfile</td>
<td class="left">msx</td>
<td class="left">id</td>
<td class="left">file+emacs</td>
<td class="left">file+sys</td>
</tr>
</tbody>
</table>

<p>
Interestingly, file links are not defined in org-link-protocols, they are handled separately. I would like to change the behavior of file+emacs links. Instead of just opening the file, I want a menu to give me the option to create the file if it does not exist, and to open it in emacs, or with a system program if the file does exist. Let us see what this link does.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(assoc <span style="color: #228b22;">"file+emacs"</span> org-link-protocols)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">file+emacs</td>
<td class="left">org-open-file-with-emacs</td>
<td class="left">nil</td>
</tr>
</tbody>
</table>

<p>
When you click on the link, it runs org-open-file-with-emacs, and there is no formatting function defined.
</p>

<p>
So, let us define a list of functions that could make a menu. A new variation we use in this post is that each element of the list will be a (key menu-name action-func visible-p) list. visible-p will be a function that determines if the function is listed in the menu. That way, our menu will be context specific.
</p>

<p>
We want an option to create a file if it does not exist, and if it does exist, a choice to open in emacs, or a system program. So the idea here is to create the menu in a variable (so it easy to add to later), then when you click on the link it will run a menu function that  filters the functions to run, and then prompt you for a selection.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">file+emacs-menu</span> '()
  <span style="color: #228b22;">"list of menu entries. (key name action visible).</span>
<span style="color: #228b22;">key is a character to select.</span>
<span style="color: #228b22;">name is what shows in the menu as [key]name</span>
<span style="color: #228b22;">action is a function that takes a path</span>
<span style="color: #228b22;">visible is a function that determines if the entry is in the menu."</span>)

(setq file+emacs-menu
      '((<span style="color: #228b22;">"c"</span> <span style="color: #228b22;">"reate"</span>
         find-file ; <span style="color: #ff0000; font-weight: bold;">action function</span>
         (<span style="color: #8b0000;">lambda</span> (x) (not (file-exists-p x)))) ; <span style="color: #ff0000; font-weight: bold;">visible-p</span>
        (<span style="color: #228b22;">"o"</span> <span style="color: #228b22;">"pen"</span>
         org-open-file-with-emacs
         (<span style="color: #8b0000;">lambda</span> (x) (file-exists-p x)))
        (<span style="color: #228b22;">"e"</span> <span style="color: #228b22;">"xternal open"</span>
         (<span style="color: #8b0000;">lambda</span> (x) (org-open-file path '(16)))
         (<span style="color: #8b0000;">lambda</span> (x) (file-exists-p x)))))


(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">file+emacs-menu</span> (path)
  <span style="color: #228b22;">"menu command for file+emacs links"</span>
  (interactive)
  (<span style="color: #8b0000;">let*</span> ((filtered-menu-list (-filter
                              (<span style="color: #8b0000;">lambda</span> (x) (funcall (car (last x)) path))
                              file+emacs-menu))
         (menu-string (concat
                       (mapconcat
                        (<span style="color: #8b0000;">lambda</span> (tup)
                          (concat <span style="color: #228b22;">"["</span> (elt tup 0) <span style="color: #228b22;">"]"</span>
                                  (elt tup 1) <span style="color: #228b22;">" "</span>))
                        filtered-menu-list
                        <span style="color: #228b22;">""</span>) <span style="color: #228b22;">": "</span>))
         (input (read-char-exclusive menu-string nil 1))
         (selected-func (and
                         input
                         (elt
                          (assoc
                           (char-to-string input) filtered-menu-list)
                          2))))
    (<span style="color: #8b0000;">when</span> selected-func
      (funcall selected-func path))))
</pre>
</div>

<pre class="example">
file+emacs-menu
</pre>

<p>
Now we need to change the link definition in org-link-protocols. setf comes to the rescue. We just get the whole entry, and then setf the second position in it like this.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setf (elt (assoc <span style="color: #228b22;">"file+emacs"</span> org-link-protocols) 1)
  'file+emacs-menu)
</pre>
</div>

<pre class="example">
file+emacs-menu
</pre>

<p>
Here we just confirm we set it.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(assoc <span style="color: #228b22;">"file+emacs"</span> org-link-protocols)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">file+emacs</td>
<td class="left">file+emacs-menu</td>
<td class="left">nil</td>
</tr>
</tbody>
</table>

<p>
Now, when we click on these links, we get our context specific menu. When
</p>

<p>
This file exists: <a href="/media/2014-11-08-A-context-sensitive-file-link-menu-in-org-mode/ase-db.org">ase-db.org</a> so we see this menu:
</p>

<div class="figure">
<p><img src="/media/2014-11-08-A-context-sensitive-file-link-menu-in-org-mode/open-menu.png">
</p>
</div>

<p>
This file does not exist: <a href="test.noext">test.noext</a>
So we see:
</p>

<div class="figure">
<p><img src="/media/2014-11-08-A-context-sensitive-file-link-menu-in-org-mode/create-menu.png">
</p>
</div>

<p>
For these, we can select to open them in a pdf reader or MS Word from our new menu.
<a href="/media/2014-11-08-A-context-sensitive-file-link-menu-in-org-mode/attaching-code-blocks-to-a-pdf.pdf">attaching-code-blocks-to-a-pdf.pdf</a>
</p>

<p>
<a href="/media/2014-11-08-A-context-sensitive-file-link-menu-in-org-mode/org-to-word.docx">org-to-word.docx</a>
</p>

<p>
I admit this example was a little contrived. You can do most of these things with prefix commands, or more specific commands in emacs. But, I rarely remember those. I would have preferred to use the file link in this example, but it is not defined in org-link-protocols, so this style of modification would not work, and I did not want to add it to org-link-protocols just to show how to change it this way.
</p>

<p>
This general approach would be very useful for links where there may be multiple contexts or actions that make sense. For file links, you may want do different things if the file already exists, or if it does not exist. As another example, my <a href="https://github.com/jkitchin/jmax/blob/master/org/doi-utils.org#a-new-doi-link-for-org-mode">doi link</a> gives me a menu to:
</p>
<ol class="org-ol">
<li>open in <a href="https://doi.org">https://doi.org</a>
</li>
<li>open the doi in Web of Science
</li>
<li>find citing articles in Web of Science
</li>
<li>search the doi in Google Scholar
</li>
<li>open the doi in CrossRef
</li>
<li>open the doi in Pubmed
</li>
<li>find the doi in my bibtex file
</li>
<li>get a bibtex entry for the doi
</li>
</ol>

<p>
I get all that from a click! org-ref offers similar functionality for cite links, where you might want to do different things from a click:
</p>
<ol class="org-ol">
<li>See preview of the citation
</li>
<li>open the bibtex entry
</li>
<li>open the pdf if you have it
</li>
<li>open the url for the entry
</li>
<li>any of the things I listed for the doi example above.
</li>
</ol>

<p>
I am sure there are many other things that might be useful to do!
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/11/08/A-context-sensitive-file-link-menu-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>
